<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>바리스타</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard 웹폰트 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #f4f3f9;
            margin: 0;
            color: #333;
        }

        /* 상단 헤더 */
        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        /* 입력 / 검색 영역 */
        /* ===== 입력/검색 영역 ===== */
        #controlBar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 20px;
        }

        .input-groups {
            display: flex;
            gap: 8px;
        }

        /* 개별 입력 카드 */
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 10px 14px;
            border: 1px solid #e2dff7;
            transition: 0.2s ease;
            gap: 8px;
            width: 50%;
        }

        .input-group span {
            color: #5a4398;
            font-weight: 600;
            flex-shrink: 0;
        }

        .input-group input {
            border: none;
            outline: none;
            text-align: center;
            width: 50%;
            padding: 6px 8px;
            border-radius: 6px;
            background: #f6f4fc;
            color: #333;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .input-group input:focus {
            background: #fff;
            border: 1px solid #5a4398;
            box-shadow: 0 0 0 2px rgba(90, 67, 152, 0.15);
        }

        /* 검색 input */
        #searchInput {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 16px;
            font-weight: 600;
            background: #fff;
            transition: 0.2s;
            width: 100%;
        }

        #searchInput:focus {
            border-color: #5a4398;
            box-shadow: 0 0 0 2px rgba(90, 67, 152, 0.15);
        }

        /* ✅ 즐겨찾기 목록 */
        #favoriteList {
            margin: 10px 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 10px;
            display: none;
        }

        #favoriteList h3 {
            margin: 0 0 8px;
            color: #5a4398;
            font-size: 14px;
        }

        .favorite-item {
            display: inline-block;
            background: #f6f4fc;
            border: 1px solid #e2dff7;
            border-radius: 8px;
            padding: 6px 10px;
            margin: 3px;
            cursor: pointer;
            color: #5a4398;
            font-weight: 600;
            font-size: 13px;
        }

        /* ✅ 현재 선택된 커피 강조 스타일 */
        .favorite-item.active {
            background: #5a4398;
            color: #fff;
            border-color: #5a4398;
        }

        .coffee-list {
            width: calc(100% - 40px);
            margin: 10px 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .coffee-item {
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .coffee-item:last-child {
            border-bottom: none;
        }

        .star {
            font-size: 18px;
            color: #c8b9e8; /* 기본 연보라색 */
            cursor: pointer;
            margin-left: 8px;
        }

        .star.active {
            color: #ffd84d; /* 클릭 시 노란색 */
        }

        /* 커피 정보 카드 */
        #coffeeInfo {
            width: calc(100% - 40px);
            position: relative;
            margin: 10px 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 15px 20px 5px 20px;
            display: none;
        }

        #coffeeInfo .coffee-name {
            color: #5a4398;
            font-size: 18px;
            font-weight: 600;
        }

        #coffeeInfo .coffee-stat {
            background: #5a4398;
            color: #fff;
            border-radius: 10px;
            padding: 8px 12px;
        }

        #coffeeInfo p {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 12px;
        }

        /* 커피 정보 카드 안의 즐겨찾기 별 */
        #coffeeInfo .info-star {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 22px;
            color: #c8b9e8; /* 기본 연보라색 */
            cursor: pointer;
            transition: 0.2s ease;
        }

        #coffeeInfo .info-star.active {
            color: #ffd84d; /* 클릭 시 노란색 */
        }

        /* 표 영역 */
        #coffeeTable,
        #subTable {
            width: calc(100% - 40px);
            margin: 10px 20px;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #coffeeTable th, #coffeeTable td,
        #subTable th, #subTable td {
            border: 1px solid #e0dff2;
            padding: 4px;
            text-align: center;
            font-size: 10px;
        }

        #coffeeTable th,
        #subTable th {
            background: #f6f4fc;
            color: #5a4398;
            font-weight: 600;
        }

        /* 교차 배경색 (줄무늬 효과) */
        #coffeeTable tbody tr:nth-child(odd),
        #subTable tbody tr:nth-child(odd) {
            background-color: #ffffff; /* 흰색 */
        }

        #coffeeTable tbody tr:nth-child(even),
        #subTable tbody tr:nth-child(even) {
            background-color: #faf9ff; /* 아주 옅은 보라빛 */
        }

        #loading {
            text-align: center;
            color: #5a4398;
            font-weight: 600;
            margin-top: 20px;
            display: none;
        }

        /* ===== 서브페이지 컨트롤 ===== */
        .sub-control-bar {
            margin: 0 20px;
        }

        #sortSelect {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 15px;
            font-weight: 600;
            background: #fff;
            color: #333;
            transition: 0.2s;
        }

        #sortSelect:focus {
            border-color: #5a4398;
            box-shadow: 0 0 0 2px rgba(90, 67, 152, 0.15);
            outline: none;
        }

    </style>
    <link rel="stylesheet" href="../modules/helpModal.css"/>
    <link rel="stylesheet" href="../modules/menuToggle.css"/>
</head>
<body>

<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>바리스타</h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">뒤로가기</button>
</div>

<div id="controlBar">
    <div class="input-groups">
        <div class="input-group">
            <span>커피판매</span>
            <input type="number" id="speedInput" placeholder="속도" min="1" max="10000">
        </div>
        <div class="input-group">
            <span>커피머신</span>
            <input type="number" id="countInput" placeholder="수량" min="1" max="25">
        </div>
    </div>
    <div>
        <input type="text" id="searchInput" placeholder="커피 이름 검색">
    </div>
</div>

<div class="mainPage">
    <!-- ✅ 즐겨찾기 목록 -->
    <div id="favoriteList">
        <h3>즐겨찾기</h3>
        <div id="favoriteItems"></div>
    </div>

    <div id="resultList" class="coffee-list">
        <div style='padding:10px; color:#999;'>빠진 커피가 있다면 문의 부탁드립니다.</div>
    </div>

    <!-- ✅ 커피 정보 카드 -->
    <div id="coffeeInfo"></div>

    <table id="coffeeTable" style="display:none;">
        <thead>
        <tr>
            <th>갯수</th>
            <th>소요시간</th>
            <th>원두<br>소모량</th>
            <th>획득<br>경험치</th>
            <th>획득<br>골드</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="subPage" style="display:none;">
    <div class="sub-control-bar">
        <select id="sortSelect">
            <option value="expPerTime">시간 대비 경험치 효율</option>
            <option value="goldPerTime">시간 대비 골드 효율</option>
            <option value="expPerBean">원두 대비 경험치 효율</option>
            <option value="goldPerBean">원두 대비 골드 효율</option>
            <option value="masterPerTime">시간 대비 마레 효율</option>
            <option value="masterBase">마레 경험치 획득량</option>
        </select>
    </div>

    <table id="subTable">
        <thead>
        <tr id="subHeaderRow">
            <th>순서</th>
            <th>이름</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


<div id="loading">불러오는 중...</div>

<!-- ✅ 도움말 모달 -->
<div id="helpModal" class="login-overlay" style="display:none;">
    <div class="login-modal help-modal">
        <button id="closeHelpModal" class="closeBtn">✕</button>
        <h2 class="help-title">바리스타 사용 가이드</h2>

        <div id="helpPages" class="help-content">
            <div class="help-page page1">
                <b>기본 설정</b><br>
                1) 상단 입력칸에서 <b>커피판매 속도</b>와 <b>커피머신 수량</b>을 입력하세요.<br>
                - 판매속도: 1시간 동안 커피를 몇 잔 판매할 수 있는지를 의미합니다.<br>
                - 커피머신 수량: 동시에 커피를 내릴 수 있는 기계의 개수입니다.<br>
                - 입력한 값은 자동으로 저장되어 다음 접속 시에도 유지됩니다.
            </div>

            <div class="help-page page2" style="display:none;">
                <b>커피 검색</b><br>
                2) 검색창에 커피 이름이나 줄임말을 입력하면 해당 메뉴를 바로 찾을 수 있습니다.<br>
                - 예시: <b>아이스 아메리카노</b> → <b>아아</b> 또는 <b>아이스</b>로 검색 가능<br>
                - 일치하는 커피가 없으면 안내 문구가 표시됩니다.<br>
                - 커피를 클릭하면 상세정보 카드가 열립니다.
            </div>

            <div class="help-page page3" style="display:none;">
                <b>커피 정보 확인</b><br>
                3) 선택한 커피의 <b>원두 소모량</b>, <b>경험치</b>, <b>골드</b> 정보를 한눈에 확인할 수 있습니다.<br>
                - 각 항목은 잔 수에 따라 자동 계산됩니다.<br>
                - 판매속도 또는 머신 수량을 수정하면 즉시 다시 계산됩니다.<br>
                - 화면 하단의 표에는 다양한 판매 조건에 따른 결과가 표시됩니다.
            </div>

            <div class="help-page page4" style="display:none;">
                <b>즐겨찾기</b><br>
                4) 커피 이름 오른쪽의 <b>별(★)</b>을 눌러 즐겨찾기에 등록하세요.<br>
                - 최대 5개까지 등록 가능하며, 목록은 상단에 따로 표시됩니다.<br>
                - 자주 계산하는 커피를 등록해두면 검색 없이 바로 선택할 수 있습니다.<br>
                - 즐겨찾기 항목의 <b>별(★)</b>을 다시 누르면 해제됩니다.
            </div>

            <div class="help-page page5" style="display:none;">
                <b>표 보기</b><br>
                5) 하단의 표에서는 선택한 커피를 기준으로<br>
                머신 수 × 커피 판매 속도에 따라 예상되는 결과를 계산합니다.<br>
                - 각 행은 판매 횟수별로 소요시간, 원두 소모량, 경험치, 골드 획득량을 보여줍니다.<br>
                - 판매 속도나 머신 수를 변경하면 표도 즉시 갱신됩니다.<br>
                - 마스터레벨이나 추가 경험치는 반영되지 않습니다.
            </div>
        </div>

        <div>
            <div id="helpDots" class="help-dots"></div>
        </div>

        <!-- ✅ 페이지네이션 -->
        <div id="helpPagination" class="help-pagination">
            <button id="prevHelpPage" class="help-btn">〈 이전</button>
            <button id="nextHelpPage" class="help-btn">다음 〉</button>
        </div>

        <div class="help-tip">다시 보고 싶을 땐, 화면 상단의 <b>?</b> 버튼을 눌러주세요.</div>
    </div>
</div>

<script type="module">
    import {menuData} from "../common/menuData.js";
    import {goToPage} from "../common/utils.js";

    const STORAGE_KEYS = {
        SPEED: "coffeeSpeed",
        COUNT: "coffeeMachineCount",
        SELECTED_COFFEE: "selectedCoffee",
        FAVORITES: "favoriteCoffees"
    };

    const $speedInput = $("#speedInput");
    const $countInput = $("#countInput");
    const $searchInput = $("#searchInput");
    const $resultList = $("#resultList");
    const $table = $("#coffeeTable");
    const $tbody = $("#coffeeTable tbody");
    const $coffeeInfo = $("#coffeeInfo");
    const $favoriteList = $("#favoriteList");
    const $favoriteItems = $("#favoriteItems");

    const MAX_SPEED = 10000;
    const MAX_COUNT = 25;
    const TIME = 3600;

    // ✅ 판매속도 / 머신수량 복원
    let savedSpeed = parseInt(localStorage.getItem(STORAGE_KEYS.SPEED)) || "1800";
    let savedCount = parseInt(localStorage.getItem(STORAGE_KEYS.COUNT)) || "4";

    if (savedSpeed > MAX_SPEED) {
        savedSpeed = MAX_SPEED;
        localStorage.setItem(STORAGE_KEYS.SPEED, savedSpeed);
    } else if (savedSpeed < 0) {
        savedSpeed = 0;
        localStorage.setItem(STORAGE_KEYS.SPEED, savedSpeed);
    }
    if (savedCount > MAX_COUNT) {
        savedCount = MAX_COUNT;
        localStorage.setItem(STORAGE_KEYS.COUNT, savedCount);
    } else if (savedCount < 0) {
        savedCount = 0;
        localStorage.setItem(STORAGE_KEYS.COUNT, savedCount);
    }

    if (savedSpeed) $speedInput.val(savedSpeed);
    if (savedCount) $countInput.val(savedCount);

    const savedCoffee = getSavedCoffee();

    // ✅ 세 가지 값이 모두 있을 때만 표 다시 표시
    if (savedSpeed && savedCount && savedCoffee) {
        showCoffeeInfo(savedCoffee);
        showCoffeeTable(savedCoffee);
    }

    renderFavorites();

    $speedInput.on("input", updateAndRefresh);
    $countInput.on("input", updateAndRefresh);

    $searchInput.on("input", () => {
        const keyword = $searchInput.val().trim();
        const mode = localStorage.getItem("coffeeBarista-mode") || "normal";

        if (mode === "filter") {
            // ✅ 서브페이지일 때
            renderSubTable();
        } else {
            // ✅ 메인페이지일 때
            renderCoffeeList(keyword);
        }
    });

    function updateAndRefresh() {
        let speed = Number($speedInput.val()) || 0;
        let count = Number($countInput.val()) || 0;

        // ✅ 상한값 초과 시 자동 교정
        if (speed > MAX_SPEED) {
            speed = MAX_SPEED;
            $speedInput.val(speed);
        } else if (speed < 0) {
            speed = 0;
            $speedInput.val(speed);
        }
        if (count > MAX_COUNT) {
            count = MAX_COUNT;
            $countInput.val(count);
        } else if (count < 0) {
            count = 0;
            $countInput.val(count);
        }

        // ✅ 로컬스토리지에도 정정된 값 저장
        localStorage.setItem(STORAGE_KEYS.SPEED, speed + "");
        localStorage.setItem(STORAGE_KEYS.COUNT, count + "");

        const selected = getSavedCoffee();
        if (selected) {
            showCoffeeInfo(selected);
            showCoffeeTable(selected);
        }
    }

    function renderCoffeeList(keyword = "") {
        $resultList.empty();
        if (!keyword) {
            $resultList.hide();
            return;
        }

        const lowerKeyword = keyword.trim().toLowerCase();

        const matched = menuData.filter(c => {
            const name = c.name.trim();
            const lowerName = name.toLowerCase();

            // ✅ 1) 이름에 직접 포함된 경우
            if (lowerName.includes(lowerKeyword)) return true;

            // ✅ 2) 단어별 첫 글자 조합으로 검색 (예: 아이스 아메리카노 → "아아")
            const words = name.split(/\s+/);
            const initials = words.map(w => w[0]).join("").toLowerCase();
            if (initials.includes(lowerKeyword)) return true;

            return false;
        });

        if (matched.length === 0) {
            $resultList.show().html("<div style='padding:10px; color:#999;'>빠진 커피가 있다면 문의 부탁드립니다.</div>");
            return;
        }

        const favorites = getFavorites();

        matched.forEach(c => {
            const isFav = favorites.some(f => f.name === c.name);
            const $item = $(`
            <div class="coffee-item">
                <span>${c.name}</span>
                <span class="star ${isFav ? 'active' : ''}">★</span>
            </div>
        `);

            $item.find(".star").on("click", (e) => {
                e.stopPropagation();
                toggleFavorite(c);
            });

            $item.on("click", () => selectCoffee(c));
            $resultList.append($item);
        });
        $resultList.show();
    }

    function selectCoffee(coffee) {
        localStorage.setItem(STORAGE_KEYS.SELECTED_COFFEE, JSON.stringify(coffee));
        $searchInput.val("");
        $resultList.empty().hide();
        showCoffeeInfo(coffee);
        showCoffeeTable(coffee);
        renderFavorites();
    }

    function getSavedCoffee() {
        const data = localStorage.getItem(STORAGE_KEYS.SELECTED_COFFEE);
        return data ? JSON.parse(data) : null;
    }

    // ✅ 커피 정보 표시
    function showCoffeeInfo(coffee) {
        $resultList.hide();

        const isFav = getFavorites().some(f => f.name === coffee.name);
        $coffeeInfo.show().html(`
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span class="coffee-name">${coffee.name}</span>
                    <span>( ${coffee.count.toLocaleString()}잔 )</span>
                </div>
                <span class="info-star ${isFav ? 'active' : ''}">★</span>
            </div>
            <p>
                <span class="coffee-stat">원두 : ${coffee.bean.toLocaleString()}</span>
                <span class="coffee-stat">경험치 : ${coffee.exp.toLocaleString()}</span>
                <span class="coffee-stat">골드 : ${coffee.gold.toLocaleString()}</span>
            </p>
        `);

        $coffeeInfo.find(".info-star").on("click", () => {
            toggleFavorite(coffee);
            showCoffeeInfo(coffee); // 상태 즉시 갱신
        });
    }

    // ✅ 표 표시
    function showCoffeeTable(coffee) {
        const speed = Number(localStorage.getItem(STORAGE_KEYS.SPEED));
        const end = (Number(localStorage.getItem(STORAGE_KEYS.COUNT)) || 0) * 4;
        $tbody.empty();
        $table.show();

        if (!speed) {
            $tbody.html(`<tr><td colspan="5" style="font-size:15px; padding:15px">커피판매 속도를 먼저 입력해주세요.</td></tr>`);
            return;
        } else if (!end) {
            $tbody.html(`<tr><td colspan="5" style="font-size:15px; padding:15px">커피머신 수량을 먼저 입력해주세요.</td></tr>`);
            return;
        }

        for (let i = end; i > 0; i--) {
            const totalSeconds = (coffee.count * i * 3600) / speed;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const timeStr = `${hours}시간 ${String(minutes).padStart(2, "0")}분 ${String(seconds).padStart(2, "0")}초`;

            const beanUse = (coffee.bean * i).toLocaleString();
            const expGain = (coffee.exp * i).toLocaleString();
            const goldGain = (coffee.gold * coffee.count * i).toLocaleString();

            $tbody.append(`
                <tr>
                    <td>${i}</td>
                    <td>${timeStr}</td>
                    <td>${beanUse}</td>
                    <td>${expGain}</td>
                    <td>${goldGain}</td>
                </tr>
            `);
        }
    }

    // ✅ 즐겨찾기 관련 함수
    function getFavorites() {
        const data = localStorage.getItem(STORAGE_KEYS.FAVORITES);
        return data ? JSON.parse(data) : [];
    }

    function saveFavorites(list) {
        localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(list));
    }

    function toggleFavorite(coffee) {
        let list = getFavorites();
        const exists = list.some(f => f.name === coffee.name);
        if (exists) {
            list = list.filter(f => f.name !== coffee.name);
        } else {
            if (list.length >= 5) {
                alert("즐겨찾기는 최대 5개까지만 가능합니다.");
                return;
            }
            list.push(coffee);
        }
        saveFavorites(list);
        renderFavorites();
        renderCoffeeList($searchInput.val().trim());
    }

    // ✅ 커피 이름 줄임말 생성
    function shortenName(name) {
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) return name; // 단어 하나면 그대로
        return parts.map(p => p[0]).join("");
    }

    function renderFavorites() {
        const list = getFavorites();
        if (list.length === 0) {
            $favoriteList.hide();
            return;
        }

        const selected = getSavedCoffee(); // ✅ 현재 선택된 커피
        const selectedName = selected ? selected.name : null;

        $favoriteItems.empty();
        list.forEach(c => {
            const shortName = shortenName(c.name);
            const $fav = $(`<div class="favorite-item" title="${c.name}">${shortName}</div>`);

            // ✅ 현재 선택된 커피면 active 스타일 추가
            if (c.name === selectedName) {
                $fav.addClass("active");
            }

            $fav.on("click", () => selectCoffee(c));
            $favoriteItems.append($fav);
        });
        $favoriteList.show();
    }

    const viewConfigMap = {
        expPerTime: {
            headers: ["시간 대비 경험치", "시간 대비 골드"],
            keys: ["expPerTime", "goldPerTime"],
            sort: ["expPerTime", "goldPerTime"]
        },
        goldPerTime: {
            headers: ["시간 대비 골드", "시간 대비 경험치"],
            keys: ["goldPerTime", "expPerTime"],
            sort: ["goldPerTime", "expPerTime"]
        },
        expPerBean: {
            headers: ["원두 대비 경험치", "원두 대비 골드"],
            keys: ["expPerBean", "goldPerBean"],
            sort: ["expPerBean", "goldPerBean"]
        },
        goldPerBean: {
            headers: ["원두 대비 골드", "원두 대비 경험치"],
            keys: ["goldPerBean", "expPerBean"],
            sort: ["goldPerBean", "expPerBean"]
        },
        masterPerTime: {
            headers: ["시간 대비 마레", "마레 획득량"],
            keys: ["masterPerTime", "masterBase"],
            sort: ["masterPerTime", "masterBase"]
        },
        masterBase: {
            headers: ["마레 획득량", "시간 대비 마레"],
            keys: ["masterBase", "masterPerTime"],
            sort: ["masterBase", "masterPerTime"]
        }
    };

    // ✅ 알림 모달 닫기 버튼
    $(document).on("click", ".baristaModeBtn", function () {
        const $area = $(".floating-btn-area");
        const $toggle = $(".floating-toggle");
        $area.addClass("collapsed");
        $toggle.show();
        $toggle.text("▲");
        toggleMode();
    });

    function toggleMode() {
        const current = localStorage.getItem("coffeeBarista-mode") || "normal";
        const next = current === "filter" ? "normal" : "filter";

        localStorage.setItem("coffeeBarista-mode", next);
        console.log(`next : ${next}`);
        applySavedMode();
    }

    function applySavedMode() {
        const savedMode = localStorage.getItem("coffeeBarista-mode") || "normal";
        console.log(`savedMode : ${savedMode}`);

        if (savedMode === "filter") {
            $(".mainPage").hide();
            $(".subPage").show();
            renderSubTable();
            $(".baristaModeBtn").text("일반모드");
        } else {
            $(".mainPage").show();
            $(".subPage").hide();
            $(".baristaModeBtn").text("필터모드");
        }
    }

    function calcEfficiency(menu) {
        const { gold, count, exp, bean } = menu;

        return {
            goldPerBean: ((gold * count) / bean) * 100,
            expPerBean: (exp / bean) * 100,
            goldPerTime: gold / (TIME / savedSpeed),
            expPerTime: (exp * (savedSpeed / count)) / TIME,
            masterPerTime: (bean * 0.03) * (savedSpeed / count) / TIME,
            masterBase: bean * 0.03
        };
    }

    const $subBody = $("#subTable tbody");
    const $sortSelect = $("#sortSelect");
    $sortSelect.on("change", renderSubTable);

    function renderSubTable() {
        const keyword = $searchInput.val()?.toLowerCase() || "";
        const selectKey = $sortSelect.val();
        const config = viewConfigMap[selectKey];

        // ✅ 헤더 재구성
        const $headerRow = $("#subHeaderRow");
        $headerRow.find("th:gt(1)").remove();

        config.headers.forEach(h => {
            $headerRow.append(`<th>${h}</th>`);
        });

        // ✅ 1. 전체 데이터 정렬 먼저
        const sortedAll = menuData
            .map(m => ({ ...m, e: calcEfficiency(m) }))
            .sort((a, b) => {
                for (const key of config.sort) {
                    if (b.e[key] !== a.e[key]) {
                        return b.e[key] - a.e[key];
                    }
                }
                return 0;
            })
            // ✅ 원래 순번 부여
            .map((m, index) => ({
                ...m,
                originIndex: index + 1
            }));

        // ✅ 2. 검색은 필터만
        const filtered = sortedAll.filter(m =>
            m.name.toLowerCase().includes(keyword)
        );

        $subBody.empty();

        filtered.forEach(m => {
            let valueCells = "";

            config.keys.forEach(k => {
                valueCells += `<td>${m.e[k].toFixed(2)}</td>`;
            });

            $subBody.append(`
            <tr>
                <td>${m.originIndex}</td>
                <td>${m.name}</td>
                ${valueCells}
            </tr>
        `);
        });
    }

    function waitForBaristaToggleBtn() {
        const observer = new MutationObserver(() => {
            const $btn = $(".baristaModeBtn");
            if ($btn.length) {
                applySavedMode();   // ✅ 버튼 생성 후 실행
                observer.disconnect(); // ✅ 한 번만 실행
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // ✅ DOM 준비되면 감시 시작
    $(document).ready(() => {
        waitForBaristaToggleBtn();
    });
</script>
<script src="../modules/helpModal.js" type="module" defer></script>
<script src="../modules/menuToggle.js" type="module" defer></script>
</body>
</html>