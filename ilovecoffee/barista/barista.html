<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>바리스타</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard 웹폰트 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #f4f3f9;
            margin: 0;
            color: #333;
        }

        /* 상단 헤더 */
        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        /* 입력 / 검색 영역 */
        /* ===== 입력/검색 영역 ===== */
        #controlBar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 20px;
        }

        .input-groups {
            display: flex;

            gap: 8px;
        }

        /* 개별 입력 카드 */
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 10px 14px;
            border: 1px solid #e2dff7;
            transition: 0.2s ease;
            gap: 8px;
            width: 50%;
        }

        .input-group:hover {
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }

        .input-group span {
            color: #5a4398;
            font-weight: 600;
            flex-shrink: 0;
        }

        .input-group input {
            border: none;
            outline: none;
            text-align: center;
            width: 50%;
            padding: 6px 8px;
            border-radius: 6px;
            background: #f6f4fc;
            color: #333;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .input-group input:focus {
            background: #fff;
            border: 1px solid #5a4398;
            box-shadow: 0 0 0 2px rgba(90, 67, 152, 0.15);
        }

        /* 검색 input */
        #searchInput {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 16px;
            font-weight: 600;
            background: #fff;
            transition: 0.2s;
            width: 100%;
        }

        #searchInput:focus {
            border-color: #5a4398;
            box-shadow: 0 0 0 2px rgba(90,67,152,0.15);
        }

        /* 검색 결과 리스트 */
        .coffee-list {
            width: calc(100% - 40px);
            margin: 10px 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .coffee-item {
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .coffee-item:last-child {
            border-bottom: none;
        }

        .coffee-item:hover {
            background: #f0ecff;
        }

        /* 커피 정보 카드 */
        #coffeeInfo {
            width: calc(100% - 40px);
            margin: 10px 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 15px 20px 5px 20px;
            display: none;
        }

        #coffeeInfo .coffee-name {
            color: #5a4398;
            font-size: 18px;
            font-weight: 600;
        }

        #coffeeInfo .coffee-stat {
            background: #5a4398;
            color: #fff;
            border-radius: 10px;
            padding: 8px 12px;
        }

        #coffeeInfo p {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 12px;
        }

        /* 표 영역 */
        #coffeeTable {
            width: calc(100% - 40px);
            margin: 10px 20px;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #coffeeTable th, #coffeeTable td {
            border: 1px solid #e0dff2;
            padding: 4px;
            text-align: center;
            font-size: 10px;
        }

        #coffeeTable th {
            background: #f6f4fc;
            color: #5a4398;
            font-weight: 600;
        }

        /* 교차 배경색 (줄무늬 효과) */
        #coffeeTable tbody tr:nth-child(odd) {
            background-color: #ffffff; /* 흰색 */
        }

        #coffeeTable tbody tr:nth-child(even) {
            background-color: #faf9ff; /* 아주 옅은 보라빛 */
        }

        #loading {
            text-align: center;
            color: #5a4398;
            font-weight: 600;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>

<div class="header-bar">
    <h1>바리스타</h1>
    <button id="backBtn">뒤로가기</button>
</div>

<div id="controlBar">
    <div class="input-groups">
        <div class="input-group">
            <span>커피판매</span>
            <input type="number" id="speedInput" placeholder="속도" min="1" max="10000">
        </div>
        <div class="input-group">
            <span>커피머신</span>
            <input type="number" id="countInput" placeholder="수량" min="1" max="20">
        </div>
    </div>
    <div>
        <input type="text" id="searchInput" placeholder="커피 이름 검색">
    </div>
</div>

<div id="resultList" class="coffee-list">
    <div style='padding:10px; color:#999;'>빠진 커피가 있다면 문의 부탁드립니다.</div>
</div>

<!-- ✅ 커피 정보 카드 -->
<div id="coffeeInfo"></div>

<table id="coffeeTable" style="display:none;">
    <thead>
    <tr>
        <th>갯수</th>
        <th>소요시간</th>
        <th>원두<br>소모량</th>
        <th>획득<br>경험치</th>
        <th>획득<br>골드</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="loading">불러오는 중...</div>

<script type="module">
    import { menuData } from "../common/menuData.js";

    const STORAGE_KEYS = {
        SPEED: "coffeeSpeed",
        COUNT: "coffeeMachineCount",
        SELECTED_COFFEE: "selectedCoffee"
    };

    const $speedInput = $("#speedInput");
    const $countInput = $("#countInput");
    const $searchInput = $("#searchInput");
    const $resultList = $("#resultList");
    const $table = $("#coffeeTable");
    const $tbody = $("#coffeeTable tbody");
    const $coffeeInfo = $("#coffeeInfo");

    // ✅ 판매속도 복원
    const savedSpeed = localStorage.getItem(STORAGE_KEYS.SPEED);
    if (savedSpeed) $speedInput.val(savedSpeed);

    const savedCount = localStorage.getItem(STORAGE_KEYS.COUNT);
    if (savedCount) $countInput.val(savedCount);

    const savedCoffee = getSavedCoffee();

    // ✅ 세 가지 값이 모두 있을 때만 표 다시 표시
    if (savedSpeed && savedCount && savedCoffee) {
        showCoffeeInfo(savedCoffee);
        showCoffeeTable(savedCoffee);
    }

    $speedInput.on("input", () => {
        const max = 10000;
        let val = Number($speedInput.val());
        if (val > max) {
            $speedInput.val(max);
        }

        localStorage.setItem(STORAGE_KEYS.SPEED, $speedInput.val());
        const selected = getSavedCoffee();
        if (selected) {
            showCoffeeInfo(selected);
            showCoffeeTable(selected);
        }
    });

    $countInput.on("input", () => {
        const max = 25;
        let val = Number($countInput.val());
        if (val > max) {
            $countInput.val(max);
        }

        localStorage.setItem(STORAGE_KEYS.COUNT, $countInput.val());
        const selected = getSavedCoffee();
        if (selected) {
            showCoffeeInfo(selected);
            showCoffeeTable(selected);
        }
    });

    function goToPage() {
        const basePath = window.location.pathname.split("/barista")[0];
        location.href = `${basePath}/levelup/levelup.html`;
    }

    // ✅ 검색 기능
    $searchInput.on("input", () => {
        const keyword = $searchInput.val().trim();
        renderCoffeeList(keyword);
    });

    function renderCoffeeList(keyword = "") {
        $resultList.empty();
        if (!keyword) {
            $resultList.hide();
            return;
        }

        const matched = menuData.filter(c => c.name.includes(keyword));
        if (matched.length === 0) {
            $resultList.show().html("<div style='padding:10px; color:#999;'>빠진 커피가 있다면 문의 부탁드립니다.</div>");
            return;
        }

        matched.forEach(c => {
            const $item = $(`<div class="coffee-item">${c.name}</div>`);
            $item.on("click", () => selectCoffee(c));
            $resultList.append($item);
        });
        $resultList.show();
    }

    function selectCoffee(coffee) {
        localStorage.setItem(STORAGE_KEYS.SELECTED_COFFEE, JSON.stringify(coffee));
        $searchInput.val("");
        $resultList.empty().hide();
        showCoffeeInfo(coffee);
        showCoffeeTable(coffee);
    }

    function getSavedCoffee() {
        const data = localStorage.getItem(STORAGE_KEYS.SELECTED_COFFEE);
        return data ? JSON.parse(data) : null;
    }

    // ✅ 커피 정보 표시
    function showCoffeeInfo(coffee) {
        $resultList.hide();

        $coffeeInfo.show().html(`
            <div>
                <span class="coffee-name">${coffee.name}</span>
                <span>( ${coffee.count.toLocaleString()}잔 )</span>
            </div>
            <p>
                <span class="coffee-stat">원두 : ${coffee.bean.toLocaleString()}</span>
                <span class="coffee-stat">경험치 : ${coffee.exp.toLocaleString()}</span>
                <span class="coffee-stat">골드 : ${coffee.gold.toLocaleString()}</span>
            </p>
        `);
    }

    // ✅ 표 표시
    function showCoffeeTable(coffee) {
        const speed = Number(localStorage.getItem(STORAGE_KEYS.SPEED));
        const end = (Number(localStorage.getItem(STORAGE_KEYS.COUNT)) || 0) * 4;
        $tbody.empty();
        $table.show();

        if (!speed) {
            $tbody.append(`
                <tr>
                    <td colspan="5" style="font-size: 15px; padding: 15px">커피판매 속도를 먼저 입력해주세요.</td>
                </tr>
            `);
            return;
        } else if (!end) {
            $tbody.append(`
                <tr>
                    <td colspan="5" style="font-size: 15px; padding: 15px">커피머신 수량을 먼저 입력해주세요.</td>
                </tr>
            `);
            return;

        }

        for (let i = end; i > 0; i--) {
            const totalSeconds = (coffee.count * i * 3600) / speed; // 총 초 단위 계산
            let timeStr = "";

            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            // ✅ 10 미만이면 0붙이기
            const mm = String(minutes).padStart(2, "0");
            const ss = String(seconds).padStart(2, "0");


            timeStr = `${hours}시간 ${mm}분 ${ss}초`;

            const beanUse = (coffee.bean * i).toLocaleString();
            const expGain = (coffee.exp * i).toLocaleString();
            const goldGain = (coffee.gold * coffee.count * i).toLocaleString();

            $tbody.append(`
                <tr>
                    <td>${i}</td>
                    <td>${timeStr}</td>
                    <td>${beanUse}</td>
                    <td>${expGain}</td>
                    <td>${goldGain}</td>
                </tr>
            `);
        }
    }

    // ✅ 뒤로가기
    $("#backBtn").on("click", () => goToPage());
</script>
</body>
</html>