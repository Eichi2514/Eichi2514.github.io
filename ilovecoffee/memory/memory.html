<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¶”ì–µìˆ˜ì§‘</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <link rel="stylesheet" href="../css/theme.css">
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #fff;
            margin: 0;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ===== ëª¨ë‹¬ ê³µí†µ ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* ===== ì»¤ìŠ¤í…€ ì•Œë¦¼/ì»¨íŒ ëª¨ë‹¬ ìµœìƒë‹¨ ê³ ì • ===== */
        #customAlert,
        #customConfirm {
            z-index: 100; /* ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ë³´ë‹¤ ì• */
        }

        #customAlert .alert-box,
        #customConfirm .alert-box {
            position: relative;
            z-index: 101; /* ë‚´ë¶€ ì½˜í…ì¸ ë„ ìµœìƒë‹¨ */
        }

        #customAlert .alert-box, #customConfirm .alert-box {
            background: #ffbcae;
            padding: 25px 25px 20px;
            border-radius: 12px;
            width: 360px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: left;
            position: relative;
        }

        #customAlert .alert-content, #customConfirm .alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #customAlert .alert-text, #customConfirm .alert-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            flex: 1;
            padding-right: 10px;

            white-space: pre-line; /* \n ì¤„ë°”ê¿ˆ ì¸ì‹ */
            word-break: keep-all; /* ë‹¨ì–´ ê¸°ì¤€ ì¤„ë°”ê¿ˆ */
            overflow-wrap: break-word; /* ê¸´ ë‹¨ì–´ ê°•ì œ ì¤„ë°”ê¿ˆ */
        }


        #customAlert .alert-img, #customConfirm .alert-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        #alertConfirmBtn {
            display: block;
            width: 100%;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            padding: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }

        /* âœ… ìºë¦­í„° ì„ íƒ ì˜ì—­ */
        .character-tabs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
            padding: 0 24px;
        }

        .character-tab {
            width: calc((100% / 3)); /* ë²„íŠ¼ í¬ê¸° */
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            color: #5a4398;
            border-radius: 8px;
            padding: 5px 0;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            overflow: hidden; /* âœ… ì´ë¯¸ì§€ê°€ ë²„íŠ¼ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜¤ì§€ ì•Šê²Œ */
        }

        .character-tab span {
            position: relative;
            z-index: 2; /* âœ… ê¸€ì ì•ìœ¼ë¡œ */
            display: block;
            width: calc(100% - 35px);
            text-align: center;
            margin-left: auto;
            margin-right: 5px;
        }

        .characterImg {
            width: 20px; /* ë²„íŠ¼ í¬ê¸° */
            height: 20px;
            border-radius: 50%; /* ì™„ì „í•œ ì›í˜• */
            object-fit: cover; /* ì´ë¯¸ì§€ ê½‰ ì±„ìš°ê¸° */
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0; /* âœ… ê¸€ìë³´ë‹¤ ì•„ë˜ */
        }

        .character-tab.active {
            background: #5a4398;
            color: #fff;
        }

        .level-input {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 0 24px;
            margin: 20px 0 8px;
            width: 100%;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.25s ease;
        }

        .toggle-switch::after {
            content: "";
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.25s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* âœ… ë‹¤í¬ëª¨ë“œìš© ë­í‚¹ í† ê¸€ ìŠ¤ìœ„ì¹˜ ë³´ì • */
        @media (prefers-color-scheme: dark) {
            .toggle-switch {
                background: #f2f2f2; /* ê¸°ë³¸ OFF ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            }
        }

        /* ON ìƒíƒœ */
        .toggle-switch.on {
            background: #5a4398;
        }

        .toggle-switch.on::after {
            left: 26px;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1 1 auto;
            min-width: 0;
            padding: 0 16px;
        }

        #searchInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        #searchBtn {
            flex-shrink: 0;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        /* âœ… 2ì°¨ ì¹´í…Œê³ ë¦¬ ëª©ë¡ */
        .subcategories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 16px;
            word-break: keep-all;
        }

        .subcategory {
            position: relative;
            background: #f6f4fc;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 14px;
            width: calc(50% - 4px);
            height: 54px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 15px;
            color: #333;
            cursor: pointer;
        }

        /* âœ… ì„œë¸Œì¹´í…Œê³ ë¦¬ ì´ë¦„ */
        .sub-name {
            font-size: 15px;
            font-weight: 600;
        }

        /* âœ… ì§„í–‰ë¥  - ì˜¤ë¥¸ìª½ ìƒë‹¨ */
        .sub-progress {
            position: absolute;
            bottom: 3px;
            right: 8px;
            font-size: 12px;
            color: #888;
            font-weight: 600;
        }

        /* âœ… ëª¨ë“  ì•„ì´í…œ ìˆ˜ì§‘ ì™„ë£Œëœ ì„œë¸Œì¹´í…Œê³ ë¦¬ */
        .subcategory.collected {
            position: relative;
            background: #f0eaff; /* ë°ì€ ë³´ë¼ìƒ‰ ê°•ì¡° */
            border-color: #b7a8f0;
            color: #5a4398;
            font-weight: 700;
        }

        /* âœ… ì˜¤ë¥¸ìª½ ìœ„ì— ì²´í¬ ì•„ì´ì½˜ ì´ë¯¸ì§€ í‘œì‹œ */
        .subcategory.collected::after {
            content: "";
            position: absolute;
            bottom: 6px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: url("../../favicon/MyCharacter2.png") no-repeat center center;
            background-size: contain;
        }

        .subcategory.active {
            background: #5a4398;
            color: #fff;
            font-weight: 600;
            flex-grow: 1;
        }

        /* ì„ íƒëœ ì„œë¸Œì¹´í…Œê³ ë¦¬ + X ë²„íŠ¼ì„ ë‚˜ë€íˆ ì •ë ¬ */
        .selected-subcategory {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .close-subcategory {
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            color: #5a4398;
            border-radius: 8px;
            font-weight: 700;
            padding: 8px 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        /* âœ… ë³´ìƒ + ì•„ì´í…œ ì¹´ë“œ */
        .reward-section {
            padding: 0 16px 16px;
        }

        .reward-box {
            background: #fff7d6;
            border: 2px solid #f1e1a5; /* âœ… ë°ì€ ë…¸ë‘ í…Œë‘ë¦¬ */
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
            color: #5a4398;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* ì‚´ì§ ì…ì²´ê° */
        }

        .item-list {
            display: flex;
            flex-wrap: wrap; /* âœ… ì—¬ëŸ¬ ì¤„ í—ˆìš© */
            gap: 10px;
            justify-content: space-between; /* âœ… ì¢Œìš° ì—¬ë°± ê· ë“± */
        }

        .item-card {
            background: #fff;
            border: 1.5px solid #e5e3f0; /* âœ… ì€ì€í•œ ë³´ë¼ë¹› í…Œë‘ë¦¬ */
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: calc(50% - 5px);
            box-sizing: border-box;
            transition: transform 0.1s ease, border-color 0.2s ease;
        }

        .item-name {
            word-break: keep-all;
            font-weight: 600;
            color: #333;
        }

        .item-detail {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            line-height: 1.5;
        }

        @media (max-width: 480px) {
            .subcategory {
                font-size: 14px;
            }

            .item-card {
                padding: 8px 10px;
            }
        }

        /* âœ… ê²€ìƒ‰ ê²°ê³¼ ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: 85%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .result-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .result-item {
            background: #f6f4fc;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .result-item-name {
            font-size: 13px;
            color: #555;
            margin-top: 4px;
        }

        #closeSearchModal {
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            margin-top: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* âœ… ìˆ˜ì§‘ ì™„ë£Œ ì•„ì´í…œ ì˜¤ë²„ë ˆì´ í‘œì‹œ */
        .item-card {
            position: relative; /* ì˜¤ë²„ë ˆì´ ê¸°ì¤€ */
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë¶€ë¶„ ìˆ¨ê¹€ */
        }

        .item-card.collected::after {
            content: "";
            position: absolute;
            inset: 0; /* ë°°ê²½ ì „ì²´ ë®ê¸° */
            background-color: rgba(90, 67, 152, 0.15);
            background-image: url("../../favicon/MyCharacter2.png");
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 54px 54px; /* âœ… ì´ë¯¸ì§€ í¬ê¸° ê³ ì • */
            border-radius: 10px;
            pointer-events: none; /* í´ë¦­ ë°©í•´ ì•ˆ í•¨ */
        }

        /* ===== í•„í„°ëª¨ë“œ í•„í„° ë° ì •ë ¬ ì˜ì—­ ===== */
        .filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 0 24px;
            width: 100%;
            box-sizing: border-box;
        }

        /* âœ… í•­ìƒ 3ë“±ë¶„ ê³ ì • (í™”ë©´ í¬ê¸°ì™€ ë¬´ê´€í•˜ê²Œ) */
        .filter-select {
            flex: 0 0 33.3333%;
            max-width: 33.3333%;
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            color: #5a4398;
            border-radius: 8px;
            padding: 4px 2px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* âœ… ëª¨ë°”ì¼ì—ì„œë„ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
        @media (max-width: 480px) {
            .filter-container {
                flex-wrap: nowrap;
            }

            .filter-select {
                flex: 0 0 33.3333%;
                max-width: 33.3333%;
            }
        }

        /* ===== ë²”ë¡€ ===== */
        #colorGuide {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: right;
            font-size: 14px;
            color: #555;
            padding: 0 24px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* ===== ì•„ì´í…œ í…Œì´ë¸” ===== */
        #tableSection {
            padding: 0 16px;
        }

        .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .item-table td {
            border: 1px solid #ddd;
            text-align: left;
            word-break: keep-all;
            padding: 4px 8px;
        }

        /* âœ… í•„í„°ëª¨ë“œ í‘œ - íšë“ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .collected-item td {
            position: relative; /* ::after ê¸°ì¤€ */
            background: #f0eaff !important;
            color: #5a4398;
            font-weight: 700;
        }

        /* âœ… íšë“ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ */
        .collected-item td::before {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 2px;
            vertical-align: middle;
            background: url("../../favicon/MyCharacter2.png") no-repeat center center;
            background-size: contain;
            opacity: 0.9;
        }

        /* âœ… íšë“ëœ ì•„ì´í…œì˜ ë‘ ë²ˆì§¸ ì¤„(tag-text)ë„ ê°™ì€ ë°°ê²½ìƒ‰ìœ¼ë¡œ */
        .collected-item + .tag-text td {
            background: #f0eaff !important;
            color: #5a4398;
            font-weight: 700;
        }

        /* âœ… ìŠ¤í‹°ì»¤(íƒœê·¸) ìŠ¤íƒ€ì¼ */
        .tag {
            display: inline-block;
            padding: 2px 2px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            line-height: 1.4;
            border: 1px solid transparent;
        }

        /* âœ… ì¢…ë¥˜ë³„ ìƒ‰ìƒ */
        .tag-theme {
            background: #f3eaff;
            color: #5a4398;
            border-color: #c9b8f8;
        }

        .tag-attr {
            background: #e6f9f3;
            color: #2c7a55;
            border-color: #9be0c3;
        }

        .tag-price {
            background: #fff7d6;
            color: #8c7000;
            border-color: #f1e1a5;
        }

        .tag-color {
            background: #e7f0ff;
            color: #205295;
            border-color: #a8c7ff;
        }

        .tag-machine {
            background: #fff0e6;
            color: #a44d00;
            border-color: #ffd0a8;
        }

        .tag-text {
            color: #555;
            border-color: #ddd;
        }

        /* âœ… ì•„ì´í…œëª… */
        .item-name {
            font-weight: 600;
        }

        /* âœ… ì²«ì¤„ê³¼ ë‘ë²ˆì§¸ì¤„ì„ í•˜ë‚˜ì²˜ëŸ¼ ë¶™ì´ê¸° */
        .item-table tr.tag-text td {
            border-top: none; /* ìœ—ì¤„ ê²½ê³„ ì œê±° */
        }

        .item-table tr td {
            border-bottom: none; /* ì²«ì¤„ì˜ ì•„ë«ì„  ì œê±° */
        }

        /* âœ… ë§ˆì§€ë§‰ ì•„ì´í…œë§Œ ì•„ë˜ìª½ í…Œë‘ë¦¬ ë‚¨ê¸°ê¸° */
        .item-table tr:last-child td {
            border-bottom: 1px solid #ddd;
        }

    </style>
    <link rel="stylesheet" href="../modules/helpModal.css"/>
    <link rel="stylesheet" href="../modules/menuToggle.css"/>
</head>
<body>

<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>ì¶”ì–µìˆ˜ì§‘</h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- âœ… ìƒë‹¨ ìºë¦­í„° -->
<div class="character-tabs mainPage" id="characterTabs"></div>

<!-- âœ… í•„í„°ëª¨ë“œ : ìƒë‹¨ í•„í„° ë° ì •ë ¬ -->
<div class="subPage" id="filterSection" style="display: none;"></div>

<div class="level-input">
    <div style="display:flex; align-items:center; gap:10px;">
            <span id="nicknameDisplay"
                  style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
        <span id="currentLevelDisplay"
              style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
    </div>
    <div id="memoryRoomToggle" class="toggle-switch"></div>
</div>

<div class="search-box mainPage">
    <input type="text" id="searchInput" placeholder="ê²€ìƒ‰">
    <button id="searchBtn">ê²€ìƒ‰</button>
</div>

<!-- âœ… ì¤‘ê°„ 2ì°¨ ì¹´í…Œê³ ë¦¬ -->
<div class="subcategories mainPage" id="subcategoryList"></div>

<!-- âœ… í•˜ë‹¨ ë³´ìƒ ë° ì•„ì´í…œ -->
<div class="reward-section mainPage" id="rewardSection"></div>

<!-- âœ… í•„í„°ëª¨ë“œ : ë²”ë¡€ -->
<div class="subPage" id="colorGuide" style="display: none;">
    <div class="legend-item">
        <span class="color-box tag-attr"></span>ì˜µì…˜
    </div>
    <div class="legend-item">
        <span class="color-box tag-color"></span>ìƒ‰ìƒ
    </div>
    <div class="legend-item">
        <span class="color-box tag-theme"></span>í…Œë§ˆ
    </div>
    <div class="legend-item">
        <span class="color-box tag-machine"></span>ë¨¸ì‹ 
    </div>
    <div class="legend-item">
        <span class="color-box tag-text"></span>ê¸°íƒ€
    </div>
</div>

<!-- âœ… í•„í„°ëª¨ë“œ : ì•„ì´í…œ í‘œ -->
<div class="subPage" id="tableSection" style="display: none;"></div>

<!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
<div id="customAlert" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <button id="alertConfirmBtn">í™•ì¸</button>
    </div>
</div>

<!-- âœ… ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="helpModal" class="login-overlay" style="display:none;">
    <div class="login-modal help-modal">
        <button id="closeHelpModal" class="closeBtn">âœ•</button>
        <h2 class="help-title">ê·¸ëŸ´ìˆ˜ì´ì¹˜ ì‚¬ìš© ê°€ì´ë“œ</h2>

        <div id="helpPages" class="help-content">
            <div class="help-page page1">
                <b>ì¶”ì–µìˆ˜ì§‘</b><br>
                1) ìºë¦­í„°ë³„ ì•„ì´í…œì„ ëª¨ì•„ ê¸°ë¡í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.<br>
                - ê° ìºë¦­í„° íƒ­ì„ ëˆŒëŸ¬ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ì•„ì´í…œì„ ëˆ„ë¥´ë©´ ìˆ˜ì§‘ ìƒíƒœê°€ ì €ì¥ë˜ë©°, ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œë©ë‹ˆë‹¤.<br>
                - ëª¨ë“  ì•„ì´í…œì„ ëª¨ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ê°€ <b>ë³´ë¼ìƒ‰</b>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="help-page page2" style="display:none;">
                <b>ë³´ìƒ ë° ì„œë¸Œì¹´í…Œê³ ë¦¬</b><br>
                2) ê° ì¹´í…Œê³ ë¦¬ëŠ” ì—¬ëŸ¬ ê°œì˜ <b>ì„œë¸Œì¹´í…Œê³ ë¦¬</b>ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
                - ë³´ìƒì€ ìƒë‹¨ì˜ ğŸ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.<br>
                - ì§„í–‰ë¥ (ì˜ˆ: 3/5)ì€ ìˆ˜ì§‘í•œ ì•„ì´í…œ ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>
                - ì „ë¶€ ëª¨ìœ¼ë©´ ë³´ìƒ ì¹´í…Œê³ ë¦¬ì— <b>ì´ì¹˜</b>ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="help-page page3" style="display:none;">
                <b>ê²€ìƒ‰ ê¸°ëŠ¥</b><br>
                3) ìƒë‹¨ ê²€ìƒ‰ì°½ì— ì•„ì´í…œ ì´ë¦„ì´ë‚˜ ë³´ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ë©´<br>
                í•´ë‹¹ ë‹¨ì–´ê°€ í¬í•¨ëœ ê²°ê³¼ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ê²€ìƒ‰ ê²°ê³¼ë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™í•©ë‹ˆë‹¤.<br>
                - ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° <b>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”...</b> ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="help-page page4" style="display:none;">
                <b>í•„í„°ëª¨ë“œ</b><br>
                4) ìš°ì¸¡ í•˜ë‹¨ì˜ <b>í•„í„°ëª¨ë“œ</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´<br>
                ëª¨ë“  ì•„ì´í…œì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” í‘œë¡œ ì „í™˜ë©ë‹ˆë‹¤.<br>
                - <b>í…Œë§ˆ / ì˜µì…˜ / ê°€ê²©ìˆœ</b>ìœ¼ë¡œ í•„í„°ë§ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                - ì•„ì´í…œì„ ëˆ„ë¥´ë©´ ìˆ˜ì§‘ ìƒíƒœê°€ ì €ì¥ë˜ê³ , ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œë©ë‹ˆë‹¤.<br>
                - ìˆ˜ì§‘ëœ ì•„ì´í…œì€ <b>ë³´ë¼ìƒ‰ ë°°ê²½</b>ê³¼ <b>ì´ì¹˜</b>ë§ˆí¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
                - ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¼ë°˜ ëª¨ë“œë¡œ ëŒì•„ì˜µë‹ˆë‹¤.
            </div>

            <div class="help-page page5" style="display:none;">
                <b>ë©”ëª¨ë¦¬ë£¸ ê³µê°œ</b><br>
                5) ìƒë‹¨ì˜ ìŠ¤ìœ„ì¹˜ë¥¼ ì¼œë©´ ë‚´ <b>ë©”ëª¨ë¦¬ë£¸</b>ì´ ê³µê°œë©ë‹ˆë‹¤.<br>
                - ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ìˆ˜ì§‘ í˜„í™©ì„ ê³µìœ  í• ìˆ˜ìˆìŠµë‹ˆë‹¤.<br>
                - ë„ë©´ ì¦‰ì‹œ ë¹„ê³µê°œë¡œ ì „í™˜ë©ë‹ˆë‹¤.<br><br>
                <b>ë§ì´ë§ì´ ì¼œì£¼ì„¸ìš” ã…ã……ã…...</b>
            </div>
        </div>

        <div>
            <div id="helpDots" class="help-dots"></div>
        </div>

        <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="helpPagination" class="help-pagination">
            <button id="prevHelpPage" class="help-btn">ã€ˆ ì´ì „</button>
            <button id="nextHelpPage" class="help-btn">ë‹¤ìŒ ã€‰</button>
        </div>

        <div class="help-tip">ë‹¤ì‹œ ë³´ê³  ì‹¶ì„ ë•, í™”ë©´ ìƒë‹¨ì˜ <b>?</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase, ref, get, update, remove
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    import {memoryData} from "../common/memoryData.js";
    import {goToPage, showAlert, closeAlert, getActiveNickname} from "../common/utils.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey", authDomain: ".env/authDomain", databaseURL: "https://test-948ba-default-rtdb.firebaseio.com", projectId: ".env/projectId", storageBucket: ".env/storageBucket", messagingSenderId: ".env/messagingSenderId", appId: ".env/appId"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // âœ… ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", "#alertConfirmBtn", function () {
        closeAlert();
    });

    const $nicknameDisplay = $("#nicknameDisplay");
    const $currentLevelDisplay = $("#currentLevelDisplay");
    let activeNickname = null;
    let collected = {};

    $(async function () {
        activeNickname = getActiveNickname();
        if (!activeNickname) {
            goToPage();
            return;
        }

        const memoryRef = ref(db, `coffeeMemory/${activeNickname}`);
        const snap = await get(memoryRef);
        collected = snap.val() || {};

        // âœ… í•„ìš”í•œ í•„ë“œë§Œ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
        Promise.all([
            get(ref(db, `coffeeUsers/${activeNickname}/profileImg`)),
            get(ref(db, `coffeeUsers/${activeNickname}/level`)),
            get(ref(db, `coffeeUsers/${activeNickname}/memoryRoomPublic`))
        ])
            .then(([profileSnap, levelSnap, memorySnap, rankingSnap, adminSnap]) => {
                const profileNum = profileSnap.exists() ? profileSnap.val() : 1;
                const level = levelSnap.exists() ? levelSnap.val() : 1;
                const memoryRoomPublic = memorySnap.exists() ? memorySnap.val() : false;

                // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ (ë‹‰ë„¤ì„ ì•)
                const profileSrc = `../image/profile${profileNum}.jpg`;
                if ($nicknameDisplay.prev(".profile-img").length > 0) {
                    $nicknameDisplay.prev(".profile-img").attr("src", profileSrc);
                } else {
                    $("<img>")
                        .attr("src", profileSrc)
                        .attr("alt", "í”„ë¡œí•„ ì´ë¯¸ì§€")
                        .addClass("profile-img")
                        .css({
                            width: "28px", height: "28px", borderRadius: "5px", objectFit: "cover"
                        })
                        .insertBefore("#nicknameDisplay");
                }

                // âœ… ë‹‰ë„¤ì„ / ë ˆë²¨ í‘œì‹œ
                $nicknameDisplay.text(activeNickname);
                $currentLevelDisplay.text(level);

                // âœ… í† ê¸€ ì´ˆê¸°ìƒíƒœ ë°˜ì˜
                const $toggle = $("#memoryRoomToggle");
                if (memoryRoomPublic) {
                    $toggle.addClass("on").css("background", "#5a4398");
                } else {
                    $toggle.removeClass("on").css("background", "#ccc");
                }

                // âœ… ìºë¦­í„° íƒ­ ìƒì„±
                memoryData.forEach((cat, i) => {
                    const imgSrc = `../image/profile${i + 17}.jpg`;
                    $("#characterTabs").append(`
                        <div class="character-tab ${i === 0 ? 'active' : ''}" data-cat="${cat.category1}">
                            <img src="${imgSrc}" alt="${cat.category1}" class="characterImg">
                            <span>${cat.category1}</span>
                        </div>
                    `);
                });

                // âœ… ì²« ë²ˆì§¸ ìºë¦­í„° í‘œì‹œ
                renderSubcategories(memoryData[0]);
            })
            .catch(err => {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", err);
                localStorage.removeItem("coffee-nickname");
                goToPage();
            });

        // ìºë¦­í„° í´ë¦­
        $(document).on("click", ".character-tab", function () {
            $(".character-tab").removeClass("active");
            $(this).addClass("active");
            const selected = $(this).data("cat");
            const category = memoryData.find(c => c.category1 === selected);
            renderSubcategories(category);
            $("#rewardSection").empty();
        });

        // 2ì°¨ ì¹´í…Œê³ ë¦¬ í´ë¦­
        $(document).on("click", ".subcategory", function () {
            const cat = $(this).data("cat");
            const sub = $(this).data("sub");
            const category = memoryData.find(c => c.category1 === cat);
            const subData = category.categories2.find(s => s.name === sub);

            renderReward(subData);
            renderSelectedSubcategory(cat, sub); // âœ… ì„ íƒí•œ ê²ƒë§Œ í‘œì‹œ
        });

        // X ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ì‹œ ì „ì²´ ëª©ë¡ìœ¼ë¡œ ë³µê·€
        $(document).on("click", ".close-subcategory", function () {
            const activeCat = $(".character-tab.active").data("cat");
            const category = memoryData.find(c => c.category1 === activeCat);
            renderSubcategories(category); // âœ… ë‹¤ì‹œ ì „ì²´ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
            $("#rewardSection").empty();    // âœ… ë³´ìƒì˜ì—­ ì´ˆê¸°í™”
        });

        // âœ… ë§ˆì§€ë§‰ ëª¨ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedMode = localStorage.getItem("coffeeMemory-mode") || "normal";
        if (savedMode === "filter") {
            $(".mainPage").hide();
            $(".subPage").show();
            $(".advancedSettingBtn").text("ì¼ë°˜ëª¨ë“œ");
            renderAdvancedSettings();
        } else {
            $(".mainPage").show();
            $(".subPage").hide();
            $(".advancedSettingBtn").text("í•„í„°ëª¨ë“œ");
        }
    });

    // âœ… ìˆ˜ì§‘ëœ ì•„ì´í…œ ì´ˆê¸° í‘œì‹œ
    async function markCollectedItems(activeNickname) {
        try {
            // í™”ë©´ì— ë Œë”ë§ëœ item-card ì¤‘ í•´ë‹¹ IDê°€ trueë©´ í‘œì‹œ
            $(".item-card").each(function () {
                const itemId = $(this).data("id");
                if (collected[itemId]) {
                    $(this).addClass("collected");
                }
            });
        } catch (err) {
            console.error("ìˆ˜ì§‘ëœ ì•„ì´í…œ í‘œì‹œ ì˜¤ë¥˜:", err);
        }
    }

    async function renderSubcategories(cat) {
        $("#subcategoryList").empty();
        if (!activeNickname) return;

        // âœ… ê° ì„œë¸Œì¹´í…Œê³ ë¦¬ ë Œë”ë§
        cat.categories2.forEach(sub => {
            const totalItems = sub.items.length;
            const collectedCount = sub.items.filter(i => collected[i.id]).length;

            const isAllCollected = totalItems > 0 && collectedCount === totalItems;
            const collectedClass = isAllCollected ? 'collected' : '';

            // âœ… ì§„í–‰ë¥  í…ìŠ¤íŠ¸ (ì™„ë£Œê°€ ì•„ë‹ˆë©´ í‘œì‹œ)
            const progressHTML = !isAllCollected ? `<span class="sub-progress">${collectedCount}/${totalItems}</span>` : '';

            $("#subcategoryList").append(`
                <div class="subcategory ${collectedClass}" data-cat="${cat.category1}" data-sub="${sub.name}">
                    ${progressHTML}
                    <span class="sub-name">${sub.name}</span>
                </div>
            `);
        });
    }

    // âœ… ì„ íƒëœ ì„œë¸Œì¹´í…Œê³ ë¦¬ë§Œ í‘œì‹œ + X ë²„íŠ¼ ìƒì„±
    function renderSelectedSubcategory(catName, subName) {
        $("#subcategoryList").html(`
            <div class="selected-subcategory">
                <div class="subcategory active" data-cat="${catName}" data-sub="${subName}">
                    ${subName}
                </div>
                <div class="close-subcategory">âœ•</div>
            </div>
        `);
    }

    function renderReward(sub) {
        const $area = $("#rewardSection");
        $area.empty();

        $area.append(`<div class="reward-box">ğŸ ë³´ìƒ : ${sub.reward || 'ì—†ìŒ'}</div>`);
        const itemsHTML = sub.items.map(i => `
            <div class="item-card" data-id="${i.id}">
                <div class="item-name">${i.item}</div>
                <div class="item-detail">
                    ${i.theme ? `í…Œë§ˆ : ${i.theme}<br>` : ''}
                    ${i.color ? `ìƒ‰ìƒ : ${i.color}<br>` : ''}
                    ${i.machine ? `ë¨¸ì‹  : ${i.machine}<br>` : ''}
                    ${i.attribute ? `ì†ì„± : ${i.attribute}<br>` : ''}
                    ${i.price ? `ê°€ê²© : ${i.price}<br>` : ''}
                    ${i.note ? `ë¹„ê³  : ${i.note}` : ''}
                </div>
            </div>
        `).join('');
        $area.append(`<div class="item-list">${itemsHTML}</div>`);

        markCollectedItems(activeNickname);
    }

    // âœ… ê²€ìƒ‰ ê¸°ëŠ¥
    $(document).on("click", "#searchBtn", function () {
        const keyword = $("#searchInput").val().trim();
        if (!keyword) return showAlert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        const results = [];

        memoryData.forEach(cat => {
            cat.categories2.forEach(sub => {
                const rewardMatch = sub.reward && sub.reward.includes(keyword);
                const addedItems = new Set(); // ì¤‘ë³µ ë°©ì§€ìš©

                sub.items.forEach(item => {
                    const itemMatch = item.item.includes(keyword);

                    // âœ… ì•„ì´í…œ ì´ë¦„ì´ ì¼ì¹˜í•  ê²½ìš°
                    if (itemMatch && !addedItems.has(item.item)) {
                        results.push({
                            category1: cat.category1,
                            category2: sub.name,
                            item: item.item,
                            type: "item" // ì•„ì´í…œ ê²°ê³¼ì„ì„ í‘œì‹œ
                        });
                        addedItems.add(item.item);
                    }
                });

                // âœ… ë³´ìƒ ì´ë¦„ì´ ì¼ì¹˜í•  ê²½ìš°
                if (rewardMatch) {
                    results.push({
                        category1: cat.category1,
                        category2: sub.name,
                        item: sub.reward,
                        type: "reward" // ë³´ìƒ ê²°ê³¼ì„ì„ í‘œì‹œ
                    });
                }
            });
        });

        if (results.length === 0) {
            showAlert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”...");
            return;
        }

        // âœ… ê²€ìƒ‰ ê²°ê³¼ ëª¨ë‹¬ ìƒì„±
        const modalHtml = `
                <div class="modal-overlay" id="searchModal">
                    <div class="modal-content">
                        <div style="position: relative; padding: 12px 0;">
                            <div>ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê°œ)</div>
                            <button id="closeSearchModalX" class="closeBtn">âœ•</button>
                        </div>
                        <div class="result-list">
                            ${results.map(r => `
                                <div class="result-item" data-cat="${r.category1}" data-sub="${r.category2}">
                                    <b>${r.category1}</b> > ${r.category2}
                                    <div class="result-item-name">
                                        ${r.type === "reward" ? `ğŸ ${r.item}` : r.item}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button id="closeSearchModal">ë‹«ê¸°</button>
                    </div>
                </div>
            `;
        $("body").append(modalHtml);
    });

    // âœ… ê²€ìƒ‰ì°½ì—ì„œ ì—”í„° ëˆŒëŸ¬ë„ ê²€ìƒ‰ë˜ê²Œ
    $(document).on("keypress", "#searchInput", function (e) {
        if (e.key === "Enter") {
            e.preventDefault(); // í¼ ì „ì†¡ ë°©ì§€
            $("#searchBtn").click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ê³¼ ë™ì¼í•˜ê²Œ ì‹¤í–‰
        }
    });

    // âœ… ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
    $(document).on("click", "#closeSearchModal, #closeSearchModalX", function () {
        $("#searchModal").remove();
    });

    // âœ… ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
    $(document).on("click", ".result-item", function () {
        const cat = $(this).data("cat");
        const sub = $(this).data("sub");
        $("#searchModal").remove();

        // í•´ë‹¹ ìºë¦­í„° íƒ­ í™œì„±í™”
        $(".character-tab").removeClass("active");
        $(`.character-tab[data-cat="${cat}"]`).addClass("active");

        const category = memoryData.find(c => c.category1 === cat);
        const subData = category.categories2.find(s => s.name === sub);

        renderSelectedSubcategory(cat, sub);
        renderReward(subData);
    });

    // âœ… ì•„ì´í…œ í´ë¦­ ì‹œ ì¶”ì–µ í† ê¸€ ì €ì¥/ì‚­ì œ
    $(document).on("click", ".item-card, .item-table tr", async function () {
        if (!activeNickname) {
            showAlert("ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!");
            return;
        }

        const itemId = $(this).data("id");
        if (!itemId) {
            console.warn("â— itemì— data-id ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const itemRef = ref(db, `coffeeMemory/${activeNickname}/${itemId}`);

        try {
            const snap = await get(itemRef);
            const isTableRow = $(this).closest(".item-table").length > 0;

            if (snap.exists()) {
                // âœ… ì´ë¯¸ ì €ì¥ëœ ê²½ìš° â†’ ì‚­ì œ
                await remove(itemRef);
                collected[itemId] = false;
                if (isTableRow) {
                    $(this).removeClass("collected-item").css("background", ""); // í…Œì´ë¸”ìš©
                } else {
                    $(this).removeClass("collected"); // ì¹´ë“œìš©
                }
            } else {
                // âœ… ì•„ì§ ì—†ëŠ” ê²½ìš° â†’ ì €ì¥
                await update(ref(db, `coffeeMemory/${activeNickname}`), {[itemId]: true});
                collected[itemId] = true;
                if (isTableRow) {
                    $(this).addClass("collected-item").css("background", "#f0eaff"); // í…Œì´ë¸”ìš©
                } else {
                    $(this).addClass("collected"); // ì¹´ë“œìš©
                }
            }
        } catch (err) {
            console.error("ì¶”ì–µ í† ê¸€ ì¤‘ ì˜¤ë¥˜:", err);
            showAlert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”...");
        }
    });

    // âœ… í•„í„°ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì¸ í™”ë©´ ìˆ¨ê¸°ê¸° / ë‹¤ì‹œ ë³´ì´ê¸° í† ê¸€
    $(document).on("click", ".advancedSettingBtn", function () {
        const $main = $(".mainPage");
        const $sub = $(".subPage");
        const isHidden = $main.is(":hidden");

        if (isHidden) {
            // ì´ë¯¸ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë‹¤ì‹œ ë³´ì´ê²Œ
            $sub.hide();
            $main.show();
            $(this).text("í•„í„°ëª¨ë“œ");
            localStorage.setItem("coffeeMemory-mode", "normal");
        } else {
            // ë³´ì´ëŠ” ì¤‘ì´ë©´ ìˆ¨ê¹€
            $main.hide();
            $sub.show();
            renderAdvancedSettings();
            $(this).text("ì¼ë°˜ëª¨ë“œ");
            localStorage.setItem("coffeeMemory-mode", "filter");
        }
    });

    // âœ… í•„í„°ëª¨ë“œ ì´ˆê¸° ë Œë”ë§
    function renderAdvancedSettings() {
        // 1ï¸âƒ£ ì „ì²´ ì•„ì´í…œì„ ìˆ˜ì§‘í•˜ë©´ì„œ ê³ ìœ  í…Œë§ˆ/ì˜µì…˜ ê°’ ì¶”ì¶œ
        const allItems = [];
        const themeSet = new Set();
        const optionSet = new Set();

        memoryData.forEach(cat => {
            cat.categories2.forEach(sub => {
                sub.items.forEach(item => {
                    allItems.push({
                        ...item, id: item.id, category1: cat.category1, category2: sub.name
                    });

                    if (item.theme) themeSet.add(item.theme.trim());
                    if (item.attribute) optionSet.add(item.attribute.trim());
                });
            });
        });

        // âœ… 1ï¸âƒ£ ë¡œì»¬ ì €ì¥ëœ í•„í„°ëª¨ë“œê°’ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
        const savedFilter = JSON.parse(localStorage.getItem("coffee-advancedFilter") || "{}");
        const defaultFilter = {
            theme: savedFilter.theme || "",
            collect: savedFilter.collect || "",
            option: savedFilter.option || "",
            sort: savedFilter.sort || "nameAsc"
        };

        // 2ï¸âƒ£ select ì˜µì…˜ HTML ìë™ ìƒì„±
        const themeOptions = ['<option value="">í…Œë§ˆ ì „ì²´</option>']
            .concat([...themeSet]
                .sort((a, b) => a.localeCompare(b, "ko")) // âœ… ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
                .map(t => `<option value="${t}">${t}</option>`))
            .join("");

        const optionOptions = ['<option value="">ì˜µì…˜ ì „ì²´</option>']
            .concat([...optionSet]
                .sort((a, b) => a.localeCompare(b, "ko")) // âœ… ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
                .map(o => `<option value="${o}">${o}</option>`))
            .join("");

        // 3ï¸âƒ£ í•„í„°ëª¨ë“œ ì˜ì—­ êµ¬ì„±
        const filterHTML = `
            <div class="filter-container">
            <!-- <select id="themeFilter" class="filter-select">${themeOptions}</select> -->
                <select id="collectFilter" class="filter-select">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="collected">ìˆ˜ì§‘ ì™„ë£Œ</option>
                    <option value="uncollected">ë¯¸ìˆ˜ì§‘</option>
                </select>
                <select id="optionFilter" class="filter-select">${optionOptions}</select>

                <select id="sortOption" class="filter-select" style="flex:1 1 100%;">
                    <option value="nameAsc">ì´ë¦„ â–²</option>
                    <option value="nameDesc">ì´ë¦„ â–¼</option>
                    <option value="priceAsc">ê°€ê²© â–²</option>
                    <option value="priceDesc">ê°€ê²© â–¼</option>
                </select>
            </div>
        `;

        $("#filterSection").html(filterHTML);
        // $("#themeFilter").val(defaultFilter.theme);
        $("#collectFilter").val(defaultFilter.collect);
        $("#optionFilter").val(defaultFilter.option);
        $("#sortOption").val(defaultFilter.sort);

        // âœ… 2ï¸âƒ£ ë¡œì»¬ í•„í„°ê°’ ë°˜ì˜í•´ì„œ í…Œì´ë¸” ë Œë”ë§
        applyAndRenderFilter(allItems, defaultFilter);

        // âœ… 3ï¸âƒ£ í•„í„° ë³€ê²½ ì‹œ ë¡œì»¬ ì €ì¥ ë° ì¦‰ì‹œ ë°˜ì˜
        $(document).off("change", ".filter-select").on("change", ".filter-select", function () {
            const theme = ""; // í˜„ì¬ëŠ” ë¹„í™œì„±í™”
            const collect = $("#collectFilter").val();
            const option = $("#optionFilter").val();
            const sort = $("#sortOption").val();

            // ë³€ê²½ëœ ê°’ ì €ì¥
            localStorage.setItem("coffee-advancedFilter", JSON.stringify({ theme, collect, option, sort }));

            applyAndRenderFilter(allItems, { theme, collect, option, sort });
        });
    }

    // âœ… í•„í„° ë° ì •ë ¬ ì ìš© í›„ ë Œë”ë§
    async function applyAndRenderFilter(allItems, {theme, collect, option, sort}) {
        let filtered = [...allItems];

        // âœ… í…Œë§ˆ (í˜„ì¬ ì£¼ì„ìš©)
        // if (theme) filtered = filtered.filter(i => i.theme && i.theme === theme);
        if (option) filtered = filtered.filter(i => i.attribute && i.attribute === option);

        // âœ… ìˆ˜ì§‘ ì—¬ë¶€ í•„í„°
        if (collect === "collected") {
            filtered = filtered.filter(i => collected[Number(i.id)] === true || collected[String(i.id)] === true);
        } else if (collect === "uncollected") {
            filtered = filtered.filter(i => !collected[Number(i.id)] && !collected[String(i.id)]);
        }

        // âœ… ê°€ê²© ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        const parsePrice = (val) => {
            if (!val) return 0;
            // ì‰¼í‘œ, ê³µë°±, ë‹¨ìœ„(G, C ë“±) ì œê±° í›„ ìˆ«ìë§Œ ì¶”ì¶œ
            const num = val.toString().replace(/[^\d]/g, "");
            return Number(num) || 0;
        };

        if (sort === "priceAsc") filtered.sort((a, b) => parsePrice(a.price) - parsePrice(b.price));
        if (sort === "priceDesc") filtered.sort((a, b) => parsePrice(b.price) - parsePrice(a.price));
        if (sort === "nameAsc") filtered.sort((a, b) => a.item.localeCompare(b.item, "ko"));
        if (sort === "nameDesc") filtered.sort((a, b) => b.item.localeCompare(a.item, "ko"));

        renderItemTable(filtered);
    }

    // âœ… ì•„ì´í…œ í…Œì´ë¸” ë Œë”ë§ (íšë“ ì—¬ë¶€ í‘œì‹œ í¬í•¨)
    async function renderItemTable(items) {
        const tableHTML = `
            <table class="item-table">
                <tbody>
                    ${items.map(i => {
            const isCollected = collected[i.id]; // âœ… íšë“ ì—¬ë¶€ ì²´í¬

            // 1ï¸âƒ£ ì²«ì¤„: ì´ë¦„ + ì†ì„± + ê°€ê²©
            const tags = [];
            if (i.attribute || i.price) tags.push(`<span class="tag tag-attr">${i.attribute} ${i.price ? " : " + i.price : ""}</span>`);
            if (i.color) tags.push(`<span class="tag tag-color">${i.color}</span>`);
            if (i.theme) tags.push(`<span class="tag tag-theme">${i.theme}</span>`);
            if (i.machine) tags.push(`<span class="tag tag-machine">${i.machine}</span>`);
            if (i.note) tags.push(`<span class="tag tag-text">${i.note}</span>`);

            // âœ… íšë“ëœ ê²½ìš° ì´ë¦„ ì•ì— ì´ë¯¸ì§€ ì¶”ê°€
            const nameHTML = `
                            <span class="item-name">${i.item}</span>
                        `;

            // âœ… íšë“ëœ ì•„ì´í…œì€ ë°°ê²½ ê°•ì¡°
            const rowClass = isCollected ? "collected-item" : "";

            return `
                            <tr class="${rowClass}" data-id="${i.id}">
                                <td>${nameHTML}<br>${tags.join(" ")}</td>
                            </tr>
                        `;
        }).join("")}
                </tbody>
            </table>
        `;

        $("#tableSection").html(tableHTML);
    }

    // âœ… í´ë¦­ ì‹œ DB ë°˜ì˜ (coffeeMemoryì— ì €ì¥)
    $(document).on("click", "#memoryRoomToggle", async function () {
        if (!activeNickname) {
            showAlert("ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!");
            return;
        }

        const $toggle = $(this);
        const isCurrentlyOn = $toggle.hasClass("on");
        const newStatus = !isCurrentlyOn;

        try {
            // ğŸ”¹ Firebase DBì— ìƒíƒœ ì €ì¥
            await update(ref(db, `coffeeUsers/${activeNickname}`), {
                memoryRoomPublic: newStatus
            });

            // ğŸ”¹ UI ê°±ì‹ 
            if (newStatus) {
                $toggle.addClass("on").css("background", "#5a4398");
                $(".memoryRoomBtn").show();
            } else {
                $toggle.removeClass("on").css("background", "#ccc");
                $(".memoryRoomBtn").hide();
            }

            console.log(`âœ… ë©”ëª¨ë¦¬ë£¸ ê³µê°œ ìƒíƒœ: ${newStatus}`);
        } catch (err) {
            console.error("ë©”ëª¨ë¦¬ë£¸ ìƒíƒœ ì €ì¥ ì˜¤ë¥˜:", err);
            showAlert("ìƒíƒœ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”...");
        }
    });
</script>
<script src="../modules/helpModal.js" type="module" defer></script>
<script src="../modules/menuToggle.js" type="module" defer></script>
</body>
</html>