<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #f4f3f9;
            margin: 0;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="../helpModal/helpModal.css"/>
    <link rel="stylesheet" href="../menuToggle/menuToggle.css"/>
<body>
<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<div style="margin: 20px;">
    <button class="notifyBtn">
        ì•Œë¦¼ ì„¤ì •
    </button>
</div>


<div id="notifyModal" class="login-overlay" style="display: none;">
    <div class="login-modal">
        <button id="closeNotifyModal" class="closeBtn">âœ•</button>
        <h2>ì•Œë¦¼ ì„¤ì •</h2>

        <select id="modalHour"></select>
        <select id="modalMinute"></select>

        <div class="modal-actions">
            <button id="modalSaveBtn">ì €ì¥í•˜ê¸°</button>
            <button id="modalDisableBtn">ì•Œë¦¼ ë„ê¸°</button>
        </div>

        <div style="font-size: 14px; color: #666; margin-top: 14px; text-align: left;">
            â€» ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë ¤ë©´<br>
            Â· Chrome ë˜ëŠ” Safariì—ì„œ ì•Œë¦¼ì„ â€˜í—ˆìš©â€™í•´ì•¼ í•©ë‹ˆë‹¤.<br>
            Â· ì¼ë¶€ iOS ê¸°ê¸°ì—ì„œëŠ” ì•Œë¦¼ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>
</div>

<script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker
                .register("/firebase-messaging-sw.js")
                .then(() => console.log("SW ë“±ë¡ ì„±ê³µ"))
                .catch(err => console.log("SW ë“±ë¡ ì‹¤íŒ¨:", err));
        });
    }
</script>
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {getDatabase, ref, set, get} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
    import {getMessaging, getToken} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-messaging.js";

    import {goToPage, getActiveNickname} from "../common/utils.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4ERWaxTCYUiEijuhdQITVsP_VlYrVXEU",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: "test-948ba",
        storageBucket: ".env/storageBucket",
        messagingSenderId: "214442102094",
        appId: "1:214442102094:web:844878f6a9c4080538e21f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const messaging = getMessaging(app);

    // ğŸ‘‰ Firebase ì½˜ì†” Cloud Messagingì—ì„œ ë³µì‚¬í•œ "Web Push ì¸ì¦ì„œ ê³µê°œí‚¤"
    const FCM_VAPID_PUBLIC_KEY = "BCzk05nOhj12ZxrKtJaM_VOYOI9i3X0YuQuGiSFLHS1Cu_kfWD7qk5wixj_g0cJE_9JtnLU83aRjrWxfd-i5sqA";

    const WORKER_BASE = "https://worker-gentle-dream-dcc5.picon1317.workers.dev";

    const nickname = getActiveNickname();
    if (!nickname) goToPage();

    async function registerFcmToWorker(timeString, token) {
        try {
            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”~!");
                return;
            }

            if (!token) {
                console.log("FCM í† í° ë°œê¸‰ ì‹¤íŒ¨");
                return;
            }

            console.log("FCM token:", token);

            // í† í° + ì‹œê°„ Cloudflare Workerë¡œ ì „ì†¡
            await fetch(`${WORKER_BASE}/subscribe-fcm`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    token,
                    time: timeString,
                    nickname: nickname
                })
            });

            console.log("Workerì— FCM í† í° + ì‹œê°„ ë“±ë¡ ì™„ë£Œ");

        } catch (e) {
            console.error("FCM ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", e);
        }
    }

    $(document).on("click", ".notifyBtn", async function () {
        $("#notifyModal").show();
    });

    // âœ… ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", ".closeBtn", function () {
        $(".login-overlay").hide();
    });

    $(document).ready(function () {
        const notifyRef = ref(db, `coffeeUsers/${nickname}/notify`);

        const $modalHour = $("#modalHour");
        const $modalMinute = $("#modalMinute");

        // â­ 0~23, 0~59 ìë™ ìƒì„±
        for (let i = 0; i < 24; i++) {
            $modalHour.append(`<option value="${i}">${String(i).padStart(2, "0")}ì‹œ</option>`);
        }

        for (let i = 0; i < 60; i += 30) {
            $modalMinute.append(`<option value="${i}">${String(i).padStart(2, "0")}ë¶„</option>`);
        }

        // â­ ì €ì¥ëœ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadNotifyTime() {
            get(notifyRef).then((snap) => {
                const data = snap.val();

                if (data?.disabled) {
                    // ì•Œë¦¼ ëˆ ìƒíƒœ â†’ ìë™ ëª¨ë‹¬ X
                    return;
                }

                if (data?.time) {
                    const [h, m] = data.time.split(":");
                    $("#modalHour").val(Number(h));
                    $("#modalMinute").val(Number(m));
                    return;
                }

                // â­ ìµœì´ˆ ë¯¸ì„¤ì • ìƒíƒœ â†’ ìë™ ëª¨ë‹¬ OPEN
                $("#notifyModal").show();
            });
        }

        loadNotifyTime();
        checkAndUpdateToken();

        // â­ ì €ì¥í•˜ê¸° ë²„íŠ¼
        $("#modalSaveBtn").on("click", async function () {
            let hour = String($("#modalHour").val()).padStart(2, "0");
            let minute = String($("#modalMinute").val()).padStart(2, "0");

            const timeString = `${hour}:${minute}`;

            const token = await getToken(messaging, {
                vapidKey: FCM_VAPID_PUBLIC_KEY
            });

            await set(notifyRef, {
                time: timeString,
                token: token
            });

            await registerFcmToWorker(timeString, token);

            alert(`ì•Œë¦¼ ì‹œê°„ì´ ${timeString}ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            $("#notifyModal").hide();
        });

        async function checkAndUpdateToken() {
            const snap = await get(notifyRef);

            const notifyData = snap.val();
            if (!notifyData || !notifyData.time) {
                // ì‹œê°„ì¡°ì°¨ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
                console.log("ğŸ”¸ ì €ì¥ëœ ì•Œë¦¼ ì„¤ì • ì—†ìŒ â€” ë¬´ì‹œ");
                return;
            }

            // í˜„ì¬ FCM í† í° ì–»ê¸°
            const currentToken = await getToken(messaging, {
                vapidKey: FCM_VAPID_PUBLIC_KEY
            });

            if (!currentToken) {
                console.log("âŒ í˜„ì¬ í† í° ë°œê¸‰ ì‹¤íŒ¨");
                return;
            }

            const savedToken = notifyData.token;

            // ğŸ” ë¹„êµ
            if (savedToken !== currentToken) {
                console.log("ğŸ”„ FCM í† í°ì´ ë³€ê²½ë¨! Workerì™€ DB ì—…ë°ì´íŠ¸ ì‹œì‘");

                // 1) DBì— ìƒˆë¡œìš´ í† í° ì €ì¥
                await set(notifyRef, {
                    time: notifyData.time,
                    token: currentToken
                });

                // 2) Workerì—ë„ ì „ì†¡
                await fetch(`${WORKER_BASE}/subscribe-fcm`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        token: currentToken,
                        time: notifyData.time,
                        nickname: nickname
                    })
                });

                console.log("âœ¨ í† í° ê°±ì‹  ì™„ë£Œ!");
            } else {
                console.log("âœ” í† í° ë™ì¼ â€” Worker ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”");
            }
        }

        // â­ ì•Œë¦¼ ë„ê¸°
        $("#modalDisableBtn").on("click", async function () {
            if (!confirm("ì •ë§ ì•Œë¦¼ì„ ëŒê¹Œìš”?")) return;

            // 1) Firebase DB notify ê°’ ì‚­ì œ
            await set(notifyRef, {disabled: true});

            // 2) Workerì—ì„œë„ í•´ë‹¹ nickname êµ¬ë… í•´ì œ ìš”ì²­(ì˜µì…˜)
            await fetch(`${WORKER_BASE}/unsubscribe-fcm`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({nickname})
            }).catch(() => {
            });

            alert("ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤.");
            loadNotifyTime(); // UI ìƒˆë¡œ ë°˜ì˜
            $("#notifyModal").hide();
        });
    });

    // âœ… ë’¤ë¡œê°€ê¸°
    $("#backBtn").on("click", () => goToPage());
</script>
<script src="../helpModal/helpModal.js" defer></script>
<script src="../menuToggle/menuToggle.js" type="module" defer></script>
</body>
</html>