<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #f4f3f9;
            margin: 0;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="../helpModal/helpModal.css"/>
    <link rel="stylesheet" href="../menuToggle/menuToggle.css"/>
<body>
<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<div style="margin: 20px; padding: 16px; background: white; border-radius: 10px;">
    <h3>ì•Œë¦¼ ì‹œê°„ ì„¤ì •</h3>

    <div id="notifyView" style="display:none; margin-bottom: 10px;">
        <p>í˜„ì¬ ì„¤ì •ëœ ì‹œê°„: <span id="currentTime"></span></p>
        <button id="editBtn">ìˆ˜ì •í•˜ê¸°</button>
    </div>

    <div id="notifyForm">
        <label>ì‹œ:
            <select id="notifyHour"></select>
        </label>
        <label>ë¶„:
            <select id="notifyMinute"></select>
        </label>
        <button id="saveNotifyBtn">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {getDatabase, ref, set, get} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
    import {getMessaging, getToken} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-messaging.js";

    import {goToPage, getActiveNickname} from "../common/utils.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4ERWaxTCYUiEijuhdQITVsP_VlYrVXEU",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: "test-948ba",
        storageBucket: ".env/storageBucket",
        messagingSenderId: "214442102094",
        appId: "1:214442102094:web:844878f6a9c4080538e21f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const messaging = getMessaging(app);

    // ğŸ‘‰ Firebase ì½˜ì†” Cloud Messagingì—ì„œ ë³µì‚¬í•œ "Web Push ì¸ì¦ì„œ ê³µê°œí‚¤"
    const FCM_VAPID_PUBLIC_KEY = "BCzk05nOhj12ZxrKtJaM_VOYOI9i3X0YuQuGiSFLHS1Cu_kfWD7qk5wixj_g0cJE_9JtnLU83aRjrWxfd-i5sqA";

    const WORKER_BASE = "https://worker-gentle-dream-dcc5.picon1317.workers.dev";

    const nickname = getActiveNickname();
    if (!nickname) goToPage();

    async function registerFcmToWorker(timeString) {
        try {
            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”~!");
                return;
            }

            // FCM í† í° ë°œê¸‰
            const token = await getToken(messaging, {
                vapidKey: FCM_VAPID_PUBLIC_KEY
            });

            if (!token) {
                console.log("FCM í† í° ë°œê¸‰ ì‹¤íŒ¨");
                return;
            }

            console.log("FCM token:", token);

            // í† í° + ì‹œê°„ Cloudflare Workerë¡œ ì „ì†¡
            await fetch(`${WORKER_BASE}/subscribe-fcm`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    token,
                    time: timeString,
                    nickname: nickname
                })
            });

            console.log("Workerì— FCM í† í° + ì‹œê°„ ë“±ë¡ ì™„ë£Œ");

        } catch (e) {
            console.error("FCM ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", e);
        }
    }

    $(document).ready(function () {
        const notifyRef = ref(db, `coffeeUsers/${nickname}/notify`);

        const $notifyHour = $("#notifyHour");
        const $notifyMinute = $("#notifyMinute");
        const $notifyForm = $("#notifyForm");
        const $notifyView = $("#notifyView");
        const $currentTime = $("#currentTime");

        // â­ 0~23, 0~59 ìë™ ìƒì„±
        for (let i = 0; i < 24; i++) {
            $notifyHour.append(`<option value="${i}">${String(i).padStart(2, "0")}ì‹œ</option>`);
        }

        for (let i = 0; i < 60; i++) {
            $notifyMinute.append(`<option value="${i}">${String(i).padStart(2, "0")}ë¶„</option>`);
        }

        // â­ ì €ì¥ëœ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadNotifyTime() {
            get(notifyRef).then((snap) => {
                const value = snap.val();   // ì˜ˆ: "09:30"

                if (value) {
                    // í‘œì‹œ
                    $currentTime.text(value);
                    $notifyView.show();
                    $notifyForm.hide();

                    // í¼ì—ë„ ê°’ ë°˜ì˜
                    const [h, m] = value.split(":");
                    $notifyHour.val(Number(h));
                    $notifyMinute.val(Number(m));

                } else {
                    $notifyView.hide();
                    $notifyForm.show();
                }
            });
        }

        loadNotifyTime();

        // â­ ì €ì¥í•˜ê¸° ë²„íŠ¼
        $("#saveNotifyBtn").on("click", function () {
            let hour = String($notifyHour.val()).padStart(2, "0");
            let minute = String($notifyMinute.val()).padStart(2, "0");

            const timeString = `${hour}:${minute}`;

            set(notifyRef, timeString).then(() => {
                alert(`ì•Œë¦¼ ì‹œê°„ì´ ${timeString}ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadNotifyTime();
                registerFcmToWorker(timeString);
            });
        });

        // â­ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼
        $("#editBtn").on("click", function () {
            $notifyView.hide();
            $notifyForm.show();
        });
    });

    // âœ… ë’¤ë¡œê°€ê¸°
    $("#backBtn").on("click", () => goToPage());
</script>
<script src="../helpModal/helpModal.js" defer></script>
<script src="../menuToggle/menuToggle.js" type="module" defer></script>
</body>
</html>