<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>메모리룸(관리자)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS 전체화면 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard 웹폰트 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            background: #f4f3f9;
            margin: 0;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        #controlBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        #controlBar input, #controlBar select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        #userTable {
            width: calc(100% - 40px);
            margin: 10px 20px;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
        }

        #userTable th, #userTable td {
            border: 1px solid #e0dff2;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        #userTable th {
            background: #f6f4fc;
            color: #5a4398;
        }

        /* ✅ 게이지 셀만 남은 폭 전부 차지하게 */
        #userTable td:nth-child(1),
        #userTable td:nth-child(2),
        #userTable td:nth-child(3) {
            white-space: nowrap; /* 닉네임, Lv, 획득수는 내용 크기만큼 */
            width: 1%;
        }

        #userTable td:nth-child(4) {
            width: 100%; /* 게이지가 남은 공간 전부 차지 */
        }

        /* ✅ 게이지 셀 전체 스타일 */
        .gauge-cell {
            width: 100%;
        }

        /* ✅ 게이지 박스 */
        .gauge-bar {
            position: relative;
            height: 14px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            text-align: center;
            color: #fff;
            font-size: 11px;
            font-weight: 300;
        }

        /* ✅ 게이지 채워지는 부분 */
        .gauge-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #a997e9;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        /* ✅ 게이지 안쪽 숫자 텍스트 */
        .gauge-text {
            position: relative;
            z-index: 2;
            line-height: 14px;
            mix-blend-mode: difference; /* 진한색/연한색 배경 모두 대비 좋게 */
        }

        /* ✅ 100% 게이지 색 강조 */
        .gauge-fill[data-full="true"] {
            background: #5a4398;
        }

        #loading {
            text-align: center;
            color: #5a4398;
            font-weight: 600;
            margin-top: 20px;
            display: none;
        }

        #searchInput {
            width: 140px;
        }

        .guide-bar {
            display: flex;
            justify-content: space-between; /* ← 양쪽 배치 */
            align-items: center;
            flex-wrap: wrap;
            margin: 10px 30px;
        }

        #userCount {
            font-weight: 600;
            color: #5a4398;
            font-size: 14px;
        }

        #colorGuide {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: right;
            font-size: 14px;
            color: #555;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* ✅ 모달 스타일 */
        #userModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: 250px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }

        .modal-content button {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }

        .move-btn {
            background: #5a4398;
            color: #fff;
        }

        .delete-btn {
            background: #ff5e5e;
            color: #fff;
        }

        .close-btn {
            background: #ccc;
            color: #333;
        }

        #userTable th, #userTable td {
            font-size: 12px;
        }
    </style>
</head>

<body>
<div class="header-bar">
    <h1>메모리룸(관리자)</h1>
    <button id="backBtn">뒤로가기</button>
</div>

<div id="controlBar">
    <input type="text" id="searchInput" placeholder="닉네임 검색">
    <select id="sortSelect">
        <option value="level">레벨</option>
        <option value="nickname">닉네임</option>
        <option value="lastlogin">접속</option>
        <option value="collected">획득수</option>
    </select>
</div>

<div class="guide-bar">
    <div id="userCount">총 명</div>
</div>

<table id="userTable">
    <thead>
    <tr>
        <th>닉네임</th>
        <th>Lv</th>
        <th>획득수</th>
        <th>게이지</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="loading">불러오는 중...</div>

<!-- 유저 모달 -->
<div id="userModal">
    <div class="modal-content">
        <h3 id="modalNickname"></h3>
        <p id="modalSignupDate"></p>
        <p id="modalLastLogin"></p>
        <button class="move-btn">이동하기</button>
        <button class="delete-btn">삭제</button>
        <button class="close-btn">닫기</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
    import { goToPage } from "../common/utils.js";
    import {memoryData} from "../common/memoryData.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    $(function () {
        const nickname = localStorage.getItem("coffee-nickname");
        if (!nickname) return alert("로그인이 필요합니다."), goToPage();

        // ✅ 관리자 권한 확인
        get(ref(db, `coffeeUsers/${nickname}`)).then(async snap => {
            if (!snap.exists() || !snap.val().isAdmin) {
                alert("관리자만 접근할 수 있습니다.");
                goToPage("memory");
                return;
            }

            $("#loading").show();

            // ✅ 모든 유저 정보 및 메모리 정보 가져오기
            const usersSnap = await get(ref(db, "coffeeUsers"));
            const memorySnap = await get(ref(db, "coffeeMemory"));

            $("#loading").hide();

            if (!usersSnap.exists() || !memorySnap.exists()) {
                $("#userTable tbody").html("<tr><td colspan='4'>데이터가 없습니다.</td></tr>");
                $("#userCount").text("총 0명");
                return;
            }

            // ✅ 전체 메모리(아이템) 갯수 계산
            const totalMemories = memoryData.reduce((sum1, cat1) => {
                return sum1 + cat1.categories2.reduce((sum2, cat2) => {
                    return sum2 + (cat2.items?.length || 0);
                }, 0);
            }, 0);

            // ✅ 유저 목록 구성
            let users = [];
            usersSnap.forEach(child => {
                const val = child.val();
                const userMemories = memorySnap.val()[child.key] || {}; // 해당 유저의 추억 목록
                const collectedCount = Object.keys(userMemories).length;

                users.push({
                    key: child.key,
                    level: val.level || 0,
                    collectedCount,
                    gauge: totalMemories > 0 ? Math.round((collectedCount / totalMemories) * 100) : 0,
                    signupDate: val.signupDate || "-",
                    lastLogin: val.lastLogin || "-"
                });
            });

            // ✅ 메모리(추억) 0개인 유저는 제외
            users = users.filter(u => u.collectedCount > 0);

            $("#userCount").text(`총 ${users.length}명`);

            // ✅ 렌더링 함수
            function renderTable(list) {
                const $tbody = $("#userTable tbody");
                $tbody.empty();

                if (list.length === 0) {
                    $tbody.html("<tr><td colspan='4'>검색 결과가 없습니다.</td></tr>");
                    return;
                }

                list.forEach(u => {
                    $tbody.append(`
                        <tr data-nick="${u.key}" data-date="${u.signupDate}" data-lastlogin="${u.lastLogin}">
                            <td style="color:${u.memoryRoomPublic ? '#5a4398' : '#333'}; font-weight:${u.memoryRoomPublic ? '600' : 'normal'};">
                                ${u.key}
                            </td>
                            <td>${u.level}</td>
                            <td>${u.collectedCount} / ${totalMemories}</td>
                            <td class="gauge-cell">
                                <div class="gauge-bar">
                                    <div class="gauge-fill" style="width: ${u.gauge}%;"></div>
                                    <span class="gauge-text">${u.gauge}%</span>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            }

            // ✅ 초기 렌더링 (최근 접속일 순)
            const parseDate = (str) => {
                if (!str || typeof str !== "string") return 0;
                // 예: "25.10.22-00:55:13" → "2025-10-22T00:55:13"
                const match = str.match(/^(\d{2})\.(\d{2})\.(\d{2})-(\d{2}):(\d{2}):(\d{2})$/);
                if (!match) return 0;
                const [_, yy, mm, dd, hh, mi, ss] = match;
                return new Date(`20${yy}-${mm}-${dd}T${hh}:${mi}:${ss}`).getTime();
            };

            users.sort((a, b) => parseDate(b.lastLogin) - parseDate(a.lastLogin));
            renderTable(users);

            // ✅ 정렬 셀렉트도 접속일로 초기값 맞추기
            $("#sortSelect").val("lastlogin");

            // ✅ 검색
            let searchTimer;
            $("#searchInput").on("input", function () {
                clearTimeout(searchTimer);
                const keyword = $(this).val().trim().toLowerCase();
                searchTimer = setTimeout(() => {
                    const filtered = users.filter(u =>
                        u.key.toLowerCase().includes(keyword)
                    );
                    renderTable(filtered);
                }, 300);
            });

            // ✅ 정렬
            $("#sortSelect").on("change", function () {
                const mode = $(this).val();
                let sorted = [...users];

                if (mode === "nickname") {
                    sorted.sort((a, b) => a.key.localeCompare(b.key));
                } else if (mode === "level") {
                    sorted.sort((a, b) => (b.level || 0) - (a.level || 0));
                } else if (mode === "lastlogin") {
                    const parseDate = (str) => {
                        if (!str || typeof str !== "string") return 0;
                        const match = str.match(/^(\d{2})\.(\d{2})\.(\d{2})-(\d{2}):(\d{2}):(\d{2})$/);
                        if (!match) return 0;
                        const [_, yy, mm, dd, hh, mi, ss] = match;
                        return new Date(`20${yy}-${mm}-${dd}T${hh}:${mi}:${ss}`).getTime();
                    };
                    sorted.sort((a, b) => parseDate(b.lastLogin) - parseDate(a.lastLogin));
                } else if (mode === "collected") {
                    sorted.sort((a, b) => (b.collectedCount || 0) - (a.collectedCount || 0));
                }

                renderTable(sorted);
            });

            // ✅ 모달 기능
            let selectedNick = "";
            let selectedDate = "";
            let selectedLastLogin = "";

            $(document).on("click", "#userTable tbody tr", function () {
                selectedNick = $(this).data("nick");
                selectedDate = $(this).data("date");
                selectedLastLogin = $(this).data("lastlogin");
                $("#modalNickname").text(`${selectedNick}`);
                $("#modalSignupDate").text(`생성일 : ${selectedDate}`);
                $("#modalLastLogin").text(`로그인 : ${selectedLastLogin}`);
                $("#userModal").css("display", "flex").hide().fadeIn(200);
            });

            $(".move-btn").on("click", function () {
                if (!selectedNick) return;
                localStorage.setItem("coffee-subnick", selectedNick);
                goToPage("memory");
            });

            $(".delete-btn").on("click", async function () {
                if (!selectedNick) return;
                if (!confirm(`${selectedNick}의 추억 데이터를 정말 삭제할까요?`)) return;
                try {
                    await remove(ref(db, `coffeeMemory/${selectedNick}`));
                    alert("삭제되었습니다.");
                    $("#userModal").fadeOut(200);
                    $(`#userTable tr[data-nick="${selectedNick}"]`).remove();
                } catch (e) {
                    alert("삭제 중 오류가 발생했습니다.");
                    console.error(e);
                }
            });

            $(".close-btn, #userModal").on("click", function (e) {
                if (e.target.id === "userModal" || $(this).hasClass("close-btn")) {
                    $("#userModal").fadeOut(200);
                }
            });

            $("#backBtn").on("click", () => {
                goToPage("memory");
            });
        });
    });
</script>
</body>
</html>