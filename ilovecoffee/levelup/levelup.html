<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê·¸ëŸ´ìˆ˜ì´ì¹˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            margin: 0;
            background: #fff;
            color: #333;
        }

        /* ===== ì „ì²´ ë˜í¼ ===== */
        #mainPage {
            display: none;
            flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
            justify-content: flex-start; /* ìœ„ìª½ë¶€í„° ë°°ì¹˜ */
            gap: 10px;
            width: 100%;
            min-height: 100vh;
            background: #fff;
            padding: 20px 16px 60px;
            margin: 0 auto;
            border-radius: 12px;
            position: relative;
            text-align: center;
        }

        /* ===== ë ˆë²¨ ì…ë ¥ ì˜ì—­ ===== */
        .level-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 0 8px;
            margin-top: 20px;
        }

        /* ===== ì œëª© / ë²„íŠ¼ ===== */
        h1 {
            text-align: center;
            color: #5a4398;
            font-size: 22px;
        }

        .level-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ===== í—¤ë” ìŠ¤íƒ€ì¼ ===== */
        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar h1 {
            color: #fff; /* í° ê¸€ì”¨ */
            font-size: 20px;
            margin: 0;
        }

        #expButton {
            background: transparent; /* ë°°ê²½ íˆ¬ëª… */
            color: #5a4398; /* ê¸€ì ë³´ë¼ìƒ‰ */
            border: 2px solid #5a4398; /* ì§„í•œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ */
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        /* ===== ì„¹ì…˜ ì œëª© ===== */
        h3 {
            margin-top: 30px;
            margin-bottom: 0;
            color: #444;
            text-align: left;
            font-size: 17px;
        }

        /* ===== í…Œì´ë¸” ===== */
        #expTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
        }

        #expTable th,
        #expTable td {
            border: 1px solid #e0dff2;
            padding: 10px;
            text-align: center;
        }

        #expTable th {
            background: #f6f4fc;
            color: #5a4398;
            font-weight: 600;
        }

        #expTable tr:nth-child(even) {
            background: #faf9fd;
        }

        /* ===== ëª¨ë‹¬ ê³µí†µ ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* ===== ì»¤ìŠ¤í…€ ì•Œë¦¼/ì»¨íŒ ëª¨ë‹¬ ìµœìƒë‹¨ ê³ ì • ===== */
        #customAlert,
        #customConfirm {
            z-index: 100; /* ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ë³´ë‹¤ ì• */
        }

        #customAlert .alert-box,
        #customConfirm .alert-box {
            position: relative;
            z-index: 101; /* ë‚´ë¶€ ì½˜í…ì¸ ë„ ìµœìƒë‹¨ */
        }

        .login-modal {
            position: relative;
            background: #fff;
            padding: 30px 25px 50px 25px;
            border-radius: 12px;
            width: 360px;
            min-height: max-content;
            text-align: center;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        }

        .login-modal h2 {
            margin-bottom: 15px;
            color: #5a4398;
        }

        .login-modal input {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .login-modal button {
            width: 100%;
            padding: 10px;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 10px;
            transition: 0.2s;
        }

        .msg {
            margin-top: 10px;
            font-size: 20px;
            height: 24px;
        }

        .closeBtn {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none !important;
            border: none;
            font-size: 20px;
            color: #aaa !important;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
            margin: 0;
            width: max-content !important;
        }

        /* ===== ì˜µì…˜ ì„ íƒ ëª¨ë‹¬ ===== */
        #optionModal {
            display: none;
        }

        #optionModal .login-modal {
            width: 280px;
            padding: 20px;
            text-align: center;
        }

        /* ì œëª© ê°€ìš´ë° ì •ë ¬ */
        #optionModal h3 {
            color: #5a4398;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #optionModal button {
            width: 100%;
            padding: 8px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            transition: all 0.2s ease;
        }

        /* ê°œë³„ ìƒ‰ìƒ */
        #editExpBtn {
            color: #5a4398;
            border: 2px solid #5a4398;
        }

        #deleteExpBtn {
            color: #d9534f;
            border: 2px solid #d9534f;
        }

        #closeOptionBtn {
            color: #777;
            border: 2px solid #777;
        }

        #customAlert .alert-box, #customConfirm .alert-box {
            background: #ffbcae;
            padding: 25px 25px 20px;
            border-radius: 12px;
            width: 360px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: left;
            position: relative;
        }

        #customAlert .alert-content, #customConfirm .alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #customAlert .alert-text, #customConfirm .alert-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            flex: 1;
            padding-right: 10px;

            white-space: pre-line; /* \n ì¤„ë°”ê¿ˆ ì¸ì‹ */
            word-break: keep-all; /* ë‹¨ì–´ ê¸°ì¤€ ì¤„ë°”ê¿ˆ */
            overflow-wrap: break-word; /* ê¸´ ë‹¨ì–´ ê°•ì œ ì¤„ë°”ê¿ˆ */
        }


        #customAlert .alert-img, #customConfirm .alert-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        #alertConfirmBtn {
            display: block;
            width: 100%;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            padding: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }

        /* ===== í€µë²„íŠ¼ ë°” ===== */
        #quickBtn-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
            padding: 0 8px;
        }

        .quickBtn {
            width: calc((100% / 3)); /* ë²„íŠ¼ í¬ê¸° */
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            color: #5a4398;
            border-radius: 8px;
            padding: 5px 0;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            overflow: hidden; /* âœ… ì´ë¯¸ì§€ê°€ ë²„íŠ¼ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜¤ì§€ ì•Šê²Œ */
        }

        /* ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ì•ìœ¼ë¡œ ì˜¬ë¦¬ê¸° ìœ„í•´ spanìœ¼ë¡œ ê°ìŒˆ */
        .quickBtn span {
            position: relative;
            z-index: 2; /* âœ… ê¸€ì ì•ìœ¼ë¡œ */
            display: block;
            width: calc(100% - 35px);
            text-align: center;
            margin-left: auto;
            margin-right: 5px;
        }

        /* ===== í€µë²„íŠ¼(ì›í˜• ì´ë¯¸ì§€) ===== */
        .quickBtnImg {
            width: 20px; /* ë²„íŠ¼ í¬ê¸° */
            height: 20px;
            border-radius: 50%; /* ì™„ì „í•œ ì›í˜• */
            object-fit: cover; /* ì´ë¯¸ì§€ ê½‰ ì±„ìš°ê¸° */
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0; /* âœ… ê¸€ìë³´ë‹¤ ì•„ë˜ */
        }

        #adminBtn-bar {
            text-align: right;
        }

        .barBtn {
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            height: 35px;
            padding: 8px 16px;
            font-weight: 600;
        }

        /* ===== ì•„ì¹´ì´ë¸Œ ê³µê°œ í† ê¸€ ìŠ¤ìœ„ì¹˜ ===== */
        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.25s ease;
        }

        .toggle-switch::after {
            content: "";
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.25s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* âœ… ë‹¤í¬ëª¨ë“œìš© ë­í‚¹ í† ê¸€ ìŠ¤ìœ„ì¹˜ ë³´ì • */
        @media (prefers-color-scheme: dark) {
            .toggle-switch {
                background: #f2f2f2; /* ê¸°ë³¸ OFF ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            }
        }

        /* ON ìƒíƒœ */
        .toggle-switch.on {
            background: #5a4398;
        }

        .toggle-switch.on::after {
            left: 26px;
        }

        /* ===== ì„¤ì • ë©”ë‰´ ìŠ¤íƒ€ì¼ ===== */
        .settings-menu {
            position: relative;
        }

        #settingsBtn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 100;
            min-width: 140px;
        }

        /* âœ… ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ê°œë³„ ìŠ¤íƒ€ì¼ */
        .dropdown-menu button {
            display: block;
            width: 100%;
            background: #fff;
            border: none;
            border-bottom: 1px solid #eee;
            color: #333;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* ë§ˆì§€ë§‰ ë²„íŠ¼ì€ êµ¬ë¶„ì„  ì œê±° */
        .dropdown-menu button:last-child {
            border-bottom: none;
        }

        /* ===== ë¡œë”© ìŠ¤í¬ë¦° ===== */
        #loadingScreen {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f4f3f9;
            z-index: 9999;
            flex-direction: column;
        }

        /* ===== ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ ===== */
        .spinner {
            border: 5px solid #eee;
            border-top: 5px solid #5a4398;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        /* ===== ë¡œë”© ë¬¸êµ¬ ===== */
        #loadingScreen p {
            margin-top: 10px;
            color: #5a4398;
            font-weight: 600;
            font-size: 16px;
        }

        /* ===== íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ===== */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .status-card {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 10px;
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            border-radius: 10px;
            padding: 12px 16px;
        }

        .status-item {
            flex: 1;
            text-align: center;
        }

        .status-label {
            font-size: 14px;
            color: #777;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 16px;
            font-weight: 700;
            color: #5a4398;
        }

        /* ===== í˜ëŸ¬ê°€ëŠ” ë¬¸ì¥ (ì• ë‹ˆë©”ì´ì…˜) ===== */
        .scrolling-text-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            overflow: hidden;
            border-radius: 8px;
        }

        .scrolling-text {
            display: inline-block;
            white-space: nowrap;
            font-size: 15px;
            font-weight: 600;
            color: #5a4398;
            animation: scrollText 14s linear infinite;
        }

        /* ì¢Œ â†’ ìš° ë°©í–¥ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes scrollText {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        /* ğŸ‡ í­ì£½ + ì¶•í•˜ë¬¸êµ¬ ì• ë‹ˆë©”ì´ì…˜ */
        .firework-container {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(0, 0, 0, 0.4);
            z-index: 150;
        }

        .firework-text {
            position: relative;
            text-align: center;
            color: #fff;
            font-size: 32px;
            font-weight: 800;
            line-height: 1.6;
            text-shadow: 0 0 20px #5a4398, 0 0 30px #c6a6ff, 0 0 50px #fff;
            margin-top: 20px;
            z-index: 200; /* âœ… í­ì£½ë³´ë‹¤ ìœ„ë¡œ */
            animation: popIn 0.8s ease;
        }

        /* í­ì£½ ì  ì• ë‹ˆë©”ì´ì…˜ */
        .firework {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            animation: explode 1.5s ease-out infinite;
        }

        .firework {
            --tx: 0;
            --ty: 0;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes explode {
            0% { transform: scale(0) translate(0, 0); opacity: 1; }
            100% {
                transform: scale(1.2)
                translate(calc(var(--tx) * 1px), calc(var(--ty) * 1px));
                opacity: 0;
            }
        }

        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
    </style>
    <link rel="stylesheet" href="../helpModal/helpModal.css"/>
    <link rel="stylesheet" href="../menuToggle/menuToggle.css"/>
</head>
<body>

<div id="mainPage" style="display:none;">

    <!-- ğŸ”¹ í˜ëŸ¬ê°€ëŠ” ë¬¸ì¥ ì˜ì—­ -->
    <div class="scrolling-text-container">
        <div class="scrolling-text"></div>
    </div>

    <div class="level-row header-bar">
        <div style="display: flex; gap: 4px; align-items: center">
            <h1>ê·¸ëŸ´ìˆ˜ì´ì¹˜</h1>
            <button id="helpBtn">?</button>
        </div>

        <div class="settings-menu">
            <button id="settingsBtn">ì„¤ì •</button>
            <div id="settingsDropdown" class="dropdown-menu" style="display:none;">
                <button class="addSubCharacterBtn">ë¶€ìº ë“±ë¡</button>
                <button class="expTableBtn">ê²½í—˜ì¹˜í‘œ</button>
                <button class="changeNicknameBtn">ë‹‰ë„¤ì„ ë³€ê²½</button>
                <button class="changePasswordBtn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                <button class="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <div id="quickBtn-bar">
        <div class="quickBtn layoutBtn">
            <img src="../image/layoutBtnImg.jpg" alt="" class="quickBtnImg">
            <span>ë°°ì¹˜ë„</span>
        </div>
        <div class="quickBtn baristaBtn">
            <img src="../image/baristaBtnImg.jpg" alt="" class="quickBtnImg">
            <span>ë°”ë¦¬ìŠ¤íƒ€</span>
        </div>
        <div class="quickBtn memoryBtn">
            <img src="../image/memoryBtnImg.jpg" alt="" class="quickBtnImg">
            <span>ì¶”ì–µìˆ˜ì§‘</span>
        </div>
    </div>

    <div class="level-input">
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="nicknameDisplay"
                  style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
            <span id="currentLevelDisplay"
                  style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
            <button id="expButton">ì…ë ¥</button>
        </div>
        <div id="rankingToggle" class="toggle-switch"></div>
    </div>

    <div class="status-card">
        <div class="status-item">
            <div class="status-label">í‰ê·  ê²½í—˜ì¹˜</div>
            <div class="status-value" id="avgExp">-</div>
        </div>
        <div class="status-item">
            <div class="status-label">ë‚¨ì€ ê²½í—˜ì¹˜ <span class="status-percent"></span></div>
            <div class="status-value" id="curExp">-</div>
        </div>
    </div>

    <div id="levelUpBox" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;"></div>

    <div style="max-height: 400px;">
        <canvas id="expChart" width="100%" height="100"></canvas>
    </div>

    <h3>ì¼ìë³„ ê²½í—˜ì¹˜</h3>
    <table id="expTable">
        <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>Lv</th>
            <th>í˜„ì¬ ê²½í—˜ì¹˜</th>
            <th>íšë“ ê²½í—˜ì¹˜</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- ë¡œê·¸ì¸ íŒì—… -->
<div id="loginPopup" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>ë¡œê·¸ì¸</h2>
        <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button id="loginBtn">í™•ì¸</button>
        <div class="msg" id="message">
            ì²« ë¡œê·¸ì¸ì‹œ ê³„ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<!-- ë¡œê·¸ì¸ íŒì—… -->
<div id="subLoginPopup" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <button id="closeSubLoginPopup" class="closeBtn">âœ•</button>
        <h2>ë¡œê·¸ì¸</h2>
        <input id="subNickname" type="text" placeholder="ë‹‰ë„¤ì„">
        <input id="subPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button id="subLoginBtn">í™•ì¸</button>
        <div class="msg" id="subMessage">
            ì²« ë¡œê·¸ì¸ì‹œ ê³„ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p>ë¡œë”© ì¤‘...</p>
</div>

<!-- ê²½í—˜ì¹˜ ì…ë ¥ ëª¨ë‹¬ -->
<div id="expModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position: relative;">
        <button id="closeExpModal" class="closeBtn">âœ•</button>
        <h2>ê²½í—˜ì¹˜ ì…ë ¥</h2>
        <div style="margin-bottom:10px;">
            <label for="expDate" style="display:block; font-size:14px; text-align:left; color:#555;">ë‚ ì§œ</label>
            <input id="expDate" type="date"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayLevel" style="display:block; font-size:14px; text-align:left; color:#555;">í˜„ì¬ ë ˆë²¨</label>
            <input id="todayLevel" type="number" min="1" max="100"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayExp" style="display:block; font-size:14px; text-align:left; color:#555;">í˜„ì¬ ê²½í—˜ì¹˜</label>
            <input id="todayExp" type="text" inputmode="numeric" placeholder="í˜„ì¬ ê²½í—˜ì¹˜"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <button id="saveExpBtn">ì €ì¥</button>
    </div>
</div>

<!-- ê²½í—˜ì¹˜í‘œ ëª¨ë‹¬ -->
<div id="expTableModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position: relative;">
        <button id="closeExpTableModal" class="closeBtn">âœ•</button>
        <h2 style="margin-bottom:10px;">ê²½í—˜ì¹˜í‘œ</h2>
        <div style="border-top:1px solid #e0dff2; border-bottom:1px solid #e0dff2;">
            <table id="expChartTable"
                   style="width:100%; border-collapse:collapse; margin-top:0; font-size:14px;">
                <thead style="position:sticky; top:0; background:#f6f4fc; z-index:2;">
                <tr style="color:#5a4398;">
                    <th style="padding:8px; border:1px solid #e0dff2; width: 80px">ë ˆë²¨</th>
                    <th style="padding:8px; border:1px solid #e0dff2;">ê²½í—˜ì¹˜</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="expTableNav"
             style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap: 8px">
            <button id="prevExpPage"
                    style="background:#f6f4fc; color:#5a4398; border:none; border-radius:6px; padding:4px 10px; cursor:pointer;">
                ã€ˆ ì´ì „
            </button>
            <button id="nextExpPage"
                    style="background:#f6f4fc; color:#5a4398; border:none; border-radius:6px; padding:4px 10px; cursor:pointer;">
                ë‹¤ìŒ ã€‰
            </button>
        </div>
    </div>
</div>

<!-- ë ˆë²¨ ì…ë ¥ ëª¨ë‹¬ -->
<div id="levelModal" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>í˜„ì¬ ë ˆë²¨ ì…ë ¥</h2>
        <input id="levelInput" type="number" placeholder="ë ˆë²¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" min="1" max="100">
        <button id="saveLevelConfirmBtn">ì €ì¥</button>
    </div>
</div>

<!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
<div id="customAlert" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <button id="alertConfirmBtn">í™•ì¸</button>
    </div>
</div>

<!-- ì»¤ìŠ¤í…€ ì»¨íŒ ëª¨ë‹¬ -->
<div id="customConfirm" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="confirmYesBtn"
                    style="flex:1; background:#5a4398; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; cursor:pointer; transition:background 0.2s;">
                í™•ì¸
            </button>
            <button id="confirmNoBtn"
                    style="flex:1; background:#aaa; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; cursor:pointer; transition:background 0.2s;">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<!-- âœ… í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ -->
<div id="profileModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="width:320px; position:relative;">
        <button id="closeProfileModal" class="closeBtn">âœ•</button>
        <h2>í”„ë¡œí•„ ë³€ê²½</h2>

        <div id="currentProfile" style="text-align:center; margin-bottom:15px;">
            <img id="currentProfileImg" src="../image/profile1.jpg"
                 alt="í˜„ì¬ í”„ë¡œí•„"
                 style="width:60px; height:60px; border-radius:50%; border:2px solid #5a4398; object-fit:cover;">
            <div id="currentProfileName" style="margin-top:6px; color:#5a4398; font-weight:600;">ê¸°ë³¸ í”„ë¡œí•„</div>
        </div>

        <div id="profileImageContainer"
             style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; justify-items:center; margin-bottom:15px;">
            <!-- ì´ë¯¸ì§€ ëª©ë¡ JSë¡œ ì¶”ê°€ -->
        </div>

        <button id="applyProfileBtn"
                style="width:100%; background:#5a4398; color:#fff; border:none; border-radius:8px; padding:8px 0; font-size:16px; font-weight:600; cursor:pointer;">
            ë³€ê²½
        </button>
    </div>
</div>

<!-- âœ… ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="helpModal" class="login-overlay" style="display:none;">
    <div class="login-modal help-modal">
        <button id="closeHelpModal" class="closeBtn">âœ•</button>
        <h2 class="help-title">ê·¸ëŸ´ìˆ˜ì´ì¹˜ ì‚¬ìš© ê°€ì´ë“œ</h2>

        <div id="helpPages" class="help-content">
            <div class="help-page page1">
                <b>ë¡œê·¸ì¸</b><br>
                1) ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´, ì²« ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤.<br>
                - ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì— ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                - ë‹‰ë„¤ì„ì€ ê³ ìœ  ì‹ë³„ìë¡œ ì‚¬ìš©ë˜ë¯€ë¡œ, ì¸ê²Œì„ ë‹‰ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.
            </div>

            <div class="help-page page2" style="display:none;">
                <b>ì„¤ì • ë©”ë‰´</b><br>
                2) ìš°ì¸¡ ìƒë‹¨ì˜ ì„¤ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¤ì • ë©”ë‰´ë¥¼ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - <b>ë¶€ìº ë“±ë¡</b>: ë‹¤ë¥¸ ìºë¦­í„°ë¥¼ ì¶”ê°€ë¡œ ìƒì„±í•´ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - <b>ë‹‰ë„¤ì„ ë³€ê²½</b> ë° <b>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</b> ê°€ëŠ¥.<br>
                - <b>ë¡œê·¸ì•„ì›ƒ</b> ì‹œ í˜„ì¬ ê³„ì •ì´ í•´ì œë˜ë©°, ë‹¤ìŒ ë¡œê·¸ì¸ ë•Œ ë‹¤ì‹œ ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
            </div>

            <div class="help-page page3" style="display:none;">
                <b>ê²½í—˜ì¹˜ ì…ë ¥</b><br>
                3) ë§¤ì¼ ì¼ì •í•œ ì‹œê°„ëŒ€(ì˜ˆ: ì›ê¸°ì˜¥ ì „í›„)ì— <b>ì…ë ¥</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ ê²½í—˜ì¹˜ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”.<br>
                - ê²½í—˜ì¹˜ëŠ” ìµœê·¼ 10ì¼ê°„ì˜ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ í‰ê· ì´ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                - ìµœê·¼ 10ì¼ ì´ë‚´ì— í•˜ë£¨ë§Œ ê¸°ë¡í•œ ê²½ìš°ì—ëŠ” í‰ê· ê³¼ D-dayê°€ í‘œì‹œë˜ì§€ ì•Šìœ¼ë‹ˆ, ìµœì†Œ 2ì¼ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br>
                - ê¸°ë¡ ì‹œê°„ì´ ì¼ì •í• ìˆ˜ë¡ D-day ì˜ˆì¸¡ì´ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.
            </div>

            <div class="help-page page4" style="display:none;">
                <b>ì•„ì¹´ì´ë¸Œ</b><br>
                4) ìš°ì¸¡ ìƒë‹¨ì˜ <b>ê³µê°œ</b> ìŠ¤ìœ„ì¹˜ë¥¼ ì¼œë©´ ì•„ì¹´ì´ë¸Œ ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.<br>
                - ë‹¤ë¥¸ ìœ ì €ë“¤ì˜ ê²½í—˜ì¹˜ ê¸°ë¡ì„ í•¨ê»˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ì˜¤ëŠ˜ ë˜ëŠ” ì–´ì œì˜ ê¸°ë¡ì´ ìˆì–´ì•¼ë§Œ ê³µê°œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                - ë¹„ê³µê°œ ìƒíƒœì—ì„œëŠ” ì•„ì¹´ì´ë¸Œ í˜ì´ì§€ë¡œ ì´ë™ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>

            <div class="help-page page5" style="display:none;">
                <b>í”„ë¡œí•„ ë³€ê²½</b><br>
                5) ë‹‰ë„¤ì„ ì™¼ìª½ì˜ <b>í”„ë¡œí•„ ì´ë¯¸ì§€</b>ë¥¼ ëˆ„ë¥´ë©´ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ê°€ì… í›„ ì¼ì • ì¡°ê±´(7ì¼ ì´ìƒ ê¸°ë¡ ë‹¬ì„±)ì„ ë§Œì¡±í•˜ë©´ ìƒˆë¡œìš´ ì´ë¯¸ì§€ê°€ í•´ê¸ˆë©ë‹ˆë‹¤.<br>
                - í•´ê¸ˆëœ ì´ë¯¸ì§€ëŠ” ììœ ë¡­ê²Œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <div class="help-page page6" style="display:none;">
                <b>ëª©í‘œ ê²½í—˜ì¹˜ ì„¤ì •</b><br>
                6) ë§Œë ™(100ë ˆë²¨)ì— ë„ë‹¬í•œ í›„ì—ëŠ” <b>ëª©í‘œ ê²½í—˜ì¹˜</b>ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ì„¤ì • ë©”ë‰´ì—ì„œ <b>ëª©í‘œ ì„¤ì •</b>ì„ ì„ íƒí•˜ë©´ ìµœëŒ€ 5ê°œì˜ ëª©í‘œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ê° ëª©í‘œëŠ” ê²½í—˜ì¹˜ ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ë©°, <b>ì‰¼í‘œ(,)</b>ë¡œ êµ¬ë¶„ ì—†ì´ ìˆ«ìë§Œ ì ìœ¼ë©´ ë©ë‹ˆë‹¤.<br>
                - ê¸°ë¡ëœ í‰ê·  ê²½í—˜ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª©í‘œ ë‹¬ì„± ì˜ˆìƒì¼(D-day)ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                - ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë©´ <b>ë‹¤ìŒ ëª©í‘œ</b>ë¡œ ìë™ ì „í™˜ë˜ë©°, ìƒˆë¡œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            </div>

            <div class="help-page page7" style="display:none;">
                <b>ê¸°ë¡ ìˆ˜ì •</b><br>
                7) í™”ë©´ í•˜ë‹¨ì˜ ì¼ìë³„ ê¸°ë¡í‘œì—ì„œ í•­ëª©ì„ ëˆŒëŸ¬ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                - ì‹¤ìˆ˜ë¡œ ì˜ëª» ì…ë ¥í•œ ê²½í—˜ì¹˜ë‚˜ ë ˆë²¨ì€ ì´ê³³ì—ì„œ ë°”ë¡œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                - ìˆ˜ì • ë‚´ì—­ì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
            </div>
        </div>

        <div>
            <div id="helpDots" class="help-dots"></div>
        </div>

        <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="helpPagination" class="help-pagination">
            <button id="prevHelpPage" class="help-btn">ã€ˆ ì´ì „</button>
            <button id="nextHelpPage" class="help-btn">ë‹¤ìŒ ã€‰</button>
        </div>

        <div class="help-tip">ë‹¤ì‹œ ë³´ê³  ì‹¶ì„ ë•, í™”ë©´ ìƒë‹¨ì˜ <b>?</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        set,
        get,
        remove,
        query,
        orderByKey,
        limitToLast,
        endAt
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // âœ… ê³µí†µ ìœ í‹¸ ëª¨ë“ˆ
    import {calcAvgExp, calcDDay} from "../common/expUtils.js";
    import {levelExp} from "../common/levelExp.js";
    import {
        getKoreanDate,
        getKoreanTimestamp,
        validateNickname,
        validatePassword,
        validateDateNotFuture,
        validateUniqueGoals,
        addComma,
        removeComma,
        bindNumericCommaFormatter,
        getActiveNickname,
        getActiveSubNickname,
        setActiveNickname,
        goToPage,
        showAlert,
        closeAlert,
        showConfirm
    } from "../common/utils.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    $(".logoutBtn").on("click", function () {
        showConfirm("ì •ë§ ë¡œê·¸ì•„ì›ƒí• ê¹Œìš”?", async (ok) => {
            if (ok) {
                localStorage.removeItem("coffee-nickname");
                localStorage.removeItem("coffee-subnickname");
                location.reload();
            }
        });
    });

    $(".layoutBtn").on("click", function () {
        goToPage("layout");
    });

    $(".baristaBtn").on("click", function () {
        goToPage("barista");
    });

    $(".memoryBtn").on("click", function () {
        goToPage("memory");
    });

    // âœ… ë¶€ìº ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    $(document).on("click", ".addSubCharacterBtn", function () {
        // ê¸°ì¡´ ëª¨ë‹¬ ìˆìœ¼ë©´ ì œê±°
        $("#subLoginPopup").show();
    });

    // âœ… ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", "#closeSubLoginPopup", function () {
        $("#subLoginPopup").hide();
    });

    // âœ… ë¶€ìº ë¡œê·¸ì¸/ë“±ë¡ ì²˜ë¦¬
    $(document).on("click", "#subLoginBtn", async function () {
        const nickname = $("#subNickname").val().trim();
        const password = $("#subPassword").val().trim();
        const $msg = $("#subMessage");

        if (!nickname || !password) {
            $msg.css("color", "red").text("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        if (!validateNickname(nickname)) return;
        if (!validatePassword(password)) return;

        const passwordRef = ref(db, `coffeeUsers/${nickname}/password`);
        const snapshot = await get(passwordRef);

        if (snapshot.exists()) {
            if (snapshot.val() === password) {
                $msg.css("color", "green").text("ë¶€ìº ë¡œê·¸ì¸ ì„±ê³µ!");
                setActiveNickname(nickname, "coffee-subnickname");
                setTimeout(() => {
                    $("#subLoginPopup").hide();
                    showAlert(`ë¶€ìº "${nickname}" ë“±ë¡ ì™„ë£Œ!`);
                    addSubCharacterButton();
                }, 800);
            } else {
                $msg.css("color", "red").text("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        } else {
            // ìƒˆ ë¶€ìº ìƒì„±
            await set(ref(db, `coffeeUsers/${nickname}`), {
                password, signupDate: getKoreanTimestamp(),
            });
            setActiveNickname(nickname, "coffee-subnickname");
            $msg.css("color", "green").text("ìƒˆ ë¶€ìº ê³„ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            setTimeout(() => {
                $("#subLoginPopup").hide();
                showAlert(`ë¶€ìº "${nickname}" ë“±ë¡ ì™„ë£Œ!`);
                addSubCharacterButton();
            }, 800);
        }
    });

    // âœ… ë¶€ìº ì „í™˜ ë²„íŠ¼ ì¶”ê°€ í•¨ìˆ˜
    function addSubCharacterButton() {
        const subNick = getActiveSubNickname();
        if (!subNick) return; // ë¶€ìº ì—†ìœ¼ë©´ ì¤‘ë‹¨

        const $subCharacterBtn = $(".subCharacterBtn");

        // ë²„íŠ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ í…ìŠ¤íŠ¸ êµì²´
        $subCharacterBtn.show();
        $subCharacterBtn.text(subNick);

        // í´ë¦­ ì‹œ ë¶€ìºë¡œ ì „í™˜
        $subCharacterBtn.on("click", () => {
            const originNick = localStorage.getItem("coffee-nickname");
            const subNick = localStorage.getItem("coffee-subnickname");
            if (!subNick) return showAlert("ë“±ë¡ëœ ë¶€ìºê°€ ì—†ìŠµë‹ˆë‹¤.");

            localStorage.setItem("coffee-nickname", subNick);
            localStorage.setItem("coffee-subnickname", originNick);
            setTimeout(() => location.reload(), 1000);
        });
    }

    // âœ… ì„¤ì • ë²„íŠ¼ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ í† ê¸€
    $("#settingsBtn").on("click", function (e) {
        e.stopPropagation();
        $("#settingsDropdown").toggle();
    });

    // âœ… ë‹¤ë¥¸ ê³³ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    $(document).on("click", function (e) {
        if (!$(e.target).closest(".settings-menu").length) {
            $("#settingsDropdown").hide();
        }
    });

    // âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì•ˆì˜ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
    $(document).on("click", "#settingsDropdown button", function () {
        $("#settingsDropdown").hide();
    });

    // âœ… ê²½í—˜ì¹˜ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $("#closeExpModal").on("click", function () {
        $("#expModal").hide();
    });

    // ================================
    // âœ… ê²½í—˜ì¹˜í‘œ í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ëŠ¥
    // ================================
    let currentExpPage = 0;
    const levelsPerPage = 10;

    // âœ… í…Œì´ë¸” í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜
    function renderExpTablePage(userLevel) {
        const totalLevels = levelExp.length;
        const $tbody = $("#expChartTable tbody");
        $tbody.empty();

        const start = currentExpPage * levelsPerPage;
        const end = Math.min(start + levelsPerPage, totalLevels);

        for (let i = start; i < end; i++) {
            const need = levelExp[i];
            const isMyLevel = i === userLevel;
            const bg = isMyLevel ? "#ede8ff" : i % 2 === 0 ? "#fff" : "#faf9fd";
            const color = isMyLevel ? "#5a4398" : "#333";
            const fontWeight = isMyLevel ? "700" : "500";

            $("#expChartTable tbody").append(`
            <tr style="background:${bg}; color:${color}; font-weight:${fontWeight};">
                <td style="padding:8px; border:1px solid #e0dff2;">
                    ${i} -> ${i + 1}
                </td>
                <td style="padding:8px; border:1px solid #e0dff2;">
                    ${need ? need.toLocaleString() : '-'}
                </td>
            </tr>
        `);
        }
    }

    // âœ… ëª¨ë‹¬ ì—´ ë•Œ í˜„ì¬ êµ¬ê°„ë¶€í„° í‘œì‹œ
    $(".expTableBtn").off("click").on("click", function () {
        const userLevel = parseInt($("#currentLevelDisplay").text()) || 1;
        currentExpPage = Math.floor((userLevel - 1) / levelsPerPage);
        $("#expTableModal").css("display", "flex");
        renderExpTablePage(userLevel);
    });

    // âœ… ì´ì „ / ë‹¤ìŒ ë²„íŠ¼ ê¸°ëŠ¥
    $("#prevExpPage").on("click", function () {
        const userLevel = parseInt($("#currentLevelDisplay").text()) || 1;
        if (currentExpPage > 0) {
            currentExpPage--;
            renderExpTablePage(userLevel);
        }
    });

    $("#nextExpPage").on("click", function () {
        const userLevel = parseInt($("#currentLevelDisplay").text()) || 1;
        const totalPages = Math.ceil(levelExp.length / levelsPerPage);
        if (currentExpPage < totalPages - 1) {
            currentExpPage++;
            renderExpTablePage(userLevel);
        }
    });

    $("#closeExpTableModal").on("click", function () {
        $("#expTableModal").hide();
    });

    // ğŸ”¹ ëª¨ë“  ë²„íŠ¼ì˜ ë¹ ë¥¸ ì—°ì† í´ë¦­(ë”ë¸”í´ë¦­) ë°©ì§€
    $(document).on("click", "button", function (e) {
        const $btn = $(this);

        // ì´ë¯¸ ì ê²¨ ìˆìœ¼ë©´ ì‹¤í–‰ ë§‰ê¸°
        if ($btn.data("clicked")) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }

        // 0.8ì´ˆê°„ í´ë¦­ ì ê¸ˆ
        $btn.data("clicked", true);
        setTimeout(() => {
            $btn.removeData("clicked");
        }, 800);
    });

    // ============================
    // âœ… (3) í–‰ í´ë¦­ ì‹œ ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
    // ============================
    let selectedDate = null;
    $(document).on("click", ".exp-row", function () {
        selectedDate = $(this).data("date");
        $("#optionModal").css("display", "flex");
    });

    // âœ… ì˜µì…˜ ëª¨ë‹¬ - ë‹«ê¸°
    $(document).on("click", "#closeOptionBtn", function () {
        $("#optionModal").hide();
    });

    // âœ… ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì‰¼í‘œ ìˆëŠ” ê°’ìœ¼ë¡œ í‘œì‹œ
    $(document).on("click", "#editExpBtn", async function () {
        const nickname = getActiveNickname();
        if (!nickname || !selectedDate) return;
        const recordRef = ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`);
        const snapshot = await get(recordRef);
        if (snapshot.exists()) {
            const record = snapshot.val();
            $("#editExpDate").val(selectedDate);
            $("#editLevelValue").val(record.level || 1);
            $("#editExpValue").val(record.exp.toLocaleString()); // âœ… ì‰¼í‘œ í¬í•¨ í‘œì‹œ
            $("#optionModal").hide();
            $("#editModal").css("display", "flex");
        }
    });

    // âœ… ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    $(document).on("click", "#closeEditModal", function () {
        $("#editModal").hide();
    });

    // âœ… ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", "#alertConfirmBtn", function () {
        closeAlert();
    });

    // âœ… ê²½í—˜ì¹˜ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì‰¼í‘œ ì¶”ê°€ (ì…ë ¥í•  ë•Œë§ˆë‹¤ í¬ë§· ì ìš©)
    $(document).on("input", "#todayExp, #editExpValue", function () {
        bindNumericCommaFormatter("#todayExp, #editExpValue", 1_000_000_000_000, "ê²½í—˜ì¹˜ëŠ” ìµœëŒ€ 1ì¡°ê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
    });

    let profileNum = 1;
    $(function () {
        const todayValue = "v6";
        const lastUpdate = localStorage.getItem("LU-update");

        if (lastUpdate !== todayValue) {
            showAlert("! ë³´ì•ˆ ê°•í™” ì•ˆë‚´ !\nëª¨ë“  ê³„ì •ì´ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.\në¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì€ ê²½ìš° ì•Œë ¤ì£¼ì„¸ìš”!");
            localStorage.setItem("LU-update", todayValue);
        }

        const $popup = $("#loginPopup");
        const $mainPage = $("#mainPage");
        const $loadingScreen = $("#loadingScreen");
        const $msg = $("#message");
        const $nicknameDisplay = $("#nicknameDisplay");
        const $currentLevelDisplay = $("#currentLevelDisplay");

        const savedNick = getActiveNickname();
        if (savedNick) {
            const userRef = ref(db, `coffeeUsers/${savedNick}`);
            get(userRef).then(async snapshot => {
                if (snapshot.exists()) {
                    // âœ… ì •ìƒ ê³„ì •ì´ë©´ í˜ì´ì§€ í‘œì‹œ
                    if (savedNick == getActiveNickname()) {
                        await set(ref(db, `coffeeUsers/${savedNick}/lastLogin`), getKoreanTimestamp());
                    }
                    $loadingScreen.hide();
                    $mainPage.css("display", "flex");
                    loadUserData(savedNick);
                    await loadTodayLevelUpUsers();
                } else {
                    // âŒ DBì— ì—†ëŠ” ë‹‰ë„¤ì„ì¼ ê²½ìš° ìë™ ì œê±°
                    console.warn("ì €ì¥ëœ ë‹‰ë„¤ì„ì´ ìœ íš¨í•˜ì§€ ì•Šì•„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
                    localStorage.removeItem("coffee-nickname");
                    $loadingScreen.hide();
                    $popup.show();
                }
            }).catch(err => {
                console.error("ë°ì´í„° í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                localStorage.removeItem("coffee-nickname");
                $loadingScreen.hide();
                $popup.show();
            });
        } else {
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ íŒì—… ìœ ì§€
            $loadingScreen.hide();
            $popup.show();
            localStorage.removeItem("coffee-nickname");
            localStorage.removeItem("coffee-subnickname");
        }

        // âœ… ë¡œê·¸ì¸ ì²˜ë¦¬
        $("#loginBtn").on("click", async function () {
            const nickname = $("#nickname").val().trim();
            const password = $("#password").val().trim();

            if (!nickname || !password) {
                $msg.text("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            if (!validateNickname(nickname)) return;

            if (!validatePassword(password)) return;

            const passwordRef = ref(db, `coffeeUsers/${nickname}/password`);
            const snapshot = await get(passwordRef);

            /*
            console.log(`snapshot : ${snapshot.val()}`);
            console.log(`password : ${password}`);
             */

            if (snapshot.exists()) {
                if (snapshot.val() === password) {
                    $msg.css("color", "green").text("ë¡œê·¸ì¸ ì„±ê³µ!");
                    setActiveNickname(nickname);
                    setTimeout(() => {
                        $popup.hide();
                        $mainPage.css("display", "flex");
                        loadUserData(nickname);
                    }, 800);
                } else {
                    $msg.css("color", "red")
                        .html("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì´ê±°ë‚˜<br>ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            } else {
                await set(ref(db, `coffeeUsers/${nickname}`), {
                    password, signupDate: getKoreanTimestamp(),   // ê°€ì…ì¼ ì €ì¥
                });
                $msg.css("color", "green").text("ìƒˆ ê³„ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                setActiveNickname(nickname);
                setTimeout(() => {
                    $popup.hide();
                    $mainPage.css("display", "flex");
                    loadUserData(nickname);
                }, 800);
            }
        });

        // âœ… ê²½í—˜ì¹˜ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
        $("#expButton").on("click", async function () {
            const today = getKoreanDate();
            $("#expDate").val(today);

            const nickname = getActiveNickname();
            if (nickname) {
                const userRef = ref(db, `coffeeUsers/${nickname}/level`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    $("#todayLevel").val(snapshot.val()); // ğŸ”¹ ê¸°ë³¸ê°’ ì„¤ì •
                }
            }

            $("#expModal").css("display", "flex");
        });

        // âœ… ê²½í—˜ì¹˜ ì €ì¥ ë²„íŠ¼
        $("#saveExpBtn").on("click", async function () {
            await saveExp();
            $("#todayExp").val("");
            $("#expModal").hide();
        });

        // âœ… ê²½í—˜ì¹˜ ì €ì¥ í•¨ìˆ˜ (ì‰¼í‘œ ì œê±° í›„ ì €ì¥)
        async function saveExp() {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

            // ğŸ”¹ ì‰¼í‘œ ì œê±° í›„ ìˆ«ì ë³€í™˜
            const exp = parseInt($("#todayExp").val().replace(/,/g, ""));
            const level = parseInt($("#todayLevel").val());
            const dateInput = $("#expDate").val();
            if (!validateDateNotFuture(dateInput)) return;
            const selectedDate = dateInput || getKoreanDate();

            if (isNaN(exp) || exp < 0) return showAlert("ê²½í—˜ì¹˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!level || level < 1 || level > 100) return showAlert("ë ˆë²¨ì€ 1~100 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.");

            // âœ… ì „ì²´ ê¸°ë¡ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸°
            const recordsRef = ref(db, `coffeeUsers/${nickname}/expRecords`);
            const allRecordsSnap = await get(recordsRef);
            const allRecords = allRecordsSnap.exists() ? allRecordsSnap.val() : {};

            // âœ… ì´ë¯¸ ê°™ì€ ë‚ ì§œê°€ ìˆìœ¼ë©´ ì¤‘ë³µ ì°¨ë‹¨
            if (allRecords[selectedDate]) {
                return showAlert("ì´ë¯¸ í•´ë‹¹ ë‚ ì§œì— ê²½í—˜ì¹˜ë¥¼ ì…ë ¥í–ˆìŠµë‹ˆë‹¤!");
            }

            // âœ… ë°”ë¡œ ì´ì „ ë‚ ì§œ ì°¾ê¸°
            const dates = Object.keys(allRecords).sort();
            const prevDate = dates[dates.length - 1];

            if (prevDate && prevDate < selectedDate) {
                const prevRecord = allRecords[prevDate];
                const prevLevel = prevRecord.level;
                const prevExp = prevRecord.exp;

                // ğŸ”¸ ê°™ì€ ë ˆë²¨ì¸ë° ê²½í—˜ì¹˜ê°€ ë‚®ìœ¼ë©´ ì…ë ¥ ê¸ˆì§€
                if (level === prevLevel && exp < prevExp) {
                    return showAlert(`ì´ì „ ê¸°ë¡(${prevDate})ë³´ë‹¤ ë‚®ì€ ê²½í—˜ì¹˜ëŠ” ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            }

            // âœ… ìƒˆ ê¸°ë¡ ì €ì¥ (ì‰¼í‘œ ì—†ëŠ” ì •ìˆ˜ ì €ì¥)
            await set(ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`), {
                level, exp, savedAt: getKoreanTimestamp(),
            });

            // ğŸ”¹ í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
            const currentLevelVal = parseInt($("#currentLevelDisplay").text()) || 1;

            // ğŸ”¹ ìƒˆë¡œ ì…ë ¥í•œ ë ˆë²¨ì´ ê¸°ì¡´ë³´ë‹¤ ë†’ì„ ë•Œë§Œ ê°±ì‹ 
            if (level > currentLevelVal) {
                await set(ref(db, `coffeeUsers/${nickname}/level`), level);
            }

            showAlert(`ë ˆë²¨ ${level}\nê²½í—˜ì¹˜ ${exp.toLocaleString()} ì €ì¥ ì™„ë£Œ!`);
            $("#expModal").hide();
            $("#todayExp").val("");

            await loadUserData(nickname);
        }

        // âœ… ì•„ì¹´ì´ë¸Œ ë²„íŠ¼ ì¶”ê°€ í•¨ìˆ˜
        function addRankingButton() {
            $(".rankingBtn").show();
        }

        // âœ… ì•„ì¹´ì´ë¸Œ ë²„íŠ¼ ì œê±° í•¨ìˆ˜
        function removeRankingButton() {
            $(".rankingBtn").hide();
        }

        // âœ… ì‚¬ìš©ì ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadUserData(nickname) {
            const userRef = ref(db, `coffeeUsers/${nickname}`);
            const snapshot = await get(userRef);

            $("#optionModal, #editModal").remove(); // ì¤‘ë³µ ë°©ì§€ìš©

            if (snapshot.exists()) {
                const userData = snapshot.val();

                // ğŸ”¹ ì˜¤ë˜ëœ ê¸°ë¡(1ë…„ ì´ˆê³¼)ì€ ìë™ ì‚­ì œ
                /*
                if (userData.expRecords) {
                    // ğŸ”¹ í˜„ì¬ í•œêµ­ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                    const now = new Date();
                    const koreaNow = new Date(now.getTime());
                    const oneYearAgo = new Date(koreaNow.getTime() - 365 * 24 * 60 * 60 * 1000);
                    let deletedCount = 0;

                    for (const date in userData.expRecords) {
                        const [y, m, d] = date.split("-").map(Number);
                        const recordDate = new Date(y, m - 1, d);
                        if (recordDate < oneYearAgo) {
                            await remove(ref(db, `coffeeUsers/${nickname}/expRecords/${date}`));
                            deletedCount++;
                        }
                    }

                    if (deletedCount > 0) {
                        showAlert(`1ë…„ ì´ìƒ ì§€ë‚œ ê¸°ë¡ ${deletedCount}ê±´ì´ ìë™ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }
                 */

                // ğŸ”¹ ë ˆë²¨ ì—†ì„ ë•Œ ë ˆë²¨ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                if (!userData.level) {
                    $("#levelModal").css("display", "flex");
                    return;
                } else {
                    // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ (ë‹‰ë„¤ì„ ì•)
                    profileNum = userData.profileImg || profileNum;
                    const profileSrc = `../image/profile${profileNum}.jpg`;

                    // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê°±ì‹ , ì—†ìœ¼ë©´ ì¶”ê°€
                    if ($("#nicknameDisplay").prev(".profile-img").length > 0) {
                        $("#nicknameDisplay").prev(".profile-img").attr("src", profileSrc);
                    } else {
                        $("<img>")
                            .attr("src", profileSrc)
                            .attr("alt", "í”„ë¡œí•„ ì´ë¯¸ì§€")
                            .addClass("profile-img")
                            .css({
                                width: "28px", height: "28px", borderRadius: "5px", objectFit: "cover",
                            })
                            .insertBefore("#nicknameDisplay");
                    }

                    // ë‹‰ë„¤ì„ / ë ˆë²¨ í‘œì‹œ
                    $nicknameDisplay.text(`${nickname}`);
                    $currentLevelDisplay.text(`${userData.level}`);
                }

                // ğŸ”¹ ê´€ë¦¬ìì¼ ê²½ìš° ê´€ë¦¬ì í˜ì´ì§€ ë²„íŠ¼ í‘œì‹œ
                if (userData.isAdmin) {
                    const $adminBtn = $('.adminBtn');

                    $adminBtn.show();
                }

                // âœ… ë¡œë“œ ì‹œ ë¶€ìº ë²„íŠ¼ ê²€ì‚¬
                addSubCharacterButton();

                if (userData.memoryRoomPublic) {
                    $(".memoryRoomBtn").show();
                }

                if (userData.expRecords) {
                    const records = userData.expRecords;
                    const sorted = Object.keys(records).sort();
                    const $tbody = $("#expTable tbody");
                    $tbody.empty();

                    const pageSize = 10;
                    const totalRecords = sorted.length;
                    const totalPages = Math.ceil(totalRecords / pageSize);
                    let currentPage = 1;

                    let prevExp = null;
                    let prevLevel = null;
                    let prevDate = null;
                    let diffs = []; // ğŸ”¸ íšë“ ê²½í—˜ì¹˜ ì €ì¥ìš©

                    sorted.forEach(date => {
                        const currentExp = records[date].exp || 0;
                        const currentLevel = records[date].level || userData.level;
                        let gained = "-";
                        let approx = "";

                        // ğŸ”¹ ë‚ ì§œ í¬ë§· ë³€ê²½
                        const [yyyy, mm, dd] = date.split("-");
                        const formattedDate = `${mm}.${dd}`;

                        if (prevExp !== null && prevLevel !== null) {
                            // ğŸ”¹ ë‘ ë‚ ì§œ ì‚¬ì´ì˜ ê°„ê²© ê³„ì‚°
                            const prevD = new Date(prevDate);
                            const curD = new Date(date);
                            const diffDays = Math.floor((curD - prevD) / (1000 * 60 * 60 * 24));

                            let diff = 0;
                            if (currentLevel > prevLevel) {
                                diff += (levelExp[prevLevel] - prevExp);
                                for (let lv = prevLevel + 1; lv < currentLevel; lv++) {
                                    diff += levelExp[lv];
                                }
                                diff += currentExp;
                            } else if (currentLevel === prevLevel && currentExp >= prevExp) {
                                diff = currentExp - prevExp;
                            }

                            if (diff > 0) {
                                gained = diff.toLocaleString();
                                const man = Math.floor(diff / 10000);
                                approx = man >= 1 ? `ì•½ ${man}ë§Œ` : '';
                            } else {
                                gained = "0";
                            }

                            diffs.push(diff);

                            // âœ… ì¤‘ê°„ ë‚ ì§œ(í•˜ë£¨ ì´ìƒ ë¹„ì—ˆì„ ë•Œ) 0 ê²½í—˜ì¹˜ ì¶”ê°€
                            if (diffDays > 1) {
                                for (let i = 1; i < diffDays; i++) {
                                    diffs.push(0);
                                }
                            }
                        }

                        $tbody.prepend(`
                            <tr class="exp-row" data-date="${date}">
                                <td>${formattedDate}</td>
                                <td>${currentLevel}</td>
                                <td>${currentExp.toLocaleString()}</td>
                                <td>${gained}<br><span style="color:red">${approx}</span></td>
                            </tr>
                        `);

                        prevExp = currentExp;
                        prevLevel = currentLevel;
                        prevDate = date; // âœ… ì´ì „ ë‚ ì§œ ì €ì¥
                    });

                    // ğŸ”¸ í‰ê·  ê³„ì‚° ë° ì „ì²´ ë ˆë²¨ì—… ì˜ˆì •ì¼ í‘œì‹œ (ë ˆë²¨ì—… ì‹œ ê²½í—˜ì¹˜ 0ìœ¼ë¡œ ì´ˆê¸°í™” êµ¬ì¡°)
                    if (Object.keys(records).length > 1 && userData.level) {
                        const today = new Date();

                        // âœ… í‰ê·  ê²½í—˜ì¹˜ ê³„ì‚° (ìœ í‹¸ ì‚¬ìš©)
                        const recordArray = Object.keys(records)
                            .sort()
                            .map(date => [date, records[date]]); // [ë‚ ì§œ, {level, exp}] í˜•íƒœë¡œ ë³€í™˜

                        const avgGain = calcAvgExp(recordArray);

                        if (!avgGain || avgGain <= 0 || isNaN(avgGain)) {
                            $("#levelUpBox").html(`<p style="color:#999;">ìµœê·¼ ê²½í—˜ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`);
                        } else {
                            // âœ… ìµœê·¼ ê¸°ë¡ ë° í˜„ì¬ ìƒíƒœ ê³„ì‚°
                            const sortedDates = Object.keys(records).sort();
                            const latestDate = sortedDates[sortedDates.length - 1];
                            const latestRecord = records[latestDate];
                            const currentLevel = userData.level;
                            const currentExp = latestRecord.exp || 0;

                            // âœ… ë§ˆì§€ë§‰ ê²½í—˜ì¹˜ ì…ë ¥ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ë„ë¡ ìˆ˜ì •
                            const latestDateObj = new Date(latestDate);
                            const koreaNow = new Date(latestDateObj.getTime());

                            // âœ… í‰ê· ê°’ ì¶œë ¥
                            if (avgGain < 10000) {
                                $("#avgExp").html(`${Math.floor(avgGain).toLocaleString()}`);
                            } else {
                                const man = Math.floor(avgGain / 10000);
                                $("#avgExp").html(`${Math.floor(avgGain).toLocaleString()}<br>( ì•½ ${man}ë§Œ )`);
                            }

                            // âœ… ë‚¨ì€ ê²½í—˜ì¹˜ ê³„ì‚° ë° í‘œì‹œ
                            if (userData.level < levelExp.length) {
                                // ì¼ë°˜ ë ˆë²¨ì—… ëª¨ë“œ
                                const nextNeedExp = levelExp[userData.level]; // ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ í•„ìš”í•œ ì´ ê²½í—˜ì¹˜
                                const remainExp = Math.max(nextNeedExp - currentExp, 0);

                                // âœ… ë‚¨ì€ ê²½í—˜ì¹˜ í¼ì„¼íŠ¸ ê³„ì‚°
                                const percent = ((remainExp / nextNeedExp) * 100).toFixed(1);
                                $(".status-percent").text(`( ${percent}% )`);

                                let approx = "";
                                if (remainExp >= 100000000) { // 1ì–µ ì´ìƒ
                                    const eok = Math.floor(remainExp / 100000000);
                                    approx = `( ì•½ ${eok.toLocaleString()}ì–µ )`;
                                } else if (remainExp >= 10000) { // 1ë§Œ ì´ìƒ
                                    const man = Math.floor(remainExp / 10000);
                                    approx = `( ì•½ ${man.toLocaleString()}ë§Œ )`;
                                }

                                $("#curExp").html(`${remainExp.toLocaleString()}<br>${approx}`);
                            } else if (userData.goalTargets?.length > 0) {
                                // ë§Œë ™ + ëª©í‘œ ê²½í—˜ì¹˜ ëª¨ë“œ
                                const goalTargets = userData.goalTargets.sort((a, b) => a - b);
                                const nextGoal = goalTargets.find(g => g > currentExp);

                                if (nextGoal) {
                                    const remainExp = Math.max(nextGoal - currentExp, 0);

                                    let approx = "";
                                    if (remainExp >= 100000000) {
                                        const eok = Math.floor(remainExp / 100000000);
                                        approx = `( ì•½ ${eok.toLocaleString()}ì–µ )`;
                                    } else if (remainExp >= 10000) {
                                        const man = Math.floor(remainExp / 10000);
                                        approx = `( ì•½ ${man.toLocaleString()}ë§Œ )`;
                                    }

                                    $("#curExp").html(`${remainExp.toLocaleString()}<br>${approx}`);
                                } else {
                                    $("#curExp").html("ë‹¬ì„±ì™„ë£Œ");
                                }
                            }

                            const toDay = new Date();
                            toDay.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ 00:00:00 ìœ¼ë¡œ ê³ ì •

                            // âœ… ë§Œë ™ì´ë©´ ëª©í‘œ ê¸°ì¤€ í…Œì´ë¸”, ì•„ë‹ˆë©´ ë ˆë²¨ì—… í…Œì´ë¸”
                            if (userData.level >= levelExp.length && userData.goalTargets?.length > 0 && avgGain > 0) {
                                $("#levelUpBox").empty();
                                const goalTargets = userData.goalTargets.sort((a, b) => a - b);

                                let goalTable = `
                                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                    <thead>
                                        <tr style="background:#f6f4fc; color:#5a4398;">
                                            <th style="padding:8px; border:1px solid #e0dff2;">ëª©í‘œ</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">D-day</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">ì˜ˆìƒ ë„ë‹¬ì¼</th>
                                        </tr>
                                    </thead>
                                <tbody>
                            `;

                                goalTargets
                                    .filter(goal => goal > currentExp)
                                    .forEach(goal => {
                                        const remainExp = Math.max(goal - currentExp, 0);
                                        const daysNeeded = Math.ceil(remainExp / avgGain);
                                        const estDate = new Date(koreaNow);
                                        estDate.setDate(koreaNow.getDate() + daysNeeded);
                                        const yyyy = estDate.getFullYear();
                                        const mm = String(estDate.getMonth() + 1).padStart(2, "0");
                                        const dd = String(estDate.getDate()).padStart(2, "0");
                                        estDate.setHours(0, 0, 0, 0);
                                        const dDay = Math.ceil((estDate - toDay) / (1000 * 60 * 60 * 24));

                                        let formattedGoal = goal < 10000
                                            ? goal.toLocaleString()
                                            : goal < 100000000
                                                ? `${Math.floor(goal / 10000)}ë§Œ`
                                                : `${Math.floor(goal / 100000000)}ì–µ`;

                                        goalTable += `
                                        <tr>
                                           <td style="padding:8px; border:1px solid #e0dff2;">${formattedGoal}</td>
                                           <td style="padding:8px; border:1px solid #e0dff2;">${dDay > 0 ? 'D-' + dDay : dDay === 0 ? 'D-day' : '-'}</td>
                                           <td style="padding:8px; border:1px solid #e0dff2;">${yyyy}-${mm}-${dd}</td>
                                        </tr>`;

                                    });

                                goalTable += `</tbody></table>`;
                                $("#levelUpBox").append(goalTable);

                            } else {
                                // ğŸ”¹ ì¼ë°˜ ë ˆë²¨ì—… í…Œì´ë¸” (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
                                let tableHTML = `
                                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                    <thead>
                                        <tr style="background:#f6f4fc; color:#5a4398;">
                                            <th style="padding:8px; border:1px solid #e0dff2;">ëª©í‘œ ë ˆë²¨</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">D-day</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">ì˜ˆìƒ ë„ë‹¬ì¼</th>
                                        </tr>
                                    </thead>
                                <tbody>
                            `;

                                let accumulatedExp = 0;
                                let curExp = currentExp;
                                const maxLevel = Math.min(currentLevel + 5, levelExp.length);

                                for (let lvl = currentLevel; lvl < maxLevel; lvl++) {
                                    const needExp = levelExp[lvl];
                                    if (!needExp) break;
                                    accumulatedExp += Math.max(needExp - curExp, 0);
                                    const daysNeeded = Math.ceil(accumulatedExp / avgGain);
                                    const estDate = new Date(koreaNow);
                                    estDate.setDate(koreaNow.getDate() + daysNeeded);
                                    const yyyy = estDate.getFullYear();
                                    const mm = String(estDate.getMonth() + 1).padStart(2, "0");
                                    const dd = String(estDate.getDate()).padStart(2, "0");
                                    estDate.setHours(0, 0, 0, 0);
                                    const dDay = Math.ceil((estDate - toDay) / (1000 * 60 * 60 * 24));

                                    if (dDay === 0) await showFireworkCelebration();
                                    if (dDay === 0 || dDay === 1) {
                                        const targetDate = new Date();
                                        targetDate.setDate(targetDate.getDate() + dDay);
                                        const y = targetDate.getFullYear();
                                        const m = String(targetDate.getMonth() + 1).padStart(2, '0');
                                        const d = String(targetDate.getDate()).padStart(2, '0');
                                        const targetStr = `${y}-${m}-${d}`;
                                        const nickname = $('#nicknameDisplay').text().trim();

                                        const dateRef = ref(db, `coffeeLevelUpToday/${targetStr}`);
                                        try {
                                            const snap = await get(dateRef);
                                            let list = snap.exists() ? snap.val() : [];
                                            if (!Array.isArray(list)) list = Object.values(list);
                                            if (!list.includes(nickname)) {
                                                list.push(nickname);
                                                await set(dateRef, list);
                                                console.log(`âœ… D-day ëª©ë¡ ì €ì¥ ì™„ë£Œ: ${targetStr} / ${nickname}`);
                                            }
                                        } catch (err) {
                                            console.error("ë ˆë²¨ì—… D-day ì €ì¥ ì¤‘ ì˜¤ë¥˜:", err);
                                        }
                                    }

                                    tableHTML += `
                                    <tr>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${lvl + 1}ë ˆë²¨</td>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${dDay > 0 ? 'D-' + dDay : dDay === 0 ? 'D-day' : '-'}</td>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${yyyy}-${mm}-${dd}</td>
                                    </tr>
                                `;
                                    curExp = 0;
                                }
                                tableHTML += `</tbody></table>`;
                                $("#levelUpBox").html(tableHTML);
                            }
                        }
                    } else {
                        $("#levelUpBox").html(`<p style="color:#999;">ê³„ì‚°í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤...<br> ë‚´ì¼ë„ ì…ë ¥ ë¶€íƒë“œë ¤ìš”~!</p>`);
                    }

                    // ============================
                    // âœ… (1) ì˜µì…˜ ì„ íƒ ëª¨ë‹¬ ì¶”ê°€
                    // ============================
                    const optionModal = $(`
                        <div id="optionModal" class="login-overlay" style="display:none;">
                            <div class="login-modal">
                                <h3>ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                                <button id="editExpBtn">ìˆ˜ì •</button>
                                <button id="deleteExpBtn">ì‚­ì œ</button>
                                <button id="closeOptionBtn">ë‹«ê¸°</button>
                            </div>
                        </div>
                    `);

                    $("body").append(optionModal);

                    // ============================
                    // âœ… (2) ìˆ˜ì • ëª¨ë‹¬ ì¶”ê°€
                    // ============================
                    const editModal = $(`
                        <div id="editModal" class="login-overlay" style="display:none;">
                            <div class="login-modal" style="position:relative; width:360px;">
                                <button id="closeEditModal" class="closeBtn">âœ•</button>
                                <h2>ê²½í—˜ì¹˜ ìˆ˜ì •</h2>
                                <label style="display:block; text-align:left; color:#555;">ë‚ ì§œ</label>
                                <input id="editExpDate" type="date" style="margin-bottom:10px;">
                                <label style="display:block; text-align:left; color:#555;">í˜„ì¬ ë ˆë²¨</label>
                                <input id="editLevelValue" type="number" min="1" max="100" style="margin-bottom:10px;">
                                <label style="display:block; text-align:left; color:#555;">í˜„ì¬ ê²½í—˜ì¹˜</label>
                                <input id="editExpValue" type="text" inputmode="numeric" style="margin-bottom:10px;">
                                <button id="updateExpBtn">ì €ì¥</button>
                            </div>
                        </div>
                    `);
                    $("body").append(editModal);

                    renderExpChart(userData.expRecords); // âœ… ìµœê·¼ 10ì¼ ê·¸ë˜í”„ í‘œì‹œ
                } else {
                    $("#levelUpBox").html(`<p style="color:#999;">ìƒë‹¨ì˜ ì…ë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ì˜¤ëŠ˜ì˜ ê²½í—˜ì¹˜ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”..!</p>`);
                }

                // âœ… ì•„ì¹´ì´ë¸Œ ê³µê°œ í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœ ë°˜ì˜
                const $toggle = $("#rankingToggle");
                if (userData.rankingPublic) {
                    $toggle.addClass("on");
                } else {
                    $toggle.removeClass("on");
                }

                // âœ… í´ë¦­ ì‹œ ìƒíƒœ í† ê¸€
                $toggle.off("click").on("click", async function () {
                    const nickname = getActiveNickname();
                    const isCurrentlyOn = $toggle.hasClass("on");
                    const newStatus = !isCurrentlyOn;

                    if (newStatus) {
                        // ğŸ”¹ ê³µê°œë¡œ ì „í™˜í•˜ë ¤ í•  ë•Œ
                        showConfirm(
                            "ë‚´ ì •ë³´ê°€ ê³µê°œë˜ë©°,\në‹¤ë¥¸ íšŒì›ì˜ ì •ë³´ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                            async (ok) => {
                                if (ok) {
                                    $toggle.addClass("on");
                                    await set(ref(db, `coffeeUsers/${nickname}/rankingPublic`), true);
                                    addRankingButton();
                                }
                            }
                        );
                    } else {
                        // ğŸ”¹ ë¹„ê³µê°œ ì „í™˜ ì‹œ
                        showConfirm(
                            "ë‚´ ì •ë³´ê°€ ë¹„ê³µê°œë˜ë©°,\në‹¤ë¥¸ íšŒì›ì˜ ì •ë³´ë„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                            async (ok) => {
                                if (ok) {
                                    $toggle.removeClass("on");
                                    await set(ref(db, `coffeeUsers/${nickname}/rankingPublic`), false);
                                    removeRankingButton();
                                }
                            }
                        );
                    }
                });

                $(document).trigger("dataLoaded", [nickname]);
            } else {
                console.log("ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }

            // âœ… ìµœê·¼ 10ì¼ êº¾ì€ì„  ê·¸ë˜í”„ ë Œë”ë§
            function renderExpChart(records) {
                // ğŸ”¹ ê¸°ì¤€ì¼ ê³„ì‚°: ì˜¤ëŠ˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì˜¤ëŠ˜, ì—†ìœ¼ë©´ ì–´ì œ
                const today = new Date();
                const todayStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const hasTodayRecord = !!records[`2025-${todayStr.replace('-', '-')}`] || !!records[todayStr];
                // í˜¹ì‹œ 'YYYY-MM-DD' í˜•ì‹ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë‘˜ ë‹¤ ì²´í¬
                const baseDate = hasTodayRecord ? today : new Date(today.setDate(today.getDate() - 1));

                const allDates = [];
                for (let i = 9; i >= 0; i--) {
                    const d = new Date(baseDate);
                    d.setDate(baseDate.getDate() - i);
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    allDates.push(`${mm}-${dd}`);
                }

                // ğŸ”¹ ê¸°ì¡´ ê¸°ë¡ ì •ë ¬
                const sortedDates = Object.keys(records).sort();
                const expMap = {};
                let prevExp = null;
                let prevLevel = null;

                // ğŸ”¹ ì¦ê°€ëŸ‰ ê³„ì‚°
                sortedDates.forEach(date => {
                    const rec = records[date];
                    const currentExp = rec.exp;
                    const currentLevel = rec.level;

                    let gained = 0;
                    if (prevExp !== null && prevLevel !== null) {
                        if (currentLevel > prevLevel) {
                            gained = (levelExp[prevLevel] - prevExp) + currentExp;
                        } else {
                            gained = Math.max(currentExp - prevExp, 0);
                        }
                    }

                    if (prevExp !== null) expMap[date.slice(5)] = gained; // "MM-DD" í‚¤ ì €ì¥

                    prevExp = currentExp;
                    prevLevel = currentLevel;
                });

                // ğŸ”¹ ëª¨ë“  ë‚ ì§œì— ëŒ€í•´ ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì±„ì›€
                const labels = allDates;
                const values = allDates.map(d => expMap[d] || 0);

                // ğŸ”¹ Chart.js ê·¸ë¦¬ê¸°
                const ctx = document.getElementById('expChart');
                if (!ctx) return;
                if (window.expChartInstance) window.expChartInstance.destroy();

                // ğŸ”¹ ìµœì†Œ/ìµœëŒ€ ê³„ì‚° + ìë™ ëˆˆê¸ˆ ë‹¨ìœ„
                const minValue = Math.min(...values);
                const maxValue = Math.max(...values);
                const range = maxValue - minValue;
                let step;
                if (range > 5_000_000) step = 1_000_000;
                else if (range > 2_000_000) step = 500_000;
                else if (range > 500_000) step = 100_000;
                else if (range > 100_000) step = 50_000;
                else if (range > 10_000) step = 10_000;
                else step = 1_000;

                const minRounded = Math.floor(minValue / step) * step;

                window.expChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.map(d => d.split('-')[1]),
                        datasets: [{
                            label: 'ì¼ë³„ íšë“ ê²½í—˜ì¹˜',
                            data: values,
                            borderColor: '#5a4398',
                            backgroundColor: 'rgba(90, 67, 152, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#5a4398'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: minRounded,
                                ticks: {
                                    color: '#5a4398',
                                    stepSize: step,
                                    callback: function (value) {
                                        if (value >= 10000) {
                                            return (value / 10000).toFixed(1).replace(/\.0$/, '') + 'ë§Œ';
                                        }
                                        return value.toLocaleString();
                                    },
                                    font: { size: 11 }
                                },
                                grid: { color: '#eee' }
                            },
                            x: {
                                ticks: {
                                    color: '#333',
                                    font: { size: 10 }
                                },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.parsed.y.toLocaleString()} EXP`
                                }
                            }
                        }
                    }
                });
            }
        }

        // âœ… ë ˆë²¨ ì…ë ¥ ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
        $(document).on("click", "#saveLevelConfirmBtn", async function () {
            const nickname = getActiveNickname();
            const levelVal = parseInt($("#levelInput").val());

            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            if (!levelVal || levelVal < 1 || levelVal > 100) return showAlert("1~100 ì‚¬ì´ì˜ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");

            await set(ref(db, `coffeeUsers/${nickname}/level`), levelVal);
            showAlert(`ë ˆë²¨ ${levelVal}ì´(ê°€) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            $("#levelModal").hide();

            // ì…ë ¥ í›„ ë°”ë¡œ ë‹¤ì‹œ ë°ì´í„° ê°±ì‹ 
            await loadUserData(nickname);
        });

        // âœ… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
        $(document).on("click", "#deleteExpBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname || !selectedDate) return;
            $("#optionModal").hide();
            showConfirm(`${selectedDate} ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?`, async (ok) => {
                if (ok) {
                    // âœ… ì„ íƒí•œ ê¸°ë¡ ì‚­ì œ
                    await remove(ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`));

                    // âœ… ë‚¨ì€ ê¸°ë¡ ì¤‘ ê°€ì¥ ìµœê·¼ ë‚ ì§œì˜ ë ˆë²¨ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ íšŒì› ë ˆë²¨ ê°±ì‹ 
                    const recordsRef = ref(db, `coffeeUsers/${nickname}/expRecords`);
                    const snapshot = await get(recordsRef);

                    if (snapshot.exists()) {
                        const records = snapshot.val();
                        const dates = Object.keys(records).sort(); // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                        const lastDate = dates[dates.length - 1]; // ê°€ì¥ ìµœê·¼ ë‚ ì§œ
                        const latestLevel = records[lastDate].level;

                        // ğŸ”¹ íšŒì› ë ˆë²¨ì„ ìµœì‹  ê¸°ë¡ì˜ ë ˆë²¨ë¡œ ê°±ì‹ 
                        await set(ref(db, `coffeeUsers/${nickname}/level`), latestLevel);
                    } else {
                        // ğŸ”¹ ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œëœ ê²½ìš°, ë ˆë²¨ ì´ˆê¸°í™”
                        await set(ref(db, `coffeeUsers/${nickname}/level`), 1);
                    }

                    showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    $("#optionModal").hide();
                    await loadUserData(nickname);
                }
            });
        });

        // âœ… ìˆ˜ì • ì €ì¥ ë²„íŠ¼ (ì‰¼í‘œ ì œê±° í›„ ì €ì¥)
        $(document).on("click", "#updateExpBtn", async function () {
            const nickname = getActiveNickname();
            const newLevel = parseInt($("#editLevelValue").val());
            const newExp = parseInt($("#editExpValue").val().replace(/,/g, "")); // âœ… ì‰¼í‘œ ì œê±°
            const newDate = $("#editExpDate").val();

            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            if (!newDate || isNaN(newExp) || newLevel < 1 || newLevel > 100) return showAlert("ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            if (!validateDateNotFuture(newDate)) return;

            // ğŸ”¹ ê¸°ì¡´ ì„ íƒëœ ë‚ ì§œ(selectedDate)ëŠ” loadUserData ë‚´ë¶€ì—ì„œ ì „ì—­ë³€ìˆ˜ë¡œ ì„ ì–¸ë˜ì–´ ìˆìŒ
            if (newDate !== selectedDate) {
                // âœ… ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°: ìƒˆë¡œ ì €ì¥ í›„ ê¸°ì¡´ ì‚­ì œ
                const oldRef = ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`);
                const newRef = ref(db, `coffeeUsers/${nickname}/expRecords/${newDate}`);

                await set(newRef, {level: newLevel, exp: newExp, savedAt: getKoreanTimestamp()});
                await remove(oldRef);
            } else {
                // âœ… ë‚ ì§œê°€ ê·¸ëŒ€ë¡œë©´ ë‹¨ìˆœ ìˆ˜ì •
                const refPath = ref(db, `coffeeUsers/${nickname}/expRecords/${newDate}`);
                await set(refPath, {level: newLevel, exp: newExp, savedAt: getKoreanTimestamp()});
            }

            showAlert(`ë ˆë²¨ ${newLevel}\nê²½í—˜ì¹˜ ${newExp.toLocaleString()}(ìœ¼)ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);

            // ğŸ”¹ í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
            const currentLevelVal = parseInt($("#currentLevelDisplay").text()) || 1;

            // ğŸ”¹ ìƒˆë¡œ ì…ë ¥í•œ ë ˆë²¨ì´ ê¸°ì¡´ë³´ë‹¤ ë†’ì„ ë•Œë§Œ ê°±ì‹ 
            if (newLevel > currentLevelVal) {
                await set(ref(db, `coffeeUsers/${nickname}/level`), newLevel);
            }

            $("#editModal").hide();
            await loadUserData(nickname);
        });

        // âœ… ëª©í‘œ ì„¤ì • ë²„íŠ¼ í•¨ìˆ˜
        function addGoalButton() {
            if ($("#goalBtn").length > 0) return; // ì¤‘ë³µ ë°©ì§€

            const goalBtn = $('<button id="goalBtn">ëª©í‘œ ì„¤ì •</button>');
            $("#settingsDropdown").prepend(goalBtn);

            // í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            goalBtn.on("click", async () => {
                const nickname = getActiveNickname();
                if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

                const goalRef = ref(db, `coffeeUsers/${nickname}/goalTargets`);
                const snapshot = await get(goalRef);
                const savedGoals = snapshot.exists() ? snapshot.val() : [];

                // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
                $("#goalModal").remove();

                const modal = $(`
                    <div id="goalModal" class="login-overlay">
                        <div class="login-modal" style="position:relative;">
                            <button id="closeGoalModal" class="closeBtn">âœ•</button>
                            <h2>ëª©í‘œ ì„¤ì •</h2>
                            <div id="goalInputs" style="margin-bottom:10px;"></div>
                            <button id="saveGoalBtn">ì €ì¥</button>
                        </div>
                    </div>
                `);

                $("body").append(modal);

                // ì…ë ¥ì°½ 5ê°œ ìƒì„± (ì‰¼í‘œ í¬í•¨)
                const $goalInputs = $("#goalInputs");
                for (let i = 0; i < 5; i++) {
                    const val = savedGoals[i] ? savedGoals[i].toLocaleString() : "";
                    $goalInputs.append(`
                        <input type="text" class="goalInput" placeholder="ëª©í‘œ ê²½í—˜ì¹˜ ${i + 1}" value="${val}"
                               style="width:100%; padding:8px; margin-bottom:8px;
                               font-size:16px; border:1px solid #ccc; border-radius:6px;">
                    `);
                }

                // âœ… ì‹¤ì‹œê°„ ì‰¼í‘œ í¬ë§· + ìƒí•œ(1ì¡°) ì²´í¬
                $(document).off("input", ".goalInput").on("input", ".goalInput", function () {
                    bindNumericCommaFormatter(".goalInput", 1_000_000_000_000, "ëª©í‘œ ê²½í—˜ì¹˜ëŠ” ìµœëŒ€ 1ì¡°ê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
                });

                // ë‹«ê¸° ë²„íŠ¼
                $(document).off("click", "#closeGoalModal").on("click", "#closeGoalModal", function () {
                    $("#goalModal").remove();
                });

                // ì €ì¥ ë²„íŠ¼ í´ë¦­
                $(document).off("click", "#saveGoalBtn").on("click", "#saveGoalBtn", async function () {
                    const values = $(".goalInput").map((_, el) => {
                        const raw = $(el).val().replace(/,/g, ""); // ì‰¼í‘œ ì œê±°
                        const num = parseInt(raw);
                        return isNaN(num) ? null : num;
                    }).get();

                    const filtered = values.filter(v => v !== null);
                    if (!validateUniqueGoals(filtered)) return;
                    if (filtered.length === 0) {
                        showAlert("ëª©í‘œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                    const sorted = filtered.sort((a, b) => a - b);

                    await set(ref(db, `coffeeUsers/${nickname}/goalTargets`), sorted);
                    showAlert("ëª©í‘œ ê²½í—˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    $("#goalModal").remove();

                    await loadUserData(nickname);
                });
            });
        }

        // âœ… ë§Œë ™ì´ë©´ ëª©í‘œ ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
        async function checkGoalButtonCondition(nickname) {
            const levelRef = ref(db, `coffeeUsers/${nickname}/level`);
            const snapshot = await get(levelRef);
            if (!snapshot.exists()) return;

            const currentLevel = snapshot.val() || 1;
            const maxLevel = levelExp.length; // levelExp ë°°ì—´ ê¸¸ì´ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°

            if (currentLevel >= maxLevel) {
                addGoalButton();
            }
        }

        // âœ… ë¡œê·¸ì¸ ë˜ëŠ” ë°ì´í„° ë¡œë“œ ì‹œ í˜¸ì¶œ
        $(document).on("dataLoaded", function (e, nickname) {
            checkGoalButtonCondition(nickname);
        });

        // âœ… ë‹‰ë„¤ì„ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
        $(document).on("click", ".changeNicknameBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
            $("#nicknameModal").remove();
            const modal = $(`
                <div id="nicknameModal" class="login-overlay">
                    <div class="login-modal" style="position:relative;">
                        <button id="closeNicknameModal" class="closeBtn">âœ•</button>
                        <h2>ë‹‰ë„¤ì„ ë³€ê²½</h2>
                        <input id="newNicknameInput" type="text" value="${nickname}"
                               style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:16px;">
                        <button id="saveNicknameBtn">ì €ì¥</button>
                    </div>
                </div>
            `);
            $("body").append(modal);

            // ë‹«ê¸° ë²„íŠ¼
            $(document).off("click", "#closeNicknameModal").on("click", "#closeNicknameModal", function () {
                $("#nicknameModal").remove();
            });

            // ì €ì¥ ë²„íŠ¼
            $(document).off("click", "#saveNicknameBtn").on("click", "#saveNicknameBtn", async function () {
                const newNick = $("#newNicknameInput").val().trim();
                if (!newNick) return showAlert("ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!validateNickname(newNick)) return;
                if (newNick === nickname) return showAlert("ê¸°ì¡´ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤.");

                const dbRef = ref(db, `coffeeUsers/${nickname}`);
                const snapshot = await get(dbRef);
                if (!snapshot.exists()) return showAlert("ê³„ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const userData = snapshot.val();

                const newRef = ref(db, `coffeeUsers/${newNick}`);
                const checkSnap = await get(newRef);
                if (checkSnap.exists()) {
                    showAlert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");
                    return;
                }

                // âœ… ë‹‰ë„¤ì„ ë³€ê²½ ë¡œê·¸ ì €ì¥
                const safeTimestamp = getKoreanTimestamp().replaceAll('.', '_');
                const randomSuffix = Math.floor(Math.random() * 100); // 0~99
                const logKey = `${safeTimestamp}_${randomSuffix}`;

                const logRef = ref(db, `coffeeUsersLogs/nickChanges/${logKey}`);
                const logText = `${nickname}ê°€ ${newNick}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`;
                await set(logRef, logText);

                // âœ… coffeeUsers ì´ë™
                await set(newRef, userData);
                await remove(dbRef);

                // âœ… coffeeMemory ë°ì´í„°ë„ ê°™ì´ ì´ë™
                const memoryRef = ref(db, `coffeeMemory/${nickname}`);
                const memorySnap = await get(memoryRef);
                if (memorySnap.exists()) {
                    const memoryData = memorySnap.val();
                    const newMemoryRef = ref(db, `coffeeMemory/${newNick}`);
                    await set(newMemoryRef, memoryData);
                    await remove(memoryRef);
                }

                setActiveNickname(newNick);
                showAlert("ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                $("#nicknameModal").remove();
                location.reload();
            });
        });


        // âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
        $(document).on("click", ".changePasswordBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
            $("#passwordModal").remove();
            const modal = $(`
                <div id="passwordModal" class="login-overlay">
                    <div class="login-modal" style="position:relative;">
                        <button id="closePasswordModal" class="closeBtn">âœ•</button>
                        <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                        <input id="newPasswordInput" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (4ì ì´ìƒ)"
                               style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:16px;">
                        <button id="savePasswordBtn">ì €ì¥</button>
                    </div>
                </div>
            `);
            $("body").append(modal);

            // ë‹«ê¸° ë²„íŠ¼
            $(document).off("click", "#closePasswordModal").on("click", "#closePasswordModal", function () {
                $("#passwordModal").remove();
            });

            // ì €ì¥ ë²„íŠ¼
            $(document).off("click", "#savePasswordBtn").on("click", "#savePasswordBtn", async function () {
                const newPassword = $("#newPasswordInput").val().trim();
                if (!newPassword) return showAlert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!validatePassword(newPassword)) return;

                await set(ref(db, `coffeeUsers/${nickname}/password`), newPassword);
                showAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                $("#passwordModal").remove();
            });
        });

        // âœ… í”„ë¡œí•„ ë³€ê²½ ê¸°ëŠ¥
        const profileList = [
            {id: 1, name: "ì „êµ1ë“±", src: "../image/profile1.jpg"},
            {id: 2, name: "ìƒ˜ì¼ë³‘", src: "../image/profile2.jpg"},
            {id: 3, name: "ì›¹íˆ°ì‘ê°€", src: "../image/profile3.jpg"},
            {id: 4, name: "ì•„ì´ëŒìŠ¤íƒ€", src: "../image/profile4.jpg"},
            {id: 5, name: "ë³´ë“œë§¤ë‹ˆì•„", src: "../image/profile5.jpg"},
            {id: 6, name: "ë¯¸ìŠ¤ì™•", src: "../image/profile6.jpg"},
            {id: 7, name: "ìºì¹˜ë¯¸ì´í”„ìœ ìº”", src: "../image/profile7.jpg"},
            {id: 8, name: "ì™¸ê³„ì†Œë…€", src: "../image/profile8.jpg"},
            {id: 9, name: "ë¯¸ìŠ¤í…Œë¦¬ë§ˆë²•ì‚¬", src: "../image/profile9.jpg"},
            {id: 10, name: "í™ëŒ€ì†Œë…€", src: "../image/profile10.jpg"},
            {id: 11, name: "ì§‘ì‚¬ ë£¨ì´", src: "../image/profile11.jpg"},
            {id: 12, name: "ì•„ê°€ì”¨", src: "../image/profile12.jpg"},
            {id: 13, name: "ë•¡ë•¡ì´ì•Œë°”", src: "../image/profile13.jpg"},
            {id: 14, name: "ì†Œê³µë…€", src: "../image/profile14.jpg"},
            {id: 15, name: "ì—„ì¹œì•„", src: "../image/profile15.jpg"},
            {id: 16, name: "í¬ì¹´ë¦¬ê±¸", src: "../image/profile16.jpg"},
            {id: 17, name: "ê°€ë¸Œë¦¬ì—˜", src: "../image/profile17.jpg"},
            {id: 18, name: "ì œì´", src: "../image/profile18.jpg"},
            {id: 19, name: "ì¼€ì´íŠ¸", src: "../image/profile19.jpg"},
        ];

        // âœ… ë‹‰ë„¤ì„ ì•ì˜ í”„ë¡œí•„ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        $(document).on("click", ".profile-img", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

            // ğŸ”¹ ìœ ì €ì˜ ê²½í—˜ì¹˜ ê¸°ë¡ ê°œìˆ˜ í™•ì¸
            const recordsRef = ref(db, `coffeeUsers/${nickname}/expRecords`);
            const recordsSnap = await get(recordsRef);
            const recordCount = recordsSnap.exists() ? Object.keys(recordsSnap.val()).length : 0;

            // ğŸ”¹ í•´ê¸ˆ ê°€ëŠ¥í•œ í”„ë¡œí•„ ê°œìˆ˜ ê³„ì‚° (ê¸°ë¡ ìˆ˜ vs ê°€ì… í›„ ì¼ìˆ˜ ì¤‘ ì‘ì€ ê°’ ê¸°ì¤€)
            const signupRef = ref(db, `coffeeUsers/${nickname}/signupDate`);
            const signupSnap = await get(signupRef);

            let daysSinceSignup = 0;
            if (signupSnap.exists()) {
                const rawVal = signupSnap.val(); // ì˜ˆ: "25.10.07-00:00:00"
                const signupDateStr = typeof rawVal === "string" ? rawVal : Object.values(rawVal)[0];

                if (signupDateStr) {
                    // ğŸ”¸ "25.10.07-00:00:00" â†’ "2025-10-07T00:00:00"
                    const normalized = signupDateStr
                        .replace("-", "T")               // ì²« '-' (ë‚ ì§œ-ì‹œê°„ êµ¬ë¶„) â†’ 'T'
                        .replace(/^(\d{2})\./, "20$1-")  // 25. â†’ 2025-
                        .replace(/\./g, "-")             // ë‚˜ë¨¸ì§€ ì (.) â†’ -
                        .replace(/T.*/, "T00:00:00");    // âœ… T ë’¤ ì „ë¶€ ì œê±° í›„ 00:00:00ìœ¼ë¡œ ê³ ì •


                    const signupDate = new Date(normalized);
                    const today = new Date();

                    if (!isNaN(signupDate.getTime())) {
                        const diffTime = today.getTime() - signupDate.getTime();
                        daysSinceSignup = Math.max(Math.floor(diffTime / (1000 * 60 * 60 * 24)), 0) + 2;
                    } else {
                        console.warn("ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:", signupDateStr, normalized);
                    }
                }
            }

            // ğŸ”¹ í”„ë¡œí•„ í•´ê¸ˆ ë¹„ìœ¨ (ì˜ˆ: ê¸°ë¡ nê°œë‹¹ 1ê°œ í•´ê¸ˆ)
            const UNLOCK_PER_RECORDS = 7; // ë‚˜ì¤‘ì— 5ë‚˜ 8ë¡œ ë°”ê¾¸ë©´ ì¦‰ì‹œ ë°˜ì˜ë¨
            // ğŸ”¸ ê¸°ë¡ ìˆ˜ì™€ ê°€ì…ì¼ ê¸°ì¤€ ì¤‘ ë‚®ì€ ê°’ ì‚¬ìš©
            const progressValue = Math.min(recordCount, daysSinceSignup);
            let unlockLimit = Math.floor(2 + (progressValue / UNLOCK_PER_RECORDS));
            /*
            console.log(`recordCount : ${recordCount}`);
            console.log(`daysSinceSignup : ${daysSinceSignup}`);
            console.log(`progressValue : ${progressValue}`);
            console.log(`unlockLimit : ${unlockLimit}`);
             */

            // í˜„ì¬ í”„ë¡œí•„ í‘œì‹œ
            const currentNum = profileNum || 1;
            const current = profileList.find(p => p.id === currentNum) || {
                id: 1,
                name: "ê¸°ë³¸ í”„ë¡œí•„",
                src: "../image/profile1.jpg"
            };
            $("#currentProfileImg").attr("src", current.src);
            $("#currentProfileName").text(current.name);

            // ì´ë¯¸ì§€ ëª©ë¡ ì±„ìš°ê¸°
            const $container = $("#profileImageContainer");
            $container.empty();

            profileList.forEach(p => {
                const isLocked = p.id > unlockLimit;
                const img = $(`<div style="position:relative;">
                <img src="${p.src}" alt="${p.name}">
                    ${isLocked ? `<div class="lock-overlay">ğŸ”’</div>` : ""}
                </div>`);

                img.find("img").css({
                    width: "55px",
                    height: "55px",
                    borderRadius: "50%",
                    objectFit: "cover",
                    cursor: isLocked ? "not-allowed" : "pointer",
                    border: p.id === currentNum ? "3px solid #5a4398" : "2px solid #ddd",
                    filter: isLocked ? "grayscale(100%) brightness(80%)" : "none"
                });

                // í´ë¦­ ì‹œ ì„ íƒ
                if (!isLocked) {
                    img.on("click", function () {
                        $("#profileImageContainer img").css("border", "2px solid #ddd");
                        $(this).find("img").css("border", "3px solid #5a4398");
                        $("#currentProfileImg").attr("src", p.src);
                        $("#currentProfileName").text(p.name);
                        $("#applyProfileBtn").data("selected", p.id);
                    });
                } else {
                    img.on("click", function () {
                        const nextUnlockThreshold = (p.id - 2) * UNLOCK_PER_RECORDS; // ë‹¤ìŒ í•´ê¸ˆ ì¡°ê±´
                        const remain = Math.max(nextUnlockThreshold - progressValue, 0); // ë‚¨ì€ ê°œìˆ˜
                        const remainText = remain > 0
                            ? `í˜„ì¬ ê¸°ë¡ : ${progressValue}ê°œ\n${remain}ê°œ ë” ì…ë ¥í•˜ë©´ í•´ê¸ˆë¼ìš”!`
                            : `í˜„ì¬ ê¸°ë¡ : ${progressValue}ê°œ`;
                        showAlert(`${p.name}(ì€)ëŠ” ì•„ì§ í•´ê¸ˆë˜ì§€ ì•Šì•˜ì–´ìš”!\n\n${remainText}`);
                    });
                }

                $container.append(img);
            });

            $("#profileModal").css("display", "flex");
        });

        // âœ… ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        $("#closeProfileModal").on("click", function () {
            $("#profileModal").hide();
        });

        // âœ… ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ Firebase ì—…ë°ì´íŠ¸
        $("#applyProfileBtn").on("click", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

            const selected = $(this).data("selected");
            if (!selected) return showAlert("í”„ë¡œí•„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            try {
                await set(ref(db, `coffeeUsers/${nickname}/profileImg`), selected);
                showAlert("í”„ë¡œí•„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                $("#profileModal").hide();

                // ì¦‰ì‹œ ë°˜ì˜
                profileNum = selected;
                const newSrc = `../image/profile${selected}.jpg`;
                $(".profile-img").attr("src", newSrc);
            } catch (err) {
                console.error("í”„ë¡œí•„ ë³€ê²½ ì˜¤ë¥˜:", err);
                showAlert("í”„ë¡œí•„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });

    // âœ… ì˜¤ëŠ˜ì˜ D-day ìœ ì € ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° â†’ scrolling-text í‘œì‹œ
    async function loadTodayLevelUpUsers() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        const listRef = ref(db, `coffeeLevelUpToday/${todayStr}`);

        try {
            const snap = await get(listRef);
            if (!snap.exists()) {
                return;
            }

            let list = snap.val();
            // ë°°ì—´ì´ ì•„ë‹ˆê³  ê°ì²´ë©´ ê°’ë§Œ ì¶”ì¶œ
            if (!Array.isArray(list)) list = Object.values(list);
            if (!list.length) {
                return;
            }

            // ë‹‰ë„¤ì„ ë‚˜ì—´ ë¬¸ì¥ ìƒì„±
            const nickText = list
                .filter(name => name && name.trim() !== "") // ë¹ˆ ë¬¸ìì—´ ì œê±°
                .map(name => `${name}ë‹˜`)
                .join(", ");
            const message = `ğŸ‰ LEVEL UP ğŸ‰ ì˜¤ëŠ˜ì€ ${nickText} ë ˆë²¨ì—… D-dayì—ìš”ğŸ¦Š ë‹¤ë“¤ ì¶•í•˜í•´ì£¼ì„¸ìš”~ğŸŒŸ`;

            $(".scrolling-text").text(message);
        } catch (err) {
            console.error("ğŸ”¥ D-day ìœ ì € ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
            $(".scrolling-text").text("D-day ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.");
        }
    }

    // ğŸ† í­ì£½ ì• ë‹ˆë©”ì´ì…˜ + ì¶•í•˜ ë¬¸êµ¬ í•¨ìˆ˜
    function showFireworkCelebration() {
        // ì¤‘ë³µ ë°©ì§€
        if ($(".firework-container").length > 0) return;

        const nickname = getActiveNickname();
        const container = $('<div class="firework-container"></div>');
        const message = $(`<div class="firework-text">ğŸ‰ ${nickname}ë‹˜ ğŸ‰<br>ë ˆë²¨ì—… ì¶¬í•˜ë“œë ¤ìš”~!</div>`);

        container.append(message);
        $("body").append(container);

        // âœ… í´ë¦­ ì‹œ ì¦‰ì‹œ ë‹«ê¸°
        container.on("click", function () {
            container.fadeOut(300, () => container.remove());
        });

        // í­ì£½ 30ê°œ ëœë¤ ìƒì„±
        for (let i = 0; i < 30; i++) {
            const fw = $('<div class="firework"></div>');
            const angle = Math.random() * 2 * Math.PI;
            const distance = 100 + Math.random() * 100;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;
            const color = `hsl(${Math.random() * 360}, 80%, 60%)`;
            const delay = Math.random() * 1;

            fw.css({
                "--tx": tx,
                "--ty": ty,
                background: color,
                left: "50%",
                top: "50%",
                animationDelay: `${delay}s`
            });

            container.append(fw);
        }

        // ì¼ì • ì‹œê°„ ë’¤ ì œê±°
        setTimeout(() => container.remove(), 15000);
    }
</script>
<script src="../helpModal/helpModal.js" defer></script>
<script src="../menuToggle/menuToggle.js" type="module" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>