<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>그럴수이치</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS 전체화면 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: #f4f3f9;
            color: #333;
        }

        /* ===== 전체 래퍼 ===== */
        #mainPage {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #fff;
            padding: 20px 16px 60px;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative;
            text-align: center;
        }

        /* ===== 레벨 입력 영역 ===== */
        .level-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding: 0 8px;
        }

        .level-input label {
            font-weight: 600;
            font-size: 15px;
        }

        #currentLevel {
            width: 80px;
            text-align: center;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        #saveLevelBtn {
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 15px;
            transition: 0.2s;
        }

        #saveLevelBtn:hover {
            background: #47327a;
        }

        /* ===== 제목 / 버튼 ===== */
        h1 {
            text-align: center;
            color: #5a4398;
            font-size: 22px;
            margin-bottom: 20px;
        }

        .level-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        /* ===== 헤더 스타일 ===== */
        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-bar h1 {
            color: #fff; /* 흰 글씨 */
            font-size: 20px;
            margin: 0;
        }

        .levelup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            margin-bottom: 10px;
        }

        .levelup-header h3 {
            margin: 0;
            color: #444;
            font-size: 17px;
        }

        #expButton {
            background: transparent; /* 배경 투명 */
            color: #5a4398; /* 글자 보라색 */
            border: 2px solid #5a4398; /* 진한 보라색 테두리 */
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #expButton:hover {
            background: #5a4398; /* hover 시 배경 채워짐 */
            color: #fff; /* 글자색 반전 */
        }

        /* ===== 섹션 제목 ===== */
        h3 {
            margin-top: 40px;
            margin-bottom: 10px;
            color: #444;
            text-align: left;
            font-size: 17px;
        }

        /* ===== 테이블 ===== */
        #expTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
        }

        #expTable th,
        #expTable td {
            border: 1px solid #e0dff2;
            padding: 10px;
            text-align: center;
        }

        #expTable th {
            background: #f6f4fc;
            color: #5a4398;
            font-weight: 600;
        }

        #expTable tr:nth-child(even) {
            background: #faf9fd;
        }

        /* ===== 모달 공통 ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* ===== 커스텀 알림/컨펌 모달 최상단 고정 ===== */
        #customAlert,
        #customConfirm {
            z-index: 100; /* 다른 모든 모달보다 앞 */
        }

        #customAlert .alert-box,
        #customConfirm .alert-box {
            position: relative;
            z-index: 101; /* 내부 콘텐츠도 최상단 */
        }

        .login-modal {
            background: #fff;
            padding: 30px 25px 50px 25px;
            border-radius: 12px;
            width: 360px;
            min-height: max-content;
            text-align: center;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        }

        .login-modal h2 {
            margin-bottom: 15px;
            color: #5a4398;
        }

        .login-modal input {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .login-modal button {
            width: 100%;
            padding: 10px;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 10px;
            transition: 0.2s;
        }

        .login-modal button:hover {
            background: #47327a;
        }

        .msg {
            margin-top: 10px;
            font-size: 20px;
            height: 24px;
        }

        .closeBtn {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none !important;
            border: none;
            font-size: 20px;
            color: #aaa !important;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
            margin: 0;
            width: max-content !important;
        }

        .closeBtn:hover {
            color: #5a4398; /* hover 시 포인트 색 */
        }

        /* ===== 옵션 선택 모달 ===== */
        #optionModal {
            display: none;
        }

        #optionModal .login-modal {
            width: 280px;
            padding: 20px;
            text-align: center;
        }

        /* 제목 가운데 정렬 */
        #optionModal h3 {
            color: #5a4398;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        /* 공통 버튼 스타일 */
        #optionModal button {
            width: 100%;
            padding: 8px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            transition: all 0.2s ease;
        }

        /* 개별 색상 */
        #editExpBtn {
            color: #5a4398;
            border: 2px solid #5a4398;
        }

        #deleteExpBtn {
            color: #d9534f;
            border: 2px solid #d9534f;
        }

        #closeOptionBtn {
            color: #777;
            border: 2px solid #777;
        }

        /* hover 효과 (색 반전) */
        #optionModal button:hover {
            color: #fff;
        }

        #editExpBtn:hover {
            background: #5a4398;
        }

        #deleteExpBtn:hover {
            background: #d9534f;
        }

        #closeOptionBtn:hover {
            background: #777;
        }

        #customAlert .alert-box, #customConfirm .alert-box {
            background: #ffbcae;
            padding: 25px 25px 20px;
            border-radius: 12px;
            width: 360px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: left;
            position: relative;
        }

        #customAlert .alert-content, #customConfirm .alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #customAlert .alert-text, #customConfirm .alert-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            flex: 1;
            padding-right: 10px;

            white-space: pre-line; /* \n 줄바꿈 인식 */
            word-break: keep-all; /* 단어 기준 줄바꿈 */
            overflow-wrap: break-word; /* 긴 단어 강제 줄바꿈 */
        }


        #customAlert .alert-img, #customConfirm .alert-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        #alertConfirmBtn {
            display: block;
            width: 100%;
            background: #5a4398;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            padding: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }

        #alertConfirmBtn:hover {
            background: #47327a;
        }

        #adminBtn-bar {
            text-align: right;
        }

        /* ===== 아카이브 공개 토글 스위치 ===== */
        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.25s ease;
        }

        .toggle-switch::after {
            content: "";
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.25s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* ON 상태 */
        .toggle-switch.on {
            background: #5a4398;
        }

        .toggle-switch.on::after {
            left: 26px;
        }

        /* ===== 설정 메뉴 스타일 ===== */
        .settings-menu {
            position: relative;
        }

        #settingsBtn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        #settingsBtn:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 100;
            min-width: 140px;
        }

        /* ✅ 드롭다운 버튼 개별 스타일 */
        .dropdown-menu button {
            display: block;
            width: 100%;
            background: #fff;
            border: none;
            border-bottom: 1px solid #eee;
            color: #333;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* 마지막 버튼은 구분선 제거 */
        .dropdown-menu button:last-child {
            border-bottom: none;
        }

        /* ✅ hover 시 강조 */
        .dropdown-menu button:hover {
            background: #f6f4fc;
            color: #5a4398;
            font-weight: 600;
        }

        /* ===== 로딩 스크린 ===== */
        #loadingScreen {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f4f3f9;
            z-index: 9999;
            flex-direction: column;
        }

        /* ===== 스피너 애니메이션 ===== */
        .spinner {
            border: 5px solid #eee;
            border-top: 5px solid #5a4398;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        /* ===== 로딩 문구 ===== */
        #loadingScreen p {
            margin-top: 10px;
            color: #5a4398;
            font-weight: 600;
            font-size: 16px;
        }

        /* ===== 회전 애니메이션 ===== */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="mainPage" style="display:none;">
    <div class="level-row header-bar">
        <h1>그럴수이치</h1>
        <div class="settings-menu">
            <button id="settingsBtn">설정</button>
            <div id="settingsDropdown" class="dropdown-menu" style="display:none;">
                <button id="layoutBtn">배치도</button>
                <button id="changeNicknameBtn">닉네임 변경</button>
                <button id="changePasswordBtn">비밀번호 변경</button>
                <button id="logoutBtn">로그아웃</button>
            </div>
        </div>
    </div>

    <div class="level-input">
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="nicknameDisplay"
                  style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
            <span id="currentLevelDisplay"
                  style="display:inline-block; padding:8px 0;
                  font-size:16px; font-weight:600; color:#5a4398;">
            </span>
            <button id="expButton">경험치 입력</button>
        </div>
        <div id="rankingToggle" class="toggle-switch"></div>
    </div>

    <div class="levelup-header">
        <span id="avgExp" style="font-size:15px; color:#5a4398; font-weight:600;"></span>
    </div>

    <div id="levelUpBox" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;"></div>

    <div id="adminBtn-bar"></div>

    <h3>일자별 경험치</h3>
    <table id="expTable">
        <thead>
        <tr>
            <th>날짜</th>
            <th>Lv</th>
            <th>현재 경험치</th>
            <th>획득 경험치</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 로그인 팝업 -->
<div id="loginPopup" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>로그인</h2>
        <input id="nickname" type="text" placeholder="닉네임">
        <input id="password" type="password" placeholder="비밀번호">
        <button id="loginBtn">확인</button>
        <div class="msg" id="message">
            첫 로그인시 계정이 생성됩니다.
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p>로딩 중...</p>
</div>

<!-- 경험치 입력 모달 -->
<div id="expModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position: relative;">
        <button id="closeExpModal" class="closeBtn">✕</button>
        <h2>경험치 입력</h2>
        <div style="margin-bottom:10px;">
            <label for="expDate" style="display:block; font-size:14px; text-align:left; color:#555;">날짜</label>
            <input id="expDate" type="date"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayLevel" style="display:block; font-size:14px; text-align:left; color:#555;">현재 레벨</label>
            <input id="todayLevel" type="number" min="1" max="100"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayExp" style="display:block; font-size:14px; text-align:left; color:#555;">현재 경험치</label>
            <input id="todayExp" type="text" inputmode="numeric" placeholder="현재 경험치"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px;">
        </div>

        <button id="saveExpBtn">저장</button>
    </div>
</div>

<!-- 레벨 입력 모달 -->
<div id="levelModal" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>현재 레벨 입력</h2>
        <input id="levelInput" type="number" placeholder="레벨을 입력해주세요" min="1" max="100">
        <button id="saveLevelConfirmBtn">저장</button>
    </div>
</div>

<!-- 커스텀 알림 모달 -->
<div id="customAlert" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <button id="alertConfirmBtn">확인</button>
    </div>
</div>

<!-- 커스텀 컨펌 모달 -->
<div id="customConfirm" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="confirmYesBtn"
                    style="flex:1; background:#5a4398; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; cursor:pointer; transition:background 0.2s;">
                확인
            </button>
            <button id="confirmNoBtn"
                    style="flex:1; background:#aaa; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; cursor:pointer; transition:background 0.2s;">
                취소
            </button>
        </div>
    </div>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {getDatabase, ref, set, get, remove} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    const levelExp = [
        0,       // 1레벨
        25,      // 2레벨
        60,      // 3레벨
        70,
        80,
        90,
        100,
        160,
        250,
        380,      // 10레벨
        520,
        880,
        1210,
        1750,
        2500,
        3639,
        4790,
        5999,
        7392,
        9102,      // 20레벨
        10992,
        13100,
        14800,
        15800,
        18100,
        19841,
        22000,
        23500,
        26000,
        29000,      // 30레벨
        30800,
        33800,
        36000,
        39000,
        41800,
        45700,
        49000,
        53000,
        58000,
        63000,      // 40레벨
        67810,
        73500,
        79000,
        86000,
        92000,
        99800,
        107000,
        117000,
        131000,
        150000,      // 50레벨
        160000,
        175000,
        191000,
        209000,
        228000,
        249000,
        271000,
        295000,
        321000,
        350000,      // 60레벨
        382000,
        417000,
        455000,
        496000,
        540000,
        587000,
        637000,
        690000,
        746000,
        805000,      // 70레벨
        867000,
        932000,
        1000000,
        1071000,
        1145000,
        1222000,
        1302000,
        1385000,
        1471000,
        1560000,      // 80레벨
        1800000,
        2200000,
        2700000,
        3200000,
        3900000,
        4700000,
        5600000,
        6800000,
        8100000,
        15000000,      // 90레벨
        19500000,
        25350000,
        32960000,
        42850000,
        55710000,
        72990000,
        96350000,
        128150000,
        171730000,
        240430000,      // 100레벨
    ];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ✅ 로그인 닉네임 가져오기 (coffee-subnick → coffee-nickname 순서)
    function getActiveNickname() {
        const subNick = localStorage.getItem("coffee-subnick");
        if (subNick) {
            // 사용 즉시 삭제 (1회용)
            localStorage.removeItem("coffee-subnick");
            return subNick;
        }
        return localStorage.getItem("coffee-nickname") || null;
    }

    function goToPage(target = "levelup") {
        const basePath = window.location.pathname.split("/levelup")[0];

        const pageMap = {
            admin: `${basePath}/admin/main.html`,
            ranking: `${basePath}/ranking/main.html`,
            levelup: `${basePath}/levelup/levelup.html`,
            layout: `${basePath}/layout/layout.html`
        };

        const targetUrl = pageMap[target] || pageMap.levelup;
        location.href = targetUrl;
    }

    function getKoreanDate() {
        const koreaTime = new Date();

        // 직접 문자열로 포맷 (UTC 문제 완벽 차단)
        const year = koreaTime.getFullYear();
        const month = String(koreaTime.getMonth() + 1).padStart(2, '0');
        const day = String(koreaTime.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }

    // ✅ 한국시간 타임스탬프 함수 추가
    function getKoreanTimestamp() {
        const koreaTime = new Date();
        const yy = String(koreaTime.getFullYear()).slice(2);
        const mm = String(koreaTime.getMonth() + 1).padStart(2, "0");
        const dd = String(koreaTime.getDate()).padStart(2, "0");
        const hh = String(koreaTime.getHours()).padStart(2, "0");
        const mi = String(koreaTime.getMinutes()).padStart(2, "0");
        const ss = String(koreaTime.getSeconds()).padStart(2, "0");
        return `${yy}.${mm}.${dd}-${hh}:${mi}:${ss}`;
    }

    function validateNickname(nickname) {
        if (!nickname || nickname.trim().length < 2) {
            showAlert("닉네임은 2자 이상이어야 합니다.");
            return false;
        }
        if (nickname.length > 12) {
            showAlert("닉네임은 12자 이하로 입력해주세요.");
            return false;
        }
        if (!/^[가-힣a-zA-Z0-9_]+$/.test(nickname)) {
            showAlert("닉네임은 한글, 영문, 숫자, 밑줄(_)만 사용할 수 있습니다.");
            return false;
        }
        return true;
    }

    function validatePassword(password) {
        if (!password || password.trim().length < 4) {
            showAlert("비밀번호는 4자 이상이어야 합니다.");
            return false;
        }
        if (password.length > 20) {
            showAlert("비밀번호는 최대 20자까지 가능합니다.");
            return false;
        }
        if (!/^[a-zA-Z0-9!@#$%^&*]+$/.test(password)) {
            showAlert("비밀번호는 영문, 숫자, 특수문자(!@#$%^&*)만 가능합니다.");
            return false;
        }
        return true;
    }

    function validateDateNotFuture(inputDate) {
        if (!inputDate) {
            showAlert("날짜를 선택해주세요.");
            return false;
        }
        const today = getKoreanDate();
        if (inputDate > today) {
            showAlert("미래 날짜는 입력할 수 없습니다.");
            return false;
        }
        return true;
    }

    function validateUniqueGoals(goals) {
        const unique = [...new Set(goals)];
        if (unique.length !== goals.length) {
            showAlert("중복된 목표값이 있습니다.");
            return false;
        }
        return true;
    }

    $("#logoutBtn").on("click", function () {
        showConfirm("정말 로그아웃할까요?", async (ok) => {
            if (ok) {
                localStorage.removeItem("coffee-nickname");
                location.reload();
            }
        });
    });

    $("#layoutBtn").on("click", function () {
        showConfirm("배치도 페이지로 이동 할까요?", async (ok) => {
            if (ok) {
                goToPage("layout");
            }
        });
    });

    // ✅ 설정 버튼 클릭 시 드롭다운 토글
    $("#settingsBtn").on("click", function (e) {
        e.stopPropagation();
        $("#settingsDropdown").toggle();
    });

    // ✅ 다른 곳 클릭 시 드롭다운 닫기
    $(document).on("click", function (e) {
        if (!$(e.target).closest(".settings-menu").length) {
            $("#settingsDropdown").hide();
        }
    });

    // ✅ 드롭다운 메뉴 안의 버튼 클릭 시 메뉴 닫기
    $(document).on("click", "#settingsDropdown button", function () {
        $("#settingsDropdown").hide();
    });

    // ✅ 경험치 입력 모달 닫기 버튼
    $("#closeExpModal").on("click", function () {
        $("#expModal").hide();
    });

    // 🔹 모든 버튼의 빠른 연속 클릭(더블클릭) 방지
    $(document).on("click", "button", function (e) {
        const $btn = $(this);

        // 이미 잠겨 있으면 실행 막기
        if ($btn.data("clicked")) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }

        // 0.8초간 클릭 잠금
        $btn.data("clicked", true);
        setTimeout(() => {
            $btn.removeData("clicked");
        }, 800);
    });

    // ============================
    // ✅ (3) 행 클릭 시 옵션 모달 표시
    // ============================
    let selectedDate = null;
    $(document).on("click", ".exp-row", function () {
        selectedDate = $(this).data("date");
        $("#optionModal").css("display", "flex");
    });

    // ✅ 옵션 모달 - 닫기
    $(document).on("click", "#closeOptionBtn", function () {
        $("#optionModal").hide();
    });

    // ✅ 수정 버튼 클릭 시 쉼표 있는 값으로 표시
    $(document).on("click", "#editExpBtn", async function () {
        const nickname = getActiveNickname();
        if (!nickname || !selectedDate) return;
        const recordRef = ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`);
        const snapshot = await get(recordRef);
        if (snapshot.exists()) {
            const record = snapshot.val();
            $("#editExpDate").val(selectedDate);
            $("#editLevelValue").val(record.level || 1);
            $("#editExpValue").val(record.exp.toLocaleString()); // ✅ 쉼표 포함 표시
            $("#optionModal").hide();
            $("#editModal").css("display", "flex");
        }
    });

    // ✅ 수정 모달 닫기
    $(document).on("click", "#closeEditModal", function () {
        $("#editModal").hide();
    });

    // ✅ 커스텀 알림 함수
    function showAlert(message) {
        $("#customAlert .alert-text").html(message);
        $("#customAlert").fadeIn(150);
    }

    // 닫기 버튼
    $(document).on("click", "#alertConfirmBtn", function () {
        $("#customAlert").fadeOut(150);
    });

    // ✅ 커스텀 컨펌 함수
    function showConfirm(message, onConfirm) {
        $("#customConfirm .alert-text").html(message);
        $("#customConfirm").fadeIn(150);

        // 기존 핸들러 제거 후 다시 등록 (중복 방지)
        $(document).off("click", "#confirmYesBtn").on("click", "#confirmYesBtn", function () {
            $("#customConfirm").fadeOut(150);
            if (typeof onConfirm === "function") onConfirm(true);
        });

        $(document).off("click", "#confirmNoBtn").on("click", "#confirmNoBtn", function () {
            $("#customConfirm").fadeOut(150);
            if (typeof onConfirm === "function") onConfirm(false);
        });
    }

    // ✅ 경험치 입력 시 자동으로 쉼표 추가 (입력할 때마다 포맷 적용)
    $(document).on("input", "#todayExp, #editExpValue", function () {
        bindNumericCommaFormatter("#todayExp, #editExpValue", 1_000_000_000_000, "경험치는 최대 1조까지 입력할 수 있어요.");
    });

    // ✅ 숫자 입력 시 실시간 쉼표 포맷 + 상한 체크 공용 함수
    function bindNumericCommaFormatter(selector, maxValue = 1_000_000_000_000, maxMsg = "최대 1조까지 입력할 수 있어요.") {
        $(document).off("input", selector).on("input", selector, function () {
            let value = $(this).val().replace(/[^0-9]/g, ""); // 숫자만 추출
            if (!value) {
                $(this).val("");
                return;
            }

            let num = parseInt(value, 10);

            if (num > maxValue) {
                showAlert(maxMsg);
                num = maxValue;
            }

            $(this).val(num.toLocaleString()); // 3자리마다 쉼표 표시
        });
    }

    $(function () {
        const $popup = $("#loginPopup");
        const $mainPage = $("#mainPage");
        const $loadingScreen = $("#loadingScreen");
        const $msg = $("#message");
        const $nicknameDisplay = $("#nicknameDisplay");
        const $currentLevelDisplay = $("#currentLevelDisplay");

        const savedNick = getActiveNickname();
        if (savedNick) {
            const userRef = ref(db, `coffeeUsers/${savedNick}`);
            get(userRef).then(snapshot => {
                if (snapshot.exists()) {
                    // ✅ 정상 계정이면 페이지 표시
                    $loadingScreen.hide();
                    $mainPage.show();
                    const todayValue = "v1";
                    const lastUpdate = localStorage.getItem("LU-update");

                    if (lastUpdate !== todayValue) {
                        showAlert("! New !\n우측 상단의 버튼을 터치하여 활성화해보세요!");
                        localStorage.setItem("LU-update", todayValue);
                    }
                    loadUserData(savedNick);
                } else {
                    // ❌ DB에 없는 닉네임일 경우 자동 제거
                    console.warn("저장된 닉네임이 유효하지 않아 초기화합니다.");
                    localStorage.removeItem("coffee-nickname");
                    $loadingScreen.hide();
                    $popup.show();
                }
            }).catch(err => {
                console.error("데이터 확인 중 오류 발생:", err);
                localStorage.removeItem("coffee-nickname");
                $loadingScreen.hide();
                $popup.show();
            });
        } else {
            // 로컬스토리지에 닉네임이 없으면 로그인 팝업 유지
            $loadingScreen.hide();
            $popup.show();
        }

        // ✅ 로그인 처리
        $("#loginBtn").on("click", async function () {
            const nickname = $("#nickname").val().trim();
            const password = $("#password").val().trim();

            if (!nickname || !password) {
                $msg.text("닉네임과 비밀번호를 모두 입력하세요.");
                return;
            }

            if (!validateNickname(nickname)) return;

            if(!validatePassword(password)) return;

            const userRef = ref(db, `coffeeUsers/${nickname}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.password === password) {
                    $msg.css("color", "green").text("로그인 성공!");
                    localStorage.setItem("coffee-nickname", nickname);
                    setTimeout(() => {
                        $popup.hide();
                        $mainPage.show();
                        loadUserData(nickname);
                    }, 800);
                } else {
                    $msg.css("color", "red")
                        .html("이미 존재하는 닉네임이거나<br>비밀번호가 틀렸습니다.");
                }
            } else {
                await set(userRef, {
                    password,
                    signupDate: getKoreanTimestamp(),   // 가입일 저장
                });
                $msg.css("color", "green").text("새 계정이 등록되었습니다.");
                localStorage.setItem("coffee-nickname", nickname);
                setTimeout(() => {
                    $popup.hide();
                    $mainPage.show();
                    loadUserData(nickname);
                }, 800);
            }
        });

        // ✅ 경험치 입력 모달 열기
        $("#expButton").on("click", async function () {
            const today = getKoreanDate();
            $("#expDate").val(today);

            const nickname = getActiveNickname();
            if (nickname) {
                const userRef = ref(db, `coffeeUsers/${nickname}/level`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    $("#todayLevel").val(snapshot.val()); // 🔹 기본값 설정
                }
            }

            $("#expModal").css("display", "flex");
        });

        // ✅ 경험치 저장 버튼
        $("#saveExpBtn").on("click", async function () {
            await saveExp();
            $("#todayExp").val("");
            $("#expModal").hide();
        });

        // ✅ 경험치 저장 함수 (쉼표 제거 후 저장)
        async function saveExp() {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("로그인 후 이용해주세요.");

            // 🔹 쉼표 제거 후 숫자 변환
            const exp = parseInt($("#todayExp").val().replace(/,/g, ""));
            const level = parseInt($("#todayLevel").val());
            const dateInput = $("#expDate").val();
            if (!validateDateNotFuture(dateInput)) return;
            const selectedDate = dateInput || getKoreanDate();

            if (isNaN(exp) || exp < 0) return showAlert("경험치를 올바르게 입력해주세요.");
            if (!level || level < 1 || level > 100) return showAlert("레벨은 1~100 사이여야 합니다.");

            // ✅ 전체 기록 한 번만 가져오기
            const recordsRef = ref(db, `coffeeUsers/${nickname}/expRecords`);
            const allRecordsSnap = await get(recordsRef);
            const allRecords = allRecordsSnap.exists() ? allRecordsSnap.val() : {};

            // ✅ 이미 같은 날짜가 있으면 중복 차단
            if (allRecords[selectedDate]) {
                return showAlert("이미 해당 날짜에 경험치를 입력했습니다!");
            }

            // ✅ 바로 이전 날짜 찾기
            const dates = Object.keys(allRecords).sort();
            const prevDate = dates[dates.length - 1];

            if (prevDate && prevDate < selectedDate) {
                const prevRecord = allRecords[prevDate];
                const prevLevel = prevRecord.level;
                const prevExp = prevRecord.exp;

                // 🔸 같은 레벨인데 경험치가 낮으면 입력 금지
                if (level === prevLevel && exp < prevExp) {
                    return showAlert(`이전 기록(${prevDate})보다 낮은 경험치는 입력할 수 없습니다.`);
                }
            }

            // ✅ 새 기록 저장 (쉼표 없는 정수 저장)
            await set(ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`), {
                level,
                exp,
                savedAt: getKoreanTimestamp(),
            });

            // 🔹 현재 표시 중인 레벨 가져오기
            const currentLevelVal = parseInt($("#currentLevelDisplay").text()) || 1;

            // 🔹 새로 입력한 레벨이 기존보다 높을 때만 갱신
            if (level > currentLevelVal) {
                await set(ref(db, `coffeeUsers/${nickname}/level`), level);
            }

            showAlert(`레벨 ${level}\n경험치 ${exp.toLocaleString()} 저장 완료!`);
            $("#expModal").hide();
            $("#todayExp").val("");

            await loadUserData(nickname);
        }

        // ✅ 아카이브 버튼 추가 함수
        function addRankingButton() {
            if ($("#rankingBtn").length > 0) return; // 중복 방지

            const rankingBtn = $('<button id="rankingBtn">아카이브</button>').css({
                background: '#5a4398',
                color: '#fff',
                border: 'none',
                borderRadius: '8px',
                padding: '8px 16px',
                marginTop: '10px',
                marginLeft: '8px',
                cursor: 'pointer',
                fontWeight: '600'
            });

            $("#adminBtn-bar").append(rankingBtn);

            // ✅ 클릭 시 아카이브 접근 조건 검증
            rankingBtn.on("click", async () => {
                const nickname = getActiveNickname();
                if (!nickname) return showAlert("로그인 후 이용해주세요.");

                const userRef = ref(db, `coffeeUsers/${nickname}`);
                const snapshot = await get(userRef);

                if (!snapshot.exists()) return showAlert("계정 정보를 불러오지 못했습니다.");

                const userData = snapshot.val();
                const records = userData.expRecords || {};
                const rankingPublic = !!userData.rankingPublic;

                // 🔹 오늘 / 어제 날짜 문자열 구하기
                const today = getKoreanDate();
                const yesterday = (() => {
                    const d = new Date();
                    d.setDate(d.getDate() - 1);
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
                })();

                const recordKeys = Object.keys(records);
                const hasRecentRecord = records[today] || records[yesterday];

                // ✅ 조건 확인
                if (!rankingPublic) {
                    showAlert("아카이브 공개 설정이 꺼져 있습니다.\n설정 후 이용해주세요.");
                    return;
                }

                if (recordKeys.length === 0 || !hasRecentRecord) {
                    showAlert("최근 경험치 기록이 없습니다.\n입력 후 이용해주세요.");
                    return;
                }

                // ✅ 통과 시 페이지 이동
                goToPage("ranking");
            });
        }

        // ✅ 아카이브 버튼 제거 함수
        function removeRankingButton() {
            $("#rankingBtn").remove();
        }

        // ✅ 사용자 전체 데이터 불러오기
        async function loadUserData(nickname) {
            const userRef = ref(db, `coffeeUsers/${nickname}`);
            const snapshot = await get(userRef);

            $("#optionModal, #editModal").remove(); // 중복 방지용

            if (snapshot.exists()) {
                const userData = snapshot.val();

                // 🔹 오래된 기록(1년 초과)은 자동 삭제
                if (userData.expRecords) {
                    // 🔹 현재 한국 날짜를 기준으로 계산
                    const now = new Date();
                    const koreaNow = new Date(now.getTime());
                    const oneYearAgo = new Date(koreaNow.getTime() - 365 * 24 * 60 * 60 * 1000);
                    let deletedCount = 0;

                    for (const date in userData.expRecords) {
                        const [y, m, d] = date.split("-").map(Number);
                        const recordDate = new Date(y, m - 1, d);
                        if (recordDate < oneYearAgo) {
                            await remove(ref(db, `coffeeUsers/${nickname}/expRecords/${date}`));
                            deletedCount++;
                        }
                    }

                    if (deletedCount > 0) {
                        showAlert(`1년 이상 지난 기록 ${deletedCount}건이 자동 삭제되었습니다.`);
                    }
                }

                // 🔹 레벨 없을 때 레벨 입력 모달 표시
                if (!userData.level) {
                    $("#levelModal").css("display", "flex");
                    return;
                } else {
                    $nicknameDisplay.text(`${nickname}`);
                    $currentLevelDisplay.text(`${userData.level}`);
                }

                // 🔹 관리자일 경우 관리자 페이지 버튼 표시
                if (userData.isAdmin) {
                    if ($("#adminBtn").length === 0) { // 중복 방지
                        const adminBtn = $('<button id="adminBtn">관리자</button>').css({
                            background: '#5a4398',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '8px',
                            padding: '8px 16px',
                            marginTop: '10px',
                            cursor: 'pointer',
                            fontWeight: '600'
                        });
                        $("#adminBtn-bar").append(adminBtn);

                        // 클릭 시 관리자 페이지 이동
                        adminBtn.on("click", () => {
                            goToPage("admin");
                        });
                    }
                }

                // ✅ 아카이브 공개 여부에 따라 아카이브 페이지 버튼 동적 제어
                const $rankingBtnBar = $("#adminBtn-bar");
                const existingRankingBtn = $("#rankingBtn");

                // 🔹 공개 상태일 때 버튼 없으면 추가
                if (userData.rankingPublic) {
                    if (existingRankingBtn.length === 0) {
                        addRankingButton();
                    }
                } else {
                    // 🔹 비공개 상태면 버튼 제거
                    removeRankingButton();
                }

                if (userData.expRecords) {
                    const records = userData.expRecords;
                    const sorted = Object.keys(records).sort();
                    const $tbody = $("#expTable tbody");
                    $tbody.empty();

                    let prevExp = null;
                    let prevLevel = null;
                    let prevDate = null;
                    let diffs = []; // 🔸 획득 경험치 저장용

                    sorted.forEach(date => {
                        const currentExp = records[date].exp || 0;
                        const currentLevel = records[date].level || userData.level;
                        let gained = "-";
                        let approx = "";

                        // 🔹 날짜 포맷 변경
                        const [yyyy, mm, dd] = date.split("-");
                        const formattedDate = `${mm}.${dd}`;

                        if (prevExp !== null && prevLevel !== null) {
                            // 🔹 두 날짜 사이의 간격 계산
                            const prevD = new Date(prevDate);
                            const curD = new Date(date);
                            const diffDays = Math.floor((curD - prevD) / (1000 * 60 * 60 * 24));

                            let diff = 0;
                            if (currentLevel > prevLevel) {
                                diff += (levelExp[prevLevel] - prevExp);
                                for (let lv = prevLevel + 1; lv < currentLevel; lv++) {
                                    diff += levelExp[lv];
                                }
                                diff += currentExp;
                            } else if (currentLevel === prevLevel && currentExp >= prevExp) {
                                diff = currentExp - prevExp;
                            }

                            if (diff > 0) {
                                gained = diff.toLocaleString();
                                const man = Math.floor(diff / 10000);
                                approx = man >= 1 ? `약 ${man}만` : '';
                            } else {
                                gained = "0";
                            }

                            diffs.push(diff);

                            // ✅ 중간 날짜(하루 이상 비었을 때) 0 경험치 추가
                            if (diffDays > 1) {
                                for (let i = 1; i < diffDays; i++) {
                                    diffs.push(0);
                                }
                            }
                        }

                        $tbody.prepend(`
                            <tr class="exp-row" data-date="${date}">
                                <td>${formattedDate}</td>
                                <td>${currentLevel}</td>
                                <td>${currentExp.toLocaleString()}</td>
                                <td>${gained}<br><span style="color:red">${approx}</span></td>
                            </tr>
                        `);

                        prevExp = currentExp;
                        prevLevel = currentLevel;
                        prevDate = date; // ✅ 이전 날짜 저장
                    });

                    // 🔸 평균 계산 및 전체 레벨업 예정일 표시 (레벨업 시 경험치 0으로 초기화 구조)
                    if (diffs.length > 0 && userData.level) {
                        const avgGain = diffs.reduce((a, b) => a + b, 0) / diffs.length;
                        const currentLevel = userData.level;
                        const records = userData.expRecords;
                        const sortedDates = Object.keys(records).sort();
                        const latestDate = sortedDates[sortedDates.length - 1];
                        const currentExp = records[latestDate].exp || 0; // 🔸 현재 경험치
                        const today = new Date();
                        const koreaNow = new Date(today.getTime());

                        if (avgGain < 10000) {
                            $("#avgExp").text(`평균 경험치 : ${Math.floor(avgGain).toLocaleString()}`);
                        } else {
                            const man = Math.floor(avgGain / 10000);
                            $("#avgExp").text(`평균 경험치 : ${Math.floor(avgGain).toLocaleString()} ( 약 ${man}만 )`);
                        }

                        let tableHTML = `
                            <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                <thead>
                                    <tr style="background:#f6f4fc; color:#5a4398;">
                                        <th style="padding:8px; border:1px solid #e0dff2;">목표 레벨</th>
                                        <th style="padding:8px; border:1px solid #e0dff2;">D-day</th>
                                        <th style="padding:8px; border:1px solid #e0dff2;">레벨업 예정일</th>
                                    </tr>
                                </thead>
                            <tbody>
                        `;

                        let accumulatedExp = 0;
                        let accumulatedDays = 0;
                        let curExp = currentExp;

                        const maxLevel = currentLevel >= 90 ? 100 : currentLevel + 10;

                        for (let lvl = currentLevel; lvl < maxLevel; lvl++) {
                            const needExp = levelExp[lvl]; // 이번 레벨에서 다음 레벨까지 필요한 양
                            if (!needExp) break;

                            // 이번 레벨에서 다음 레벨까지 필요한 경험치
                            const remainExp = Math.max(needExp - curExp, 0);
                            accumulatedExp += remainExp;


                            // ✅ 총 누적 경험치를 평균으로 나눠서 필요한 일수 계산
                            const daysNeeded = Math.ceil(accumulatedExp / avgGain);

                            // ✅ 도달일 계산 (오늘 기준 + 필요 일수)
                            const estDate = new Date(koreaNow);
                            estDate.setDate(koreaNow.getDate() + daysNeeded);

                            const yyyy = estDate.getFullYear();
                            const mm = String(estDate.getMonth() + 1).padStart(2, '0');
                            const dd = String(estDate.getDate()).padStart(2, '0');

                            // ✅ D-day는 오늘 포함 표시만 별도로 (표시용 +1)
                            const dDay = daysNeeded > 0 ? `D-${daysNeeded}` : "D-day";


                            // 출력 부분 수정
                            tableHTML += `
                                <tr>
                                    <td style="padding:8px; border:1px solid #e0dff2;">${lvl + 1}레벨</td>
                                    <td style="padding:8px; border:1px solid #e0dff2;">${dDay}</td>
                                    <td style="padding:8px; border:1px solid #e0dff2;">${yyyy}-${mm}-${dd}</td>
                                </tr>
                            `;

                            // 다음 루프부터는 경험치 0부터 시작
                            curExp = 0;
                        }

                        tableHTML += `
                                </tbody>
                            </table>
                        `;

                        $("#levelUpBox").html(tableHTML);

                        // ✅ 목표 경험치 도달 예상일 표 추가
                        if (userData.goalTargets && avgGain > 0) {
                            $("#levelUpBox").empty();
                            const goalTargets = userData.goalTargets.sort((a, b) => a - b);
                            const currentExp = records[latestDate].exp || 0;

                            let goalTable = `
                                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                    <thead>
                                        <tr style="background:#f6f4fc; color:#5a4398;">
                                            <th style="padding:8px; border:1px solid #e0dff2;">목표</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">D-day</th>
                                            <th style="padding:8px; border:1px solid #e0dff2;">예상 도달일</th>
                                        </tr>
                                    </thead>
                                <tbody>
                            `;

                            goalTargets.forEach(goal => {
                                const remainExp = Math.max(goal - currentExp, 0);
                                if (remainExp <= 0) return; // 이미 달성한 목표는 표시 안 함

                                const daysNeeded = Math.ceil(remainExp / avgGain);
                                const estDate = new Date(koreaNow);
                                estDate.setDate(koreaNow.getDate() + daysNeeded);

                                const yyyy = estDate.getFullYear();
                                const mm = String(estDate.getMonth() + 1).padStart(2, '0');
                                const dd = String(estDate.getDate()).padStart(2, '0');
                                const dDay = daysNeeded > 0 ? `D-${daysNeeded}` : "D-day";

                                // ✅ 숫자 단위 변환
                                let formattedGoal = "";
                                if (goal < 10000) {
                                    formattedGoal = goal.toLocaleString();
                                } else if (goal < 100000000) {
                                    formattedGoal = `${Math.floor(goal / 10000)}만`;
                                } else {
                                    formattedGoal = `${Math.floor(goal / 100000000)}억`;
                                }

                                goalTable += `
                                    <tr>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${formattedGoal.toLocaleString()}</td>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${dDay}</td>
                                        <td style="padding:8px; border:1px solid #e0dff2;">${yyyy}-${mm}-${dd}</td>
                                    </tr>
                                `;
                            });

                            goalTable += `
                                    </tbody>
                                </table>
                            `;

                            $("#levelUpBox").append(`
                                ${goalTable}
                            `);
                        }

                    } else {
                        $("#levelUpBox").html(`<p style="color:#999;">계산할 데이터가 부족합니다.</p>`);
                    }

                    // ============================
                    // ✅ (1) 옵션 선택 모달 추가
                    // ============================
                    const optionModal = $(`
                        <div id="optionModal" class="login-overlay" style="display:none;">
                            <div class="login-modal">
                                <h3>옵션을 선택해주세요</h3>
                                <button id="editExpBtn">수정</button>
                                <button id="deleteExpBtn">삭제</button>
                                <button id="closeOptionBtn">닫기</button>
                            </div>
                        </div>
                    `);

                    $("body").append(optionModal);

                    // ============================
                    // ✅ (2) 수정 모달 추가
                    // ============================
                    const editModal = $(`
                        <div id="editModal" class="login-overlay" style="display:none;">
                            <div class="login-modal" style="position:relative; width:360px;">
                                <button id="closeEditModal" class="closeBtn">✕</button>
                                <h2>경험치 수정</h2>
                                <label style="display:block; text-align:left; color:#555;">날짜</label>
                                <input id="editExpDate" type="date" style="margin-bottom:10px;">
                                <label style="display:block; text-align:left; color:#555;">현재 레벨</label>
                                <input id="editLevelValue" type="number" min="1" max="100" style="margin-bottom:10px;">
                                <label style="display:block; text-align:left; color:#555;">현재 경험치</label>
                                <input id="editExpValue" type="text" inputmode="numeric" style="margin-bottom:10px;">
                                <button id="updateExpBtn">저장</button>
                            </div>
                        </div>
                    `);
                    $("body").append(editModal);
                } else {
                    $("#levelUpBox").html(`<p style="color:#999;">계산할 데이터가 부족합니다.</p>`);
                }

                // ✅ 아카이브 공개 토글 스위치 상태 반영
                const $toggle = $("#rankingToggle");
                if (userData.rankingPublic) {
                    $toggle.addClass("on");
                } else {
                    $toggle.removeClass("on");
                }

                // ✅ 클릭 시 상태 토글
                $toggle.off("click").on("click", async function () {
                    const nickname = getActiveNickname();
                    const isCurrentlyOn = $toggle.hasClass("on");
                    const newStatus = !isCurrentlyOn;

                    if (newStatus) {
                        // 🔹 공개로 전환하려 할 때
                        showConfirm(
                            "내 정보가 공개되며,\n다른 회원의 정보도 확인할 수 있습니다.",
                            async (ok) => {
                                if (ok) {
                                    $toggle.addClass("on");
                                    await set(ref(db, `coffeeUsers/${nickname}/rankingPublic`), true);
                                    addRankingButton();
                                }
                            }
                        );
                    } else {
                        // 🔹 비공개 전환 시
                        showConfirm(
                            "내 정보가 비공개되며,\n다른 회원의 정보도 확인할 수 없습니다.",
                            async (ok) => {
                                if (ok) {
                                    $toggle.removeClass("on");
                                    await set(ref(db, `coffeeUsers/${nickname}/rankingPublic`), false);
                                    removeRankingButton();
                                }
                            }
                        );
                    }
                });

                $(document).trigger("dataLoaded", [nickname]);
            } else {
                console.log("불러올 데이터가 없습니다.");
            }
        }

        // ✅ 레벨 입력 모달 저장 버튼
        $(document).on("click", "#saveLevelConfirmBtn", async function () {
            const nickname = getActiveNickname();
            const levelVal = parseInt($("#levelInput").val());

            if (!nickname) return showAlert("로그인 후 이용해주세요.");
            if (!levelVal || levelVal < 1 || levelVal > 100) return showAlert("1~100 사이의 값을 입력하세요.");

            await set(ref(db, `coffeeUsers/${nickname}/level`), levelVal);
            showAlert(`레벨 ${levelVal}이(가) 저장되었습니다!`);
            $("#levelModal").hide();

            // 입력 후 바로 다시 데이터 갱신
            await loadUserData(nickname);
        });

        // ✅ 삭제 버튼 클릭 시
        $(document).on("click", "#deleteExpBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname || !selectedDate) return;
            $("#optionModal").hide();
            showConfirm(`${selectedDate} 데이터를 삭제할까요?`, async (ok) => {
                if (ok) {
                    // ✅ 선택한 기록 삭제
                    await remove(ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`));

                    // ✅ 남은 기록 중 가장 최근 날짜의 레벨을 다시 불러와서 회원 레벨 갱신
                    const recordsRef = ref(db, `coffeeUsers/${nickname}/expRecords`);
                    const snapshot = await get(recordsRef);

                    if (snapshot.exists()) {
                        const records = snapshot.val();
                        const dates = Object.keys(records).sort(); // 날짜 오름차순 정렬
                        const lastDate = dates[dates.length - 1]; // 가장 최근 날짜
                        const latestLevel = records[lastDate].level;

                        // 🔹 회원 레벨을 최신 기록의 레벨로 갱신
                        await set(ref(db, `coffeeUsers/${nickname}/level`), latestLevel);
                    } else {
                        // 🔹 모든 기록이 삭제된 경우, 레벨 초기화
                        await set(ref(db, `coffeeUsers/${nickname}/level`), 1);
                    }

                    showAlert("삭제되었습니다!");
                    $("#optionModal").hide();
                    await loadUserData(nickname);
                }
            });
        });

        // ✅ 수정 저장 버튼 (쉼표 제거 후 저장)
        $(document).on("click", "#updateExpBtn", async function () {
            const nickname = getActiveNickname();
            const newLevel = parseInt($("#editLevelValue").val());
            const newExp = parseInt($("#editExpValue").val().replace(/,/g, "")); // ✅ 쉼표 제거
            const newDate = $("#editExpDate").val();

            if (!nickname) return showAlert("로그인 후 이용해주세요.");
            if (!newDate || isNaN(newExp) || newLevel < 1 || newLevel > 100) return showAlert("값이 올바르지 않습니다.");
            if (!validateDateNotFuture(newDate)) return;

            // 🔹 기존 선택된 날짜(selectedDate)는 loadUserData 내부에서 전역변수로 선언되어 있음
            if (newDate !== selectedDate) {
                // ✅ 날짜가 변경된 경우: 새로 저장 후 기존 삭제
                const oldRef = ref(db, `coffeeUsers/${nickname}/expRecords/${selectedDate}`);
                const newRef = ref(db, `coffeeUsers/${nickname}/expRecords/${newDate}`);

                await set(newRef, {level: newLevel, exp: newExp, savedAt: getKoreanTimestamp()});
                await remove(oldRef);
            } else {
                // ✅ 날짜가 그대로면 단순 수정
                const refPath = ref(db, `coffeeUsers/${nickname}/expRecords/${newDate}`);
                await set(refPath, {level: newLevel, exp: newExp, savedAt: getKoreanTimestamp()});
            }

            showAlert(`레벨 ${newLevel}\n경험치 ${newExp.toLocaleString()}(으)로 수정되었습니다!`);

            // 🔹 현재 회원의 레벨도 업데이트
            await set(ref(db, `coffeeUsers/${nickname}/level`), newLevel);

            $("#editModal").hide();
            await loadUserData(nickname);
        });

        // ✅ 목표 설정 버튼 함수
        function addGoalButton() {
            if ($("#goalBtn").length > 0) return; // 중복 방지

            const goalBtn = $('<button id="goalBtn">목표 설정</button>');
            $("#settingsDropdown").prepend(goalBtn);

            // 클릭 시 모달 열기
            goalBtn.on("click", async () => {
                const nickname = getActiveNickname();
                if (!nickname) return showAlert("로그인 후 이용해주세요.");

                const goalRef = ref(db, `coffeeUsers/${nickname}/goalTargets`);
                const snapshot = await get(goalRef);
                const savedGoals = snapshot.exists() ? snapshot.val() : [];

                // 기존 모달 제거 후 새로 생성
                $("#goalModal").remove();

                const modal = $(`
                    <div id="goalModal" class="login-overlay">
                        <div class="login-modal" style="position:relative;">
                            <button id="closeGoalModal" class="closeBtn">✕</button>
                            <h2>목표 설정</h2>
                            <div id="goalInputs" style="margin-bottom:10px;"></div>
                            <button id="saveGoalBtn">저장</button>
                        </div>
                    </div>
                `);

                $("body").append(modal);

                // 입력창 5개 생성 (쉼표 포함)
                const $goalInputs = $("#goalInputs");
                for (let i = 0; i < 5; i++) {
                    const val = savedGoals[i] ? savedGoals[i].toLocaleString() : "";
                    $goalInputs.append(`
                        <input type="text" class="goalInput" placeholder="목표 경험치 ${i + 1}" value="${val}"
                               style="width:100%; padding:8px; margin-bottom:8px;
                               font-size:16px; border:1px solid #ccc; border-radius:6px;">
                    `);
                }

                // ✅ 실시간 쉼표 포맷 + 상한(1조) 체크
                $(document).off("input", ".goalInput").on("input", ".goalInput", function () {
                    bindNumericCommaFormatter(".goalInput", 1_000_000_000_000, "목표 경험치는 최대 1조까지 입력할 수 있어요.");
                });

                // 닫기 버튼
                $(document).off("click", "#closeGoalModal").on("click", "#closeGoalModal", function() {
                    $("#goalModal").remove();
                });

                // 저장 버튼 클릭
                $(document).off("click", "#saveGoalBtn").on("click", "#saveGoalBtn", async function() {
                    const values = $(".goalInput").map((_, el) => {
                        const raw = $(el).val().replace(/,/g, ""); // 쉼표 제거
                        const num = parseInt(raw);
                        return isNaN(num) ? null : num;
                    }).get();

                    const filtered = values.filter(v => v !== null);
                    if (!validateUniqueGoals(filtered)) return;
                    if (filtered.length === 0) {
                        showAlert("목표를 하나 이상 입력해주세요.");
                        return;
                    }

                    // 오름차순 정렬
                    const sorted = filtered.sort((a, b) => a - b);

                    await set(ref(db, `coffeeUsers/${nickname}/goalTargets`), sorted);
                    showAlert("목표 경험치가 저장되었습니다!");
                    $("#goalModal").remove();

                    await loadUserData(nickname);
                });
            });
        }

        // ✅ (추가) 만렙이면 목표 등록 버튼 활성화
        async function checkGoalButtonCondition(nickname) {
            const userRef = ref(db, `coffeeUsers/${nickname}`);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) return;

            const userData = snapshot.val();
            const currentLevel = userData.level || 1;

            // 만렙이면 추가 (유동적으로 levelExp 길이 사용)
            const maxLevel = levelExp.length;
            if (currentLevel >= maxLevel) {
                addGoalButton();
            }
        }

        // ✅ 로그인 또는 데이터 로드 시 호출
        $(document).on("dataLoaded", function(e, nickname) {
            checkGoalButtonCondition(nickname);
        });

        // ✅ 닉네임 변경 모달 열기
        $(document).on("click", "#changeNicknameBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("로그인 후 이용해주세요.");

            // 기존 모달 제거 후 새로 생성
            $("#nicknameModal").remove();
            const modal = $(`
                <div id="nicknameModal" class="login-overlay">
                    <div class="login-modal" style="position:relative;">
                        <button id="closeNicknameModal" class="closeBtn">✕</button>
                        <h2>닉네임 변경</h2>
                        <input id="newNicknameInput" type="text" value="${nickname}"
                               style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:16px;">
                        <button id="saveNicknameBtn">저장</button>
                    </div>
                </div>
            `);
            $("body").append(modal);

            // 닫기 버튼
            $(document).off("click", "#closeNicknameModal").on("click", "#closeNicknameModal", function () {
                $("#nicknameModal").remove();
            });

            // 저장 버튼
            $(document).off("click", "#saveNicknameBtn").on("click", "#saveNicknameBtn", async function () {
                const newNick = $("#newNicknameInput").val().trim();
                if (!newNick) return showAlert("새 닉네임을 입력해주세요.");
                if (!validateNickname(newNick)) return;
                if (newNick === nickname) return showAlert("기존 닉네임과 동일합니다.");

                const dbRef = ref(db, `coffeeUsers/${nickname}`);
                const snapshot = await get(dbRef);
                if (!snapshot.exists()) return showAlert("계정 정보를 불러올 수 없습니다.");
                const userData = snapshot.val();

                const newRef = ref(db, `coffeeUsers/${newNick}`);
                const checkSnap = await get(newRef);
                if (checkSnap.exists()) {
                    showAlert("이미 존재하는 닉네임입니다.");
                    return;
                }

                // ✅ 닉네임 변경 로그 저장
                const safeTimestamp = getKoreanTimestamp().replaceAll('.', '_');
                const randomSuffix = Math.floor(Math.random() * 100); // 0~99
                const logKey = `${safeTimestamp}_${randomSuffix}`;

                const logRef = ref(db, `coffeeUsersLogs/nickChanges/${logKey}`);
                const logText = `${nickname}가 ${newNick}로 변경되었습니다`;
                await set(logRef, logText);

                await set(newRef, userData);
                await remove(dbRef);
                localStorage.setItem("coffee-nickname", newNick);
                showAlert("닉네임이 변경되었습니다!");
                $("#nicknameModal").remove();
                location.reload();
            });
        });


        // ✅ 비밀번호 변경 모달 열기
        $(document).on("click", "#changePasswordBtn", async function () {
            const nickname = getActiveNickname();
            if (!nickname) return showAlert("로그인 후 이용해주세요.");

            // 기존 모달 제거 후 새로 생성
            $("#passwordModal").remove();
            const modal = $(`
                <div id="passwordModal" class="login-overlay">
                    <div class="login-modal" style="position:relative;">
                        <button id="closePasswordModal" class="closeBtn">✕</button>
                        <h2>비밀번호 변경</h2>
                        <input id="newPasswordInput" type="password" placeholder="새 비밀번호 입력 (4자 이상)"
                               style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:16px;">
                        <button id="savePasswordBtn">저장</button>
                    </div>
                </div>
            `);
            $("body").append(modal);

            // 닫기 버튼
            $(document).off("click", "#closePasswordModal").on("click", "#closePasswordModal", function () {
                $("#passwordModal").remove();
            });

            // 저장 버튼
            $(document).off("click", "#savePasswordBtn").on("click", "#savePasswordBtn", async function () {
                const newPassword = $("#newPasswordInput").val().trim();
                if (!newPassword) return showAlert("새 비밀번호를 입력해주세요.");
                if(!validatePassword(newPassword)) return;

                await set(ref(db, `coffeeUsers/${nickname}/password`), newPassword);
                showAlert("비밀번호가 변경되었습니다!");
                $("#passwordModal").remove();
            });
        });
    });
</script>
</body>
</html>