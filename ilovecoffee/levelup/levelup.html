<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>그럴수이치</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS 전체화면 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard 웹폰트 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <link rel="stylesheet" href="../theme/theme.css">
    <link rel="stylesheet" href="../levelup/levelup.css"/>
    <link rel="stylesheet" href="../modules/helpModal.css"/>
    <link rel="stylesheet" href="../modules/menuToggle.css"/>
    <link rel="stylesheet" href="../modules/favoriteBtns.css"/>
</head>
<body>

<div id="mainPage" style="display:none;">

    <!-- 🔹 흘러가는 문장 영역 -->
    <div class="scrolling-text-container">
        <div class="scrolling-text"></div>
    </div>

    <div class="level-row header-bar">
        <div style="display: flex; gap: 4px; align-items: center">
            <h1>그럴수이치</h1>
            <button id="helpBtn">?</button>
        </div>

        <div class="settings-menu">
            <button id="settingsBtn">설정</button>
            <div id="settingsDropdown" class="dropdown-menu" style="display:none;">
                <button class="addSubCharacterBtn">부캐 등록</button>
                <button class="favoriteSettingBtn">즐겨찾기 설정</button>

                <button class="closeMenuBtn">메뉴닫기</button>
                <button class="notifyBtn">알림 설정</button>
                <!-- <button class="changeNicknameBtn">닉네임 변경</button> -->
                <button class="changePasswordBtn">비밀번호 변경</button>
                <button class="logoutBtn">로그아웃</button>
            </div>
        </div>
    </div>

    <div class="quickBtn-bar">
    </div>

    <div class="level-input">
        <div class="user-info">
            <div class="user-profile-wrap">
                <img class="user-profile" src="../image/profile1.jpg" alt="프로필이미지" id="profileDisplay">
                <div id="activeBadgeDisplay" class="badge-overlay"></div>
            </div>
            <span id="nicknameDisplay">닉네임</span>
            <span id="currentLevelDisplay"></span>
        </div>
        <div id="rankingToggle" class="toggle-switch"></div>
    </div>

    <div id="progressWrapper" style="display: none; justify-content: space-between; align-items: center;">
        <!-- ✅ 경험치 진행도 바 -->
        <div id="expBarContainer"
             style="position:relative; width:100%; background: var(--bg-sub); border-radius:10px; overflow:hidden; height:20px;">
            <div id="expBarFill"
                 style="height:100%; width:0; background: var(--primary); transition:width 0.6s ease;"></div>
            <div id="expBarPercent"
                 style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
                    color:white; font-size:13px; font-weight:600; text-shadow:0 0 3px rgba(0,0,0,0.5); white-space: nowrap;">
                0%
            </div>
        </div>

        <!-- 전체 레벨 진행도 표시 -->
        <div id="totalProgressBarContainer"
             style="display: none; position:relative; width:100%; background: var(--bg-sub); border-radius:10px; overflow:hidden; height:20px;">
            <div id="totalProgressBarFill"
                 style="height:100%; width:0; background: var(--primary); transition:width 0.6s ease;"></div>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
                 color:white; font-size:12px; text-shadow:0 0 3px rgba(0,0,0,0.5); white-space: nowrap;">
                진행률 : <span id="totalProgressPercent">0%</span>
                <span id="totalProgressAccum"></span>
            </div>
        </div>

        <button id="switchProgressBtn">전환</button>
    </div>

    <div class="status-box">
        <div class="status-card">
            <div class="status-item">
                <div class="status-label">평균 경험치</div>
                <div class="status-value" id="avgExp">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">남은 경험치 <span class="status-percent"></span></div>
                <div class="status-value" id="curExp">-</div>
            </div>
        </div>
    </div>

    <div id="levelUpBox" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;"></div>

    <div style="max-height: 400px;">
        <canvas id="expChart" width="100%" height="100"></canvas>
    </div>
    <div style="display:flex; justify-content: right;">
        <button id="toggleChartBtn"
                style="background: var(--primary); color: var(--text-accent); border:1px solid var(--border-main);
                 border-radius:8px; padding:5px 10px; font-weight:600;">
        </button>
    </div>

    <div style="display: flex; justify-content:space-between; margin-top: 30px;">
        <h3>일자별 경험치</h3>
        <button id="toggleExpTableBtn" style="background: var(--primary); color: var(--text-accent); border:1px solid var(--border-main);
        border-radius:8px; padding:5px 10px; font-weight:600;">하이라이트</button>
    </div>
    <table id="expTable">
        <thead>
        <tr>
            <th>날짜</th>
            <th>Lv</th>
            <th>현재 경험치</th>
            <th>획득 경험치</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 로그인 팝업 -->
<div id="loginPopup" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>로그인</h2>
        <input id="nickname" type="text" placeholder="닉네임">
        <input id="password" type="password" placeholder="비밀번호">
        <button id="loginBtn">확인</button>
        <div class="msg" id="message">
            첫 로그인시 계정이 생성됩니다.
        </div>
    </div>
</div>

<!-- 로그인 팝업 -->
<div id="subLoginPopup" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <button id="closeSubLoginPopup" class="closeBtn">✕</button>
        <h2>로그인</h2>
        <input id="subNickname" type="text" placeholder="닉네임">
        <input id="subPassword" type="password" placeholder="비밀번호">
        <button id="subLoginBtn">확인</button>
        <div class="msg" id="subMessage">
            첫 로그인시 계정이 생성됩니다.
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p>로딩 중...</p>
</div>

<!-- 경험치 입력 모달 -->
<div id="expModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position: relative;">
        <button id="closeExpModal" class="closeBtn">✕</button>
        <h2>경험치 입력</h2>
        <div style="margin-bottom:10px;">
            <label for="expDate" style="display:block; font-size:14px; text-align:left; color: var(--text-sub);">날짜</label>
            <input id="expDate" type="date"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid var(--border-sub); border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayLevel" style="display:block; font-size:14px; text-align:left; color: var(--text-sub);">현재 레벨</label>
            <input id="todayLevel" type="number" min="1" max="100"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid var(--border-sub); border-radius:6px;">
        </div>

        <div style="margin-bottom:10px;">
            <label for="todayExp" style="display:block; font-size:14px; text-align:left; color: var(--text-sub);">현재 경험치</label>
            <input id="todayExp" type="text" inputmode="numeric" placeholder="현재 경험치"
                   style="width:100%; padding:8px; font-size:16px; border:1px solid var(--border-sub); border-radius:6px;">
            <div class="formattedExp" style="text-align: left; padding-left: 10px;"></div>
        </div>

        <button id="saveExpBtn">저장</button>
    </div>
</div>

<!-- 경험치표 모달 -->
<div id="expTableModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position: relative;">
        <button id="closeExpTableModal" class="closeBtn">✕</button>
        <h2 style="margin-bottom:10px;">경험치표</h2>
        <div style="border-top:1px solid var(--border-main); border-bottom:1px solid var(--border-main);">
            <table id="expChartTable"
                   style="width:100%; border-collapse:collapse; margin-top:0; font-size:14px;">
                <thead style="position:sticky; top:0; background: var(--bg-sub); z-index:2;">
                <tr style="color: var(--primary);">
                    <th style="padding:8px; border:1px solid var(--border-main); width: 80px">레벨</th>
                    <th style="padding:8px; border:1px solid var(--border-main);">경험치</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="expTableNav"
             style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap: 8px">
            <button id="prevExpPage"
                    style="background: var(--bg-sub); color: var(--primary); border:none; border-radius:6px; padding:4px 10px;">
                〈 이전
            </button>
            <button id="nextExpPage"
                    style="background: var(--bg-sub); color: var(--primary); border:none; border-radius:6px; padding:4px 10px;">
                다음 〉
            </button>
        </div>
    </div>
</div>

<!-- 레벨 입력 모달 -->
<div id="levelModal" class="login-overlay" style="display:none;">
    <div class="login-modal">
        <h2>현재 레벨 입력</h2>
        <input id="levelInput" type="number" placeholder="레벨을 입력해주세요" min="1" max="100">
        <button id="saveLevelConfirmBtn">저장</button>
    </div>
</div>

<!-- 커스텀 알림 모달 -->
<div id="customAlert" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <button id="alertConfirmBtn">확인</button>
    </div>
</div>

<!-- 커스텀 컨펌 모달 -->
<div id="customConfirm" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div class="alert-content">
            <div class="alert-text"></div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="confirmYesBtn"
                    style="flex:1; background: var(--primary); color: var(--text-accent); border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; transition:background 0.2s;">
                확인
            </button>
            <button id="confirmNoBtn"
                    style="flex:1; background: var(--btn-close); color: var(--text-accent); border:none; border-radius:8px; font-size:16px; font-weight:600; padding:10px; transition:background 0.2s;">
                취소
            </button>
        </div>
    </div>
</div>

<!-- ✅ 프로필 변경 모달 -->
<div id="profileModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="width:320px; position:relative;">
        <button id="closeProfileModal" class="closeBtn">✕</button>
        <h2>프로필 변경</h2>

        <div id="currentProfile" style="display:flex; flex-direction:column; align-items:center;">
            <div class="user-profile-wrap" style="width: 60px; height: 60px;">
                <img id="currentProfileImg" src="../image/profile1.jpg"
                     style="width:60px; height:60px; border-radius:10px; border:2px solid var(--primary); object-fit:cover;">
                <div id="modalBadgeDisplay" class="badge-overlay" style="font-size: 20px; right: -6px; bottom: -2px;"></div>
            </div>
            <div id="currentProfileName" style="margin-top:6px; color: var(--primary); font-weight:600;">기본 프로필</div>
        </div>

        <div id="profileTabs" style="display:flex; gap:8px; margin-bottom:12px;">
            <button class="profile-tab" data-tab="normal">출석</button>
            <button class="profile-tab active" data-tab="favorite">기록</button>
            <button class="profile-tab" data-tab="rank">랭킹</button>
        </div>

        <div id="profileImageContainer"
             style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; justify-items:center; align-content: start; margin-bottom:15px; height: 340px; overflow-y:auto;">
            <!-- 이미지 목록 JS로 추가 -->
        </div>

        <button id="applyProfileBtn"
                style="width:100%; background: var(--primary); color: var(--text-accent); border:none; border-radius:8px; padding:8px 0; font-size:16px; font-weight:600;">
            변경
        </button>
    </div>
</div>

<!-- ✅ 도움말 모달 -->
<div id="helpModal" class="login-overlay" style="display:none;">
    <div class="login-modal help-modal">
        <button id="closeHelpModal" class="closeBtn">✕</button>
        <h2 class="help-title">그럴수이치 사용 가이드</h2>

        <div id="helpPages" class="help-content">
            <div class="help-page page1">
                <b>로그인</b><br>
                1) 닉네임과 비밀번호를 입력하면, 첫 로그인 시 자동으로 회원가입이 완료됩니다.<br>
                - 이미 존재하는 닉네임에 다른 비밀번호를 입력하면 로그인할 수 없습니다.<br>
                - 닉네임은 고유 식별자로 사용되므로, 인게임 닉으로 설정해주세요.
            </div>

            <div class="help-page page2" style="display:none;">
                <b>설정 메뉴</b><br>
                2) 우측 상단의 설정 버튼을 눌러 설정 메뉴를 열 수 있습니다.<br>
                - <b>부캐 등록</b>: 다른 캐릭터를 추가로 생성해 관리할 수 있습니다.<br>
                - <b>닉네임 변경</b> 및 <b>비밀번호 변경</b> 가능.<br>
                - <b>로그아웃</b> 시 현재 계정이 해제되며, 다음 로그인 때 다시 닉네임과 비밀번호를 입력해야 합니다.
            </div>

            <div class="help-page page3" style="display:none;">
                <b>경험치 입력</b><br>
                3) 매일 일정한 시간대(예: 원기옥 전후)에 <b>입력</b> 버튼을 눌러 오늘의 경험치를 기록해보세요.<br>
                - 경험치는 최근 10일간의 기록을 바탕으로 평균이 계산됩니다.<br>
                - 최근 10일 이내에 하루만 기록한 경우에는 평균과 D-day가 표시되지 않으니, 최소 2일 이상 입력해 주세요.<br>
                - 기록 시간이 일정할수록 D-day 예측이 더 정확해집니다.
            </div>

            <div class="help-page page4" style="display:none;">
                <b>아카이브</b><br>
                4) 우측 상단의 <b>공개</b> 스위치를 켜면 아카이브 기능이 활성화됩니다.<br>
                - 다른 유저들의 경험치 기록을 함께 볼 수 있습니다.<br>
                - 오늘 또는 어제의 기록이 있어야만 공개가 가능합니다.<br>
                - 비공개 상태에서는 아카이브 페이지로 이동이 불가능합니다.
            </div>

            <div class="help-page page5" style="display:none;">
                <b>프로필 변경</b><br>
                5) 닉네임 왼쪽의 <b>프로필 이미지</b>를 누르면 변경할 수 있습니다.<br>
                - 가입 후 일정 조건(7일 이상 기록 달성)을 만족하면 새로운 이미지가 해금됩니다.<br>
                - 해금된 이미지는 자유롭게 교체할 수 있습니다.
            </div>

            <div class="help-page page6" style="display:none;">
                <b>목표 경험치 설정</b><br>
                6) 만렙(100레벨)에 도달한 후에는 <b>목표 경험치</b>를 설정할 수 있습니다.<br>
                - 설정 메뉴에서 <b>목표 설정</b>을 선택하면 최대 5개의 목표를 입력할 수 있습니다.<br>
                - 각 목표는 경험치 단위로 입력하며, <b>쉼표(,)</b>로 구분 없이 숫자만 적으면 됩니다.<br>
                - 기록된 평균 경험치를 기준으로 목표 달성 예상일(D-day)이 자동 계산됩니다.<br>
                - 목표를 달성하면 <b>다음 목표</b>로 자동 전환되며, 새로 설정할 수도 있습니다.
            </div>

            <div class="help-page page7" style="display:none;">
                <b>기록 수정</b><br>
                7) 화면 하단의 일자별 기록표에서 항목을 눌러 수정하거나 삭제할 수 있습니다.<br>
                - 실수로 잘못 입력한 경험치나 레벨은 이곳에서 바로 수정 가능합니다.<br>
                - 수정 내역은 자동으로 저장됩니다.
            </div>
        </div>

        <div>
            <div id="helpDots" class="help-dots"></div>
        </div>

        <!-- ✅ 페이지네이션 -->
        <div id="helpPagination" class="help-pagination">
            <button id="prevHelpPage" class="help-btn">〈 이전</button>
            <button id="nextHelpPage" class="help-btn">다음 〉</button>
        </div>

        <div class="help-tip">다시 보고 싶을 땐, 화면 상단의 <b>?</b> 버튼을 눌러주세요.</div>
    </div>
</div>

<!-- 레벨업 기록 모달 -->
<div id="levelUpLogModal" class="login-overlay" style="display:none;">
    <div class="login-modal"
         style="position:relative; width:230px;">
        <button id="closeLevelUpLogModal" class="closeBtn">✕</button>
        <div id="levelUpLogList"
             style="text-align:left; margin-top:30px; font-size:15px; line-height:1.6; min-height: 250px;">
        </div>
        <div id="logPagination"
             style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap: 8px;">
            <button class="logPrev"
                    style="background: var(--bg-sub); color: var(--primary); border:none; border-radius:6px; padding:4px 20px 4px 10px;">
                〈 이전
            </button>
            <button class="logNext"
                    style="background: var(--bg-sub); color: var(--primary); border:none; border-radius:6px; padding:4px 10px 4px 20px;">
                다음 〉
            </button>
        </div>
    </div>
</div>

<div id="favoriteModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="width:300px; position:relative;">
        <button id="closeFavoriteModal" class="closeBtn">✕</button>
        <h2>즐겨찾기 설정</h2>

        <div id="favoriteSelectArea" style="margin:15px 0; display:flex; flex-direction:column; gap:8px;">
            <!-- 버튼 목록 JS에서 채움 -->
        </div>

        <button id="saveFavoriteBtn"
                style="width:100%; background: var(--primary); color: var(--text-accent); border:none;
                     border-radius:8px; padding:8px 0; font-size:16px; font-weight:600;">
            저장
        </button>
    </div>
</div>

<div id="notifyModal" class="login-overlay" style="display: none;">
    <div class="login-modal">
        <button id="closeNotifyModal" class="closeBtn">✕</button>
        <h2>알림 설정</h2>

        <select id="modalHour"></select>
        <select id="modalMinute"></select>

        <div class="modal-actions">
            <button id="modalSaveBtn">저장하기</button>
            <button id="modalDisableBtn">알림 끄기</button>
        </div>

        <div style="font-size: 14px; color: var(--text-sub); margin-top: 14px; text-align: left;">
            ※ 알림이 정상적으로 동작하려면<br>
            · Chrome 또는 Safari에서 알림을 ‘허용’해야 합니다.<br>
            · 일부 iOS 기기에서는 알림이 제한될 수 있습니다.
        </div>
    </div>
</div>

<div id="tirCalcModal" class="login-overlay" style="display:none;">
    <div class="login-modal" style="position:relative; width:320px;">
        <button id="closeTirCalcModal" class="closeBtn">✕</button>
        <h2 style="margin-bottom:12px;">티르계산기</h2>

        <!-- 🔹 현재 상태 요약 (카드형) -->
        <div class="tir-status">
            <div class="tir-card">
                <div class="tir-label">레벨</div>
                <div class="tir-value">
                    <span id="tirCurLevel">-</span>
                </div>
            </div>

            <div class="tir-card">
                <div class="tir-label">현재 EXP</div>
                <div class="tir-value">
                    <span id="tirCurExp">-</span>
                </div>
            </div>

            <div class="tir-card emphasis">
                <div class="tir-label">남은 EXP</div>
                <div class="tir-value highlight">
                    <span id="tirRemainExp">-</span>
                </div>
            </div>
        </div>

        <!-- 🔹 목표 날짜 -->
        <div style="margin-bottom:12px;">
            <label for="tirTargetDate"
                   style="display:block; font-size:14px; text-align:left; var(--text-sub); margin-bottom:4px;">
                목표 날짜
            </label>
            <input id="tirTargetDate"
                   type="date"
                   style="width:100%; padding:8px; font-size:15px;
                          border:1px solid var(--border-sub); border-radius:6px;">
        </div>

        <!-- 🔹 계산 결과 -->
        <div id="tirResultBox"
             style="display:none; margin-top:14px;
                    border-top:1px solid var(--border-main); padding-top:12px;">

            <div style="font-size:14px; color: var(--text-sub); margin-bottom:4px;">
                하루 필요 경험치
            </div>

            <div style="font-size:20px; font-weight:700; color: var(--primary);">
                <span id="tirDailyExp">-</span>
                <span id="tirDailyExpApprox"
                      style="font-size:13px; color: var(--text-sub); margin-top:4px;"></span>
            </div>
        </div>

        <!-- 🔹 안내 문구 -->
        <div style="font-size:12px; color: var(--text-sub); margin-top:14px; text-align:left;">
            ※ 선택한 날짜에 <b>다음 레벨</b>에 도달하기 위한<br>
            하루 평균 필요 경험치를 계산합니다.
        </div>
    </div>
</div>

<script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker
                .register("/firebase-messaging-sw.js")
                .then(() => console.log("SW 등록 성공"))
                .catch(err => console.log("SW 등록 실패:", err));
        });
    }
</script>
<script src="../theme/theme.js" type="module" defer></script>
<script src="../levelup/levelup.js" type="module" defer></script>
<script src="../modules/helpModal.js" type="module" defer></script>
<script src="../modules/menuToggle.js" type="module" defer></script>
<script src="../modules/favoriteBtns.js" type="module" defer></script>
<script src="../modules/pwaNotify.js" type="module" defer></script>
<script src="../modules/regularGuests.js" type="module" defer></script>
<script src="../modules/generalGuests.js" type="module" defer></script>
<script src="../common/computeLevelUpLogs.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>