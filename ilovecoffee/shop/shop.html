<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì  í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <link rel="stylesheet" href="../theme/theme.css">
    <link rel="stylesheet" href="../common/common.css">
    <style>
        /* =========================
           ë©”ë‰´ ì„ íƒ ì˜ì—­
        ========================= */
        .menu-tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: right;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }

        .menu-tab {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: calc((100% - 16px) / 3);
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 0;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .menu-tab.active {
            background: var(--primary);
            color: var(--text-accent);
        }

        /* =========================
           ìœ ì € ì •ë³´
        ========================= */
        .user-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 0 8px;
            margin-top: 20px;
        }

        .info-side-icon {
            color: var(--primary);
            border: 1px solid var(--border-main);
            border-radius: 4px;
        }

        /* ë‹‰ë„¤ì„ ì˜ì—­ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary);
            padding: 0 8px;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (ë±ƒì§€ ê¸°ì¤€ì ) */
        .user-profile-wrap {
            position: relative;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ì‹¤ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ */
        .user-profile {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            object-fit: cover;
        }

        /* ìƒë‹¨ í”„ë¡œí•„ìš© ë±ƒì§€ ì „ìš© ìœ„ì¹˜ */
        .user-profile-wrap .badge-overlay {
            position: absolute;
            right: -4px;
            bottom: 0;
            font-size: 12px;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.3));
            pointer-events: none;
        }

        /* ì¬í™” ì˜ì—­ */
        .user-currency {
            display: grid;
            grid-template-columns: 4fr 6fr;
            gap: 10px;
        }

        /* ê°œë³„ ì¬í™” */
        .currency-item {
            display: flex;
            justify-content: right;
            align-items: center;
            gap: 4px;
            border-radius: 999px;
            border: 1px solid var(--border-main);
            font-size: 14px;
            width: 100%;
        }

        /* ì¬í™” ë¼ë²¨ */
        .currency-label {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-sub);
            color: var(--primary);
            font-weight: 500;
            height: 30px;
            width: 45px;
            text-align: center;
            border-left: 1px solid var(--border-main);
            border-radius: 0 999px 999px 0;
        }

        /* ì¬í™” ê°’ */
        .currency-value {
            color: var(--primary);
            font-weight: 700;
            padding: 4px;
        }

        /* =========================
           ìƒí’ˆ ê³µí†µ ì˜ì—­
        ========================= */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            border-radius: 10px;
            padding: 12px 4px 4px 4px;
            text-align: center;
            font-size: 14px;
        }

        /* =========================
            ì¬í™” ìƒì ì˜ì—­
        ========================= */
        .box-image {
            height: 48px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            display: block;
        }

        /* =========================
           í…Œë§ˆ ì˜ì—­
        ========================= */
        .theme-color-strip {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            height: 48px;
            overflow: hidden;
            border-radius: 6px;
            border: 1px solid var(--border-main);
        }

        /* ê°œë³„ ì»¬ëŸ¬ */
        .theme-color-bar {
            height: 100%;
        }

        /* =========================
            ìƒì ê°œë´‰ ì—°ì¶œ
        ========================= */
        #boxOpenOverlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box-open-container {
            position: relative;
            text-align: center;
        }

        #boxOpenImage {
            width: 120px;
            animation: shake 1s ease-in-out;
            z-index: 1;
        }

        /* í”ë“¤ë¦¼ */
        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }
            20% {
                transform: rotate(-10deg);
            }
            40% {
                transform: rotate(10deg);
            }
            60% {
                transform: rotate(-8deg);
            }
            80% {
                transform: rotate(8deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

        /* í™•ë¥  ì´í™íŠ¸ */
        #boxEffect {
            position: absolute;
            width: 120px;
            height: 120px;
            inset: 0;
            border-radius: 50%;
            animation: burst 1.5s ease-out forwards;
            z-index: 2;
        }

        @keyframes burst {
            from {
                transform: scale(0.5);
            }
            to {
                transform: scale(10);
                opacity: 0;
            }
        }

        #boxResultText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            z-index: 3;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes resultFloatUp {
            0% {
                transform: translate(-50%, -100%) scale(0.5);
            }
            100% {
                transform: translate(-50%, -500%) scale(1.5);
            }
        }

        #boxResultText.show {
            animation: resultFloatUp 0.6s ease-out forwards;
        }

        #boxHintText {
            padding-top: 40px;
            color: var(--text-sub);
            opacity: 0.6;
            letter-spacing: -0.3px;
            animation: hintBlink 1.6s ease-in-out infinite;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes hintBlink {
            0%, 100% {
                opacity: 0.4;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* âœ… ë¡œê·¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .log-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .log-modal .modal-content {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 320px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-content button {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
        }

        .close-btn {
            background: var(--btn-close);
            color: var(--text-accent);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            align-items: center;
            margin-bottom: 16px;
        }

        .log-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-main);
        }

        .date-nav-btn {
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            color: var(--text-main);
            padding: 4px 12px;
            border-radius: 6px;
        }

        #logContent {
            flex: 1;
            overflow-y: auto;
            text-align: left;
            min-height: 200px;
            border-top: 1px solid var(--border-sub);
            padding-top: 8px;
        }

        /* ë¡œê·¸ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ */
        .log-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-sub);
        }

        .log-item-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .log-item-time {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 2px;
        }

        /* =========================
            ë¯¸ë‹ˆê²Œì„ (ê³¨ë“ ìƒ· ì¶”ì¶œ)
        ========================= */
        /* ê²Œì´ì§€ íŠ¸ë™ (ë°°ê²½ ë°”) */
        .gauge-track {
            position: relative;
            width: 100%;
            height: 35px;
            background: var(--bg-main); /* í”„ë¡œì íŠ¸ ê³µí†µ ë°°ê²½ìƒ‰ */
            background-image: linear-gradient(90deg, var(--border-main) 1px, transparent 1px);
            background-size: 10% 100%;
            border: 2px solid var(--border-main);
            border-radius: 20px;
            margin: 25px 0;
            overflow: visible;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ëª©í‘œ ì§€ì  (Golden Zone) */
        #target-zone {
            position: absolute;
            left: 70%; /* ì„±ê³µ ë²”ìœ„ ì‹œì‘ */
            width: 5%; /* ì„±ê³µ ë²”ìœ„ ë„ˆë¹„ */
            height: 100%;
            background: #FFC90E; /* ê³¨ë“œ ìƒ‰ìƒ */
            box-shadow: 0 0 15px #FFC90E; /* í™©ê¸ˆë¹› ê´‘ì±„ */
            animation: glow 0.8s ease-in-out infinite alternate;
            opacity: 0.6;
            border-left: 2px dashed rgba(255, 255, 255, 0.5);
            border-right: 2px dashed rgba(255, 255, 255, 0.5);
        }

        @keyframes glow {
            from { opacity: 0.5; }
            to { opacity: 1; box-shadow: 0 0 25px #FFC90E; }
        }

        /* ì›€ì§ì´ëŠ” ê²Œì´ì§€ ë°” */
        #gauge-bar {
            position: absolute;
            width: 8px;
            height: 100%;
            background: var(--primary); /* í”„ë¡œì íŠ¸ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
            left: 0;
            box-shadow: 0 0 10px var(--primary);
            z-index: 2;
            border-radius: 4px;
        }

        #gauge-bar > div {
            animation: float 0.6s ease-in-out infinite alternate;
        }

        @keyframes float {
            from { transform: translateX(-50%) translateY(0); }
            to { transform: translateX(-50%) translateY(-5px); }
        }

        /* ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ (ê¸°ì¡´ ë²„íŠ¼ê³¼ í†µì¼ê°) */
        #miniGameActionBtn {
            flex: 2;
            background: var(--primary);
            color: var(--text-accent);
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            transition: transform 0.1s;
        }

        #miniGameActionBtn:active {
            transform: scale(0.96); /* í´ë¦­ ì‹œ ëˆŒë¦¬ëŠ” íš¨ê³¼ */
        }

        /* =========================
           ì˜¤ëŠ˜ì˜ ë°”ë¦¬ìŠ¤íƒ€ (ëŒ€í˜• ìŠ¤í¬íŠ¸ë¼ì´íŠ¸)
        ========================= */
        .spotlight-label-layout {
            margin-top: 20px;
            text-align: center;
        }

        .spotlight-body {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .spotlight-msg-title {
            font-weight: 800;
            color: var(--primary); /* í”„ë¡œì íŠ¸ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
            margin-bottom: 2px;
            width: 100%;
            text-align: left;
        }

        .spotlight-card {
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            border-radius: 20px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: visible;
        }

        /* 1ë“± ìŠ¤íƒ€ì¼ ë°•ìŠ¤ ì´ì‹ */
        .spotlight-profile-box {
            width: 110px;
            height: 110px;
            flex-shrink: 0;
            border-radius: 16px;
            border: 6px solid #FFC400; /* ê³¨ë“œ ë³´ë” */
            box-shadow: inset 0 0 0 3px #FFC400, 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: visible;
        }

        .spotlight-img-wrap {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        .spotlight-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ë±ƒì§€ ìœ„ì¹˜ ë° í¬ê¸° ê°•í™” */
        .spotlight-badge {
            position: absolute;
            right: -14px;
            bottom: -8px;
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            pointer-events: none;
        }

        .spotlight-label {
            display: inline-block;
            padding: 2px 10px;
            background: var(--primary);
            color: var(--text-accent);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 800;
        }

        .spotlight-msg {
            font-size: 14px;
            color: var(--text-sub);
            line-height: 1.4;
            word-break: keep-all;
        }

    </style>
    <link rel="stylesheet" href="../modules/helpModal.css"/>
    <link rel="stylesheet" href="../modules/menuToggle.css"/>
<body>
<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>íŠ¹ë³„ìƒì </h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- âœ… ìƒë‹¨ ë©”ë‰´ -->
<div class="menu-tabs">
    <div class="menu-tab" data-menu="boxes">
        <span>ì¬í™” ìƒì</span>
    </div>
    <div class="menu-tab" data-menu="themes">
        <span>ì–´í”Œ í…Œë§ˆ</span>
    </div>
    <div class="menu-tab" data-menu="badges">
        <span>í”„ë¡œí•„ ë±ƒì§€</span>
    </div>
    <div class="menu-tab" data-menu="miniGame">
        ë¯¸ë‹ˆê²Œì„
    </div>
</div>

<div class="user-info-container">
    <div class="user-info">
        <div class="user-profile-wrap">
            <img class="user-profile" src="../image/profile1.jpg" alt="í”„ë¡œí•„ì´ë¯¸ì§€" id="profileDisplay">
            <div id="activeBadgeDisplay" class="badge-overlay"></div>
        </div>
        <span id="nicknameDisplay">ë‹‰ë„¤ì„</span>
    </div>
    <div class="info-side-icon log-view-btn">
        <svg viewBox="0 0 28 28" width="28" height="28" stroke="currentColor" stroke-width="2.5" fill="none">
            <line x1="3" y1="7" x2="25" y2="7"></line>
            <line x1="3" y1="14" x2="25" y2="14"></line>
            <line x1="3" y1="21" x2="25" y2="21"></line>
        </svg>
    </div>
</div>

<div class="user-currency">
    <div class="currency-item">
        <span id="couponDisplay" class="currency-value">0</span>
        <span class="currency-label">ğŸ«</span>
    </div>
    <div class="currency-item">
        <span id="hDisplay" class="currency-value">0</span>
        <span class="currency-label">H</span>
    </div>
</div>

<div id="shopContents">
    <div class="shop-content" data-content="boxes"></div>
    <div class="shop-content" data-content="themes" style="display:none;"></div>
    <div class="shop-content" data-content="badges" style="display:none;"></div>
    <div class="shop-content" data-content="miniGame" style="display:none;">
        <div class="mini-game-wrapper" style="padding: 20px; text-align: center;">
            <h2 style="color:var(--primary);">GOLDEN SHOT</h2>
            <p style="color:var(--text-sub); font-size: 14px;">íƒ€ì´ë°ì— ë§ì¶° ì¶”ì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!</p>

            <div class="gauge-track">
                <div id="target-zone"></div>
                <div id="gauge-bar" style="overflow: visible;">
                    <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 25px;">ğŸ¦Š</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button id="miniGameActionBtn" style="width: 100%;">ì¶”ì¶œ ì‹œì‘</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ ìƒì ê°œë´‰ ì—°ì¶œ ë ˆì´ì–´ -->
<div id="boxOpenOverlay" style="display:none;">
    <div class="box-open-container">
        <img id="boxOpenImage" src="" alt="box">
        <div id="boxEffect"></div>
        <div id="boxResultText"></div>
        <div id="boxHintText">í™”ë©´ì„ í„°ì¹˜í•´ ì£¼ì„¸ìš”</div>
    </div>
</div>

<!-- ğŸ¨ í…Œë§ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="themeSelectModal" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div id="themeModalText" style="text-align: center; margin-bottom: 20px;"></div>
        <div class="alert-content">
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img" style="transform: scaleX(-1);">
            <div style="display: flex; flex-direction: column; gap: 10px; width:100%;">
                <button id="themeBuyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    êµ¬ë§¤
                </button>
                <button id="themeApplyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì ìš©
                </button>
                <button id="themePreviewBtn"
                        style="flex:1; background:var(--bg-sub); color:var(--primary); border:1px solid var(--border-main); border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button id="themeCancelBtn"
                        style="flex:1; background:var(--btn-close); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì·¨ì†Œ
                </button>
            </div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
    </div>
</div>

<!-- ğŸ¦Š ë±ƒì§€ ì„ íƒ ëª¨ë‹¬ -->
<div id="badgeSelectModal" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div id="badgeModalText" style="text-align: center; margin-bottom: 20px;"></div>
        <div class="alert-content">
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img" style="transform: scaleX(-1);">
            <div style="display: flex; flex-direction: column; gap: 10px; width:100%;">
                <button id="badgeBuyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    êµ¬ë§¤
                </button>
                <button id="badgeApplyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì ìš©
                </button>
                <button id="badgePreviewBtn"
                        style="flex:1; background:var(--bg-sub); color:var(--primary); border:1px solid var(--border-main); border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button id="badgeCancelBtn"
                        style="flex:1; background:var(--btn-close); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë‹«ê¸°
                </button>
            </div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
    </div>
</div>

<!-- ğŸ¦Š ë±ƒì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="badgePreviewOverlay" class="login-overlay" style="display:none;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div id="previewNickname"
             style="color: #FFC90E; font-weight: 600; font-size: 24px; text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);"></div>
        <div style="position: relative; width: 200px; height: 200px;">
            <img id="previewProfileImg" src="" alt="profile"
                 style="width: 100%; height: 100%; border-radius: 15px; object-fit: cover; box-shadow: 0 0 15px rgba(0,0,0,0.3);">
            <div id="previewBadgeIcon"
                 style="position: absolute; right: -16px; bottom: -8px; font-size: 50px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));"></div>
        </div>
        <p style="color: white; font-size: 14px; opacity: 0.8;">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤</p>
    </div>
</div>

<div id="logModal" class="log-modal">
    <div class="modal-content">
        <div class="log-header">
            <button id="prevDate" class="date-nav-btn">â—€</button>
            <h4 id="logDateTitle">2026-00-00</h4>
            <button id="nextDate" class="date-nav-btn">â–¶</button>
        </div>
        <div id="logContent">
        </div>
        <button class="close-log-btn close-btn">ë‹«ê¸°</button>
    </div>
</div>

<div class="spotlight-label-layout">
    <div class="spotlight-label">ğŸ€ TODAY'S BARISTA ğŸ€</div>
</div>

<div id="spotlightBody" class="spotlight-body">
    <div class="spotlight-profile-box">
        <div class="spotlight-img-wrap">
            <img id="spotlightImg" src="" alt="ë°”ë¦¬ìŠ¤íƒ€">
        </div>
        <div id="spotlightBadge" class="spotlight-badge"></div>
    </div>

    <div class="spotlight-card">
        <div class="spotlight-msg-title">ì˜¤ëŠ˜ì˜ í•œë§ˆë””</div>
        <div id="spotlightMsg" class="spotlight-msg">"ë°˜ê°‘ìŠµë‹ˆë‹¤!"</div>
    </div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p>ë¡œë”© ì¤‘...</p>
</div>

<script src="../theme/theme.js" type="module" defer></script>
<script type="module" defer>
    import {initializeApp, getApps, getApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        set,
        runTransaction,
        update,
        query,
        orderByKey,
        startAt,
        endAt
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    import {SHOP_DATA} from "../common/shopData.js";
    import {applySavedThemeOnLoad} from "../theme/theme.js";
    import {
        goToPage,
        showAlert,
        closeAlert,
        showConfirm,
        getActiveNickname,
        getKoreanTimestamp,
        getKoreanDate
    } from "../common/utils.js";
    import {getProfileImageSrc} from "../common/profileUtils.js";
    import {writeWalletLog, giveCoupon} from "../common/walletUtils.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId"
    };

    const app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const $loadingScreen = $("#loadingScreen");

    // ìƒì  í˜ì´ì§€ ì „ìš© ìºì‹œ
    const shopProfileCache = {
        nickname: null,
        profileImgId: null,
        profileImgSrc: null
    };

    let inventoryThemes = {};
    let inventoryBadges = {};
    let activeBadgeId = null;

    // âœ… ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", "#alertConfirmBtn", function () {
        closeAlert();
    });

    /** ìƒì  ìƒë‹¨(í”„ë¡œí•„/ë‹‰ë„¤ì„/ì¬í™”) ë¡œë”© */
    async function loadShopHeader() {
        try {
            const nickname = getActiveNickname();
            if (!nickname) return;

            // 1) í”„ë¡œí•„ ì´ë¯¸ì§€ ë²ˆí˜¸ (coffeeUsers)
            const profileImgRef = ref(db, `coffeeUsers/${nickname}/profileImg`);
            const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);

            // 2) ì¬í™”/ì¸ë²¤í† ë¦¬ (coffeeStore)
            const storeRef = ref(db, `coffeeStore/${nickname}`);

            // âœ… ë³‘ë ¬ ì¡°íšŒ (ì†ë„ ì´ë“)
            const [profileSnap, badgeSnap, storeSnap] = await Promise.all([
                get(profileImgRef),
                get(activeBadgeRef),
                get(storeRef)
            ]);

            // --- í”„ë¡œí•„/ë‹‰ë„¤ì„ í‘œì‹œ ---
            $("#nicknameDisplay").text(nickname);
            const profileImgId = profileSnap.exists() ? profileSnap.val() : null;
            const profileSrc = getProfileImageSrc(profileImgId);

            // --- âœ… ì°©ìš© ë±ƒì§€ ì •ë³´ ì €ì¥ (ë°ì´í„° ì–‘ ìµœì†Œí™”) ---
            activeBadgeId = badgeSnap.exists() ? badgeSnap.val() : "NONE";
            const badgeIcon = SHOP_DATA.badges[activeBadgeId]?.icon || "";
            $("#activeBadgeDisplay").text(badgeIcon);

            // âœ… ìºì‹œ ì €ì¥ (ìµœì´ˆ 1íšŒ ê¸°ì¤€ê°’)
            shopProfileCache.nickname = nickname;
            shopProfileCache.profileImgId = profileImgId;
            shopProfileCache.profileImgSrc = profileSrc;

            $("#profileDisplay").attr("src", profileSrc);

            // --- ì¬í™” í‘œì‹œ ---
            if (!storeSnap.exists() || !storeSnap.val().wallet) {
                const ts = getKoreanTimestamp();
                const startCoupon = 1;
                // ğŸ ìµœì´ˆ ë°©ë¬¸ ë³´ìƒ: ì¿ í° ì§€ê¸‰
                const initWallet = {
                    coupon: startCoupon,
                    h: 0
                };

                await update(ref(db, `coffeeStore/${nickname}`), {
                    wallet: initWallet
                });

                applyWalletToUI(initWallet);
                await writeWalletLog(nickname, "ì„±ê³µ", ts, "íšë“", "ì¿ í°", startCoupon, "ì²« ë°©ë¬¸ ë³´ìƒ");
                showAlert("ğŸ ì²« ë°©ë¬¸ ë³´ìƒ!\nğŸ« ë“œë¦´ê²Œìš”~!");
                return;
            }

            const store = storeSnap.val();
            applyWalletToUI(store.wallet);
            inventoryThemes = store.inventory?.themes || {};
            inventoryBadges = store.inventory?.badges || {};
            await loadRandomBarista();
        } finally {
            $loadingScreen.hide();
            if (rendered.themes) renderThemes();
            if (rendered.badges) renderBadges();
        }
    }

    /** ì¬í™” UI ë°˜ì˜ */
    function applyWalletToUI(wallet) {
        const coupon = wallet && wallet.coupon != null ? Number(wallet.coupon) : 0;
        const h = wallet && wallet.h != null ? Number(wallet.h) : 0;

        $("#couponDisplay").text(coupon.toLocaleString());
        $("#hDisplay").text(h.toLocaleString());
    }

    const rendered = {
        boxes: false,
        themes: false,
        badges: false,
        miniGame: false
    };

    const $menuTab = $(".menu-tab");

    $menuTab.on("click", function () {
        const target = $(this).data("menu");

        // ğŸ”‘ URL í•´ì‹œ ë³€ê²½
        location.hash = target;

        // ì½˜í…ì¸  ì „ë¶€ ìˆ¨ê¹€
        $(".shop-content").hide();

        // í•´ë‹¹ ì½˜í…ì¸  í‘œì‹œ
        const $targetContent = $('.shop-content[data-content="' + target + '"]');
        $targetContent.show();

        // íƒ­ í™œì„±í™”
        $menuTab.removeClass("active");
        $(this).addClass("active");

        // âœ… ì•„ì§ ë Œë” ì•ˆ í–ˆìœ¼ë©´ ì—¬ê¸°ì„œ ë Œë”
        if (!rendered[target]) {
            if (target === "boxes") renderBoxes();
            if (target === "themes") renderThemes();
            if (target === "badges") renderBadges();
            if (target === "miniGame") initMiniGameTab();
            rendered[target] = true;
        }
    });

    function activateTabByHash() {
        const hash = location.hash.replace("#", "");
        const target = hash || "boxes";

        const $tab = $(`.menu-tab[data-menu="${target}"]`);

        if ($tab.length) {
            $tab.trigger("click");
        } else {
            $menuTab.first().trigger("click");
        }
    }

    loadShopHeader();
    activateTabByHash();

    // ==============================
    // SHOP_DATA ë Œë”ë§
    // ==============================
    function renderBoxes() {
        const $container = $('.shop-content[data-content="boxes"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.boxes).forEach(box => {
            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${box.name}</div>
                    <div style="display: flex; justify-content: center;">
                        <img src="${box.img}" alt="${box.name}" class="box-image">
                    </div>
                    <div style="font-size:12px; color:var(--text-sub); text-align: right;">
                        ${box.couponCost.toLocaleString()}ğŸ«
                    </div>
                </div>
            `);
            $item.on("click", () => confirmOpenBox(box));
            $grid.append($item);
        });

        $container.append($grid);
    }

    function pickReward(rewards) {
        const total = rewards.reduce((sum, r) => sum + r.rate, 0);
        let roll = Math.random() * total;

        for (const r of rewards) {
            roll -= r.rate;
            if (roll <= 0) return r.h;
        }
        return rewards[rewards.length - 1].h; // ì•ˆì „ì¥ì¹˜
    }

    function buildProbabilityText(rewards) {
        return rewards
            .map(r => `â€¢ ${r.h}H (${r.rate}%)`)
            .join("\n");
    }

    function confirmOpenBox(box) {
        const probabilityText = buildProbabilityText(box.rewards);

        showConfirm(
            `${box.name}ë¥¼ ê°œë´‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
            `í•„ìš” : ${box.couponCost.toLocaleString()}ğŸ«\n\n` +
            `[íšë“ í™•ë¥ ]\n${probabilityText}`,
            (confirmed) => {
                if (!confirmed) return;
                openBox(box);
            }
        );
    }

    function buildRewardTierMap(rewards) {
        // h ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
        const sorted = [...rewards]
            .map(r => r.h)
            .sort((a, b) => a - b);

        const maxH = sorted[sorted.length - 1]; // ìµœê³  ë³´ìƒ
        const rest = sorted.slice(0, -1);       // ë‚˜ë¨¸ì§€

        const half = Math.ceil(rest.length / 2);

        const lowTier = new Set(rest.slice(0, half));
        const midTier = new Set(rest.slice(half));

        return {
            maxH,
            midTier,
            lowTier
        };
    }

    function getEffectColorByBox(rewardH, box) {
        const tierMap = buildRewardTierMap(box.rewards);

        if (rewardH === tierMap.maxH) {
            return "#FFC400"; // ìµœê³  ë³´ìƒ
        }

        if (tierMap.midTier.has(rewardH)) {
            return "#CFCFCF"; // ì¤‘ê°„ ë³´ìƒ
        }

        return "#C48A5A";     // ìµœí•˜ ë³´ìƒ
    }

    async function openBox(box) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const rewardH = pickReward(box.rewards);
        const ts = getKoreanTimestamp();
        const effectColor = getEffectColorByBox(rewardH, box);

        // âœ… 1ï¸âƒ£ ë¨¼ì € íŠ¸ëœì­ì…˜ë¶€í„°
        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            // ì¿ í° ë¶€ì¡± â†’ íŠ¸ëœì­ì…˜ ì¤‘ë‹¨
            if (wallet && safeWallet.coupon < box.couponCost) return;

            safeWallet.coupon -= box.couponCost;
            safeWallet.h += rewardH;
            return safeWallet;
        });

        // âŒ ì‹¤íŒ¨ ì‹œ: ì—°ì¶œ ì—†ì´ ì•Œë¦¼ë§Œ
        if (!result.committed) {
            showAlert("ğŸ«ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. ì¿ í° ì‚¬ìš© ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "ì¿ í°", box.couponCost, `${box.name} ê°œë´‰`);
        // 2. H íšë“ ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "íšë“", "H", rewardH, `${box.name} ë³´ìƒ íšë“`);

        // âœ… 2ï¸âƒ£ ì„±ê³µí–ˆì„ ë•Œë§Œ ì—°ì¶œ ì‹œì‘
        applyWalletToUI(result.snapshot.val());

        const $resultText = $("#boxResultText");

        $("#boxOpenImage").attr("src", box.img);
        $("#boxEffect").css("background", effectColor);
        $resultText.hide();

        $("#boxOpenOverlay").fadeIn(150);

        // í”ë“¤ë¦¼ ëë‚œ ë’¤ ê²°ê³¼ í‘œì‹œ
        setTimeout(() => {
            $resultText
                .removeClass("show")
                .text(`ğŸ¦Š ${rewardH.toLocaleString()}H íšë“!`)
                .show();

            // ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ ë³´ì¥
            void $resultText[0].offsetWidth;
            $resultText.addClass("show");
        }, 800);
    }

    // âœ… ìƒì ê°œë´‰ ì—°ì¶œ í´ë¦­ ì‹œ ë‹«ê¸°
    $(document).on("click", "#boxOpenOverlay", function () {
        closeBoxOpenOverlay();
    });

    function closeBoxOpenOverlay() {
        $("#boxOpenOverlay").fadeOut(300);

        // ë‹¤ìŒ ì—°ì¶œì„ ìœ„í•´ ìƒíƒœ ì´ˆê¸°í™”
        $("#boxResultText").hide().css("opacity", 1);
        $("#boxEffect").stop(true, true);
    }

    function renderThemes() {
        const $container = $('.shop-content[data-content="themes"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.themes).forEach(theme => {
            const owned = theme.priceH === 0 || inventoryThemes?.[theme.id];
            const applied = localStorage.getItem("activeTheme") === theme.id;
            const statusText = applied ? "ì ìš© ì¤‘" : owned ? "ë³´ìœ  ì¤‘" : "";
            const statusColor = applied ? "var(--primary)" : "var(--text-sub)";
            const priceText = theme.priceH === 0 ? 'ë¬´ë£Œ' : `${theme.priceH.toLocaleString()}H`;

            const colorBars = theme.previewColors.map(color =>
                `<div class="theme-color-bar" style="background:${color}"></div>`
            ).join("");

            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${theme.name}</div>
                    <div class="theme-color-strip">${colorBars}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                        <span style="color:${statusColor}; font-weight:600;">
                            ${statusText}
                        </span>
                        <span style="color:var(--text-sub);">
                            ${priceText}
                        </span>
                    </div>
                </div>
            `);
            $item.on("click", () => onThemeClick(theme, owned));
            $grid.append($item);
        });

        $container.append($grid);
    }

    let currentThemeTarget = null;

    function onThemeClick(theme, isOwned) {
        currentThemeTarget = theme;

        $("#themeModalText").text(`${theme.name} í…Œë§ˆ`);

        if (isOwned) {
            $("#themeBuyBtn").hide();
            $("#themePreviewBtn").hide();
            $("#themeApplyBtn").show();
        } else {
            $("#themeBuyBtn").show();
            $("#themePreviewBtn").show();
            $("#themeApplyBtn").hide();
        }

        $("#themeSelectModal").fadeIn(150);
    }

    $("#themeBuyBtn").on("click", function () {
        if (!currentThemeTarget) return;

        purchaseTheme(currentThemeTarget);
        $("#themeSelectModal").fadeOut(150);
    });

    $("#themePreviewBtn").on("click", function () {
        if (!currentThemeTarget) return;

        $("html").attr("data-theme", currentThemeTarget.id);
        $("#themeSelectModal").fadeOut(150);
    });

    $("#themeApplyBtn").on("click", function () {
        if (!currentThemeTarget) return;

        applyTheme(currentThemeTarget.id);
    });

    $("#themeCancelBtn").on("click", function () {
        $("#themeSelectModal").fadeOut(150);
    });

    function applyTheme(themeId) {
        $("html").attr("data-theme", themeId);
        localStorage.setItem("activeTheme", themeId);
        location.reload();
    }

    async function purchaseTheme(theme) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const inventoryRef = ref(db, `coffeeStore/${nickname}/inventory/themes/${theme.id}`);
        const ts = getKoreanTimestamp();

        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            if (wallet && safeWallet.h < theme.priceH) return;

            safeWallet.h -= theme.priceH;
            return safeWallet;
        });

        if (!result.committed) {
            showAlert("Hê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. H ì‚¬ìš© ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "H", theme.priceH, `${theme.name} í…Œë§ˆ êµ¬ë§¤`);

        // âœ… í…Œë§ˆ ì†Œìœ  ì²˜ë¦¬
        await set(inventoryRef, true);

        localStorage.setItem("activeTheme", theme.id);
        applySavedThemeOnLoad();
        applyWalletToUI(result.snapshot.val());
        location.reload();
    }

    function renderBadges() {
        const $container = $('.shop-content[data-content="badges"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.badges).forEach(badge => {
            const owned = badge.priceH === 0 || inventoryBadges?.[badge.id];
            const applied = activeBadgeId === badge.id;
            const statusText = applied ? "ì ìš© ì¤‘" : owned ? "ë³´ìœ  ì¤‘" : "";
            const statusColor = applied ? "var(--primary)" : "var(--text-sub)";
            const priceText = badge.priceH === 0 ? 'ë¬´ë£Œ' : badge.priceH.toLocaleString() + 'H';


            const badgeIcon = badge.icon ? badge.icon : `ğŸš«`;

            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${badge.name}</div>
                    <div style="font-size:36px;">${badgeIcon}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                        <span style="color:${statusColor}; font-weight:600;">
                            ${statusText}
                        </span>
                        <span style="color:var(--text-sub);">
                            ${priceText}
                        </span>
                    </div>
                </div>
            `);
            $item.on("click", () => onBadgeClick(badge, owned));
            $grid.append($item);
        });

        $container.append($grid);
    }

    let currentBadgeTarget = null;

    function onBadgeClick(badge, isOwned) {
        currentBadgeTarget = badge;
        $("#badgeModalText").text(`${badge.name} ë±ƒì§€`);

        if (isOwned) {
            $("#badgeBuyBtn").hide();
            $("#badgePreviewBtn").hide();
            $("#badgeApplyBtn").show();
        } else {
            $("#badgeBuyBtn").show();
            $("#badgePreviewBtn").show();
            $("#badgeApplyBtn").hide();
        }

        $("#badgeSelectModal").fadeIn(150);
    }

    // âœ… ë±ƒì§€ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
    $("#badgePreviewBtn").on("click", function () {
        if (!currentBadgeTarget) return;

        const nickname = shopProfileCache.nickname;
        const profileSrc = shopProfileCache.profileImgSrc;

        $("#previewNickname").text(nickname);
        $("#previewProfileImg").attr("src", profileSrc);
        $("#previewBadgeIcon").text(currentBadgeTarget.icon || "");

        $("#badgeSelectModal").hide(); // ë±ƒì§€ ì„ íƒ ëª¨ë‹¬ ì ì‹œ ìˆ¨ê¹€
        $("#badgePreviewOverlay").fadeIn(150);
    });

    // âœ… ë±ƒì§€ êµ¬ë§¤ ë²„íŠ¼ í´ë¦­ ì‹œ
    $("#badgeBuyBtn").on("click", function () {
        if (!currentBadgeTarget) return;

        purchaseBadge(currentBadgeTarget);
        $("#badgeSelectModal").fadeOut(150);
    });

    // âœ… ë±ƒì§€ êµ¬ë§¤ ë° ì„œë²„ ì ìš© í•¨ìˆ˜
    async function purchaseBadge(badge) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const inventoryRef = ref(db, `coffeeStore/${nickname}/inventory/badges/${badge.id}`);
        const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);
        const ts = getKoreanTimestamp();

        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            // ì¬í™” ë¶€ì¡± ì‹œ ì¤‘ë‹¨
            if (wallet && safeWallet.h < badge.priceH) return;

            safeWallet.h -= badge.priceH;
            return safeWallet;
        });

        if (!result.committed) {
            showAlert("Hê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. H ì‚¬ìš© ë¡œê·¸ ê¸°ë¡
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "H", badge.priceH, `${badge.name} ë±ƒì§€ êµ¬ë§¤`);

        // 2. í†µí•© ì—…ë°ì´íŠ¸: ë‹¨ í•œ ë²ˆì˜ ì„œë²„ í†µì‹ ìœ¼ë¡œ ì¸ë²¤í† ë¦¬ ì¶”ê°€ì™€ ì°©ìš© ë±ƒì§€ ë³€ê²½ ì²˜ë¦¬
        const updates = {};
        updates[`coffeeStore/${nickname}/inventory/badges/${badge.id}`] = true;
        updates[`coffeeUsers/${nickname}/activeBadge`] = badge.id;

        await update(ref(db), updates);

        // UI ê°±ì‹ ì„ ìœ„í•´ í˜ì´ì§€ ë¦¬ë¡œë“œ (ë˜ëŠ” ì¬ë Œë”ë§ ì²˜ë¦¬)
        applyWalletToUI(result.snapshot.val());
        location.reload();
    }

    // âœ… ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ ë‹«ê¸°
    $(document).on("click", "#badgePreviewOverlay", function () {
        $(this).fadeOut(150);
    });

    // âœ… ë±ƒì§€ ì ìš© ë²„íŠ¼ í´ë¦­ ì‹œ (ë³´ìœ  ì¤‘ì¸ ë±ƒì§€ ì¥ì°©)
    $("#badgeApplyBtn").on("click", async function () {
        if (!currentBadgeTarget) return;

        const nickname = getActiveNickname();
        if (!nickname) return;

        // ì ìš©ì€ ì¬í™” ì†Œëª¨ê°€ ì—†ìœ¼ë¯€ë¡œ transaction ì—†ì´ ë°”ë¡œ set ì²˜ë¦¬
        const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);

        try {
            await set(activeBadgeRef, currentBadgeTarget.id);

            $("#badgeSelectModal").fadeOut(150);
            location.reload();
        } catch (err) {
            console.error("Badge Apply Error:", err);
            showAlert("ë±ƒì§€ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    $(document).on("click", "#badgeCancelBtn", function () {
        $("#badgeSelectModal").fadeOut(150);
    });

    /* ======================
        ì¬í™” ë¡œê·¸ ê´€ë¦¬ ìƒíƒœ
    ====================== */
    let currentLogNick = "";
    let currentLogDate = new Date();

    async function fetchWalletLogs(nickname, dateObj) {
        // 1. ì¿¼ë¦¬ìš© ë‚ ì§œ í‚¤ ìƒì„± (ID í¬ë§·: 26_01_06)
        const yy = String(dateObj.getFullYear()).slice(-2);
        const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
        const dd = String(dateObj.getDate()).padStart(2, '0');

        const dateKeyPrefix = `${yy}_${mm}_${dd}`; // ê²°ê³¼: "26_01_06"

        $("#logDateTitle").text(`${dateObj.getFullYear()}.${mm}.${dd}`);
        $("#logContent").html("<div class='loading-text'>ë°ì´í„° ì¿¼ë¦¬ ì¤‘...</div>");

        try {
            // 2. ì¿¼ë¦¬ ìµœì í™”: í•´ë‹¹ ë‚ ì§œ í‚¤ ë²”ìœ„ë§Œ ê°€ì ¸ì˜´
            const logBaseRef = ref(db, `coffeeWalletLogs/${nickname}/logs`);
            const logQuery = query(
                logBaseRef,
                orderByKey(),
                startAt(dateKeyPrefix),
                endAt(dateKeyPrefix + "\uf8ff") // í•´ë‹¹ ì ‘ë‘ì‚¬ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  í‚¤ í¬í•¨
            );

            const snap = await get(logQuery);

            if (snap.exists()) {
                const dayLogs = snap.val();
                const keys = Object.keys(dayLogs).sort().reverse();

                let html = '';
                keys.forEach(key => {
                    const logStr = dayLogs[key];
                    const parts = logStr.split(' | ');
                    if (parts.length < 6) return;

                    const [result, time, action, asset, amountStr, reason] = parts;
                    const isSuccess = result.trim() === "ì„±ê³µ";
                    if (!isSuccess) return;
                    const isPositive = !amountStr.includes('-');
                    const assetVeiw = asset === "ì¿ í°" ? "ğŸ«" : "H";

                    html += `
                    <div class="log-item" style="${!isSuccess ? 'border-left: 4px solid var(--btn-danger);' : ''}">
                        <div class="log-item-top">
                            <span class="log-reason">${reason}</span>
                            <span class="log-amount" style="color:${isPositive ? '#27ae60' : '#e74c3c'}">
                                ${amountStr}${assetVeiw}
                            </span>
                        </div>
                        <div class="log-item-time">${time.split('-')[1]}</div>
                    </div>`;
                });
                $("#logContent").html(html);
            } else {
                $("#logContent").html(`<div class='no-data' style="text-align: center;">${dateKeyPrefix.replace(/_/g, '.')} ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`);
            }
        } catch (e) {
            console.error("ë¡œê·¸ ì¿¼ë¦¬ ì—ëŸ¬:", e);
            $("#logContent").html(`<div class='error-text' style="text-align: center;">ì¿¼ë¦¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
        }
    }

    /* ======================
       ë¡œê·¸ ê´€ë ¨ ì´ë²¤íŠ¸
    ====================== */

    // 1. ë¡œê·¸ ë²„íŠ¼ í´ë¦­ ì‹œ
    $(document).on("click", ".log-view-btn", function () {
        currentLogNick = getActiveNickname();
        currentLogDate = new Date();
        $("#logModal").css("display", "flex").hide().fadeIn(200);
        fetchWalletLogs(currentLogNick, currentLogDate);
    });

    // 2. ì´ì „ ë‚ ì§œ
    $("#prevDate").on("click", function () {
        currentLogDate.setDate(currentLogDate.getDate() - 1);
        fetchWalletLogs(currentLogNick, currentLogDate);
    });

    // 3. ë‹¤ìŒ ë‚ ì§œ
    $("#nextDate").on("click", function () {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // í˜„ì¬ ë³´ê³  ìˆëŠ” ë‚ ì§œ ë³µì‚¬
        const checkDate = new Date(currentLogDate);
        checkDate.setDate(checkDate.getDate() + 1);
        checkDate.setHours(0, 0, 0, 0);

        if (checkDate > today) {
            showAlert("ì˜¤ëŠ˜ ì´í›„ì˜ ê¸°ë¡ì€ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        currentLogDate.setDate(currentLogDate.getDate() + 1);
        fetchWalletLogs(currentLogNick, currentLogDate);
    });

    // 4. ë¡œê·¸ ëª¨ë‹¬ ë‹«ê¸°
    $(".close-log-btn").on("click", function () {
        $("#logModal").fadeOut(200);
    });

    /* ======================
        ë¯¸ë‹ˆê²Œì„ ë¡œì§
    ====================== */
    let gameActive = false;
    let gamePos = 0;
    let gameDir = 1;
    let gameAnimId = null;
    const GAME_SPEED = 2.5;     // ì†ë„ ì¡°ì ˆ
    let currentTargetWidth = 5; // í˜„ì¬ íƒ€ê²Ÿ ë„“ì´ (ê¸°ë³¸ 5)

    /** ë¯¸ë‹ˆê²Œì„ ì™„ë£Œ í™”ë©´ ë Œë”ë§ */
    function renderMiniGameCompleted() {
        $('.shop-content[data-content="miniGame"]').html(
            `
                <div style="padding: 50px 0; text-align: center;">
                    <p style="font-size: 40px;">â˜•</p>
                    <p style="color:var(--text-main); font-weight:600;">ì˜¤ëŠ˜ì˜ ì¶”ì¶œ ì„±ê³µ!</p>
                    <p style="color:var(--text-sub); font-size:13px;">ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•´ ì£¼ì„¸ìš”.</p>
                </div>
            `
        );
    }

    async function initMiniGameTab() {
        const today = getKoreanDate();
        const nickname = getActiveNickname();

        // ì´ë¯¸ ì˜¤ëŠ˜ ì„±ê³µí–ˆë‹¤ë©´ í™”ë©´ì„ 'ì™„ë£Œ' ìƒíƒœë¡œ êµì²´
        if (localStorage.getItem('lastMiniGameDate') === today) {
            renderMiniGameCompleted();
            return;
        }

        try {
            // [2ë‹¨ê³„] ì„œë²„ DB í™•ì¸ (ë‹¤ë¥¸ ê¸°ê¸° ì¤‘ë³µ ìˆ˜ë ¹ ë°©ì§€)
            const logRef = ref(db, `coffeeWalletLogs/${nickname}/rewardIndex/miniGame/${today}`);
            const snapshot = await get(logRef);

            if (snapshot.exists()) {
                // ì„œë²„ì— ê¸°ë¡ì´ ìˆë‹¤ë©´ ë¡œì»¬ë„ ì—…ë°ì´íŠ¸í•˜ê³  ì°¨ë‹¨
                localStorage.setItem('lastMiniGameDate', today);
                renderMiniGameCompleted();
                return;
            }
        } catch (error) {
            console.error("ë¯¸ë‹ˆê²Œì„ ì¤‘ë³µ í™•ì¸ ì¤‘ ì—ëŸ¬:", error);
        }

        // ê²Œì„ ì„¤ì • (ë‚œì´ë„ ë“±)
        setDifficulty(5);
    }

    function setDifficulty(width) {
        currentTargetWidth = width;
        const targetStartPos = 70;
        const targetZone = $("#target-zone");

        // ì‹œê°ì ìœ¼ë¡œ ë„“ì´ ë³€ê²½
        targetZone.css({
            "width": width + "%",
            "left": targetStartPos + "%"
        });
        return targetStartPos;
    }

    // 2. ì¶”ì¶œ ë²„íŠ¼ í´ë¦­ (ì‹œì‘/ì¤‘ì§€)
    const $miniGameActionBtn = $("#miniGameActionBtn");
    $miniGameActionBtn.on("click", function () {
        if (!gameActive) {
            // ê²Œì„ ì‹œì‘
            if (gameAnimId) cancelAnimationFrame(gameAnimId);
            gameActive = true;
            gamePos = 0;
            gameDir = 1;
            $(this).text("ì§€ê¸ˆì´ì•¼! ì¶”ì¶œ!!");
            runGameAnimation();
        } else {
            // ì¶”ì¶œ íŒì •
            stopGameAndCheck();
        }
    });

    function runGameAnimation() {
        if (!gameActive) return;

        gamePos += GAME_SPEED * gameDir;

        // [ìˆ˜ì •] ë–¨ë¦¼ ë°©ì§€ ê²½ê³„ ì²˜ë¦¬
        if (gamePos >= 100) {
            gamePos = 100;
            gameDir = -1;
        } else if (gamePos <= 0) {
            gamePos = 0;
            gameDir = 1;
        }

        $("#gauge-bar").css("left", gamePos + "%");
        gameAnimId = requestAnimationFrame(runGameAnimation);
    }

    async function stopGameAndCheck() {
        cancelAnimationFrame(gameAnimId);
        gameActive = false;

        // ì„±ê³µ íŒì • (ì‹œì‘ì  70 + í˜„ì¬ ë„“ì´ë§Œí¼)
        const targetStart = 70;
        if (gamePos >= targetStart && gamePos <= (targetStart + currentTargetWidth)) {
            const $celebration = $('<div style="position:absolute; left:'+gamePos+'%; top:0; font-size:30px; z-index:10; pointer-events:none;">âœ¨â˜•âœ¨</div>');
            $(".gauge-track").append($celebration);

            $celebration.animate({
                top: '-50px',
                opacity: 0
            }, 800, function() { $(this).remove(); });

            const nickname = getActiveNickname();
            const today = getKoreanDate();
            const ts = getKoreanTimestamp();

            try {
                // 1. ì¿ í° ì§€ê¸‰ ë° ì¼ë°˜ ë¡œê·¸ ê¸°ë¡
                await giveCoupon(nickname, 1, `ë¯¸ë‹ˆê²Œì„ ì„±ê³µ(${currentTargetWidth/5})`);
                localStorage.setItem('lastMiniGameDate', getKoreanDate());

                // 2. ì¤‘ë³µ í™•ì¸ìš© ì¸ë±ìŠ¤ ì„œë²„ ê¸°ë¡
                const rewardRef = ref(db, `coffeeWalletLogs/${nickname}/rewardIndex/miniGame/${today}`);
                await set(rewardRef, ts);

                showAlert("â˜• ì™„ë²½í•œ íƒ€ì´ë°!\nê³¨ë“ ìƒ· ì¶”ì¶œì— ì„±ê³µí•˜ì—¬\nğŸ«ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤!");
                renderMiniGameCompleted();
                setDifficulty(5);

                // UI ì¬í™” ìˆ˜ì¹˜ ê°±ì‹ 
                const currentCoupon = parseInt($("#couponDisplay").text().replace(/,/g, ''));
                $("#couponDisplay").text((currentCoupon + 1).toLocaleString());
            } catch (e) {
                showAlert("ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } else {
            let nextWidth = currentTargetWidth + 5;
            if (nextWidth > 25) nextWidth = 25; // ìµœëŒ€ 15%ê¹Œì§€ë§Œ

            showAlert("ì˜¨ë„ê°€ ë§ì§€ ì•Šì•„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”!");
            setDifficulty(nextWidth);
            gamePos = 0;
            $("#gauge-bar").css("left", "0%");
        }
        $miniGameActionBtn.text("ì¶”ì¶œ ì‹œì‘");
    }

    let currentSpotlightNick = "";

    /** ì˜¤ëŠ˜ì˜ ë°”ë¦¬ìŠ¤íƒ€ ë¡œë“œ */
    async function loadRandomBarista() {
        const GREETINGS = [
            // ğŸŒŸ ì¼ìƒ ì‘ì›
            "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”.",
            "ë‹¹ì‹ ì˜ ì˜¤ëŠ˜ì´ ì–´ì œë³´ë‹¤ ë” í–‰ë³µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.",
            "í¬ê¸°í•˜ì§€ ì•Šê³  ë²„í‹´ ì˜¤ëŠ˜, ë‹¹ì‹ ì´ ì œì¼ ë©‹ì ¸ìš”.",
            "ê°€ë”ì€ ì•„ë¬´ ìƒê° ì—†ì´ í‘¹ ì‰¬ì–´ë„ ê´œì°®ì•„ìš”.",
            "ì˜í•´ì™”ê³ , ì˜í•˜ê³  ìˆê³ , ì•ìœ¼ë¡œë„ ì˜ë  ê±°ì˜ˆìš”.",
            "ì˜¤ëŠ˜ë”°ë¼ ë‹¹ì‹ ì˜ ë°œê±¸ìŒì´ ìœ ë‚œíˆ ë¹›ë‚˜ë„¤ìš”.",
            "ë¬´ë„ˆì§€ì§€ ì•Šê³  ì´ ìë¦¬ì— ìˆì–´ì¤˜ì„œ ê³ ë§ˆì›Œìš”.",

            // ğŸ’– ë”°ëœ»í•œ ìœ„ë¡œ
            "ì ì‹œ ìˆ¨ì„ ê³ ë¥´ê³  í•˜ëŠ˜ì„ í•œ ë²ˆ ë´ë³´ì„¸ìš”.",
            "ì„¸ìƒ ê·¸ ëˆ„êµ¬ë³´ë‹¤ ë‹¹ì‹  ìì‹ ì„ ë¨¼ì € ì•„ê»´ì£¼ì„¸ìš”.",
            "ë‹¹ì‹ ì€ ìƒê°ë³´ë‹¤ í›¨ì”¬ ë” ë‹¨ë‹¨í•œ ì‚¬ëŒì…ë‹ˆë‹¤.",
            "ì„œë‘ë¥´ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”. ë‹¹ì‹ ë§Œì˜ ì†ë„ê°€ ì •ë‹µì´ë‹ˆê¹Œìš”.",
            "í˜ë“  ì¼ì€ í˜ëŸ¬ê°€ëŠ” êµ¬ë¦„ì²˜ëŸ¼ ê³§ ì§€ë‚˜ê°ˆ ê±°ì˜ˆìš”.",
            "ì˜¤ëŠ˜ í•˜ë£¨, ìŠ¤ìŠ¤ë¡œì—ê²Œ 'ì°¸ ì˜í–ˆë‹¤'ê³  ë§í•´ì£¼ì„¸ìš”.",

            // âœ¨ ê¸ì • ì—ë„ˆì§€
            "ë‹¹ì‹ ì˜ ë¯¸ì†Œê°€ ëˆ„êµ°ê°€ì—ê²ŒëŠ” í° í˜ì´ ë©ë‹ˆë‹¤.",
            "ì‘ì€ í–‰ë³µë“¤ì´ ëª¨ì—¬ ë‹¹ì‹ ì˜ í° ê¸°ì¨ì´ ë˜ê¸¸.",
            "ì˜¤ëŠ˜ì€ ë‹¹ì‹ ì´ ê°€ì¥ ì£¼ì¸ê³µì¸ ë‚ ì´ì—ìš”.",
            "ì–´ë–¤ ì„ íƒì„ í•˜ë“ , ì €ëŠ” ë‹¹ì‹ ì˜ í¸ì…ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì´ ê¿ˆê¾¸ëŠ” ëª¨ë“  ì¼ë“¤ì´ ì„ ë¬¼ì²˜ëŸ¼ ë‹¤ê°€ì˜¤ê¸°ë¥¼.",

            // â˜• ì€ì€í•œ ê°ì„± (ì»¤í”¼ ì‚´ì§ ë¯¹ìŠ¤)
            "ë§ˆìŒì˜ ì˜¨ë„ê°€ 1ë„ ë” ì˜¬ë¼ê°€ëŠ” ë”°ëœ»í•œ ì‹œê°„ ë˜ì„¸ìš”.",
            "ì§€ì¹œ ë§ˆìŒì— ì€ì€í•œ í–¥ê¸° ê°™ì€ íœ´ì‹ì´ ê¹ƒë“¤ê¸¸.",
            "ì“°ë””ì“´ í•˜ë£¨ ëì— ë‹¬ì½¤í•œ íœ´ì‹ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ ê±°ì˜ˆìš”.",

            // ğŸ€ í–‰ìš´ê³¼ ê¸°íšŒ
            "ìƒê°ì§€ë„ ëª»í•œ ê³³ì—ì„œ ê¸°ë¶„ ì¢‹ì€ ì†Œì‹ì´ ë“¤ë ¤ì˜¬ ê±°ì˜ˆìš”.",
            "ì˜¤ëŠ˜ì€ ë‹¹ì‹ ì´ ê°€ëŠ” ê¸¸ì´ ê³§ ì§€ë¦„ê¸¸ì´ ë˜ëŠ” ë‚ ì…ë‹ˆë‹¤.",
            "ë§ì„¤ì´ë˜ ì¼ì„ ì˜¤ëŠ˜ ì‹œì‘í•´ë³´ì„¸ìš”. í–‰ìš´ì´ ë”°ë¥¼ ê±°ì˜ˆìš”.",
            "ê°€ê¹Œìš´ ê³³ì—ì„œ ë‹¹ì‹ ì„ ë•ê³  ì‹¶ì–´ í•˜ëŠ” ê·€ì¸ì„ ë§Œë‚˜ê²Œ ë©ë‹ˆë‹¤.",
            "ì˜¤ë«ë™ì•ˆ ê¸°ë‹¤ë ¤ì˜¨ ë³´ìƒì´ ê³§ ë‹¹ì‹ ì˜ í’ˆìœ¼ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤.",

            // âœ¨ ë§ˆìŒê³¼ ìœ„ë¡œ
            "ë‹¹ì‹ ì˜ ë¯¸ì†Œê°€ ì˜¤ëŠ˜ ëˆ„êµ°ê°€ì˜ í•˜ë£¨ë¥¼ êµ¬ì›í•  ê±°ì˜ˆìš”.",
            "ì§€ê¸ˆ ê³ ë¯¼í•˜ëŠ” ì¼ì€ ê²°êµ­ ì•„ë¬´ ì¼ë„ ì•„ë‹ˆì—ˆë‹¤ëŠ” ë“¯ í•´ê²°ë©ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ë¹›ë‚˜ê³  ìˆì–´ìš”. ìŠ¤ìŠ¤ë¡œë¥¼ ë” ë¯¿ì–´ì£¼ì„¸ìš”.",
            "ì ì‹œ ì‰¬ì–´ê°€ëŠ” ì˜¤ëŠ˜ì´ ë‚´ì¼ì˜ ë” í° ë„ì•½ì´ ë  ê±°ì˜ˆìš”.",
            "ë‹¹ì‹ ì´ ë¿Œë¦° ì¹œì ˆì˜ ì”¨ì•—ì´ ì˜¤ëŠ˜ ì˜ˆìœ ê½ƒìœ¼ë¡œ í”¼ì–´ë‚©ë‹ˆë‹¤.",

            // â˜• ë°”ë¦¬ìŠ¤íƒ€ ê°ì„± í•œ ìŠ¤í‘¼
            "ì˜¤ëŠ˜ì€ ì™„ë²½í•œ ìƒ·ì„ ë‚´ë¦° ë“¯ì´ ê¹”ë”í•œ í•˜ë£¨ê°€ ë  ê±°ì˜ˆìš”.",
            "ì¸ìƒì˜ ì“´ë§› ë’¤ì—ëŠ” ë¼ë–¼ì²˜ëŸ¼ ë¶€ë“œëŸ¬ìš´ í–‰ë³µì´ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ ë‹¹ì‹ ì´ ë‚´ë¦° ê²°ì •ì€ ìµœê³ ì˜ ë¸”ë Œë”©ì´ ë  ê±°ì˜ˆìš”.",

            // ğŸ íŠ¹ë³„í•œ ì˜ˆì–¸
            "ì˜¤ëŠ˜ ìƒì ì—ì„œ ê³ ë¥¸ ì•„ì´í…œì´ ë‹¹ì‹ ì—ê²Œ í° í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤„ì§€ë„?",
            "ì§€ê¸ˆ ì´ ë©”ì‹œì§€ë¥¼ ì½ëŠ” ìˆœê°„ë¶€í„° ê¸°ì  ê°™ì€ ì¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ì§„ì‹¬ì€ ë§í•˜ì§€ ì•Šì•„ë„ ì´ë¯¸ ìƒëŒ€ë°©ì—ê²Œ ë‹¿ì•„ìˆì–´ìš”."
        ];

        try {
            const myNickname = getActiveNickname();
            if (!myNickname) return;

            // 1. ë‚´ IDì™€ ìµœê·¼ ì ‘ì†ì ëª…ë‹¨ ë³‘ë ¬ ë¡œë“œ
            const [myIdSnap, recentSnap] = await Promise.all([
                get(ref(db, `coffeeUsers/${myNickname}/id`)),
                get(ref(db, `coffeeRecentUsers`))
            ]);

            if (!myIdSnap.exists() || !recentSnap.exists()) return;
            const myId = Number(myIdSnap.val());

            let list = Array.isArray(recentSnap.val()) ? recentSnap.val() : Object.values(recentSnap.val());

            // 2. ë³¸ì¸ ì œì™¸ í•„í„°ë§
            const otherUsers = list.filter(u => Number(u.id) !== myId);
            if (otherUsers.length === 0) return;

            // 3. ëœë¤ í•œ ëª… ì„ íƒ
            const luckyTarget = otherUsers[Math.floor(Math.random() * otherUsers.length)];

            // 4. IDë¡œ ë‹‰ë„¤ì„ ì°¾ê¸°
            const nickSnap = await get(ref(db, `coffeeUsersId/${luckyTarget.id}`));
            if (!nickSnap.exists()) return;
            const luckyNickname = nickSnap.val();

            // 5. âœ… í•µì‹¬ ìµœì í™”: í”„ë¡œí•„ ì´ë¯¸ì§€ì™€ ë±ƒì§€ë§Œ ì½• ì§‘ì–´ì„œ ê°€ì ¸ì˜¤ê¸°
            const [imgSnap, badgeSnap] = await Promise.all([
                get(ref(db, `coffeeUsers/${luckyNickname}/profileImg`)),
                get(ref(db, `coffeeUsers/${luckyNickname}/activeBadge`))
            ]);

            const profileImgId = imgSnap.exists() ? imgSnap.val() : 1;
            const activeBadgeId = badgeSnap.exists() ? badgeSnap.val() : "NONE";

            // 6. UI ë Œë”ë§
            $("#spotlightImg").attr("src", getProfileImageSrc(profileImgId));

            const badgeIcon = SHOP_DATA.badges[activeBadgeId]?.icon || "";
            $("#spotlightBadge").text(badgeIcon);

            currentSpotlightNick = luckyNickname;

            const randomMsg = GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
            $("#spotlightMsg").text(`${randomMsg}`);

        } catch (e) {
            console.warn("ë°”ë¦¬ìŠ¤íƒ€ ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", e);
        }
    }

    $(document).on("click", "#spotlightBody", function() {
        if (!currentSpotlightNick) return;

        // ì•„ëŠ” ì‚¬ì´ë‹ˆê¹Œ ì¢€ ë” ì¹œê·¼í•œ ë¬¸êµ¬ë¡œ ì •ì²´ë¥¼ ê³µê°œí•©ë‹ˆë‹¤.
        showAlert(`í–‰ìš´ì˜ ë©”ì‹ ì €ëŠ” ë°”ë¡œğŸ€\n\n"${currentSpotlightNick}"ë‹˜ì…ë‹ˆë‹¤!`);
    });
</script>
<script src="../modules/helpModal.js" type="module" defer></script>
<script src="../modules/menuToggle.js" type="module" defer></script>
<script src="../modules/event-coupon.js" type="module" defer></script>
</body>
</html>