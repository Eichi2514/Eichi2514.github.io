<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì  í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <link rel="stylesheet" href="../theme/theme.css">
    <link rel="stylesheet" href="../common/common.css">
    <style>
        /* =========================
           ë©”ë‰´ ì„ íƒ ì˜ì—­
        ========================= */
        .menu-tabs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }

        .menu-tab {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: calc((100% / 3));
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 0;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .menu-tab.active {
            background: var(--primary);
            color: var(--text-accent);
        }

        /* =========================
           ìœ ì € ì •ë³´
        ========================= */
        /* ë‹‰ë„¤ì„ ì˜ì—­ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary);
            padding: 20px 8px 0 8px;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (ë±ƒì§€ ê¸°ì¤€ì ) */
        .user-profile-wrap {
            position: relative;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ì‹¤ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ */
        .user-profile {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            object-fit: cover;
        }

        /* ìƒë‹¨ í”„ë¡œí•„ìš© ë±ƒì§€ ì „ìš© ìœ„ì¹˜ */
        .user-profile-wrap .badge-overlay {
            position: absolute;
            right: -4px;
            bottom: 0;
            font-size: 12px;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));
            pointer-events: none;
        }

        /* ì¬í™” ì˜ì—­ */
        .user-currency {
            display: grid;
            grid-template-columns: 4fr 6fr;
            gap: 10px;
        }

        /* ê°œë³„ ì¬í™” */
        .currency-item {
            display: flex;
            justify-content: right;
            align-items: center;
            gap: 4px;
            border-radius: 999px;
            border: 1px solid var(--border-main);
            font-size: 14px;
            width: 100%;
        }

        /* ì¬í™” ë¼ë²¨ */
        .currency-label {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-sub);
            color: var(--primary);
            font-weight: 500;
            height: 30px;
            width: 45px;
            text-align: center;
            border-left: 1px solid var(--border-main);
            border-radius: 0 999px 999px 0;
        }

        /* ì¬í™” ê°’ */
        .currency-value {
            color: var(--primary);
            font-weight: 700;
            padding: 4px;
        }

        /* =========================
           ìƒí’ˆ ê³µí†µ ì˜ì—­
        ========================= */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-sub);
            border: 1px solid var(--border-main);
            border-radius: 10px;
            padding: 12px 4px 4px 4px;
            text-align: center;
            font-size: 14px;
        }

        /* =========================
            ì¬í™” ìƒì ì˜ì—­
        ========================= */
        .box-image {
            height: 48px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            display: block;
        }

        /* =========================
           í…Œë§ˆ ì˜ì—­
        ========================= */
        .theme-color-strip {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            height: 48px;
            overflow: hidden;
            border-radius: 6px;
            border: 1px solid var(--border-main);
        }

        /* ê°œë³„ ì»¬ëŸ¬ */
        .theme-color-bar {
            height: 100%;
        }

        /* =========================
            ìƒì ê°œë´‰ ì—°ì¶œ
        ========================= */
        #boxOpenOverlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box-open-container {
            position: relative;
            text-align: center;
        }

        #boxOpenImage {
            width: 120px;
            animation: shake 1s ease-in-out;
            z-index: 1;
        }

        /* í”ë“¤ë¦¼ */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            60% { transform: rotate(-8deg); }
            80% { transform: rotate(8deg); }
            100% { transform: rotate(0deg); }
        }

        /* í™•ë¥  ì´í™íŠ¸ */
        #boxEffect {
            position: absolute;
            width: 120px;
            height: 120px;
            inset: 0;
            border-radius: 50%;
            animation: burst 1.5s ease-out forwards;
            z-index: 2;
        }

        @keyframes burst {
            from {
                transform: scale(0.5);
            }
            to {
                transform: scale(10);
                opacity: 0;
            }
        }

        #boxResultText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            z-index: 3;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes resultFloatUp {
            0% {
                transform: translate(-50%, -100%) scale(0.5);
            }
            100% {
                transform: translate(-50%, -500%) scale(1.5);
            }
        }

        #boxResultText.show {
            animation: resultFloatUp 0.6s ease-out forwards;
        }

        #boxHintText {
            padding-top: 40px;
            color: var(--text-sub);
            opacity: 0.6;
            letter-spacing: -0.3px;
            animation: hintBlink 1.6s ease-in-out infinite;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes hintBlink {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

    </style>
    <link rel="stylesheet" href="../modules/helpModal.css"/>
    <link rel="stylesheet" href="../modules/menuToggle.css"/>
<body>
<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>íŠ¹ë³„ìƒì </h1>
        <button id="helpBtn">?</button>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<!-- âœ… ìƒë‹¨ ë©”ë‰´ -->
<div class="menu-tabs">
    <div class="menu-tab" data-menu="boxes">
        <span>ì¬í™” ìƒì</span>
    </div>
    <div class="menu-tab" data-menu="themes">
        <span>ì–´í”Œ í…Œë§ˆ</span>
    </div>
    <div class="menu-tab" data-menu="badges">
        <span>í”„ë¡œí•„ ë±ƒì§€</span>
    </div>
</div>

<div class="user-info">
    <div class="user-profile-wrap">
        <img class="user-profile" src="../image/profile1.jpg" alt="í”„ë¡œí•„ì´ë¯¸ì§€" id="profileDisplay">
        <div id="activeBadgeDisplay" class="badge-overlay"></div>
    </div>
    <span id="nicknameDisplay">ë‹‰ë„¤ì„</span>
</div>

<div class="user-currency">
    <div class="currency-item">
        <span id="couponDisplay" class="currency-value">0</span>
        <span class="currency-label">ğŸ«</span>
    </div>
    <div class="currency-item">
        <span id="hDisplay" class="currency-value">0</span>
        <span class="currency-label">H</span>
    </div>
</div>

<div id="shopContents">
    <div class="shop-content" data-content="boxes"></div>
    <div class="shop-content" data-content="themes" style="display:none;"></div>
    <div class="shop-content" data-content="badges" style="display:none;"></div>
</div>

<!-- ğŸ ìƒì ê°œë´‰ ì—°ì¶œ ë ˆì´ì–´ -->
<div id="boxOpenOverlay" style="display:none;">
    <div class="box-open-container">
        <img id="boxOpenImage" src="" alt="box">
        <div id="boxEffect"></div>
        <div id="boxResultText"></div>
        <div id="boxHintText">í™”ë©´ì„ í„°ì¹˜í•´ ì£¼ì„¸ìš”</div>
    </div>
</div>

<!-- ğŸ¨ í…Œë§ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="themeSelectModal" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div id="themeModalText" style="text-align: center; margin-bottom: 20px;"></div>
        <div class="alert-content">
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img" style="transform: scaleX(-1);">
            <div style="display: flex; flex-direction: column; gap: 10px; width:100%;">
                <button id="themeBuyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    êµ¬ë§¤
                </button>
                <button id="themeApplyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì ìš©
                </button>
                <button id="themePreviewBtn"
                        style="flex:1; background:var(--bg-sub); color:var(--primary); border:1px solid var(--border-main); border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button id="themeCancelBtn"
                        style="flex:1; background:var(--btn-close); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì·¨ì†Œ
                </button>
            </div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
    </div>
</div>

<!-- ğŸ¦Š ë±ƒì§€ ì„ íƒ ëª¨ë‹¬ -->
<div id="badgeSelectModal" class="login-overlay" style="display:none;">
    <div class="alert-box">
        <div id="badgeModalText" style="text-align: center; margin-bottom: 20px;"></div>
        <div class="alert-content">
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img" style="transform: scaleX(-1);">
            <div style="display: flex; flex-direction: column; gap: 10px; width:100%;">
                <button id="badgeBuyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    êµ¬ë§¤
                </button>
                <button id="badgeApplyBtn"
                        style="flex:1; background:var(--primary); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ì ìš©
                </button>
                <button id="badgePreviewBtn"
                        style="flex:1; background:var(--bg-sub); color:var(--primary); border:1px solid var(--border-main); border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button id="badgeCancelBtn"
                        style="flex:1; background:var(--btn-close); color:var(--text-accent); border:none; border-radius:8px; font-size:15px; font-weight:600; padding:10px;">
                    ë‹«ê¸°
                </button>
            </div>
            <img src="../../favicon/Eichi2.png" alt="Eichi" class="alert-img">
        </div>
    </div>
</div>

<!-- ğŸ¦Š ë±ƒì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="badgePreviewOverlay" class="login-overlay" style="display:none; z-index: 10001;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div id="previewNickname" style="color: #FFC90E; font-weight: 600; font-size: 24px; text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);"></div>
        <div style="position: relative; width: 200px; height: 200px;">
            <img id="previewProfileImg" src="" alt="profile" style="width: 100%; height: 100%; border-radius: 15px; object-fit: cover; box-shadow: 0 0 15px rgba(0,0,0,0.3);">
            <div id="previewBadgeIcon" style="position: absolute; right: -16px; bottom: -8px; font-size: 50px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));"></div>
        </div>
        <p style="color: white; font-size: 14px; opacity: 0.8;">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤</p>
    </div>
</div>

<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <p>ë¡œë”© ì¤‘...</p>
</div>

<script src="../theme/theme.js" type="module" defer></script>
<script type="module" defer>
    import {initializeApp, getApps, getApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, get, set, runTransaction, update, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    import {SHOP_DATA} from "../common/shopData.js";
    import {applySavedThemeOnLoad} from "../theme/theme.js";
    import {goToPage, showAlert, closeAlert, showConfirm, getActiveNickname, getKoreanTimestamp, COLORS} from "../common/utils.js";
    import { getProfileImageSrc } from "../common/profileUtils.js";
    import { writeWalletLog } from "../common/walletUtils.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey", authDomain: ".env/authDomain", databaseURL: "https://test-948ba-default-rtdb.firebaseio.com", projectId: ".env/projectId", storageBucket: ".env/storageBucket", messagingSenderId: ".env/messagingSenderId", appId: ".env/appId"
    };

    const app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const $loadingScreen = $("#loadingScreen");

    // ìƒì  í˜ì´ì§€ ì „ìš© ìºì‹œ
    const shopProfileCache = {
        nickname: null,
        profileImgId: null,
        profileImgSrc: null
    };

    let inventoryThemes = {};
    let inventoryBadges = {};
    let activeBadgeId = null;

    // âœ… ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $(document).on("click", "#alertConfirmBtn", function () {
        closeAlert();
    });

    /** ìƒì  ìƒë‹¨(í”„ë¡œí•„/ë‹‰ë„¤ì„/ì¬í™”) ë¡œë”© */
    async function loadShopHeader() {
        try {
            const nickname = getActiveNickname();
            if (!nickname) return;

            // 1) í”„ë¡œí•„ ì´ë¯¸ì§€ ë²ˆí˜¸ (coffeeUsers)
            const profileImgRef = ref(db, `coffeeUsers/${nickname}/profileImg`);
            const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);

            // 2) ì¬í™”/ì¸ë²¤í† ë¦¬ (coffeeStore)
            const storeRef = ref(db, `coffeeStore/${nickname}`);

            // âœ… ë³‘ë ¬ ì¡°íšŒ (ì†ë„ ì´ë“)
            const [profileSnap, badgeSnap, storeSnap] = await Promise.all([
                get(profileImgRef),
                get(activeBadgeRef),
                get(storeRef)
            ]);

            // --- í”„ë¡œí•„/ë‹‰ë„¤ì„ í‘œì‹œ ---
            $("#nicknameDisplay").text(nickname);
            const profileImgId = profileSnap.exists() ? profileSnap.val() : null;
            const profileSrc = getProfileImageSrc(profileImgId);

            // --- âœ… ì°©ìš© ë±ƒì§€ ì •ë³´ ì €ì¥ (ë°ì´í„° ì–‘ ìµœì†Œí™”) ---
            activeBadgeId = badgeSnap.exists() ? badgeSnap.val() : "NONE";
            const badgeIcon = SHOP_DATA.badges[activeBadgeId]?.icon || "";
            $("#activeBadgeDisplay").text(badgeIcon);

            // âœ… ìºì‹œ ì €ì¥ (ìµœì´ˆ 1íšŒ ê¸°ì¤€ê°’)
            shopProfileCache.nickname = nickname;
            shopProfileCache.profileImgId = profileImgId;
            shopProfileCache.profileImgSrc = profileSrc;

            $("#profileDisplay").attr("src", profileSrc);

            // --- ì¬í™” í‘œì‹œ ---
            if (!storeSnap.exists() || !storeSnap.val().wallet) {
                // ğŸ ìµœì´ˆ ë°©ë¬¸ ë³´ìƒ: ì¿ í° ì§€ê¸‰
                const initWallet = {
                    coupon: 1,
                    h: 0
                };

                await update(ref(db, `coffeeStore/${nickname}`), {
                    wallet: initWallet
                });

                applyWalletToUI(initWallet);
                showAlert("ğŸ ì²« ë°©ë¬¸ ë³´ìƒ!\nğŸ« ë“œë¦´ê²Œìš”~!");
                return;
            }

            const store = storeSnap.val();
            applyWalletToUI(store.wallet);
            inventoryThemes = store.inventory?.themes || {};
            inventoryBadges = store.inventory?.badges || {};

        } finally {
            $loadingScreen.hide();
            if (rendered.themes) renderThemes();
            if (rendered.badges) renderBadges();
        }
    }

    /** ì¬í™” UI ë°˜ì˜ */
    function applyWalletToUI(wallet) {
        const coupon = wallet && wallet.coupon != null ? Number(wallet.coupon) : 0;
        const h = wallet && wallet.h != null ? Number(wallet.h) : 0;

        $("#couponDisplay").text(coupon.toLocaleString());
        $("#hDisplay").text(h.toLocaleString());
    }

    const rendered = {
        boxes: false,
        themes: false,
        badges: false
    };

    const $menuTab = $(".menu-tab");

    $menuTab.on("click", function () {
        const target = $(this).data("menu");

        // ğŸ”‘ URL í•´ì‹œ ë³€ê²½
        location.hash = target;

        // ì½˜í…ì¸  ì „ë¶€ ìˆ¨ê¹€
        $(".shop-content").hide();

        // í•´ë‹¹ ì½˜í…ì¸  í‘œì‹œ
        const $targetContent = $('.shop-content[data-content="' + target + '"]');
        $targetContent.show();

        // íƒ­ í™œì„±í™”
        $menuTab.removeClass("active");
        $(this).addClass("active");

        // âœ… ì•„ì§ ë Œë” ì•ˆ í–ˆìœ¼ë©´ ì—¬ê¸°ì„œ ë Œë”
        if (!rendered[target]) {
            if (target === "boxes") renderBoxes();
            if (target === "themes") renderThemes();
            if (target === "badges") renderBadges();
            rendered[target] = true;
        }
    });

    function activateTabByHash() {
        const hash = location.hash.replace("#", "");
        const target = hash || "boxes";

        const $tab = $(`.menu-tab[data-menu="${target}"]`);

        if ($tab.length) {
            $tab.trigger("click");
        } else {
            $menuTab.first().trigger("click");
        }
    }

    loadShopHeader();
    activateTabByHash();

    // ==============================
    // SHOP_DATA ë Œë”ë§
    // ==============================
    function renderBoxes() {
        const $container = $('.shop-content[data-content="boxes"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.boxes).forEach(box => {
            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${box.name}</div>
                    <div style="display: flex; justify-content: center;">
                        <img src="${box.img}" alt="${box.name}" class="box-image">
                    </div>
                    <div style="font-size:12px; color:var(--text-sub); text-align: right;">
                        ${box.couponCost.toLocaleString()}ğŸ«
                    </div>
                </div>
            `);
            $item.on("click", () => confirmOpenBox(box));
            $grid.append($item);
        });

        $container.append($grid);
    }

    function pickReward(rewards) {
        const total = rewards.reduce((sum, r) => sum + r.rate, 0);
        let roll = Math.random() * total;

        for (const r of rewards) {
            roll -= r.rate;
            if (roll <= 0) return r.h;
        }
        return rewards[rewards.length - 1].h; // ì•ˆì „ì¥ì¹˜
    }

    function buildProbabilityText(rewards) {
        return rewards
            .map(r => `â€¢ ${r.h}H (${r.rate}%)`)
            .join("\n");
    }

    function confirmOpenBox(box) {
        const probabilityText = buildProbabilityText(box.rewards);

        showConfirm(
            `${box.name}ë¥¼ ê°œë´‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
            `í•„ìš” : ${box.couponCost.toLocaleString()}ğŸ«\n\n` +
            `[íšë“ í™•ë¥ ]\n${probabilityText}`,
            (confirmed) => {
                if (!confirmed) return;
                openBox(box);
            }
        );
    }

    function buildRewardTierMap(rewards) {
        // h ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
        const sorted = [...rewards]
            .map(r => r.h)
            .sort((a, b) => a - b);

        const maxH = sorted[sorted.length - 1]; // ìµœê³  ë³´ìƒ
        const rest = sorted.slice(0, -1);       // ë‚˜ë¨¸ì§€

        const half = Math.ceil(rest.length / 2);

        const lowTier = new Set(rest.slice(0, half));
        const midTier = new Set(rest.slice(half));

        return {
            maxH,
            midTier,
            lowTier
        };
    }

    function getEffectColorByBox(rewardH, box) {
        const tierMap = buildRewardTierMap(box.rewards);

        if (rewardH === tierMap.maxH) {
            return "#FFC400"; // ìµœê³  ë³´ìƒ
        }

        if (tierMap.midTier.has(rewardH)) {
            return "#CFCFCF"; // ì¤‘ê°„ ë³´ìƒ
        }

        return "#C48A5A";     // ìµœí•˜ ë³´ìƒ
    }

    async function openBox(box) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const rewardH = pickReward(box.rewards);
        const ts = getKoreanTimestamp();
        const effectColor = getEffectColorByBox(rewardH, box);

        // âœ… 1ï¸âƒ£ ë¨¼ì € íŠ¸ëœì­ì…˜ë¶€í„°
        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            // ì¿ í° ë¶€ì¡± â†’ íŠ¸ëœì­ì…˜ ì¤‘ë‹¨
            if (wallet && safeWallet.coupon < box.couponCost) return;

            safeWallet.coupon -= box.couponCost;
            safeWallet.h += rewardH;
            return safeWallet;
        });

        // âŒ ì‹¤íŒ¨ ì‹œ: ì—°ì¶œ ì—†ì´ ì•Œë¦¼ë§Œ
        if (!result.committed) {
            showAlert("ğŸ«ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. ì¿ í° ì‚¬ìš© ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "ì¿ í°", box.couponCost, `${box.name} ê°œë´‰`);
        // 2. H íšë“ ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "íšë“", "H", rewardH, `${box.name} ë³´ìƒ íšë“`);

        // âœ… 2ï¸âƒ£ ì„±ê³µí–ˆì„ ë•Œë§Œ ì—°ì¶œ ì‹œì‘
        applyWalletToUI(result.snapshot.val());

        const $resultText = $("#boxResultText");

        $("#boxOpenImage").attr("src", box.img);
        $("#boxEffect").css("background", effectColor);
        $resultText.hide();

        $("#boxOpenOverlay").fadeIn(150);

        // í”ë“¤ë¦¼ ëë‚œ ë’¤ ê²°ê³¼ í‘œì‹œ
        setTimeout(() => {
            $resultText
                .removeClass("show")
                .text(`ğŸ¦Š ${rewardH.toLocaleString()}H íšë“!`)
                .show();

            // ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ ë³´ì¥
            void $resultText[0].offsetWidth;
            $resultText.addClass("show");
        }, 800);
    }

    // âœ… ìƒì ê°œë´‰ ì—°ì¶œ í´ë¦­ ì‹œ ë‹«ê¸°
    $(document).on("click", "#boxOpenOverlay", function () {
        closeBoxOpenOverlay();
    });

    function closeBoxOpenOverlay() {
        $("#boxOpenOverlay").fadeOut(300);

        // ë‹¤ìŒ ì—°ì¶œì„ ìœ„í•´ ìƒíƒœ ì´ˆê¸°í™”
        $("#boxResultText").hide().css("opacity", 1);
        $("#boxEffect").stop(true, true);
    }

    function renderThemes() {
        const $container = $('.shop-content[data-content="themes"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.themes).forEach(theme => {
            const owned = theme.priceH === 0 || inventoryThemes?.[theme.id];
            const applied = localStorage.getItem("activeTheme") === theme.id;
            const statusText = applied ? "ì ìš© ì¤‘" : owned ? "ë³´ìœ  ì¤‘" : "";
            const statusColor = applied ? "var(--primary)" : "var(--text-sub)";
            const priceText = theme.priceH === 0 ? 'ë¬´ë£Œ' : `${theme.priceH.toLocaleString()}H`;

            const colorBars = theme.previewColors.map(color =>
                `<div class="theme-color-bar" style="background:${color}"></div>`
            ).join("");

            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${theme.name}</div>
                    <div class="theme-color-strip">${colorBars}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                        <span style="color:${statusColor}; font-weight:600;">
                            ${statusText}
                        </span>
                        <span style="color:var(--text-sub);">
                            ${priceText}
                        </span>
                    </div>
                </div>
            `);
            $item.on("click", () => onThemeClick(theme, owned));
            $grid.append($item);
        });

        $container.append($grid);
    }

    let currentThemeTarget = null;
    function onThemeClick(theme, isOwned) {
        currentThemeTarget = theme;

        $("#themeModalText").text(`${theme.name} í…Œë§ˆ`);

        if (isOwned) {
            $("#themeBuyBtn").hide();
            $("#themePreviewBtn").hide();
            $("#themeApplyBtn").show();
        } else {
            $("#themeBuyBtn").show();
            $("#themePreviewBtn").show();
            $("#themeApplyBtn").hide();
        }

        $("#themeSelectModal").fadeIn(150);
    }

    $("#themeBuyBtn").on("click", function () {
        if (!currentThemeTarget) return;

        purchaseTheme(currentThemeTarget);
        $("#themeSelectModal").fadeOut(150);
    });

    $("#themePreviewBtn").on("click", function () {
        if (!currentThemeTarget) return;

        $("html").attr("data-theme", currentThemeTarget.id);
        $("#themeSelectModal").fadeOut(150);
    });

    $("#themeApplyBtn").on("click", function () {
        if (!currentThemeTarget) return;

        applyTheme(currentThemeTarget.id);
    });

    $("#themeCancelBtn").on("click", function () {
        $("#themeSelectModal").fadeOut(150);
    });

    function applyTheme(themeId) {
        $("html").attr("data-theme", themeId);
        localStorage.setItem("activeTheme", themeId);
        location.reload();
    }

    async function purchaseTheme(theme) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const inventoryRef = ref(db, `coffeeStore/${nickname}/inventory/themes/${theme.id}`);
        const ts = getKoreanTimestamp();

        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            if (wallet && safeWallet.h < theme.priceH) return;

            safeWallet.h -= theme.priceH;
            return safeWallet;
        });

        if (!result.committed) {
            showAlert("Hê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. H ì‚¬ìš© ë¡œê·¸
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "H", theme.priceH, `${theme.name} í…Œë§ˆ êµ¬ë§¤`);

        // âœ… í…Œë§ˆ ì†Œìœ  ì²˜ë¦¬
        await set(inventoryRef, true);

        localStorage.setItem("activeTheme", theme.id);
        applySavedThemeOnLoad();
        applyWalletToUI(result.snapshot.val());
        location.reload();
    }

    function renderBadges() {
        const $container = $('.shop-content[data-content="badges"]');
        $container.empty();

        const $grid = $('<div class="shop-grid"></div>');

        Object.values(SHOP_DATA.badges).forEach(badge => {
            const owned = badge.priceH === 0 || inventoryBadges?.[badge.id];
            const applied = activeBadgeId === badge.id;
            const statusText = applied ? "ì ìš© ì¤‘" : owned ? "ë³´ìœ  ì¤‘" : "";
            const statusColor = applied ? "var(--primary)" : "var(--text-sub)";
            const priceText = badge.priceH === 0 ? 'ë¬´ë£Œ' : badge.priceH.toLocaleString() + 'H';


            const badgeIcon = badge.icon ? badge.icon : `ğŸš«`;

            const $item = $(`
                <div class="shop-item">
                    <div style="font-weight:600;">${badge.name}</div>
                    <div style="font-size:36px;">${badgeIcon}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                        <span style="color:${statusColor}; font-weight:600;">
                            ${statusText}
                        </span>
                        <span style="color:var(--text-sub);">
                            ${priceText}
                        </span>
                    </div>
                </div>
            `);
            $item.on("click", () => onBadgeClick(badge, owned));
            $grid.append($item);
        });

        $container.append($grid);
    }

    let currentBadgeTarget = null;
    function onBadgeClick(badge, isOwned) {
        currentBadgeTarget = badge;
        $("#badgeModalText").text(`${badge.name} ë±ƒì§€`);

        if (isOwned) {
            $("#badgeBuyBtn").hide();
            $("#badgePreviewBtn").hide();
            $("#badgeApplyBtn").show();
        } else {
            $("#badgeBuyBtn").show();
            $("#badgePreviewBtn").show();
            $("#badgeApplyBtn").hide();
        }

        $("#badgeSelectModal").fadeIn(150);
    }

    // âœ… ë±ƒì§€ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
    $("#badgePreviewBtn").on("click", function () {
        if (!currentBadgeTarget) return;

        const nickname = shopProfileCache.nickname;
        const profileSrc = shopProfileCache.profileImgSrc;

        $("#previewNickname").text(nickname);
        $("#previewProfileImg").attr("src", profileSrc);
        $("#previewBadgeIcon").text(currentBadgeTarget.icon || "");

        $("#badgeSelectModal").hide(); // ë±ƒì§€ ì„ íƒ ëª¨ë‹¬ ì ì‹œ ìˆ¨ê¹€
        $("#badgePreviewOverlay").fadeIn(150);
    });

    // âœ… ë±ƒì§€ êµ¬ë§¤ ë²„íŠ¼ í´ë¦­ ì‹œ
    $("#badgeBuyBtn").on("click", function () {
        if (!currentBadgeTarget) return;

        purchaseBadge(currentBadgeTarget);
        $("#badgeSelectModal").fadeOut(150);
    });

    // âœ… ë±ƒì§€ êµ¬ë§¤ ë° ì„œë²„ ì ìš© í•¨ìˆ˜
    async function purchaseBadge(badge) {
        const nickname = getActiveNickname();
        if (!nickname) return;

        const walletRef = ref(db, `coffeeStore/${nickname}/wallet`);
        const inventoryRef = ref(db, `coffeeStore/${nickname}/inventory/badges/${badge.id}`);
        const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);
        const ts = getKoreanTimestamp();

        const result = await runTransaction(walletRef, (wallet) => {
            const safeWallet = {
                coupon: Number(wallet?.coupon ?? 0),
                h: Number(wallet?.h ?? 0)
            };

            // ì¬í™” ë¶€ì¡± ì‹œ ì¤‘ë‹¨
            if (wallet && safeWallet.h < badge.priceH) return;

            safeWallet.h -= badge.priceH;
            return safeWallet;
        });

        if (!result.committed) {
            showAlert("Hê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            return;
        }

        // 1. H ì‚¬ìš© ë¡œê·¸ ê¸°ë¡
        await writeWalletLog(nickname, "ì„±ê³µ", ts, "ì‚¬ìš©", "H", badge.priceH, `${badge.name} ë±ƒì§€ êµ¬ë§¤`);

        // 2. í†µí•© ì—…ë°ì´íŠ¸: ë‹¨ í•œ ë²ˆì˜ ì„œë²„ í†µì‹ ìœ¼ë¡œ ì¸ë²¤í† ë¦¬ ì¶”ê°€ì™€ ì°©ìš© ë±ƒì§€ ë³€ê²½ ì²˜ë¦¬
        const updates = {};
        updates[`coffeeStore/${nickname}/inventory/badges/${badge.id}`] = true;
        updates[`coffeeUsers/${nickname}/activeBadge`] = badge.id;

        await update(ref(db), updates);

        // UI ê°±ì‹ ì„ ìœ„í•´ í˜ì´ì§€ ë¦¬ë¡œë“œ (ë˜ëŠ” ì¬ë Œë”ë§ ì²˜ë¦¬)
        applyWalletToUI(result.snapshot.val());
        location.reload();
    }

    // âœ… ë¯¸ë¦¬ë³´ê¸° ë ˆì´ì–´ ë‹«ê¸°
    $(document).on("click", "#badgePreviewOverlay", function () {
        $(this).fadeOut(150);
    });

    // âœ… ë±ƒì§€ ì ìš© ë²„íŠ¼ í´ë¦­ ì‹œ (ë³´ìœ  ì¤‘ì¸ ë±ƒì§€ ì¥ì°©)
    $("#badgeApplyBtn").on("click", async function () {
        if (!currentBadgeTarget) return;

        const nickname = getActiveNickname();
        if (!nickname) return;

        // ì ìš©ì€ ì¬í™” ì†Œëª¨ê°€ ì—†ìœ¼ë¯€ë¡œ transaction ì—†ì´ ë°”ë¡œ set ì²˜ë¦¬
        const activeBadgeRef = ref(db, `coffeeUsers/${nickname}/activeBadge`);

        try {
            await set(activeBadgeRef, currentBadgeTarget.id);

            $("#badgeSelectModal").fadeOut(150);
            location.reload();
        } catch (err) {
            console.error("Badge Apply Error:", err);
            showAlert("ë±ƒì§€ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    $(document).on("click", "#badgeCancelBtn", function () {
        $("#badgeSelectModal").fadeOut(150);
    });
</script>
<script src="../modules/helpModal.js" type="module" defer></script>
<script src="../modules/menuToggle.js" type="module" defer></script>
<script src="../modules/event-coupon.js" type="module" defer></script>
</body>
</html>