<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', sans-serif;
        }

        body {
            margin: 0;
            background: #fff;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        .content-wrapper {
            margin: 0 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        select, input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }

        textarea {
            height: 180px;
            resize: none;
            line-height: 1.6;
        }

        #loadBtn, #updateBtn, #deleteBtn {
            width: 100%;
            padding: 12px 0;
            margin-top: 10px;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        #loadBtn, #updateBtn {
            background: #5a4398;
        }

        #deleteBtn {
            background: #d9534f;
        }
    </style>
</head>
<body>

<div class="header-bar">
    <h1>ê²Œì‹œê¸€ ìˆ˜ì •</h1>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<div class="content-wrapper">

    <!-- â‘  ê¸€ ì„ íƒ ì˜ì—­ -->
    <div id="loadSection">
        <div class="form-group">
            <label>ê¸€ ì¢…ë¥˜ ì„ íƒ</label>
            <select id="loadType">
                <option value="ê³µì§€">ê³µì§€</option>
                <option value="ì—…ë°ì´íŠ¸">ì—…ë°ì´íŠ¸</option>
            </select>
        </div>

        <div class="form-group">
            <label>ê¸€ ë²ˆí˜¸ ì…ë ¥</label>
            <input type="number" id="loadId" placeholder="ì˜ˆ: 12">
        </div>

        <button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- â‘¡ ìˆ˜ì • UI ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="editSection" style="display:none">

        <div class="form-group">
            <label>ê¸€ ì¢…ë¥˜</label>
            <select id="postType">
                <option value="ì—…ë°ì´íŠ¸">ì—…ë°ì´íŠ¸</option>
                <option value="ê³µì§€">ê³µì§€</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì œëª©</label>
            <input type="text" id="title">
        </div>

        <div class="form-group">
            <label>ë‚´ìš©</label>
            <textarea id="content"></textarea>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="updateBtn" style="flex:1;">ìˆ˜ì •í•˜ê¸°</button>
            <button id="deleteBtn" style="flex:1;">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
</div>

<script type="module">

    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase, ref, get, set, remove
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    import {goToPage, getKoreanTimestamp, getActiveNickname} from "../common/utils.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ==== ê´€ë¦¬ì ì¸ì¦ ====
    $(function () {
        const savedNick = getActiveNickname();
        if (!savedNick) return goToPage();

        const adminRef = ref(db, `coffeeUsers/${savedNick}/isAdmin`);
        get(adminRef).then(snap => {
            if (!snap.val()) goToPage();
        }).catch(() => goToPage());
    });

    // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¨ ê°’ (ë¶ˆëŸ¬ì˜¤ê¸°í•  ë•Œ ì €ì¥í•´ë‘ê¸°)
    let originalCreated = null;

    // ====== ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ======
    $("#loadBtn").on("click", async function () {
        const type = $("#loadType").val();
        const id = $("#loadId").val().trim();

        if (!id) return alert("ê¸€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const category = (type === "ê³µì§€") ? "ê³µì§€" : "ê¸°íƒ€";
        const targetRef = ref(db, `coffeePosts/${category}/${id}`);

        const snapshot = await get(targetRef);

        if (!snapshot.exists()) {
            alert("í•´ë‹¹ ë²ˆí˜¸ì˜ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const data = snapshot.val();

        // ì‘ì„±ì¼ ì €ì¥í•´ë‘ê¸°
        originalCreated = data.created;

        // ê¸€ ì¢…ë¥˜ ê°’ ë„£ê³  ìˆ˜ì • ë¶ˆê°€ë¡œ ë³€ê²½
        $("#postType").val(data.type).prop("disabled", true);
        $("#title").val(data.title);
        $("#content").val(data.content);

        $("#loadSection").hide();
        $("#editSection").show();
    });


    // ====== ê¸€ ìˆ˜ì • ì €ì¥ ======
    $("#updateBtn").on("click", async function () {

        const type = $("#postType").val();
        const title = $("#title").val().trim();
        const content = $("#content").val().trim();
        if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const originalType = $("#loadType").val();
        const id = $("#loadId").val().trim();

        const category = (originalType === "ê³µì§€") ? "ê³µì§€" : "ê¸°íƒ€";
        const targetRef = ref(db, `coffeePosts/${category}/${id}`);

        const newData = {
            id: Number(id),
            type,
            title,
            content,
            created: originalCreated,              // ğŸ”¥ ê¸°ì¡´ ì‘ì„±ì¼ ìœ ì§€
            updated: getKoreanTimestamp()          // ğŸ”¥ ë™ì¼ í¬ë§·ì˜ ìˆ˜ì •ì¼
        };

        await set(targetRef, newData);

        alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        goToPage("postList");
    });

    // ====== ê¸€ ì‚­ì œ ======
    $("#deleteBtn").on("click", async function () {

        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            return;
        }

        const originalType = $("#loadType").val();
        const id = $("#loadId").val().trim();

        const category = (originalType === "ê³µì§€") ? "ê³µì§€" : "ê¸°íƒ€";
        const targetRef = ref(db, `coffeePosts/${category}/${id}`);

        await remove(targetRef);

        alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        goToPage("postList");  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
    });

    $("#backBtn").on("click", () => goToPage());
</script>

</body>
</html>