<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—…ë°ì´íŠ¸ ëª©ë¡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../../favicon/Eichi2.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- iOS ì „ì²´í™”ë©´ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA manifest -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../../favicon/Eichi2.png">

    <!-- Pretendard ì›¹í°íŠ¸ CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="../helpModal/helpModal.css"/>
    <link rel="stylesheet" href="../menuToggle/menuToggle.css"/>

    <style>

        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        body {
            margin: 0;
            background: #fff;
            color: #333;
        }

        .header-bar {
            background: #5a4398;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px;
        }

        .header-bar h1 {
            font-size: 20px;
            margin: 0;
        }

        .header-bar button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ê³µì§€ ì˜ì—­ */
        .notice-box {
            background: #f6f4fc;
            border: 1px solid #e0dff2;
            border-radius: 10px;
            padding: 16px;
            margin: 0 20px;
        }

        .notice-item {
            padding: 4px 0;
        }

        .postList {
            margin: 0 20px 0 20px;
        }

        /* ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ */
        .post-item {
            padding: 16px 0;
            border-bottom: 1px solid #eee;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-text {
            height: 24px;
        }

        .isNew {
            background: #5a4398;
            padding: 3px 7px;
            color: #fff;
            border-radius: 100%;
        }

        .post-footer {
            display: flex;
            justify-content: right;
            font-size: 14px;
            color: #777;
            gap: 10px;
        }

        .post-footer span {
            width: calc((100% - 20px) / 3);
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination button {
            padding: 8px 16px;
            background: #5a4398;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }

        .pagination button:disabled {
            background: #ccc;
        }

        /* ê³µì§€/ì—…ë°ì´íŠ¸ ë¼ë²¨ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .label-tag {
            display: inline-block;
            padding: 2px 8px;
            font-weight: 700;
            border-radius: 6px;
            margin-right: 6px;
            color: #fff;
            background: #5a4398;
        }

        .modal-date, .modal-view {
            padding-right: 8px;
            text-align: right;
        }

        .modal-content {
            text-align: left;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            height: 60vh;
            overflow-y: auto;
            word-break: keep-all;
        }
    </style>
</head>
<body>

<div class="header-bar">
    <div style="display: flex; gap: 4px; align-items: center">
        <h1>ì—…ë°ì´íŠ¸</h1>
    </div>
    <button id="backBtn">ë’¤ë¡œê°€ê¸°</button>
</div>

<div class="notice-box" id="noticeList">
</div>
<div class="postList" id="postList">
</div>

<div class="pagination">
    <button id="prevBtn">ì´ì „</button>
    <button id="nextBtn">ë‹¤ìŒ</button>
</div>

<!-- ===== ğŸ”¥ ê²Œì‹œê¸€ ìƒì„¸ ëª¨ë‹¬ ===== -->
<div class="login-overlay" id="postModal" style="display:none;">
    <div class="login-modal">
        <button id="closeModalBtn" class="closeBtn">âœ•</button>
        <h2 id="modal-title"></h2>
        <div id="modal-date" class="modal-date"></div>
        <div id="modal-content" class="modal-content"></div>
        <div id="modal-view" class="modal-view"></div>
    </div>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        query,
        orderByKey,
        endAt,
        limitToLast,
        update
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    import {goToPage, parseKoreanTimestamp, isToday, formatDisplayDate} from "../common/utils.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let perPage = 5;
    let lastPostId = null;    // ê°€ì¥ ìµœì‹ ê¸€ì˜ id (ì»¤ì„œ ì‹œì‘ì )
    let currentEndKey = null; // í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ key (ë‹¤ìŒ í˜ì´ì§€ì˜ cursor)
    let currentQueryEndKey = null; // ë§ˆì§€ë§‰ loadPageì—ì„œ ì‚¬ìš©í•œ endKey
    let prevStack = [];       // ì´ì „ í˜ì´ì§€ keyë“¤ ì €ì¥í•´ì„œ Prev ë²„íŠ¼ ì²˜ë¦¬

    $(document).ready(async function () {
        // ğŸ”¹ ê³µì§€ ê°€ì ¸ì˜¤ê¸°
        const noticesSnap = await get(ref(db, "coffeePosts/ê³µì§€"));
        let notices = [];
        if (noticesSnap.exists()) notices = Object.values(noticesSnap.val());

        // ğŸ”¹ ê³µì§€ ìµœì‹ ìˆœ ì •ë ¬
        notices.sort((a, b) => parseKoreanTimestamp(b.created) - parseKoreanTimestamp(a.created));

        // ğŸ”¹ ê³µì§€ ë Œë”ë§
        renderNotices(notices);

        // ğŸ”¹ posts counter ê°€ì ¸ì˜¤ê¸° â†’ ë§ˆì§€ë§‰ key í™•ì¸
        const counterSnap = await get(ref(db, "coffeePosts/counters/ê¸°íƒ€"));
        lastPostId = counterSnap.val();

        // ğŸ”¹ ì²« í˜ì´ì§€ ë¡œë“œ
        await loadPage(lastPostId);
    });

    // ğŸ”¥ íŠ¹ì • key ëì—ì„œë¶€í„° ìµœì‹ ê¸€ 5ê°œ ê°€ì ¸ì˜¤ê¸°
    async function loadPage(endKey) {
        currentQueryEndKey = endKey;

        const postsQuery = query(
            ref(db, "coffeePosts/ê¸°íƒ€"),
            orderByKey(),
            endAt(String(endKey)),
            limitToLast(perPage)
        );

        const snap = await get(postsQuery);
        if (!snap.exists()) return;

        const postsObj = snap.val();
        const posts = Object.values(postsObj);

        // ìµœì‹ ìˆœ ì •ë ¬ì„ ìœ„í•´ reverse ì—†ìŒ (ì´ë¯¸ ìµœì‹ ìˆœ)
        posts.sort((a, b) => parseInt(b.id) - parseInt(a.id));

        // í˜„ì¬ í˜ì´ì§€ì˜ ê°€ì¥ ì‘ì€ key(=ë‹¤ìŒ í˜ì´ì§€ cursor)
        currentEndKey = Math.min(...Object.keys(postsObj).map(k => Number(k)));

        // í˜ì´ì§€ ë Œë”ë§
        renderUpdates(posts);

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateButtons();
    }

    // ğŸ”¥ ë²„íŠ¼ ìƒíƒœ ì²˜ë¦¬
    function updateButtons() {
        $("#prevBtn").prop("disabled", prevStack.length === 0);
        $("#nextBtn").prop("disabled", currentEndKey <= 1);
    }

    // ğŸ”¥ ë‹¤ìŒ í˜ì´ì§€
    $("#nextBtn").on("click", async () => {
        if (currentEndKey <= 1) return;

        // í˜„ì¬ cursor ì €ì¥ â†’ prev ë²„íŠ¼ìš©
        prevStack.push(currentQueryEndKey);

        // ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
        await loadPage(currentEndKey - 1);
    });

    // ğŸ”¥ ì´ì „ í˜ì´ì§€
    $("#prevBtn").on("click", async () => {
        if (prevStack.length === 0) return;

        const prevKey = prevStack.pop();

        await loadPage(prevKey);

        updateButtons();
    });

    // ğŸ”¹ ê³µì§€ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderNotices(noticeList) {
        const box = $("#noticeList");
        box.empty();

        noticeList.forEach(n => {
            const finalDate = n.updated ?? n.created;
            const showNew = isToday(finalDate);
            const dateText = formatDisplayDate(finalDate);
            const createdText = formatDisplayDate(n.created);

            box.append(`
                <div class="notice-item"
                     data-title="${n.title}"
                     data-content="${n.content}"
                     data-date="${dateText}"
                     data-view="${n.view ?? 0}"
                     data-viewId="noticeViwe${n.id}"
                    >
                    <div class="title">
                        <div class="title-text">${n.title}</div>
                        ${showNew ? `<div class="isNew">N</div>` : ``}
                    </div>
                    <div class="post-footer">
                        <span>${n.type}</span>
                        <span class="date">${createdText}</span>
                        <span id="noticeViwe${n.id}" class="viwe">${n.view ?? 0}</span>
                    </div>
                </div>
            `);
        });
    }

    // ğŸ”¹ ì¼ë°˜ê¸€(í˜ì´ì§• ì ìš©) ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function renderUpdates(listItems) {
        const list = $("#postList");
        list.empty();

        listItems.forEach(p => {
            const finalDate = p.updated ?? p.created;
            const showNew = isToday(finalDate);
            const dateText = formatDisplayDate(finalDate);
            const createdText = formatDisplayDate(p.created);

            list.append(`
                <div class="post-item"
                     data-title="${p.title}"
                     data-content="${p.content}"
                     data-date="${dateText}"
                     data-view="${p.view ?? 0}"
                     data-viewId="postViwe${p.id}"
                    >
                    <div class="title">
                        <div class="title-text">${p.id} ) ${p.title}</div>
                        ${showNew ? `<div class="isNew">N</div>` : ``}
                    </div>
                    <div class="post-footer">
                        <span>${p.type}</span>
                        <span class="date">${createdText}</span>
                        <span id="postViwe${p.id}" class="viwe">${p.view ?? 0}</span>
                    </div>
                </div>
            `);
        });
    }

    // ===== ğŸ”¥ ê³µì§€ & ì¼ë°˜ ê¸€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸° =====
    $(document).on("click", ".notice-item, .post-item", async function () {
        const title = $(this).attr("data-title");
        const date  = $(this).attr("data-date");

        let view = Number($(this).attr("data-view")) || 0;
        let newView = view + 1;

        let viewId = $(this).attr("data-viewId");
        let content = $(this).attr("data-content");

        const isNotice = $(this).hasClass("notice-item");

        // ğŸ”¥ ID ì¶”ì¶œ
        const key = isNotice
            ? $(this).attr("data-viewId").replace("noticeViwe", "")
            : $(this).attr("data-viewId").replace("postViwe", "");

        // ğŸ”¥ DB ê²½ë¡œ
        const dbPath = isNotice
            ? `coffeePosts/ê³µì§€/${key}`
            : `coffeePosts/ê¸°íƒ€/${key}`;

        // ğŸ”¥ DB ì—…ë°ì´íŠ¸ (view í•„ë“œë§Œ ë³€ê²½)
        try {
            await update(ref(db, dbPath), { view: newView });
        } catch (error) {
            console.error("ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
        }

        // =======================
        // ğŸ”¹ ëª¨ë‹¬ UI ì—…ë°ì´íŠ¸
        // =======================
        $("#modal-title").text(title);
        $("#modal-date").text(date);

        const safeContent = content ? content.replace(/\n/g, "<br>") : "";
        $("#modal-content").html(safeContent);

        $("#modal-view").text(`ì¡°íšŒìˆ˜ : ${newView}`);
        $(`#${viewId}`).text(`${newView}`);
        $(this).attr("data-view", newView);

        $("#postModal").show();
    });

    // ë‹«ê¸° ë²„íŠ¼
    $("#closeModalBtn").on("click", function () {
        $("#postModal").hide();
    });

    // ë’¤ë¡œê°€ê¸°
    $("#backBtn").on("click", () => goToPage());
</script>
<script src="../helpModal/helpModal.js" defer></script>
<script src="../menuToggle/menuToggle.js" type="module" defer></script>
</body>
</html>