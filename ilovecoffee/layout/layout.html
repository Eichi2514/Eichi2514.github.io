<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>ì‘ì—…ëŒ€ ë°°ì¹˜ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
            background: #f7f7f9;
        }

        :root {
            --primary: #5a4398;
        }

        .page {
            width: calc(100vw - 48px);
            height: calc(100vh - 48px);
            padding: 24px;
            display: flex;
            flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
        }

        .head-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .help {
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--primary);
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .box {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            min-height: 0;
        }

        .wrap {
            flex: 1;
            border: 1px dashed #e5e7eb;
            border-radius: 12px;
            background: #fafafa;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;

            max-width: 100%;
            max-height: 100%;
        }

        svg {
            display: block;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        .controls {
            flex: 0 0 120px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ctrl {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
        }

        .ctrl label {
            flex: 0 0 45px;
            text-align: right;
        }

        /* ìˆ«ì ì…ë ¥ ì „ìš© */
        .ctrl input[type="number"] {
            font-size: 16px;
            width: 70px;
        }

        /* ì²´í¬ë°•ìŠ¤ ì „ìš© */
        .ctrl input[type="checkbox"] {
            font-size: 16px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .start-btn {
            margin-top: 8px;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .tile {
            fill: #f3f4f6;
            stroke: #cbd5e1;
            cursor: pointer;
            transition: fill .15s ease;
        }

        .tile.judy {
            fill: #84cc16;
            stroke: #84cc16;
        }

        .tile.romer {
            fill: #3b82f6;
            stroke: #3b82f6;
        }

        .tile.kumer {
            fill: #10b981;
            stroke: #10b981;
        }

        .tile.showke {
            fill: #0ea5e9;
            stroke: #0ea5e9;
        }

        .tile.pickup {
            fill: #4338ca;
            stroke: #4338ca;
        }

        .tile.cashier {
            fill: #ec4899;
            stroke: #ec4899;
        }

        .tile.trash {
            fill: #ef4444;
            stroke: #ef4444;
        }

        .tile.workbench {
            fill: #5a4398;
            stroke: #5a4398;
        }

        .tile.gita {
            fill: #111827;
            stroke: #111827;
        }

        .tile.protected {
            fill: #fef9c3; /* ì—°í•œ ë…¸ë€ìƒ‰ */
            stroke: #facc15; /* ë…¸ë€ ê³„ì—´ í…Œë‘ë¦¬ */
        }

        .label {
            font-size: 10px;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: #fff;
            font-weight: 600;
            pointer-events: none;
        }

        /* ì•ˆë‚´ ë¬¸êµ¬ */
        .orientation-alert {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #374151;
            font-family: sans-serif;
            gap: 12px;
            height: 100vh;
        }

        .orientation-alert .icon {
            font-size: 48px;
            animation: rotatePhone 1.5s infinite ease-in-out;
        }

        @keyframes rotatePhone {
            0%, 100% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
<div id="page" class="page">
    <div class="head-line">
        <div class="title">ì‘ì—…ëŒ€ ë°°ì¹˜ë„</div>
        <div id="coord-box" style="margin-left:8px;font-size:14px;color:#333;">ì¢Œí‘œ : -</div>
        <div class="help" title="ë°°ì¹˜ ê·œì¹™ ë„ì›€ë§">?</div>
    </div>
    <div class="box">
        <div class="wrap">
            <svg id="board" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
        <div class="controls">
            <div class="ctrl"><label for="judy">ì¥¬ë””</label><input type="checkbox" id="judy"></div>
            <div class="ctrl"><label for="romer">ë¡œë¨¸</label><input type="number" id="romer" value="0"></div>
            <div class="ctrl"><label for="kumer">ì¿ ë¨¸</label><input type="number" id="kumer" value="0"></div>
            <div class="ctrl"><label for="showke">ì‡¼ì¼€</label><input type="number" id="showke" value="0"></div>
            <div class="ctrl"><label for="gita">ê¸°íƒ€</label><input type="number" id="gita" value="0" disabled></div>
            <div class="ctrl"><label>ì‘ì—…ëŒ€</label><input type="number" id="workbenchCount" value="0" disabled></div>
            <button class="start-btn">ë°°ì¹˜ ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="landscape" class="orientation-alert">
    <div class="icon">ğŸ“±</div>
    <div class="text"><h3>í™”ë©´ì„ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”</h3>
        <p>ë°°ì¹˜ë„ëŠ” ê°€ë¡œ ëª¨ë“œì—ì„œë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p></div>
</div>

<script>
    $(function () {
        function checkOrientation() {
            if ($(window).width() < $(window).height()) {
                $("#landscape").show();
                $("#page").hide();
            } else {
                $("#landscape").hide();
                $("#page").show();
            }
        }

        checkOrientation();
        $(window).on("resize", checkOrientation);

        const ROWS = 16, COLS = 15, W = 42, H = 21, PAD = 24;
        const $svg = $("#board");
        const minX = (0 - (ROWS - 1)) * (W / 2), maxX = (COLS - 1) * (W / 2);
        const minY = 0, maxY = (ROWS - 1 + (COLS - 1)) * (H / 2);
        const boardW = (maxX - minX) + W, boardH = (maxY - minY) + H;
        const centerX = (minX + maxX) / 2, centerY = (minY + maxY) / 2;
        const fullW = boardW + PAD * 2, fullH = boardH + PAD * 2;
        const offsetX = centerX - boardW / 2 - PAD, offsetY = centerY - boardH / 2 - PAD;
        $svg.attr("viewBox", `${offsetX} ${offsetY} ${fullW} ${fullH}`);

        function toScreen(r, c) {
            return {cx: (c - r) * (W / 2), cy: (c + r) * (H / 2)};
        }

        function diamondPoints(cx, cy) {
            return `${cx},${cy - H / 2} ${cx + W / 2},${cy} ${cx},${cy + H / 2} ${cx - W / 2},${cy}`;
        }

        // ë³´ë“œ ìƒì„±
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const {cx, cy} = toScreen(r, c);
                const $poly = $(document.createElementNS("http://www.w3.org/2000/svg", "polygon"))
                    .attr("points", diamondPoints(cx, cy)).attr("data-rc", `${r},${c}`).addClass("tile")
                    .data({rc: `${r},${c}`, occupied: false, protected: false}).attr("title", `(${r},${c})`);
                const $text = $(document.createElementNS("http://www.w3.org/2000/svg", "text"))
                    .attr({x: cx, y: cy + 1}).addClass("label").hide();
                $svg.append($poly).append($text);
            }
        }

        function getTile(r, c) {
            return $(`.tile[data-rc='${r},${c}']`);
        }

        function mark($tile, name, cls) {
            if (!$tile.length) return;
            $tile.data("occupied", true).attr("class", "tile " + cls).next("text").text(name).show();
        }

        function protect(r, c) {
            const $t = getTile(r, c);
            if ($t.length && !$t.data("occupied")) $t.data("protected", true);
        }

        function addProtectL(r, c) {
            const down = getTile(r + 1, c);

            // ì•„ë˜ì¹¸(down)ì„ í•­ìƒ ë¹ˆì¹¸ìœ¼ë¡œ ì´ˆê¸°í™”
            down.attr("class", "tile protected")           // ê¸°ë³¸ íƒ€ì¼ë¡œ ë˜ëŒë¦¼
                .data({occupied: false, protected: true}); // ì°¨ì§€X, ë³´í˜¸ì¹¸O
            down.next("text").text("").hide();      // ë¼ë²¨ ì§€ìš°ê¸°
        }

        function addProtectR(r, c) {
            const right = getTile(r, c + 1);

            // ì˜¤ë¥¸ìª½ì€ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ
            right.attr("class", "tile protected")              // ê¸°ë³¸ íƒ€ì¼ë¡œ ë˜ëŒë¦¼
                .data({occupied: false, protected: true}); // ì°¨ì§€X, ë³´í˜¸ì¹¸O
            right.next("text").text("").hide();      // ë¼ë²¨ ì§€ìš°ê¸°
        }

        function addProtectCross(r, c) {
            const up = getTile(r - 1, c),
                down = getTile(r + 1, c),
                left = getTile(r, c - 1),
                right = getTile(r, c + 1);

            if (up.length && down.length) {
                // ìœ„/ì•„ë˜ ë³´í˜¸ì¹¸ ì²˜ë¦¬
                up.attr("class", "tile protected")
                    .data({occupied: false, protected: true});
                up.next("text").text("").hide();
                down.attr("class", "tile protected")
                    .data({occupied: false, protected: true});
                down.next("text").text("").hide();
            } else {
                // ì™¼ìª½/ì˜¤ë¥¸ìª½ ë³´í˜¸ì¹¸ ì²˜ë¦¬
                left.attr("class", "tile protected")
                    .data({occupied: false, protected: true});
                left.next("text").text("").hide();

                right.attr("class", "tile protected")
                    .data({occupied: false, protected: true});
                right.next("text").text("").hide();
            }
        }

        // ê³ ì • ë°°ì¹˜
        function placeFixed() {
            if ($("#judy").is(":checked")) {
                mark(getTile(13, 12), "ì¥¬ë””", "judy");
                addProtectL(13, 12);

            }

            mark(getTile(14, 13), "ìºì…”", "cashier");
            addProtectCross(14, 13);
            mark(getTile(14, 14), "í”½ì—…", "pickup");
            addProtectCross(14, 14);
            mark(getTile(15, 11), "íœ´ì§€í†µ", "trash");
            mark(getTile(14, 11), "íœ´ì§€í†µ", "trash");
            addProtectR(15, 11);
            addProtectR(14, 11);
        }

        // ë°°ì¹˜ ê°€ëŠ¥ ê²€ì¦
        function canPlace(r, c) {
            const $self = getTile(r, c);
            // ì´ë¯¸ ì°¨ì§€ëœ ì¹¸ì€ ëª»ì”€ (í”½ì—…, ìºì…”, íœ´ì§€í†µ, ì¥¬ë”” ë“± í¬í•¨)
            if ($self.data("occupied")) return false;

            if ($self.data("protected")) return false;

            const left     = getTile(r, c - 1);
            const up       = getTile(r - 1, c);
            const leftDown = getTile(r + 1, c - 1);
            const upRight  = getTile(r - 1, c + 1);

            const isWorkbench = $t => $t.length && $t.hasClass("workbench");

            const hasLeft     = isWorkbench(left);
            const hasUp       = isWorkbench(up);
            const hasLeftDown = isWorkbench(leftDown);
            const hasUpRight  = isWorkbench(upRight);

            // 1) ì™¼ìª½, ìœ„ ëª¨ë‘ ì‘ì—…ëŒ€ ì—†ìŒ
            if (!hasLeft && !hasUp) return true;

            // 2) ì™¼ìª½ë§Œ ì‘ì—…ëŒ€ â†’ ì¢Œí•˜ í™•ì¸
            else if (hasLeft && !hasUp && !hasLeftDown) return true;

            // 3) ìœ„ë§Œ ì‘ì—…ëŒ€ â†’ ìš°ìƒ í™•ì¸
            else if (hasUp && !hasLeft && !hasUpRight) return true;

            // 4) ì™¼ìª½, ìœ„ ëª¨ë‘ ì‘ì—…ëŒ€ â†’ ì¢Œí•˜, ìš°ìƒ í™•ì¸
            else if (hasLeft && hasUp && !hasLeftDown && !hasUpRight) return true;

            return false;
        }

        // ë¡œë¨¸/ì¿ ë¨¸ (ë¹ˆìë¦¬ + ê°€ê¹Œìš´ ìë¦¬ ìš°ì„ )
        function placeFree(name, cls, count) {
            let placed = 0;
            for (let c = COLS - 1; c >= 0 && placed < count; c--) {
                for (let r = ROWS - 1; r >= 0 && placed < count; r--) {
                    if (canPlace(r, c)) {
                        const $t = getTile(r, c);
                        mark($t, name, cls);
                        console.log(`â¡ï¸ ${name} (${r},${c})`);
                        placed++;
                    }
                }
            }
        }

        // ì‡¼ì¼€
        function placeShowke(count) {
            let placed = 0;
            for (let c = 6; c < COLS && placed < count; c++) {
                if (canPlace(15, c)) {
                    const $t = getTile(15, c);
                    mark($t, "ì‡¼ì¼€", "showke");
                    console.log(`â¡ï¸ ${name} (${r},${c})`);
                    addProtectCross(15, c);
                    placed++;
                }
            }
        }

        // ì‘ì—…ëŒ€: ê³„ë‹¨ì‹ìœ¼ë¡œ ì „ë¶€ ë°°ì¹˜
        function placeWorkbenches() {
            let count = 0;

            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r < ROWS; r++) {
                    let place = false;

                    if (c % 3 === 0) {
                        if (r % 3 === 1 || r % 3 === 2) place = true;
                    } else if (c % 3 === 1) {
                        if (r % 3 === 2 || r % 3 === 0) place = true;
                    } else if (c % 3 === 2) {
                        if (r % 3 === 0 || r % 3 === 1) place = true;
                    }

                    if (place) {
                        const $t = getTile(r, c);

                        if ($t.length) {
                            mark($t, "ì‘ì—…ëŒ€", "workbench");
                            count++;
                        }
                    }
                }
            }
            $("#workbenchCount").val(count);
        }

        // ì‘ì—…ëŒ€ ìœ„ì¹˜ ê²€ì¦
        function validateWorkbenches() {
            // íƒ€ì¼ë“¤ì„ ì—­ìˆœìœ¼ë¡œ ìˆœíšŒ
            $(".tile.workbench").get().reverse().forEach(function (el) {
                const $t = $(el);
                const [r, c] = $t.data("rc").split(",").map(Number);

                const $down = getTile(r + 1, c);
                const $right = getTile(r, c + 1);

                // ì•„ë˜/ì˜¤ë¥¸ìª½ì´ "ì¡´ì¬í•˜ë©´ì„œ (ë¹„ì–´ìˆê±°ë‚˜ ë³´í˜¸ì¹¸)" ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ valid
                const downOk = $down.length && (!$down.data("occupied") || $down.data("protected"));
                const rightOk = $right.length && (!$right.data("occupied") || $right.data("protected"));

                const valid = downOk || rightOk;

                if (!valid) {
                    /*
                    console.log(
                        `${r},${c} : \n` +
                        `ì•„ë˜: ${$down.length ? ($down.data("occupied") ? $down.next("text").text() : "empty") : "ì—†ìŒ"}, ` +
                        `ì˜¤ë¥¸ìª½: ${$right.length ? ($right.data("occupied") ? $right.next("text").text() : "empty") : "ì—†ìŒ"}`
                    );
                     */

                    // ì˜ëª»ëœ ì‘ì—…ëŒ€ â†’ ì´ˆê¸°í™” (ë¹ˆì¹¸ìœ¼ë¡œ ë˜ëŒë¦¼)
                    $t.attr("class", "tile").data({occupied: false, protected: false});
                    $t.next("text").text("").hide();
                } else {
                    // ë³´í˜¸ì¹¸ ì§€ì •
                    if (downOk && $down.length && !$down.data("occupied")) {
                        $down.data("protected", true).addClass("protected");
                    } else if (rightOk && $right.length && !$right.data("occupied")) {
                        $right.data("protected", true).addClass("protected");
                    }
                }
            });

            // ì¹´ìš´íŠ¸ ê°±ì‹ 
            $("#workbenchCount").val($(".tile.workbench").length);
        }

        // í•„ìˆ˜ ìë¦¬ ë°°ì¹˜ í›„ ë³´í˜¸ì¹¸ ê±¸ë¦° ì‘ì—…ëŒ€ ì œê±°
        function refineWorkbenches() {
            const romer = parseInt($("#romer").val(), 10) || 0;
            placeFree("ë¡œë¨¸", "romer", romer);
            const kumer = parseInt($("#kumer").val(), 10) || 0;
            placeFree("ì¿ ë¨¸", "kumer", kumer);
            const showke = parseInt($("#showke").val(), 10) || 0;
            placeShowke(showke);
            $("#workbenchCount").val($(".tile.workbench").length);
        }

        // ê¸°íƒ€/ë¹ˆì¹¸ í† ê¸€
        $(document).on("click", ".tile", function () {
            const $t = $(this);
            const label = $t.next("text").text();
            if (label === "ê¸°íƒ€") {
                $t.attr("class", "tile").data({occupied: false, protected: false});
                $t.next("text").text("").hide();
                $("#gita").val(Math.max(0, parseInt($("#gita").val() || 0) - 1));
            } else if (label === "ì‘ì—…ëŒ€") {
                $t.attr("class", "tile").data({occupied: false, protected: false});
                $t.next("text").text("").hide();
                $("#workbenchCount").val(Math.max(0, parseInt($("#workbenchCount").val() || 0) - 1));
            } else if (!label) {
                mark($t, "ê¸°íƒ€", "gita");
                $("#gita").val(parseInt($("#gita").val() || 0) + 1);
            } else {
                $t.attr("class", "tile").data({occupied: false, protected: false});
                $t.next("text").text("").hide();
            }
        });

        // ì´ˆê¸°í™”
        function resetBoard() {
            // ëª¨ë“  íƒ€ì¼ ì´ˆê¸°í™”
            $(".tile").each(function () {
                $(this).attr("class", "tile")
                    .data({occupied: false, protected: false});
                $(this).next("text").text("").hide();
            });

            // ê¸°íƒ€/ì‘ì—…ëŒ€ ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ
            $("#gita").val(0);
            $("#workbenchCount").val(0);

            // ì¢Œí‘œ í‘œì‹œ ì´ˆê¸°í™”
            $("#coord-box").text("ì¢Œí‘œ : -");
        }

        // ë°°ì¹˜ ì‹œì‘
        $(".start-btn").on("click", function () {
            const $btn = $(this);
            if ($btn.text() === "ë°°ì¹˜ ì‹œì‘") {
                console.clear();
                placeWorkbenches();   // ê¸°ë³¸ ì‘ì—…ëŒ€ íŒ¨í„´
                placeFixed();         // í•„ìˆ˜ ìë¦¬ ë„£ê³  ë³´í˜¸ì¹¸ ì •ë¦¬
                validateWorkbenches() // ì‘ì—…ëŒ€ ìœ„ì¹˜ ê²€ì¦ í•¨ìˆ˜
                refineWorkbenches();  // ë¨¸ì‹  ë°°ì¹˜ í•¨ìˆ˜

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $btn.text("ì´ˆê¸°í™”");
            } else {
                // === ì´ˆê¸°í™” ===
                resetBoard();
                $btn.text("ë°°ì¹˜ ì‹œì‘");
            }
        });

        const $coordBox = $("#coord-box");
        $(document).on("mouseenter", ".tile", function () {
            const rc = $(this).data("rc");
            $coordBox.text(`ì¢Œí‘œ : ${rc}`);
        }).on("mouseleave", ".tile", function () {
            $coordBox.text("ì¢Œí‘œ : -");
        });
    })
    ;
</script>
</body>
</html>