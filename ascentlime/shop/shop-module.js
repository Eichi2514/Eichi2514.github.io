const productStatItems = {
    "s1": {
        "img": "https://github.com/user-attachments/assets/c8fa776d-4542-4ff9-a720-3def28066354",
        "name": "힘 10 증가",
        "price": 200
    },
    "s2": {
        "img": "https://github.com/user-attachments/assets/d2325c86-7fa2-4c39-a105-8b51c3a8d496",
        "name": "힘 20 증가",
        "price": 380
    },
    "s3": {
        "img": "https://github.com/user-attachments/assets/3529dc2b-8a3d-478c-9bcf-078736ee5b0b",
        "name": "힘 50 증가",
        "price": 900
    },
    "s4": {
        "img": "https://github.com/user-attachments/assets/1bff301c-0adb-4109-94fa-6eff7be8ef66",
        "name": "힘 80 증가",
        "price": 1360
    },
    "s5": {
        "img": "https://github.com/user-attachments/assets/3a61e399-7e23-4a81-9a85-fa0bfc5fb1bb",
        "name": "힘 100 증가",
        "price": 1600
    },
    "s6": {
        "img": "https://github.com/user-attachments/assets/140b3b12-d14b-4168-9e8c-c2a652f25704",
        "name": "체력 10 회복",
        "price": 200
    },
    "s7": {
        "img": "https://github.com/user-attachments/assets/b3795aa4-bbfc-4658-bd19-02eacafa7020",
        "name": "체력 20 회복",
        "price": 380
    },
    "s8": {
        "img": "https://github.com/user-attachments/assets/a992c00d-36ef-4cde-a602-8ff5af49d73b",
        "name": "체력 50 회복",
        "price": 900
    },
    "s9": {
        "img": "https://github.com/user-attachments/assets/1289412b-5507-4f13-a9a4-9809a3d979ff",
        "name": "체력 80 회복",
        "price": 1360
    },
    "s10": {
        "img": "https://github.com/user-attachments/assets/0a978402-9dd5-4280-8d95-ac0f57193ac6",
        "name": "체력 100 회복",
        "price": 1600
    },
    "s11": {
        "img": "https://github.com/user-attachments/assets/274f7067-2d2b-4ec3-96c4-c8ee9149cea7",
        "name": "속도 10 증가",
        "price": 1000
    }
};

const productWeaponItems = {
    "w1": {
        "img": "../image/weapon/weapon1.png",
        "name": "톡신 오브",
        "price": 10
    },
    "w2": {
        "img": "../image/weapon/weapon2.png",
        "name": "디케이 큐브",
        "price": 20
    },
    "w3": {
        "img": "../image/weapon/weapon3.png",
        "name": "베놈 랜스",
        "price": 30
    },
    "w4": {
        "img": "../image/weapon/weapon4.png",
        "name": "포이즌 스타",
        "price": 40
    },
    "w5": {
        "img": "../image/weapon/weapon5.png",
        "name": "플라그 애로우",
        "price": 50
    },
    "w6": {
        "img": "../image/weapon/weapon6.png",
        "name": "코러시브 빔",
        "price": 60
    },
    "w7": {
        "img": "../image/weapon/weapon7.png",
        "name": "테트라 팽",
        "price": 70
    },
    "w8": {
        "img": "../image/weapon/weapon8.png",
        "name": "블라이트 봄버맨",
        "price": 80
    },
    "w9": {
        "img": "../image/weapon/weapon9.png",
        "name": "퍼시드 스매셔",
        "price": 90
    },
    "w10": {
        "img": "../image/weapon/weapon10.png",
        "name": "제노시스 블레이드",
        "price": 100
    },
    "w11": {
        "img": "../image/weapon/weapon11.png",
        "name": "어비스 오브",
        "price": 210
    },
    "w12": {
        "img": "../image/weapon/weapon12.png",
        "name": "크립틱 큐브",
        "price": 220
    },
    "w13": {
        "img": "../image/weapon/weapon13.png",
        "name": "나이트 랜스",
        "price": 230
    },
    "w14": {
        "img": "../image/weapon/weapon14.png",
        "name": "쉐이드 스타",
        "price": 240
    },
    "w15": {
        "img": "../image/weapon/weapon15.png",
        "name": "팬텀 애로우",
        "price": 250
    },
    "w16": {
        "img": "../image/weapon/weapon16.png",
        "name": "루나 빔",
        "price": 260
    },
    "w17": {
        "img": "../image/weapon/weapon17.png",
        "name": "섀도우 팽",
        "price": 270
    },
    "w18": {
        "img": "../image/weapon/weapon18.png",
        "name": "나이트폴 봄버맨",
        "price": 280
    },
    "w19": {
        "img": "../image/weapon/weapon19.png",
        "name": "스펙터 스매셔",
        "price": 290
    },
    "w20": {
        "img": "../image/weapon/weapon20.png",
        "name": "루나틱 블레이드",
        "price": 300
    },
    "w21": {
        "img": "../image/weapon/weapon21.png",
        "name": "스톰 오브",
        "price": 510
    },
    "w22": {
        "img": "../image/weapon/weapon22.png",
        "name": "타이달 큐브",
        "price": 520
    },
    "w23": {
        "img": "../image/weapon/weapon23.png",
        "name": "블리자드 랜스",
        "price": 530
    },
    "w24": {
        "img": "../image/weapon/weapon24.png",
        "name": "스카이 스타",
        "price": 540
    },
    "w25": {
        "img": "../image/weapon/weapon25.png",
        "name": "제피르 애로우",
        "price": 550
    },
    "w26": {
        "img": "../image/weapon/weapon26.png",
        "name": "볼텍스 빔",
        "price": 560
    },
    "w27": {
        "img": "../image/weapon/weapon27.png",
        "name": "게일 팽",
        "price": 570
    },
    "w28": {
        "img": "../image/weapon/weapon28.png",
        "name": "프로스트 봄버맨",
        "price": 580
    },
    "w29": {
        "img": "../image/weapon/weapon29.png",
        "name": "스카이 스매셔",
        "price": 590
    },
    "w30": {
        "img": "../image/weapon/weapon30.png",
        "name": "글레이셔 블레이드",
        "price": 600
    },
    "w31": {
        "img": "../image/weapon/weapon31.png",
        "name": "포레스트 오브",
        "price": 910
    },
    "w32": {
        "img": "../image/weapon/weapon32.png",
        "name": "베르던트 큐브",
        "price": 920
    },
    "w33": {
        "img": "../image/weapon/weapon33.png",
        "name": "가이아 랜스",
        "price": 930
    },
    "w34": {
        "img": "../image/weapon/weapon34.png",
        "name": "실피드 스타",
        "price": 940
    },
    "w35": {
        "img": "../image/weapon/weapon35.png",
        "name": "바인 애로우",
        "price": 950
    },
    "w36": {
        "img": "../image/weapon/weapon36.png",
        "name": "테라 빔",
        "price": 960
    },
    "w37": {
        "img": "../image/weapon/weapon37.png",
        "name": "와일드 팽",
        "price": 970
    },
    "w38": {
        "img": "../image/weapon/weapon38.png",
        "name": "가이아 봄버맨",
        "price": 980
    },
    "w39": {
        "img": "../image/weapon/weapon39.png",
        "name": "네이처 스매셔",
        "price": 990
    },
    "w40": {
        "img": "../image/weapon/weapon40.png",
        "name": "스피릿 블레이드",
        "price": 1000
    },
    "w41": {
        "img": "../image/weapon/weapon41.png",
        "name": "라이트닝 오브",
        "price": 1510
    },
    "w42": {
        "img": "../image/weapon/weapon42.png",
        "name": "볼태틱 큐브",
        "price": 1520
    },
    "w43": {
        "img": "../image/weapon/weapon43.png",
        "name": "스파크 랜스",
        "price": 1530
    },
    "w44": {
        "img": "../image/weapon/weapon44.png",
        "name": "라디언트 스타",
        "price": 1540
    },
    "w45": {
        "img": "../image/weapon/weapon45.png",
        "name": "플래시 애로우",
        "price": 1550
    },
    "w46": {
        "img": "../image/weapon/weapon46.png",
        "name": "라디언트 빔",
        "price": 1560
    },
    "w47": {
        "img": "../image/weapon/weapon47.png",
        "name": "썬더 팽",
        "price": 1570
    },
    "w48": {
        "img": "../image/weapon/weapon48.png",
        "name": "템페스트 봄버맨",
        "price": 1580
    },
    "w49": {
        "img": "../image/weapon/weapon49.png",
        "name": "디바인 스매셔",
        "price": 1590
    },
    "w50": {
        "img": "../image/weapon/weapon50.png",
        "name": "플라즈마 블레이드",
        "price": 1600
    },
    "w51": {
        "img": "../image/weapon/weapon51.png",
        "name": "서지 오브",
        "price": 2610
    },
    "w52": {
        "img": "../image/weapon/weapon52.png",
        "name": "라디언트 큐브",
        "price": 2620
    },
    "w53": {
        "img": "../image/weapon/weapon53.png",
        "name": "블레이즈 랜스",
        "price": 2630
    },
    "w54": {
        "img": "../image/weapon/weapon54.png",
        "name": "썬셋 스타",
        "price": 2640
    },
    "w55": {
        "img": "../image/weapon/weapon55.png",
        "name": "플레어 애로우",
        "price": 2650
    },
    "w56": {
        "img": "../image/weapon/weapon56.png",
        "name": "솔라 빔",
        "price": 2660
    },
    "w57": {
        "img": "../image/weapon/weapon57.png",
        "name": "폭풍 팽",
        "price": 2670
    },
    "w58": {
        "img": "../image/weapon/weapon58.png",
        "name": "썬더 봄버맨",
        "price": 2680
    },
    "w59": {
        "img": "../image/weapon/weapon59.png",
        "name": "파워 스매셔",
        "price": 2690
    },
    "w60": {
        "img": "../image/weapon/weapon60.png",
        "name": "에너제틱 블레이드",
        "price": 2700
    },
    "w61": {
        "img": "../image/weapon/weapon61.png",
        "name": "파이어 오브",
        "price": 4710
    },
    "w62": {
        "img": "../image/weapon/weapon62.png",
        "name": "인페르노 큐브",
        "price": 4720
    },
    "w63": {
        "img": "../image/weapon/weapon63.png",
        "name": "헬파이어 랜스",
        "price": 4730
    },
    "w64": {
        "img": "../image/weapon/weapon64.png",
        "name": "플레임 스타",
        "price": 4740
    },
    "w65": {
        "img": "../image/weapon/weapon65.png",
        "name": "피닉스 애로우",
        "price": 4750
    },
    "w66": {
        "img": "../image/weapon/weapon66.png",
        "name": "블러드 빔",
        "price": 4760
    },
    "w67": {
        "img": "../image/weapon/weapon67.png",
        "name": "크림슨 팽",
        "price": 4770
    },
    "w68": {
        "img": "../image/weapon/weapon68.png",
        "name": "블레이즈 봄버맨",
        "price": 4780
    },
    "w69": {
        "img": "../image/weapon/weapon69.png",
        "name": "파이로 스매셔",
        "price": 4790
    },
    "w70": {
        "img": "../image/weapon/weapon70.png",
        "name": "인페르노 블레이드",
        "price": 4800
    }
};

const productCashItems = {
    "c1": {
        "img": "https://github.com/user-attachments/assets/58999c47-910e-4eea-8fc0-9c2cf3a1ca3f",
        "name": "닉네임 변경권",
        "price": 1000
    },
    "c2": {
        "img": "https://github.com/user-attachments/assets/25b5197e-0ab4-4fb5-9d11-644a7e46d954",
        "name": "초보 등반자 (여)",
        "price": 1000
    }
};

// Firebase SDK 불러오기
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import {
    getDatabase,
    ref,
    query,
    orderByChild,
    equalTo,
    get,
    child,
    update
} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

// Firebase 설정
const firebaseConfig = {
    apiKey: ".env/apiKey",
    authDomain: ".env/authDomain",
    databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
    projectId: ".env/projectId",
    storageBucket: ".env/storageBucket",
    messagingSenderId: ".env/messagingSenderId",
    appId: ".env/appId",
    measurementId: ".env/measurementId"
};

// Firebase 초기화
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const membersRef = ref(database, 'members');
const weaponFindRef = ref(database, 'weaponFind');

const key = localStorage.getItem('nickname') || sessionStorage.getItem('nickname');
if (!key) {
    alert('로그인이 필요한 서비스 입니다');
    window.location.href = '../../ascentlime.html';
}

window.getUserAssets = function (key) {
    const queryRef = query(membersRef, orderByChild("key"), equalTo(key));
    return get(queryRef)
        .then((snapshot) => {
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();
            const memberKey = Object.keys(memberData)[0];
            const data = memberData[memberKey];

            return {
                money: data.money || 0,
                cash: data.cash || 0,
            };
        })
        .catch((error) => {
            console.error("유저 재화 확인 중 오류 발생:", error);
            return null;
        });
};

/*
function convertNumberFormat(value) {
    const units = {K: 1_000, M: 1_000_000, B: 1_000_000_000};

    if (typeof value === 'string') {
        const unit = value.slice(-1);
        if (units[unit]) {
            return parseFloat(value.replace(unit, '')) * units[unit];
        }
    }

    if (typeof value === 'number') {
        for (let [unit, threshold] of Object.entries(units).reverse()) {
            if (value >= threshold) {
                return (Math.floor(value / threshold * 10) / 10) + unit;
            }
        }
    }

    return value;
}
*/

function formatNumber(number) {
    return number.toLocaleString();
}

const urls = window.location.search;

const shopTap = urls ? parseInt(new URLSearchParams(urls).get('tap'), 10) || 0 : 0;
const page = urls ? parseInt(new URLSearchParams(urls).get('page'), 10) || 1 : 1;

// console.log(`shopTap : ${shopTap}, page : ${page}`);

$(`.tab-${shopTap}`).css('z-index', 1);

window.loginKeyCheckById = async function () {
    const loginKeyCheckByIdKey = localStorage.getItem('nickname') || sessionStorage.getItem('nickname');

    if (!loginKeyCheckByIdKey) return;

    const queryRef = query(membersRef, orderByChild("key"), equalTo(loginKeyCheckByIdKey));
    try {
        const snapshot = await get(queryRef);
        if (!snapshot.exists()) {
            console.log('loginKeyCheckById) 해당 키가 존재하지 않습니다.');
            return null;
        }

        const memberData = snapshot.val();

        const memberKey = Object.keys(memberData)[0];
        return memberData[memberKey].id;
    } catch (error) {
        console.error("loginKeyCheckById) 해당 키 확인 중 오류 발생:", error);
        return null;
    }
};

window.getWeaponFind = async function (memberKey) {
    const memberId = await loginKeyCheckById();
    const safeId = memberId.toString();
    const newWeaponFindRef = child(weaponFindRef, safeId);

    try {
        const snapshot = await get(newWeaponFindRef);
        if (!snapshot.exists()) return;

        const weaponData = snapshot.val();

        let newProductWeaponItems = {}; // 객체로 초기화

        Object.keys(weaponData).forEach((key) => {
            newProductWeaponItems[`w${key}`] = productWeaponItems[`w${key}`];
        });

        return newProductWeaponItems;

    } catch (error) {
        console.error("무기 데이터를 가져오는 중 오류 발생:", error);
    }
};

let userMoney = 0;
let userCash = 0;
const unknownItems = 'https://github.com/user-attachments/assets/34628dee-0e58-4d89-a510-13ebb9a2dcae';

async function displayShopItems() {
    let itemsToDisplay = [];

    try {
        const userAssets = await getUserAssets(key);
        userMoney = userAssets.money;
        userCash = userAssets.cash;

        let userCashString = formatNumber(userAssets.cash);
        let userMoneyString = formatNumber(userAssets.money);

        $('.cash_count').text(userCashString);
        $('.money_count').text(userMoneyString);

    } catch (error) {
        console.error('돈 불러오는 중 오류 발생:', error);
        $('.cash_count').text('불러오기 실패');
        $('.money_count').text('불러오기 실패');
    }

    const createProductItem = (product, itemKey, price) => `
        <div class="product-item">
            <img src="${product.img || unknownItems}" alt="상품 이미지" class="product-image"/>
            
            <div class="product-details">
                <div class="product-name">${product.name || '미확인 아이템'}</div>
                <div class="product-purchase">
                    ${product.name ? `
                    <span class="product-price">${price}</span>
                    <button class="s-button buy-button" data-id="${itemKey}">구매</button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    const renderItems = (productItems, isStat, prefix, length = Object.keys(productItems).length) => {
        for (let i = 1; i <= length; i++) {
            const itemKey = prefix ? `${prefix}${i}` : `c${i}`;
            const product = productItems[itemKey] || {};
            const price = isStat ? `$ ${formatNumber(product.price || 0)}` : `${formatNumber(product.price || 0)}원`;
            itemsToDisplay.push(createProductItem(product, itemKey, price));
        }
    };

    if (shopTap === 1 || shopTap === 0) {
        renderItems(productStatItems, true, 's');
    }
    if (shopTap === 2 || shopTap === 0) {
        const newProductWeaponItems = await getWeaponFind(key);
        if (newProductWeaponItems) {
            renderItems(newProductWeaponItems, true, 'w', Object.keys(productWeaponItems).length);
        }
    }
    if (shopTap === 3 || shopTap === 0) {
        renderItems(productCashItems, false, 'c');
    }

    itemsToDisplay.slice((page - 1) * 15, page * 15).forEach(item => $('.shop-container').append(item));
    await updatePagination(itemsToDisplay.length);
}

displayShopItems();

$(document).on('click', '.buy-button', async function () {
    const button = $(this);
    button.prop('disabled', true).text('구매 중...');

    const id = button.data('id');

    let success = false;

    try {
        if (id.startsWith('s')) {
            if (userMoney < productStatItems[id].price) {
                alert(`재화가 부족합니다.`);
            } else {
                await applyStatItem(key, id);
                success = true;
            }
        } else if (id.startsWith('w')) {
            if (userMoney < productWeaponItems[id].price) {
                alert(`재화가 부족합니다.`);
            } else {
                await equipWeaponItem(key, id);
                success = true;
            }
        } else if (id.startsWith('c')) {
            alert('현재 구매가 불가능한 상품입니다.');
        }
    } catch (error) {
        button.prop('disabled', false).text('구매');
        console.error('구매 처리 실패:', error);
        return;
    }

    if (success) {
        const productName = id.startsWith('s')
            ? productStatItems[id].name
            : productWeaponItems[id].name;

        alert(`${productName}을(를) 구매하셨습니다!`);
        location.reload();
    }
});

window.updateUserMoney = async function (memberKey, newMoney) {
    try {
        const queryRef = query(membersRef, orderByChild("key"), equalTo(memberKey));
        const snapshot = await get(queryRef);

        if (snapshot.exists()) {
            const key = Object.keys(snapshot.val())[0];
            const data = snapshot.val()[key];

            if (data) {
                const updatedData = {
                    ...data,
                    money: newMoney,
                };

                await update(ref(database, `members/${key}`), updatedData);
            }
        }
    } catch (error) {
        console.error("금액 업데이트 실패:", error);
        throw error;
    }
};


window.applyStatItem = async function (memberKey, id) {
    const memberId = await loginKeyCheckById();
    const safeId = memberId.toString();
    const characRef = ref(database, `characs/${safeId}`);

    let newId = parseInt(id.replace('s', ''), 10);
    const characSnapshot = await get(characRef);
    const characData = characSnapshot.val();
    const originalCharacData = JSON.parse(JSON.stringify(characData));

    const updateHp = async (hpIncrease) => {
        if (characData.hp >= 1000) {
            throw new Error('현재 체력이 이미 최대치입니다!');
        } else if (characData.hp + hpIncrease > 1000) {
            await update(characRef, {hp: 1000});
        } else {
            await update(characRef, {hp: characData.hp + hpIncrease});
        }
    };

    const updatePower = async (powerIncrease) => {
        await update(characRef, {power: characData.power + powerIncrease});
    };

    const updateSpeed = async (powerIncrease) => {
        if (characData.speed <= 10) {
            throw new Error('현재 속도가 이미 최대치입니다!');
        } else {
            await update(characRef, {speed: characData.speed - powerIncrease});
        }
    };

    try {
        switch (newId) {
            case 1:
                await updatePower(10);
                break;
            case 2:
                await updatePower(20);
                break;
            case 3:
                await updatePower(50);
                break;
            case 4:
                await updatePower(80);
                break;
            case 5:
                await updatePower(100);
                break;
            case 6:
                await updateHp(10);
                break;
            case 7:
                await updateHp(20);
                break;
            case 8:
                await updateHp(50);
                break;
            case 9:
                await updateHp(80);
                break;
            case 10:
                await updateHp(100);
                break;
            case 11:
                await updateSpeed(10);
                break;
        }

        await updateUserMoney(memberKey, userMoney - productStatItems[id].price);
    } catch (err) {
        try {
            await update(characRef, {...originalCharacData});
            await updateUserMoney(memberKey, userMoney);
            alert(err.message);
        } catch (recoveryError) {
            console.error("원상복구에 실패했습니다!", recoveryError);
            alert("Error : 원상복구에 실패했습니다. Q & A 게시판으로 문의해주세요.");
            throw recoveryError;
        }
        throw err;
    }
};

window.equipWeaponItem = async function (memberKey, id) {
    const memberId = await loginKeyCheckById();
    const safeId = memberId.toString();
    const characRef = ref(database, `characs/${safeId}`);

    let newId = parseInt(id.replace('w', ''), 10);
    const characSnapshot = await get(characRef);
    const characData = characSnapshot.val();
    const originalCharacData = JSON.parse(JSON.stringify(characData));

    if (characData.weaponId === newId) {
        alert('이미 착용중인 무기 입니다.');
        throw new Error('이미 착용중인 무기 입니다.');
    }

    try {
        await update(characRef, {weaponId: newId});
        await updateUserMoney(memberKey, userMoney - productWeaponItems[id].price);
    } catch (err) {
        try {
            await update(characRef, {...originalCharacData});
            await updateUserMoney(memberKey, userMoney);
            alert(err.message);
        } catch (recoveryError) {
            console.error("원상복구에 실패했습니다!", recoveryError);
            alert("Error : 원상복구에 실패했습니다. Q & A 게시판으로 문의해주세요.");
            throw recoveryError;
        }
        throw err;
    }
};

// 페이지네이션 동적 링크 계산
async function updatePagination(totalLogsCount) {
    const pagination = $('.pagination');
    let lastPage = Math.ceil(totalLogsCount / 15.0) || 1;

    if (page > lastPage) {
        location.href = `../shop/shop.html?tap=${shopTap}&page=${lastPage}`;
    }

    pagination.html(`        
            <!-- '처음' 버튼 -->
            <a href="../shop/shop.html?page=1">처음 )</a>
            &nbsp;
            <!-- 이전 페이지 버튼들 -->
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.max(page - 4, 1)}" style="${page <= 4 ? 'display: none;' : ''}">${Math.max(page - 4, 1)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.max(page - 3, 1)}" style="${page <= 3 ? 'display: none;' : ''}">${Math.max(page - 3, 1)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.max(page - 2, 1)}" style="${page <= 2 ? 'display: none;' : ''}">${Math.max(page - 2, 1)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.max(page - 1, 1)}" style="${page === 1 ? 'display: none;' : ''}">${Math.max(page - 1, 1)}</a>
            <!-- 현재 페이지 -->
            <div class="page active">${page}</div>
            <!-- 다음 페이지 버튼들 -->
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.min(page + 1, lastPage)}" style="${page >= lastPage ? 'display: none;' : ''}">${Math.min(page + 1, lastPage)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.min(page + 2, lastPage)}" style="${page + 1 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 2, lastPage)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.min(page + 3, lastPage)}" style="${page + 2 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 3, lastPage)}</a>
            <a class="page" href="../shop/shop.html?tap=${shopTap}&page=${Math.min(page + 4, lastPage)}" style="${page + 3 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 4, lastPage)}</a>
            <!-- '마지막' 버튼 -->
            &nbsp;
            <a href="../shop/shop.html?tap=${shopTap}&page=${lastPage}">( 마지막</a>        
    `);
}