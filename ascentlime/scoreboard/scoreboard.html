<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>
    <link rel="stylesheet" href="../main/main.css"/>

    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- 한글 폰트 불러오기 -->
    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="body">
    <!-- p2 홈페이지 배경 이미지 -->
    <img class="bg_img"
         src="https://github.com/user-attachments/assets/57d5f274-24c1-486b-9679-7aa7b6fa9017"
         alt=""/>

    <div class="scoreboard_bg absolute">
        <!-- p2 나무판 배경 이미지 -->
        <img class="scoreboard_bg"
             src="https://github.com/user-attachments/assets/2ad87f22-47df-4929-9e1d-10b172cb3aa7"
             alt=""/>

        <!-- 테이블: 점수판을 동적으로 업데이트 -->
        <table class="scoreboard_table absolute">
            <caption style="padding-bottom: 7vh;">SCORE</caption>
            <tbody id="scoreboardBody">
            <!-- 여기서 데이터를 동적으로 추가 -->
            </tbody>
        </table>

        <!-- 페이지네이션: 페이지네이션 링크는 여기서 동적으로 추가 -->
        <div class="pagination">
            <!-- 여기서 데이터를 동적으로 추가 -->
        </div>
    </div>
</div>

<script type="module">
    // Firebase 관련 라이브러리 임포트
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        onChildAdded,
        onValue,
        query,
        orderByKey,
        startAt,
        limitToFirst
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const logsRef = ref(database, 'logs');

    const nickname = localStorage.getItem('nickname');
    const urlParams = new URLSearchParams(window.location.search);
    let page = parseInt(urlParams.get('page')) || 2; // 기본값은 1 페이지
    const startIndex = Math.max((page - 1) * 10);

    // Firebase에서 데이터를 가져오기 (페이지네이션)
    const logsQuery = query(logsRef, orderByKey(), startAt(String(startIndex)), limitToFirst(10));

    // 실시간으로 logs 데이터를 받아서 테이블에 표시
    onChildAdded(logsQuery, (data) => {
        const log = data.val(); // Firebase에서 가져온 데이터
        const scoreboardBody = document.getElementById('scoreboardBody');

        let className = '';
        if (nickname !== log.name) {
            className = 'text-gray-500'; // 닉네임과 다르면 회색으로 표시
        }

        let floorName = log.floor;
        let roomName = log.room + '번방';
        if (log.room === 0) {
            floorName++;
            roomName = '보스방'; // 0번방은 보스방으로 설정
        }

        // 새로운 테이블 행 생성
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="${className}" style="text-align: center; padding: 0;">${log.name}</td>
            <td class="${className}" style="text-align: center; padding: 0 1vh;">:</td>
            <td class="${className}" style="text-align: center; padding: 0 0.5vh;">${floorName}층</td>
            <td class="${className}" style="text-align: center; padding: 0;">${roomName}</td>
            <td class="scoreboard_clearTime ${className}" style="text-align: center; padding: 0;">[${log.clearTime}s]</td>
        `;

        // 테이블에 행 추가
        scoreboardBody.appendChild(row);
    });

    // 페이지네이션 컨트롤 생성
    const pagination = document.querySelector('.pagination');
    let totalLogsCount = 0; // 총 로그 갯수

    // Firebase에서 로그 갯수 구하기
    onValue(logsRef, (snapshot) => {
        const data = snapshot.val(); // 데이터를 객체로 가져옴

        // 데이터가 객체 형태라면
        if (data) {
            totalLogsCount = Object.keys(data).length; // 자식 노드 개수 계산

            // lastPage 계산
            const lastPage = Math.ceil(totalLogsCount / 10.0);

            // 페이지네이션을 업데이트하는 코드
            updatePagination(lastPage);
        }
    });

    // 페이지네이션 동적 링크 계산
    function updatePagination(lastPage) {
        pagination.innerHTML = `
            <a class="pagination_left absolute" href="../list?page=${page > 1 ? page - 1 : 1}" ${page === 1 ? 'style="visibility: hidden;"' : ''}>
                <i class="fa-solid fa-caret-left" style="font-size: 10vh;"></i>
            </a>
            <a class="pagination_right absolute" href="../list?page=${page < lastPage ? page + 1 : lastPage}" ${page === lastPage ? 'style="visibility: hidden;"' : ''}>
                <i class="fa-solid fa-caret-right" style="font-size: 10vh;"></i>
            </a>

            <a class="scoreboard_exit_bt absolute" href="../main/main">나가기</a>

            <div class="pagination flex justify-center absolute">
                <a href="../list?page=1" ${page === 1 ? 'style="visibility: hidden;"' : ''}>처음</a>
                <button ${page === 1 ? 'style="visibility: hidden;"' : ''}>)&nbsp;</button>
                <a href="../list?page=${page > 1 ? page - 1 : 1}" ${page === 1 ? 'style="visibility: hidden;"' : ''}>${page > 1 ? page - 1 : 1}</a>
                <a class="text-red-500" href="../list?page=${page}">${page}</a>
                <a href="../list?page=${page < lastPage ? page + 1 : lastPage}" ${page === lastPage ? 'style="visibility: hidden;"' : ''}>${page < lastPage ? page + 1 : lastPage}</a>
                <button ${page === lastPage ? 'style="visibility: hidden;"' : ''}>&nbsp;(</button>
                <a href="../list?page=${lastPage}" ${page === lastPage ? 'style="visibility: hidden;"' : ''}>마지막</a>
            </div>
        `;
    }
</script>
</body>
</html>