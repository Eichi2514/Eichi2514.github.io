<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>

    <link rel="stylesheet" href="../main/main.css"/>
    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="body">
    <!-- p2 홈페이지 배경 -->
    <img class="bg_img"
         src="https://github.com/user-attachments/assets/57d5f274-24c1-486b-9679-7aa7b6fa9017"
         alt=""/>

    <div class="doJoin_bg absolute">
        <!-- p2 나무판 -->
        <img class="doJoin_bg" src="https://github.com/user-attachments/assets/2017f1b7-9290-4387-a5ac-daee1743354c"
             alt=""/>
        <div class="doJoin_title absolute text-center">회 원 가 입</div>

        <form method="POST">
            <div class="doJoin_id absolute">
                <div class="label">아 이 디</div>
                <label>
                    <input class="inputID label" type="text" placeholder="아이디 입력" name="loginId"/>
                </label>
            </div>
            <div class="doJoin_pw absolute">
                <div class="label">비밀번호</div>
                <label>
                    <input class="inputPW label" type="password" placeholder="비밀번호 입력" name="loginPw"/>
                </label>
            </div>
            <div class="doJoin_pw2 absolute">
                <div class="label">비밀번호 확인</div>
                <label>
                    <input class="inputPW2 label" type="password" placeholder="비밀번호 입력" name="loginPw2"/>
                </label>
            </div>
            <div class="doJoin_name absolute">
                <div class="label">이 름</div>
                <label>
                    <input class="inputName label" type="text" placeholder="이름 입력" name="name"/>
                </label>
            </div>
            <div class="doJoin_nickname absolute">
                <div class="label">닉 네 임</div>
                <label>
                    <input class="inputNickname label" type="text" placeholder="닉네임 입력" name="nickname"/>
                </label>
            </div>
            <!-- 오류 메시지 표시할 공간 -->
            <div class="errorMessageVew absolute">
                <div class="errorID"></div>
                <div class="errorPW"></div>
                <div class="errorPW2"></div>
                <div class="errorName"></div>
                <div class="errorNickname"></div>
            </div>

            <button class="doJoin_bt absolute text-center" type="submit">회원가입</button>
            <a class="doJoin_exit absolute text-center" href="../main/main">취소</a>
        </form>
    </div>
</div>
<script type="module">
    // Firebase SDK 불러오기
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        set,
        push
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const membersRef = ref(database, 'members');

    window.saveMembers = async function (member) {
        const now = new Date();
        const formattedTime = `${now.getFullYear()}년 ${String(now.getMonth() + 1).padStart(2, '0')}월 ${String(now.getDate()).padStart(2, '0')}일 ${String(now.getHours()).padStart(2, '0')}시 ${String(now.getMinutes()).padStart(2, '0')}분 ${String(now.getSeconds()).padStart(2, '0')}초`;

        let info = "알 수 없음";

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`
                        );
                        const data = await response.json();

                        if (data.error) {
                            info = "정보를 가져올 수 없음";
                        } else {
                            info = data.display_name;
                        }
                    } catch (error) {
                        console.error("정보를 가져오는 중 오류 발생:", error);
                        info = "정보를 가져오는 중 오류 발생";
                    }

                    saveToDatabase();
                },
                (error) => {
                    console.error("정보를 가져오는 중 오류 발생:", error);
                    saveToDatabase();
                }
            );
        } else {
            console.warn("정보를 지원하지 않는 브라우저입니다");
            await saveToDatabase();
        }

        async function saveToDatabase() {
            try {
                console.log("Saving to database...");
                const snapshot = await get(membersRef);
                let newId = 1;

                if (snapshot.exists()) {
                    const members = snapshot.val();
                    const ids = Object.values(members).map(info => info.id);
                    newId = Math.max(...ids, 0) + 1; // 가장 큰 ID 값에 1을 추가
                }

                const newMembersRef = push(membersRef);
                set(newMembersRef, {
                    id: newId,
                    name: member.name,
                    nickname: member.nickname,
                    loginId: member.loginId,
                    loginPw: member.loginPw,
                    key: member.key,
                    time: formattedTime,
                    info: info
                });

                alert("회원가입이 완료되었습니다.");
                window.location.href = "../main/main";
            } catch (error) {
                alert("데이터를 저장하는 중 오류 발생:" + error);
            }
        }
    };

    window.doJoin = async function (member) {
        const snapshot = await get(membersRef);
        if (snapshot.exists()) {
            const members = snapshot.val();
            const existingIds = Object.values(members).map(info => info.loginId);
            const existingNicknames = Object.values(members).map(info => info.nickname);

            if (existingIds.includes(member.loginId)) {
                alert("이미 사용 중인 아이디입니다.");
                return;
            }
            if (existingNicknames.includes(member.nickname)) {
                alert("이미 사용 중인 닉네임입니다.");
                return;
            }
        }

        await saveMembers(member);
    };

    window.getKey = async function () {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; // 영문 대소문자와 숫자
        let key = '';
        for (let i = 0; i < 7; i++) {
            key += chars.charAt(Math.floor(Math.random() * chars.length)); // 랜덤으로 문자 선택
        }

        // 중복된 키가 있는지 확인하는 함수
        const snapshot = await get(membersRef);
        if (snapshot.exists()) {
            const members = snapshot.val();
            const existingKeys = Object.values(members).map(info => info.key);

            // 만약 생성된 키가 이미 존재하면 재귀적으로 새로운 키를 생성
            if (existingKeys.includes(key)) {
                return getKey(); // 중복된 키가 있으면 다시 호출
            }
        }

        return key;
    }

    // 아이디 중복 검사 함수
    window.checkDuplicateId = async function (loginId) {
        const snapshot = await get(membersRef);
        if (snapshot.exists()) {
            const members = snapshot.val();
            const existingIds = Object.values(members).map(info => info.loginId);
            return existingIds.includes(loginId);
        }
        return false; // 데이터가 없으면 중복되지 않음
    }

    // 닉네임 중복 검사 함수
    window.checkDuplicateNickname = async function (nickname) {
        const snapshot = await get(membersRef);
        if (snapshot.exists()) {
            const members = snapshot.val();
            const existingNicknames = Object.values(members).map(info => info.nickname);
            return existingNicknames.includes(nickname);
        }
        return false; // 데이터가 없으면 중복되지 않음
    }
</script>
<script>
    window.onerror = function () {
        window.location.href = 'https://eichi2514.github.io/ascentlime/restricted/restricted';
        return true;
    };

    const restrictedNicknames = ['chi', 'Eichi', '에이치', '빨간이치', 'admin', '관리자'];

    $(document).ready(function () {
        $("form").submit(async function (event) {
            event.preventDefault();

            const member = {
                loginId: $("input[name='loginId']").val().trim(),
                loginPw: $("input[name='loginPw']").val().trim(),
                nickname: $("input[name='nickname']").val().trim(),
                name: $("input[name='name']").val().trim()
            };

            const loginPw2 = $("input[name='loginPw2']").val().trim();

            if (!member.loginId) {
                alert("아이디를 입력해주세요.");
                return;
            } else if (!member.loginPw) {
                alert("비밀번호를 입력해주세요.");
                return;
            } else if (!loginPw2) {
                alert("재확인 비밀번호를 입력해주세요.");
                return;
            } else if (member.loginPw !== loginPw2) {
                alert("재확인 비밀번호가 틀렸습니다.");
                return;
            } else if (!member.nickname) {
                alert("닉네임을 입력해주세요.");
                return;
            } else if (!member.name) {
                alert("이름을 입력해주세요.");
                return;
            }

            // key를 비동기적으로 가져옵니다.
            member.key = await getKey();

            doJoin(member);
        });

        // 닉네임 검사를 위한 함수
        function validateNickname(nickname) {
            const trimmedNickname = nickname.trim();

            // 특수문자 확인 (정규식)
            const specialCharPattern = /[^a-zA-Z0-9가-힣]/; // 한글, 영문, 숫자 외의 문자
            if (specialCharPattern.test(trimmedNickname)) {
                return '한글, 영문, 숫자만 사용해 주세요. <br> (특수기호, 공백 사용 불가)';
            }

            // 사용 불가능한 닉네임 확인
            if (restrictedNicknames.includes(trimmedNickname)) {
                return '사용할 수 없는 닉네임 입니다.';
            }

            // 닉네임 글자수 제한
            if (trimmedNickname.length > 7) {
                return '닉네임은 7글자 이하로 입력해주세요!';
            }

            if (trimmedNickname.length < 3) {
                return '닉네임은 최소 3글자 이상이어야 합니다!';
            }

            return ''; // 에러가 없으면 빈 문자열 반환
        }


        $('.inputID').on('input', async function () {
            const loginId = $(this).val().trim();
            const $errorID = $('.errorID');

            if (!loginId) {
                $errorID.html('* 아이디를 입력해주세요.').show();
                return;
            }

            const isDuplicate = await checkDuplicateId(loginId);
            if (isDuplicate) {
                $errorID.html('* 이미 사용 중인 아이디입니다.').show();
            } else {
                $errorID.html(' ').hide();
            }
        });

        $('.inputPW').on('input', function () {
            const PW = $(this).val().trim();
            const $errorPW = $('.errorPW');

            // 오류 메시지가 있으면 화면에 표시, 없으면 숨기기
            if (!PW) {
                $errorPW.html('비밀번호를 입력해주세요.').show();
            } else {
                $errorPW.html(' ').show();
            }
        });

        $('.inputPW2').on('input', function () {
            const PW = $('.inputPW').val().trim();
            const PW2 = $(this).val().trim();
            const $errorPW2 = $('.errorPW2');

            // 오류 메시지가 있으면 화면에 표시, 없으면 숨기기
            if (!PW) {
                $errorPW2.html('* 재확인 비밀번호를 입력해주세요.').show();
            } else if (PW !== PW2) {
                $errorPW2.html('* 재확인 비밀번호가 틀렸습니다.').show();
            } else {
                $errorPW2.html(' ').show();
            }
        });

        $('.inputName').on('input', function () {
            const name = $(this).val().trim();
            const $errorName = $('.errorName');

            // 오류 메시지가 있으면 화면에 표시, 없으면 숨기기
            if (!name) {
                $errorName.html('이름을 입력해주세요.').show();
            } else {
                $errorName.html(' ').show();
            }
        });

        $('.inputNickname').on('input', async function () {
            const nickname = $(this).val().trim();
            const errorMessage = validateNickname(nickname);
            const $errorNickname = $('.errorNickname');

            if (errorMessage) {
                $errorNickname.html('* ' + errorMessage).show();
                return;
            }

            const isDuplicate = await checkDuplicateNickname(nickname);
            if (isDuplicate) {
                $errorNickname.html('* 이미 사용 중인 닉네임입니다.').show();
            } else {
                $errorNickname.html(' ').hide();
            }
        });
    });
</script>
</body>
</html>