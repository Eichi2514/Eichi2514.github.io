<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>
    <link rel="stylesheet" href="../community/community.css"/>

    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Toast UI Editor 최신 버전 -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/i18n/ko-kr.js"></script>

    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="head">
    <div class="head-line">
        <a class="logo" href="/ascentlime">
            <img class="logo" src="https://github.com/user-attachments/assets/19a18684-da40-4693-a6db-81039eebb6e2"
                 alt="로고 이미지"/>
        </a>

        <div class="title">게시글 작성</div>

        <!-- 메뉴바 -->
        <div class="menu-bg">
            <div class="menu-container">
                <ul class="menu">
                    <li class="submenu-container">
                        <a href="../community/main">
                            <div class="button menu-item">커뮤니티</div>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="../community/main?boardId=1">
                                    <div class="button submenu-item">공지사항</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=2">
                                    <div class="button submenu-item">자유게시판</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=3">
                                    <div class="button submenu-item">Q & A</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="body">
    <div class="article-container">
        <form onsubmit="return ArticleWrite__submit(this);" enctype="multipart/form-data">
            <div class="article-header">
                <div class="flex gap-2 border p-2">
                    <div>게시판</div>
                    <div>
                        <label>
                            <select class="pl-2 pr-2" name="boardId">
                                <option value="" selected disabled>게시판을 선택해주세요</option>
                                <option class="Notice hidden" value="1">공지사항</option>
                                <option value="2">자유게시판</option>
                                <option value="3">Q & A</option>
                            </select>
                        </label>
                    </div>
                </div>
                <div class="flex gap-2 flex-grow border p-2">
                    <div>제목</div>
                    <label class="flex-grow">
                        <input class="w-full" name="title" autocomplete="off" type="text" placeholder="제목을 입력하세요"/>
                    </label>
                </div>
            </div>

            <label>
                <textarea class="article-body border" name="body"></textarea>
            </label>

            <div class="flex">
                <button class="article_backButton mt-5" type="button" onclick="history.back()">뒤로가기</button>

                <button class="article_button mt-5 ml-auto">작성</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
    // Firebase SDK 불러오기
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        set,
        get,
        child,
        query,
        orderByChild,
        equalTo
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const articlesRef = ref(database, 'articles');
    const membersRef = ref(database, 'members');

    async function loginKeyCheck(key) {
        const queryRef = query(membersRef, orderByChild("key"), equalTo(key));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();
            const memberKey = Object.keys(memberData)[0];
            return memberData[memberKey].nickname;
        } catch (error) {
            console.error("로그인 아이디 확인 중 오류 발생:", error);
            return null;
        }
    }

    // 로그인된 사용자 확인
    const key = localStorage.getItem('nickname');
    let author = null;
    if (key) {
        author = await loginKeyCheck(key);
    }

    const adminNicknames = ['chi', 'Eichi', '에이치', '빨간이치', 'admin', '관리자'];
    if (adminNicknames.includes(author)) $('.Notice').removeClass('hidden');

    // 게시글 작성 제출 함수
    window.ArticleWrite__submit = async function (form) {
        event.preventDefault(); // 기본 폼 제출 방지
        const now = new Date();
        const formattedTime = `${now.getFullYear()}년 ${String(now.getMonth() + 1).padStart(2, '0')}월 ${String(now.getDate()).padStart(2, '0')}일 ${String(now.getHours()).padStart(2, '0')}시 ${String(now.getMinutes()).padStart(2, '0')}분 ${String(now.getSeconds()).padStart(2, '0')}초`;

        const boardId = form.boardId.value;
        const title = form.title.value;
        const body = form.body.value;

        if (boardId.length === 0) {
            alert("게시판을 선택해주세요");
            return false;
        } else if (title.length === 0) {
            alert("제목을 입력하세요");
            return false;
        } else if (body.length === 0) {
            alert("내용을 입력하세요");
            return false;
        }

        try {
            // 현재 저장된 게시글 개수를 조회하여 번호를 생성
            const snapshot = await get(articlesRef);
            let articleCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
            let newArticleNumber = articleCount + 1; // 새 번호 생성
            let zero = '000';
            if (newArticleNumber < 10) zero = '00';
            else if (newArticleNumber < 100) zero = '0';

            // 새 게시글 저장
            const newArticlesRef = child(articlesRef, 'article' + zero + newArticleNumber);
            await set(newArticlesRef, {
                id: newArticleNumber,
                boardId: parseInt(boardId, 10),
                title: title,
                body: body,
                author: author,
                viewCount: 0,
                createdAt: formattedTime
            });

            alert("게시글이 성공적으로 등록되었습니다!");
            window.location.href = "../community/main";
        } catch (error) {
            console.error("게시글 저장 오류:", error);
            alert("게시글 저장 중 오류가 발생했습니다.");
        }

        return false;
    };
</script>
</body>
</html>