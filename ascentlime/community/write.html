<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>
    <link rel="stylesheet" href="../community/community.css"/>

    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Toast UI Editor 최신 버전 -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/i18n/ko-kr.js"></script>

    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="head">
    <div class="head-line">
        <a class="logo" href="/ascentlime">
            <img class="logo" src="https://github.com/user-attachments/assets/19a18684-da40-4693-a6db-81039eebb6e2"
                 alt="로고 이미지"/>
        </a>

        <div class="title">게시글 작성</div>

        <!-- 메뉴바 -->
        <div class="menu-bg">
            <div class="menu-container">
                <ul class="menu">
                    <li class="submenu-container">
                        <a href="../community/main">
                            <div class="button menu-item">커뮤니티</div>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="../community/main?boardId=1">
                                    <div class="button submenu-item">공지사항</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=2">
                                    <div class="button submenu-item">자유게시판</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=3">
                                    <div class="button submenu-item">Q & A</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="body">
    <form class="write-form" onsubmit="return ArticleWrite__submit(this);" enctype="multipart/form-data">
        <div class="article-container">
            <div class="article-header">
                <div class="flex gap-2 border p-2">
                    <div>게시판</div>
                    <div>
                        <label>
                            <select class="pl-2 pr-2" name="boardId">
                                <option value="" selected disabled>게시판을 선택해주세요</option>
                                <option class="Notice hidden" value="1">공지사항</option>
                                <option value="2">자유게시판</option>
                                <option value="3">Q & A</option>
                            </select>
                        </label>
                    </div>
                </div>
                <div class="flex gap-2 flex-grow border p-2">
                    <div>제목</div>
                    <label class="flex-grow">
                        <input class="w-full" name="title" autocomplete="off" type="text" placeholder="제목을 입력하세요"/>
                    </label>
                </div>
            </div>

            <label>
                <textarea class="article-body border" name="body"></textarea>
            </label>

            <div class="flex">
                <button class="article_backButton" type="button" onclick="history.back()">뒤로가기</button>

                <button class="article_button ml-auto">작성</button>
            </div>
        </div>
    </form>
</div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        set,
        get,
        child,
        query,
        orderByChild,
        equalTo,
        push
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const articlesRef = ref(database, 'articles');
    const membersRef = ref(database, 'members');

    let urls = window.location.search;
    let articleNum = urls ? parseInt(urls.substring(1)) : 0;

    async function loginKeyCheck(key) {
        const queryRef = query(membersRef, orderByChild("key"), equalTo(key));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();
            return Object.values(memberData)[0].nickname;
        } catch (error) {
            console.error("로그인 아이디 확인 중 오류 발생:", error);
            return null;
        }
    }

    const adminNicknames = ['chi', 'Eichi', '에이치', '빨간이치', 'admin', '관리자'];

    const key = localStorage.getItem('nickname');
    let author = null;

    if (key) {
        author = await loginKeyCheck(key);
    } else {
        alert('로그인이 필요합니다');
        location.href = '/ascentlime';
    }

    async function articleIdCheck(num) {
        const queryRef = query(articlesRef, orderByChild("id"), equalTo(num));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                alert('해당 게시글을 찾을 수 없습니다.');
                return null;
            }

            const articleData = snapshot.val();
            const articleId = Object.keys(articleData)[0];

            if (articleData[articleId].author !== author && !adminNicknames.includes(author)) {
                alert('수정 권한이 없습니다.');
                history.back();
            }
            return articleData[articleId];
        } catch (error) {
            console.error("게시글 조회 중 오류 발생:", error);
            return null;
        }
    }

    if (adminNicknames.includes(author)) $('.Notice').removeClass('hidden');

    if (articleNum) {
        const article = await articleIdCheck(articleNum);

        $('.title').text('게시글 수정');

        if (article) {
            $("select[name='boardId']").val(article.boardId);
            $("input[name='title']").val(article.title);
            $("textarea[name='body']").val(article.body);
        }
    }

    window.ArticleWrite__submit = async function (form) {
        event.preventDefault();
        const now = new Date();
        const formattedTime = `${now.getFullYear()}년 ${String(now.getMonth() + 1).padStart(2, '0')}월 ${String(now.getDate()).padStart(2, '0')}일 ${String(now.getHours()).padStart(2, '0')}시 ${String(now.getMinutes()).padStart(2, '0')}분 ${String(now.getSeconds()).padStart(2, '0')}초`;

        const boardId = form.boardId.value;
        const title = form.title.value;
        const body = form.body.value;

        if (boardId.length === 0) {
            alert("게시판을 선택해주세요");
            return false;
        } else if (title.length === 0) {
            alert("제목을 입력하세요");
            return false;
        } else if (body.length === 0) {
            alert("내용을 입력하세요");
            return false;
        }

        let word;

        if (!articleNum) {
            word = '작성';
            const newArticleRef = push(articlesRef);
            await set(newArticleRef, {
                id: newArticleRef.key,
                boardId: parseInt(boardId, 10),
                title: title,
                body: body,
                author: author,
                viewCount: 0,
                createdAt: formattedTime
            });
        } else {
            word = '수정';
            const article = await articleIdCheck(articleNum);
            if (!article) return;
            await set(child(articlesRef, "article" + article.id), {...article, title, body});
        }

        alert(`게시글이 성공적으로 ${word}되었습니다!`);
        window.location.href = "../community/main";
        return false;
    };
</script>
</body>
</html>