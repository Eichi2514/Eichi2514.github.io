<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>
    <link rel="stylesheet" href="../community/community.css"/>

    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="head">
    <div class="head-line">
        <a class="logo" href="/ascentlime">
            <img class="logo" src="https://github.com/user-attachments/assets/19a18684-da40-4693-a6db-81039eebb6e2"
                 alt="로고 이미지"/>
        </a>

        <div class="title">
            제목
        </div>

        <!-- 메뉴바 -->
        <div class="menu-bg">
            <div class="menu-container">
                <ul class="menu">
                    <li class="submenu-container">
                        <a href="../community/main">
                            <div class="button menu-item">커뮤니티</div>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="../community/main?boardId=1">
                                    <div class="button submenu-item">공지사항</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=2">
                                    <div class="button submenu-item">자유게시판</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=3">
                                    <div class="button submenu-item">Q & A</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="body">
    <div class="article-header border">
        <div class="flex gap-2">
            <div class="profile-photo">
                <img src="https://github.com/user-attachments/assets/2ab0ec46-1847-4c87-9b6c-b485ffd5bcc0" alt="프로필 사진">
            </div>
            <div class="profile-details">
                <div class="nickname">
                    닉네임
                </div>
                <div class="meta">
                    0000-00-00 / 조회수 000
                </div>
            </div>
        </div>
        <div class="article-actions m-2">
            <div class="edit link">
                수정
            </div>
            <div class="delete link">
                삭제
            </div>
        </div>
    </div>
    <div class="article-body border">

    </div>
</div>

<script type="module">
    // Firebase SDK 불러오기
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        query,
        orderByChild,
        remove,
        equalTo
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const articlesRef = ref(database, 'articles');
    const membersRef = ref(database, 'members');

    let urls = window.location.search;
    let articleNum = urls ? parseInt(urls.substring(1)) : 0;

    async function loginKeyCheck(key) {
        const queryRef = query(membersRef, orderByChild("key"), equalTo(key));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();
            const memberKey = Object.keys(memberData)[0];
            return memberData[memberKey].nickname;
        } catch (error) {
            console.error("로그인 아이디 확인 중 오류 발생:", error);
            return null;
        }
    }

    const adminNicknames = ['chi', 'Eichi', '에이치', '빨간이치', 'admin', '관리자'];

    // 로그인된 사용자 확인
    const key = localStorage.getItem('nickname');
    let author = null;
    if (key) {
        author = await loginKeyCheck(key);
    }

    const $edit = $('.edit');
    const $delete = $('.delete');

    async function articleIdCheck(num) {
        const queryRef = query(articlesRef, orderByChild("id"), equalTo(num));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                alert('해당 게시글을 찾을 수 없습니다.');
                history.back();
                return null;
            }

            const articleData = snapshot.val();
            const articleId = Object.keys(articleData)[0];

            if (articleData[articleId].author !== author && !adminNicknames.includes(author)) {
                $edit.addClass('hidden');
                $delete.addClass('hidden');
            }

            return articleData[articleId];
        } catch (error) {
            console.error("게시글 조회 중 오류 발생:", error);
            return null;
        }
    }

    const article = await articleIdCheck(articleNum);
    const dateOnly = article.createdAt.split(" ").slice(0, 3).map((e) => e.replace(/[^\d]/g, '')).join("-");

    $('.nickname').text(article.author);
    $('.meta').text(`${dateOnly} / 조회수 00`);
    $('.article-body').html(article.body.replace(/\n/g, '<br>'));

    $edit.click(function() {
        location.href = `../community/write?${articleNum}`;
    });

    $delete.click(async function() {
        const deleteCheck = confirm('정말로 삭제하시겠습니까? \n글 삭제시 복구가 불가능합니다.');

        if (deleteCheck) {
            const articleRef = ref(database, `articles/article${articleNum}`);  // 해당 게시글 데이터의 참조

            try {
                const snapshot = await get(articleRef);  // 데이터 가져오기
                if (!snapshot.exists()) {
                    alert('해당 게시글을 찾을 수 없습니다.');
                    return;
                }

                const article = snapshot.val();  // 게시글 데이터
                if (article.author !== author) {
                    alert('삭제 권한이 없습니다');
                    return;
                }

                await remove(articleRef);  // Firebase에서 해당 게시글 삭제
                alert('게시글이 삭제되었습니다.');
                location.href = '../community/main';  // 게시글 삭제 후 목록 페이지로 이동

            } catch (error) {
                console.error('게시글 삭제 중 오류 발생:', error);
                alert('게시글 삭제에 실패했습니다.');
            }
        }
    });
</script>
<script src="../community/community.js" defer></script>
</body>
</html>