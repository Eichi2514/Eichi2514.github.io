<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AscentLime(test)</title>
    <link rel="stylesheet" href="../community/community.css"/>

    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        @import url("https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css");
    </style>
</head>
<body>
<div class="head">
    <div class="head-line">
        <a class="logo" href="/ascentlime">
            <img class="logo" src="https://github.com/user-attachments/assets/19a18684-da40-4693-a6db-81039eebb6e2"
                 alt="로고 이미지"/>
        </a>

        <div class="title">
            커뮤니티
        </div>

        <!-- 메뉴바 -->
        <div class="menu-bg">
            <div class="menu-container">
                <ul class="menu">
                    <li class="submenu-container">
                        <a href="../community/main">
                            <div class="button menu-item">커뮤니티</div>
                        </a>
                        <ul class="submenu">
                            <li>
                                <a href="../community/main?boardId=1">
                                    <div class="button submenu-item">공지사항</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=2">
                                    <div class="button submenu-item">자유게시판</div>
                                </a>
                            </li>
                            <li>
                                <a href="../community/main?boardId=3">
                                    <div class="button submenu-item">Q & A</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="body">
    <div class="profile-container">
        <div class="profile login border hidden">
            <div class="profile-photo">
                <img src="https://github.com/user-attachments/assets/2ab0ec46-1847-4c87-9b6c-b485ffd5bcc0" alt="프로필 사진">
            </div>
            <div class="profile-details">
                <div class="nickname">
                    닉네임
                </div>
                <a class="written-posts-link link" href="../community/main?boardId=10">
                    내가 작성한 글 보기
                </a>
            </div>
        </div>
        <div class="profile logout border link">
            로그인
        </div>
        <div class="board-description border">
            <div class="board-title">
                전체 게시판
            </div>
            <a class="write-post link" href="../community/write">
                글쓰기
            </a>
        </div>
    </div>
    <div class="content">

    </div>

    <div class="pagination">
    </div>
</div>

<div class="login-bg hidden">
    <div class="close-button link">✖</div>
    <form class="login-form" method="POST">
        <div class="login-box border">
            <div class="login-title">로그인</div>
            <div class="login-form-container">
                <div class="login-inputs">
                    <label>
                        <input class="id text-center" type="text" placeholder="아이디를 입력해주세요" name="loginId"/>
                    </label>
                    <label>
                        <input class="pw text-center" type="password" placeholder="비밀번호를 입력해주세요"
                               name="loginPw"/>
                    </label>
                </div>
                <button class="login_bt p-2 border" type="submit">로그인</button>
            </div>
            <a class="join_bt link" href="../member/join">회원가입 / 아이디 * 비밀번호 찾기</a>
        </div>
    </form>
</div>

<script type="module">
    // Firebase SDK 불러오기
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        query,
        orderByChild,
        startAt,
        limitToFirst,
        equalTo
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: ".env/apiKey",
        authDomain: ".env/authDomain",
        databaseURL: "https://test-948ba-default-rtdb.firebaseio.com",
        projectId: ".env/projectId",
        storageBucket: ".env/storageBucket",
        messagingSenderId: ".env/messagingSenderId",
        appId: ".env/appId",
        measurementId: ".env/measurementId"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const articlesRef = ref(database, 'articles');
    const membersRef = ref(database, 'members');

    const boardName = ['오류', '공지', '자유', 'Q&A'];
    const boardFullName = ['내가 작성한 글', '공지사항', '자유 게시판', 'Q&A'];

    const urlParams = new URLSearchParams(window.location.search);
    let page = parseInt(urlParams.get('page')) || 1;
    let boardId = parseInt(urlParams.get('boardId')) || '';

    if (boardId === 10) $('.board-title').text(boardFullName[0]);
    else if (boardId >= 0) $('.board-title').text(boardFullName[boardId]);

    let lastPage = 1;  // 전역 lastPage 변수

    window.loginIdCheck = async function (loginId) {
        const queryRef = query(membersRef, orderByChild("loginId"), equalTo(loginId));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();

            const memberKey = Object.keys(memberData)[0];
            return memberData[memberKey];
        } catch (error) {
            console.error("로그인 아이디 확인 중 오류 발생:", error);
            return null;
        }
    };

    window.loginKeyCheck = async function (key) {
        const queryRef = query(membersRef, orderByChild("key"), equalTo(key));
        try {
            const snapshot = await get(queryRef);
            if (!snapshot.exists()) {
                console.log('해당 아이디를 찾을 수 없습니다.');
                return null;
            }

            const memberData = snapshot.val();
            const memberKey = Object.keys(memberData)[0];
            return memberData[memberKey].nickname;
        } catch (error) {
            console.error("로그인 아이디 확인 중 오류 발생:", error);
            return null;
        }
    }

    // 로그인된 사용자 확인
    const key = localStorage.getItem('nickname');
    let author = null;
    if (key) {
        author = await loginKeyCheck(key);
        $('.nickname').text(author);
    }

    const $logout = $(".logout");

    $logout.click(async function() {
        $loginBg.removeClass('hidden');
    });

    $('.close-button').click(async function() {
        $loginBg.addClass('hidden');
    });

    // 페이지네이션 및 데이터 표시를 위한 쿼리
    function getLogsQuery(startIndex, boardId) {
        let queryRef;
        if (boardId === '') {
            // 모든 게시글 가져오기
            queryRef = query(articlesRef, orderByChild("id"), startAt(startIndex), limitToFirst(10));
        } else if (boardId === 10) {
            // 내가 쓴 글만 가져오기 (예: author 필드가 현재 사용자랑 일치하는 글)
            queryRef = query(articlesRef, orderByChild("author"), equalTo(author));
        } else if (boardId > 0) {
            // 특정 boardId에 해당하는 글만 가져오기
            queryRef = query(articlesRef, orderByChild("boardId"), equalTo(boardId));
        }

        return query(queryRef);
    }

    // Firebase에서 전체 로그 개수 계산 후 페이지네이션 업데이트
    get(articlesRef).then((snapshot) => {
        const data = snapshot.val(); // 데이터를 객체로 가져옴
        if (data) {
            const totalLogsCount = Object.keys(data).length; // 자식 노드 개수 계산

            // 마지막 페이지 계산
            lastPage = Math.ceil(totalLogsCount / 10.0);

            // page 값 조정 (1보다 작은 경우 1로, lastPage보다 큰 경우 lastPage로 설정)
            if (page < 1) page = 1;
            else if (page > lastPage) page = lastPage;

            // 페이지네이션 업데이트
            const paginationElement = document.querySelector('.pagination');  // 요소가 존재하는지 확인 후 업데이트
            if (paginationElement) {
                updatePagination();
            }

            // 페이지에 맞는 로그 데이터를 가져오기
            loadPosts(boardId);  // boardId를 인자로 전달
        }
    }).catch((error) => {
        console.error("전체 로그 개수 가져오기 오류: ", error); // 한글로 출력
    });

    // 게시글 목록을 불러오는 함수
    window.loadPosts = async function (boardId) {
        const contentDiv = document.querySelector(".content");
        if (!contentDiv) {
            console.error("게시글을 표시할 요소가 존재하지 않습니다.");
            return;
        }
        contentDiv.innerHTML = ""; // 기존 내용 초기화

        try {
            const snapshot = await get(getLogsQuery(page, boardId));
            if (!snapshot.exists()) {
                contentDiv.innerHTML = "<p class='text-center text-gray-500'>게시글이 없습니다.</p>";
                return;
            }

            const articles = snapshot.val();
            const sortedArticles = Object.values(articles).sort((a, b) => b.id - a.id); // 최신 글 순서

            sortedArticles.forEach(article => {
                const postElement = document.createElement("a");
                postElement.classList.add("post-item", "border");
                postElement.href = `../community/detail?${article.id}`;

                const now = new Date();
                const formattedTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const dateOnly = article.createdAt.split(" ").slice(0, 3).map((e) => e.replace(/[^\d]/g, '')).join("-");

                const NewIcon = dateOnly >= formattedTime ? `
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 30 30" style="display: inline-block;">
                    <circle cx="15" cy="15" r="12" fill="#AE001B"/>
                    <text x="15" y="16" font-size="10" fill="white" font-family="Arial, sans-serif" text-anchor="middle" dominant-baseline="middle"> N </text>
                </svg>` : '';

                postElement.innerHTML = `
                <div class="post-thumbnail">
                    <img src="https://github.com/user-attachments/assets/2ab0ec46-1847-4c87-9b6c-b485ffd5bcc0" alt="대표 이미지">
                </div>
                <div class="post-details">
                    <div class="post-header">
                        <div class="flex gap-2 items-center">
                            <div class="border boardName">${boardName[article.boardId]}</div>
                            <div class="post-title">${article.title ? article.title.substring(0, 30) + (article.title.length > 30 ? '...' : '') : ''}</div>
                        </div>
                        <div class="post-title-side flex gap-10">
                            <div class="comment">
                                <img src="https://github.com/user-attachments/assets/0d4c9144-13e5-4daa-8799-bd5c6de1ded8" alt="댓글 이미지">
                                <div class="comment-count">${article.commentCount || 0}</div>
                            </div>
                            ${NewIcon}
                        </div>
                    </div>
                    <div class="post-body">
                        <div class="post-title">${article.body ? article.body.substring(0, 35) + (article.body.length > 35 ? '...' : '') : ''}</div>
                    </div>
                    <div class="post-meta">
                        <div class="author">${article.author}</div>
                        <div class="view-count">
                            <img src="https://github.com/user-attachments/assets/f172ce36-3488-48a9-ab40-a4d1a02f2cf2" alt="조회수" width="30" height="30">
                            <span class="pl-5">${article.viewCount}</span>
                        </div>
                        <div class="like-count">
                            <img src="https://github.com/user-attachments/assets/94d75263-e1b4-4d0e-8bc7-a8315a3322b2" alt="좋아요" width="30" height="30">
                            <span class="pl-5">${article.likeCount || 0}</span>
                        </div>
                        <div class="post-time">
                            <img src="https://github.com/user-attachments/assets/6e0e9738-1a6a-453e-91c6-c35e851ccedf" alt="시간" width="30" height="30">
                            <span class="pl-5">${dateOnly}</span>
                        </div>
                    </div>
                </div>
            `;
                contentDiv.appendChild(postElement);
            });
        } catch (error) {
            console.error("게시글 로드 오류:", error);
            contentDiv.innerHTML = "<p class='text-center text-red-500'>게시글을 불러오는 중 오류가 발생했습니다.</p>";
        }
    }

    // 페이지네이션 동적 링크 계산
    function updatePagination() {
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = `
        <a class="pagination_left" href="../community/detail?${boardId}&page=${page > 1 ? page - 1 : 1}" style="${page === 1 ? 'display: none;' : ''}">
            <i class="fa-solid fa-caret-left" style="font-size: 10vh;"></i>
        </a>
        <a class="pagination_right" href="../community/detail?${boardId}&page=${page < lastPage ? page + 1 : lastPage}" style="${page === lastPage ? 'display: none;' : ''}">
            <i class="fa-solid fa-caret-right" style="font-size: 10vh;"></i>
        </a>
        <div class="pagination flex justify-center">
            <!-- '처음' 버튼 -->
            <a href="../scoreboard?page=1" style="${page === 1 ? 'display: none;' : ''}">처음</a>
            <button style="${page === 1 ? 'display: none;' : ''}">)&nbsp;</button>
            <!-- 이전 페이지 버튼들 -->
            <a class="page" href="../community/detail?${boardId}&page=${Math.max(page - 4, 1)}" style="${page <= 4 ? 'display: none;' : ''}">${Math.max(page - 4, 1)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.max(page - 3, 1)}" style="${page <= 3 ? 'display: none;' : ''}">${Math.max(page - 3, 1)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.max(page - 2, 1)}" style="${page <= 2 ? 'display: none;' : ''}">${Math.max(page - 2, 1)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.max(page - 1, 1)}" style="${page === 1 ? 'display: none;' : ''}">${Math.max(page - 1, 1)}</a>
            <!-- 현재 페이지 -->
            <a class="page text-red-500 border" href="../scoreboard?${boardId}&page=${page}">${page}</a>
            <!-- 다음 페이지 버튼들 -->
            <a class="page" href="../community/detail?${boardId}&page=${Math.min(page + 1, lastPage)}" style="${page >= lastPage ? 'display: none;' : ''}">${Math.min(page + 1, lastPage)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.min(page + 2, lastPage)}" style="${page + 1 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 2, lastPage)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.min(page + 3, lastPage)}" style="${page + 2 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 3, lastPage)}</a>
            <a class="page" href="../community/detail?${boardId}&page=${Math.min(page + 4, lastPage)}" style="${page + 3 >= lastPage ? 'display: none;' : ''}">${Math.min(page + 4, lastPage)}</a>
            <!-- '마지막' 버튼 -->
            <button style="${page === lastPage ? 'display: none;' : ''}">&nbsp;(</button>
            <a href="../community/detail?${boardId}&page=${lastPage}" style="${page === lastPage ? 'display: none;' : ''}">마지막</a>
        </div>
    `;
    }

    updatePagination();
</script>
<script src="../ascentlime.js" defer></script>
</body>
</html>