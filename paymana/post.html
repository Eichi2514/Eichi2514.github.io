<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, minimum-scale=0.01">
    <link rel="icon" href="../favicon/PayMana.png" type="image/png">
    <title>PayMana</title>

    <link rel="stylesheet" href="paymana.css"/>
    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body>
<div class="container">
    <div class="header">
        <a href="/paymana" class="flex gap-3">
            <img src="../favicon/PayMana.png" alt="로고" style="width: 37px;">
            <div>PayMana</div>
        </a>
        <label>
            <input type="text" id="title" class="title" value="제목">
        </label>
    </div>

    <div class="section">
        <div class="row">
            <span>총 예산</span><span>총 지출</span><span>잔액</span>
        </div>
        <div class="row">
            <span class="totalFee">0원</span>
            <span class="totalSpent">0원</span>
            <span class="remainingAmount">0원</span>
        </div>
    </div>

    <div class="flex-container">
        <div class="section">
            <button class="button mb-2" onclick="addItem()">추가</button>

            <div class="row">
                <span>항목</span><span>금액(원)</span><span></span><span>삭제</span>
            </div>

            <div class="item-list">
            </div>
        </div>

        <div class="section">
            <div class="flex">
                <span class="person-list-description mb-2">
                    ?
                    <span class="person-list-description-view">
                        정산금액이<br>
                        음수(-)이면 환급금액이며,<br>
                        양수(+)이면 납부금액입니다.
                    </span>
                </span>
                <button class="button mb-2" onclick="addPerson()">추가</button>
            </div>

            <div class="row">
                <span>이름</span><span>정산금액</span><span>선납금액</span><span>삭제</span>
            </div>

            <div class="person-list">
            </div>
        </div>
    </div>
    <div class="flex gap-2">
        <button class="button" onclick="window.location.href = `../paymana`">목록</button>
        <button class="remove-button" onclick="removePost()">삭제</button>
    </div>
</div>

<div class="footer">
    <p>© 2025 PayMana. All Rights Reserved.</p>
</div>

<script>
    const urls = window.location.search;
    const titleNum = urls ? parseInt(urls.substring(1)) : 0;
    const postString = localStorage.getItem(`PM-${titleNum}`);
    const post = postString ? JSON.parse(postString) : {};


    if (titleNum === 0) {
        alert(`잘못된 접근방식입니다.`);
        history.back();
    }

    function titleUpdate() {
        $('.title').val(post.title);
    }

    titleUpdate();

    function removePost() {
        const deleteCheck = confirm('정말로 삭제하시겠습니까? \n삭제 시 복구가 불가능합니다.');

        if (deleteCheck) {
            localStorage.removeItem(`PM-${titleNum}`);
            window.location.href = `../paymana`;
        }
    }

    function formatNum(num) {
        return num.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 1});
    }

    function totalSpentUpdate() {
        let totalSpent = 0;
        Object.keys(post).forEach(key => {
            if (key.startsWith('i')) {
                const amount = parseInt(post[key].amount) || 0;
                totalSpent += amount;
            }
        });

        const $totalSpent = $('.totalSpent');
        $totalSpent.removeClass('total-amount-negative total-amount');

        const formatString = formatNum(totalSpent);

        if (totalSpent < 0) {
            $totalSpent.text(`${formatString}원`).addClass('total-amount-negative');
        } else {
            $totalSpent.text(`${formatString}원`).addClass('total-amount');
        }

        return totalSpent;
    }

    function totalFeeUpdate() {
        let totalFee = 0;
        Object.keys(post).forEach(key => {
            if (key.startsWith('p')) {
                const advanceAmount = parseInt(post[key].advanceAmount) || 0;
                totalFee += advanceAmount;
            }
        });

        const $totalFee = $('.totalFee');
        $totalFee.removeClass('total-amount-negative total-amount');

        const formatString = formatNum(totalFee);

        if (totalFee < 0) {
            $totalFee.text(`${formatString}원`).addClass('total-amount-negative');
        } else {
            $totalFee.text(`${formatString}원`).addClass('total-amount');
        }

        return totalFee;
    }

    function remainingAmountUpdate() {
        const totalFee = totalFeeUpdate();
        const totalSpent = totalSpentUpdate();
        const remainingAmount = totalFee - totalSpent;

        const $remainingAmount = $('.remainingAmount');
        $remainingAmount.removeClass('total-amount-negative total-amount');
        const formatString = formatNum(remainingAmount);

        if (remainingAmount < 0) {
            $remainingAmount.text(`${formatString}원`).addClass('total-amount-negative');
        } else {
            $remainingAmount.text(`${formatString}원`).addClass('total-amount');
        }

        let count = 0;

        Object.keys(post).forEach(key => {
            if (key.startsWith('p')) {
                count++;
            }
        });


        if (count > 0) {
            Object.keys(post).forEach(key => {
                if (key.startsWith('p')) {
                    const advanceAmount = parseInt(post[key].advanceAmount) || 0;
                    const calculatedAmount = (totalSpent / count) - advanceAmount;

                    const $settledAmount = $(`.settledAmount-${key}`);
                    $settledAmount.removeClass('total-amount-negative total-amount');
                    const formatString = formatNum(calculatedAmount);

                    if (calculatedAmount < 0) {
                        $settledAmount.text(`${formatString}원`).addClass('total-amount');
                    } else {
                        $settledAmount.text(`${formatString}원`).addClass('total-amount-negative');
                    }
                }
            });
        }
    }

    function startPost() {
        Object.keys(post).forEach(key => {
            if (key.startsWith('i')) {
                const num = parseInt(key.substring(1), 10);

                const itemName = post[key].itemName || '';
                const amount = parseInt(post[key].amount) || 0;

                const newItem = `
                    <div class="item row">
                        <label>
                            <input class="itemName" type="text" name="i${num}" value="${itemName}">
                        </label>
                        <label>
                            <input class="amount" type="number" name="i${num}" value="${amount}">
                        </label>
                        <span class="splitAmount"></span>
                        <button class="remove-bt" data-id="i${num}">🗑</button>
                    </div>
                    `;

                $('.item-list').append(newItem);
            } else if (key.startsWith('p')) {
                const num = parseInt(key.substring(1), 10);

                const name = post[key].name || '';
                const advanceAmount = parseInt(post[key].advanceAmount) || 0;

                const newItem = `
                    <div class="person row">
                        <label>
                            <input class="name" type="text" name="p${num}" value="${name}">
                        </label>
                        <span class="settledAmount-p${num}">0원</span>
                        <label>
                            <input class="advanceAmount" type="number" name="p${num}" value="${advanceAmount}">
                        </label>
                        <button class="remove-bt" data-id="p${num}">🗑</button>
                    </div>
                    `;

                $('.person-list').append(newItem);
            }
        });

        remainingAmountUpdate();

    }

    startPost();

    function addItem() {
        let lastItemId = 0;

        Object.keys(post).forEach(key => {
            if (key.startsWith('i')) {
                const num = parseInt(key.substring(1), 10);
                if (!isNaN(num) && num > lastItemId) {
                    lastItemId = num;
                }
            }
        });

        const newItem = `
        <div class="item row">
            <label>
                <input class="itemName" type="text" name="i${lastItemId + 1}">
            </label>
            <label>
                <input class="amount" type="number" name="i${lastItemId + 1}">
            </label>
            <span class="splitAmount"></span>
            <button class="remove-bt" data-id="i${lastItemId + 1}">🗑</button>
        </div>
        `;

        $('.item-list').append(newItem);
    }

    function addPerson() {
        let lastPersonId = 0;

        Object.keys(post).forEach(key => {
            if (key.startsWith('p')) {
                const num = parseInt(key.substring(1), 10);
                if (!isNaN(num) && num > lastPersonId) {
                    lastPersonId = num;
                }
            }
        });

        const newItem = `
        <div class="person row">
            <label>
                <input class="name" type="text" name="p${lastPersonId + 1}">
            </label>
            <span class="settledAmount-p${lastPersonId + 1}">0원</span>
            <label>
                <input class="advanceAmount" type="number" name="p${lastPersonId + 1}">
            </label>
            <button class="remove-bt" data-id="p${lastPersonId + 1}">🗑</button>
        </div>
        `;

        $('.person-list').append(newItem);
    }

    $(document).on('input', 'input', function () {
        const val = $(this).val();
        const nameAttr = $(this).attr('name');
        const classAttr = $(this).attr('class');

        if (classAttr === 'title') {
            post[classAttr] = val;
        } else {
            if (!post[nameAttr]) {
                post[nameAttr] = {};
            }
            post[nameAttr][classAttr] = val;
        }

        localStorage.setItem(`PM-${titleNum}`, JSON.stringify(post));

        if (nameAttr.startsWith('p') || nameAttr.startsWith('i') && classAttr === 'amount' && classAttr !== 'title') {
            remainingAmountUpdate();
        }
    });


    $(document).on('click', '.remove-bt', function () {
        const button = $(this);
        const id = button.data('id');

        button.closest('div').remove();

        delete post[`${id}`];
        localStorage.setItem(`PM-${titleNum}`, JSON.stringify(post));

        if (id.startsWith('p') || id.startsWith('i')) {
            remainingAmountUpdate();
        }
    });


    function getLocalStorageSize() {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += (localStorage[key].length * 2); // UTF-16 문자당 2바이트
            }
        }
        console.log(`현재 로컬스토리지 사용량: ${total / 1024} KB`);
    }

    getLocalStorageSize();
</script>
</body>
</html>