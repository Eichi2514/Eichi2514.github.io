<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayMana</title>

    <link rel="stylesheet" href="paymana.css"/>
    <!-- ì œì´ì¿¼ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- í…Œì¼ìœˆë“œ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- í°íŠ¸ì–´ì¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>PayMana</h1>
        <label>
            <input type="text" id="title" class="title" value="ì œëª©">
            <button class="button">ìˆ˜ì •</button>
        </label>
    </div>

    <div class="section">
        <div class="row">
            <span>ì´ ì˜ˆì‚°</span><span>ì´ ì§€ì¶œ</span><span>ì”ì•¡</span>
        </div>
        <div class="row">
            <span class="totalFee total-amount">0ì›</span>
            <span class="totalSpent total-amount">0ì›</span>
            <span class="remainingAmount total-amount">0ì›</span>
        </div>
    </div>

    <div class="flex-container">
        <div class="section">
            <button class="button" onclick="addItem()">ì¶”ê°€</button>

            <div class="row">
                <span>í•­ëª©</span><span>ê¸ˆì•¡(ì›)</span><span></span><span>ê¸°íƒ€</span>
            </div>

            <div class="item-list">
            </div>
        </div>

        <div class="section">
            <button class="button" onclick="addPerson()">ì¶”ê°€</button>

            <div class="row">
                <span>ì´ë¦„</span><span>ì •ì‚°ê¸ˆì•¡</span><span>ë¯¸ë¦¬ë‚¸ê¸ˆì•¡</span><span>ê¸°íƒ€</span>
            </div>

            <div class="person-list">
            </div>
        </div>
    </div>
    <div class="flex gap-2">
        <button class="button" onclick="location.reload()">ì •ì‚°</button>
        <button class="remove-button" onclick="removePost()">ì‚­ì œ</button>
    </div>
</div>

<div class="footer">
    <p>Â© 2025 PayMana. All Rights Reserved.</p>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const title = params.keys().next().value;


    if (title === '') {
        alert(`ì˜ëª»ëœ ì ‘ê·¼ë°©ì‹ì…ë‹ˆë‹¤.`);
        history.back();
    }

    function titleUpdate() {
        $('.title').val(title);
    }

    titleUpdate();

    function removePost() {
        const deleteCheck = confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? \nì‚­ì œ ì‹œ ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');

        if (deleteCheck) {
            localStorage.removeItem(`PM-${title}`);
            window.location.href = `../paymana`;
        }
    }

    const postString = localStorage.getItem(`PM-${title}`);
    const post = postString ? JSON.parse(postString) : {};

    function totalFeeUpdate() {
        let totalFee = 0;
        Object.keys(post).forEach(key => {
            if (key.startsWith('p')) {
                const advanceAmount = parseInt(post[key].advanceAmount) || 0;
                totalFee += advanceAmount;
            }
        });

        $('.totalFee').text(`${totalFee}ì›`);
    }

    function startPost() {
        Object.keys(post).forEach(key => {
            if (key.startsWith('i')) {
                const num = parseInt(key.substring(1), 10);

                const itemName = post[key].itemName || '';
                const amount = parseInt(post[key].amount) || 0;

                const newItem = `
                    <div class="item row">
                        <label>
                            <input class="itemName" type="text" name="i${num}" value="${itemName}">
                        </label>
                        <label>
                            <input class="amount" type="number" name="i${num}" value="${amount}">
                        </label>
                        <span class="splitAmount"></span>
                        <button class="remove-bt" data-id="i${num}">ğŸ—‘</button>
                    </div>
                    `;

                $('.item-list').append(newItem);
            } else if (key.startsWith('p')) {
                const num = parseInt(key.substring(1), 10);

                const name = post[key].name || '';
                const advanceAmount = parseInt(post[key].advanceAmount) || 0;

                const newItem = `
                    <div class="person row">
                        <label>
                            <input class="name" type="text" name="p${num}" value="${name}">
                        </label>
                        <span class="settledAmount">0ì›</span>
                        <label>
                            <input class="advanceAmount" type="number" name="p${num}" value="${advanceAmount}">
                        </label>
                        <button class="remove-bt" data-id="p${num}">ğŸ—‘</button>
                    </div>
                    `;

                $('.person-list').append(newItem);
            }
        });

        totalFeeUpdate();
    }

    startPost();

    function addItem() {
        let lastItemId = 0;

        Object.keys(post).forEach(key => {
            if (key.startsWith('i')) {
                const num = parseInt(key.substring(1), 10);
                if (!isNaN(num) && num > lastItemId) {
                    lastItemId = num;
                }
            }
        });

        const newItem = `
        <div class="item row">
            <label>
                <input class="itemName" type="text" name="i${lastItemId + 1}">
            </label>
            <label>
                <input class="amount" type="number" name="i${lastItemId + 1}">
            </label>
            <span class="splitAmount"></span>
            <button class="remove-bt" data-id="i${lastItemId + 1}">ğŸ—‘</button>
        </div>
        `;

        $('.item-list').append(newItem);
    }

    function addPerson() {
        let lastPersonId = 0;

        Object.keys(post).forEach(key => {
            if (key.startsWith('p')) {
                const num = parseInt(key.substring(1), 10);
                if (!isNaN(num) && num > lastPersonId) {
                    lastPersonId = num;
                }
            }
        });

        const newItem = `
        <div class="person row">
            <label>
                <input class="name" type="text" name="p${lastPersonId + 1}">
            </label>
            <span class="settledAmount">0ì›</span>
            <label>
                <input class="advanceAmount" type="number" name="p${lastPersonId + 1}">
            </label>
            <button class="remove-bt" data-id="p${lastPersonId + 1}">ğŸ—‘</button>
        </div>
        `;

        $('.person-list').append(newItem);
    }

    $(document).on('input', 'input', function () {
        const val = $(this).val();
        const nameAttr = $(this).attr('name');
        const classAttr = $(this).attr('class');

        if (classAttr === 'title') return;

        if (!post[nameAttr]) {
            post[nameAttr] = {};
        }

        post[nameAttr][classAttr] = val;

        localStorage.setItem(`PM-${title}`, JSON.stringify(post));

        if (nameAttr.startsWith('p') && classAttr === 'advanceAmount') {
            totalFeeUpdate();
        }
    });


    $(document).on('click', '.remove-bt', function () {
        const button = $(this);
        const id = button.data('id');

        button.closest('div').remove();

        delete post[`${id}`];
        localStorage.setItem(`PM-${title}`, JSON.stringify(post));

        if (id.startsWith('p')) {
            totalFeeUpdate();
        }
    });


    function getLocalStorageSize() {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += (localStorage[key].length * 2); // UTF-16 ë¬¸ìë‹¹ 2ë°”ì´íŠ¸
            }
        }
        console.log(`í˜„ì¬ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰: ${total / 1024} KB`);
    }

    getLocalStorageSize();

</script>
</body>
</html>