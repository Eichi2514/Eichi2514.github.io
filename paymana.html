<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, minimum-scale=0.01">
    <link rel="icon" href="favicon/PayMana.png" type="image/png">
    <title>PayMana</title>

    <link rel="stylesheet" href="paymana/paymana.css"/>
    <!-- 제이쿼리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 테일윈드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css">

    <!-- 폰트어썸 불러오기 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- LZString 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="" class="flex gap-3">
            <img src="favicon/PayMana.png" alt="로고" style="width: 37px;">
            <div>PayMana</div>
        </a>
        <button class="button" onclick="createPost()">만들기</button>
    </div>
    <div class="post-list">
    </div>
</div>

<div class="footer">
    <p>© 2025 PayMana. All Rights Reserved.</p>
</div>

<div class="popup-bg hidden">
    <form class="popup-form" method="POST">
        <div class="popup-box">
            <div class="popup-title">포스트 제목 입력</div>
            <div class="close-button">✖</div>
            <div class="popup-form-container">
                <label>
                    <input class="popup-input" type="text" placeholder="제목을 입력해주세요" name="title"/>
                </label>
                <button class="button" type="submit">생성</button>
            </div>
        </div>
    </form>
</div>

<script>
    const $popupBg = $('.popup-bg');

    function createPost() {
        $popupBg.removeClass('hidden').addClass('flex');
    }

    $('.close-button').click(function () {
        $popupBg.removeClass('flex').addClass('hidden');
    });

    $(document).ready(function () {
        Object.keys(localStorage).forEach(function (key) {
            if (key.startsWith('PM-')) {
                const match = key.match(/\d+/);
                const titleNum = match ? parseInt(match[0], 10) : NaN;

                const decompressedData = LZString.decompressFromUTF16(localStorage.getItem(`PM-${titleNum}`));
                const postData = decompressedData ? JSON.parse(decompressedData) : {};
                const title = postData?.title || "제목 없음"; // 안전하게 title 가져오기

                const newPost = `
                <a href="../paymana/post?${titleNum}">
                    <img src="https://github.com/user-attachments/assets/e86ae66f-cd1b-407f-a195-d5c2e030ee01" alt="폴더">
                    <div>${title}</div>
                </a>
            `;

                $('.post-list').append(newPost);
            }
        });
    });


    $('.popup-form').submit(async function (event) {
        event.preventDefault(); // 폼의 기본 제출 동작을 막음

        const $titleInput = $('input[name="title"]');
        const title = $titleInput.val().trim();

        if (!title) {
            alert('제목을 입력해주세요.');
            return;
        }

        let titleId = 1;

        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('PM-')) {
                const match = key.match(/\d+/);
                const num = match ? parseInt(match[0], 10) : NaN;
                if (!isNaN(num) && num >= titleId) {
                    titleId = num + 1;
                }
            }
        });

        const compressedData = LZString.compressToUTF16(JSON.stringify({"title": title}));
        localStorage.setItem(`PM-${titleId}`, compressedData);
        window.location.href = `../paymana/post?${titleId}`;
    });
</script>
</body>
</html>